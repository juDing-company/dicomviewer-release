function ImageStatus(){this.image,this.brightness=0,this.contrast=0,this.Negative=!1,this.scaledWidth=0,this.scaledHeight=0,this.ptMove={x:0,y:0},this.rotateState=0,this.pseudoColor=null,this.bDrawText=!0}function DicomRequest(options){var defaults={wadourl:"",hospid:"",studyuid:"",study:"",token:void 0,imageType:void 0,departCode:0,hasDesensitize:0,isKeyImage:0,isInternal:0,progress:null,serverRead:"",error:null,success:null,deseriesfakeprogress:null,manager:void 0},opt=$.extend(defaults,options),self=this;function FillServerProcess(arrInfos){arrInfos instanceof Array&&arrInfos.forEach(function(dicom){dicom.bLoadImage=!0,opt.progress(dicom,opt.study,100)})}function RespontStudy(rsp){rsp.success?(rsp.data.requestDesensitize=opt.hasDesensitize,opt.study.SetStudyInfo(rsp.data),opt.study.UpdateSort(),null!=opt.success&&opt.success(opt.study),(opt.study.hasseries&&"RAW"==opt.study.totaltype?StartDLDicom:StartDLJpg)()):null!==opt.error&&opt.error({msg:rsp.msg,studyuid:opt.studyuid})}function GetDLDicomId(bFirst){for(var arrDicomId=[],arrSeries=opt.study.GetAllSeries(),i=0;i<arrSeries.length;i++)for(var series=arrSeries[i],j=0;j<Math.min(series.arrImage.length,1);j++){var dicom=series.arrImage[j];arrDicomId.push(dicom.id)}if(!bFirst)for(i=0;i<arrSeries.length;i++)for(series=arrSeries[i],j=1;j<series.arrImage.length;j++){dicom=series.arrImage[j];arrDicomId.push(dicom.id)}return arrDicomId}function GetDLDicomLaminated(){var arrImage,groupSeries=[];for({arrImage}of opt.study.GetAllSeries())groupSeries.push(arrImage);return simple.arraysLaminated(...groupSeries)}function GetDLDicom(bFirst){for(var arrDicom=[],arrSeries=opt.study.GetAllSeries(),i=0;i<arrSeries.length;i++)for(var series=arrSeries[i],j=0;j<Math.min(series.arrImage.length,1);j++){var dicom=series.arrImage[j];arrDicom.push(dicom)}if(!bFirst)for(i=0;i<arrSeries.length;i++)for(series=arrSeries[i],j=1;j<series.arrImage.length;j++){dicom=series.arrImage[j];arrDicom.push(dicom)}return arrDicom}function StartDLDicom(){var bSeries;CBoBo.Draw.GetIsFromServer()?self.DLJsonBySeriesUid():(bSeries="series"===(bSeries=opt.study.GetStudyType()),opt.study.IsPageSwitch()&&bSeries?RequestFirstDicom():void 0===opt.study.GetAllSeries()[0].uuid?DLDicomMeta():self.DLJsonBySeriesUid())}function DLDicomMeta(){var arrDLId=GetDLDicomId(),dlDicomNums=0,imageCount=opt.study.imgcount;$.each(arrDLId,function(){var id=this,url=opt.wadourl+"/GetImageMeta/"+id,xhr=new XMLHttpRequest;xhr.open("GET",url,!0),xhr.responseType="json",xhr.send(),xhr.onreadystatechange=function(){var rsp;xhr.readyState===xhr.DONE&&200===xhr.status&&xhr.response?(rsp=xhr.response,"string"==typeof rsp&&(rsp=eval("("+rsp+")")),opt.study.SetDicomData(rsp,id,0),dlDicomNums++):xhr.readyState===xhr.DONE&&200!==xhr.status&&dlDicomNums++,dlDicomNums===imageCount&&(opt.study.CorrectScout(),opt.study.bAllMetaDl=!0,RequestDicom())}})}function RequestDicom(){const{study,wadourl,studyuid,hospid,departCode,imageType}=opt;var arrItems=[],arrPriority=[];let arrPrefetch=[];var arrDicom=GetDLDicomLaminated(),bSeries=study.GetStudyType();const seriesLength=study.GetAllSeries().length||6;function PushDicomRequest(dicom,imgIndex){let{isRGB,url,id,uid,col,row,mod,compress,seruid,imgnum,patid}=dicom;var item={url:url=1==imageType?"ECG"==mod?wadourl+"/GetECGImageData?id="+id:compress?wadourl+"/GetDecodeImageData?id="+id:url||wadourl+"/GetImageData?id="+id:url||wadourl+"/GetBlock/"+id+"?blockIndex=0&studyuid="+studyuid+"&hospitalid="+hospid+"&hospid="+hospid+"&seriesId="+seruid+"&departCode="+departCode,id:id,uid:uid,imageType:imageType,bseries:!0,brgb:isRGB,index:0,ratio:1,dcmWidth:col,dcmHeight:row,bsave:!0,patid:patid,dicomInfo:{isRGB:isRGB}};dicom.setData({threadPostData:item}),(imgnum<=2||imgIndex<seriesLength||void 0===imgIndex?arrPriority:arrPrefetch).push(item)}bSeries="series"===bSeries,arrDicom instanceof Array&&(bSeries?arrDicom.forEach((dicom,index)=>{PushDicomRequest(dicom,index)}):$.each(arrDicom,function(){var seriesId;1==imageType?PushDicomRequest(this):(seriesId=this.seruid,function(dicom,studyuid,hospitalid,seriesId,departCode){if(dicom instanceof DVDicomInfo)for(var{isRGB,url,id,uid,blocks,bits,col,row,patid}=dicom,i=0;i<blocks;i++){var item={url:url||wadourl+"/GetBlock/"+id+"?blockIndex="+i+"&studyuid="+studyuid+"&hospitalid="+hospitalid+"&hospid="+hospitalid+"&seriesId="+seriesId+"&departCode="+departCode,id:id,uid:uid,imageType:imageType,bseries:!1,brgb:!1,index:i,ratio:Math.sqrt(blocks),bits:bits,dcmWidth:col,dcmHeight:row,bsave:!0,patid:patid,dicomInfo:{isRGB:isRGB}};(0===i?arrPriority:arrItems).push(item)}}(this,study.studyuid,study.hospid,seriesId,study.departCode))}));bSeries=simple.queryToObject().prefetchNum||$("#prefetchNum").val();arrPrefetch=arrPrefetch.slice(0,isNaN(bSeries)?seriesLength*(seriesLength<7?1:0):bSeries),mergeThread.postMessage({type:0,arrpriority:[...arrPriority,...arrItems,...arrPrefetch]})}function RequestFirstDicom(){var arrDLId=GetDLDicomId(!0),dlDicomNums=0,imageCount=arrDLId.length;$.each(arrDLId,function(){var id=this,url=opt.wadourl+"/GetImageMeta/"+id,xhr=new XMLHttpRequest;xhr.open("GET",url,!0),xhr.responseType="json",xhr.send(),xhr.onreadystatechange=function(){var rsp;xhr.readyState===xhr.DONE&&200===xhr.status&&xhr.response?(rsp=xhr.response,"string"==typeof rsp&&(rsp=eval("("+rsp+")")),opt.study.SetDicomData(rsp,id,0),dlDicomNums++):xhr.readyState===xhr.DONE&&200!==xhr.status&&dlDicomNums++,dlDicomNums===imageCount&&RequestFirstDicomPage()}})}function RequestFirstDicomPage(){var arrPriority=[],arrDicom=GetDLDicom(!0),bSeries=opt.study.GetStudyType();bSeries="series"===bSeries,arrDicom instanceof Array&&bSeries&&$.each(arrDicom,function(){var{isRGB:dicom,url,id,uid,col,row,patid}=dicom=this,imageType=opt.imageType;url={url:url||opt.wadourl+"/GetBlock/"+id+"?blockIndex=0",id:id,uid:uid,imageType:imageType,bseries:!0,brgb:dicom,index:0,ratio:1,dcmWidth:col,dcmHeight:row,bsave:!0,patid:patid,dicomInfo:{isRGB:dicom}},arrPriority.push(url)}),mergeThread.postMessage({type:0,arrpriority:arrPriority,arrnormal:[]})}function StartDLJpg(){for(var arrImgs=opt.study.GetJpg(),i=0;i<arrImgs.length;i++){var imgInfo=arrImgs[i];imgInfo.image=new Image,imgInfo.image.crossOrigin="",imgInfo.image.src=opt.wadourl+"/GetImageData/"+imgInfo.id,$(imgInfo.image).bind("load",{img:imgInfo},function(event){event=event.data.img;event.bLoaded=!0,null!=opt.progress&&opt.progress(event,opt.study)})}}this.RequestVrtWsURl=function(){const{study,wadourl}=opt;var url=wadourl+"/getPath3d",xhr=new XMLHttpRequest;xhr.open("GET",url,!0),opt.token&&xhr.setRequestHeader("Authorization","bearer "+opt.token),xhr.responseType="json",xhr.onreadystatechange=function(){var{readyState,status,response}=xhr;4===readyState&&200===status&&response&&(readyState=response.data["path"],readyState)&&(study.vrtWsURl=readyState,CBoBo.isShow3D=!0,status=document.querySelector('div[title="3D"]'))&&(status.style.display="inline")},xhr.send()},this.StartStudyInfo=function(){const{serverRead,wadourl,studyuid,hospid,hasDesensitize,departCode,token,imageType,isKeyImage,isInternal,clientType,error}=opt;var url=wadourl+"/GetStudyInfo";CBoBo.Draw.SetIsFromServer(serverRead),CBoBo.Draw.SetWadoUrl(wadourl),$.ajax({headers:token?{Authorization:"bearer "+token}:{},url:url,type:"get",data:{hospId:hospid,StudyUID:studyuid,hasDesensitize:hasDesensitize,departCode:departCode,imageType:imageType,isDcm:imageType,isKeyImage:isKeyImage,isInternal:isInternal,clientType:clientType},complete:function(response){200==response.status&&response.responseJSON?RespontStudy(response.responseJSON):console.log(response)},error:function(jqXHR,textStatus,errorThrown){console.log(jqXHR,textStatus,errorThrown),error({msg:errorThrown||"影像加载失败，请稍后再试",studyuid:studyuid})}})},this.DLJsonBySeriesUid=function(){var dlSeries=0,arrSeries=opt.study.GetAllSeries();const{wadourl,hospid,departCode,imageType,study:{studyuid}}=opt,getMate=function(series){return new Promise(function(resolve){var uuid=series.uuid,url=wadourl+"/GetSeriesMeta?uuid="+uuid+"&studyuid="+studyuid+"&hospitalid="+hospid+"&hospid="+hospid+"&departCode="+departCode+"&imageType="+imageType,xhr=new XMLHttpRequest;xhr.open("GET",url,!0),opt.token&&xhr.setRequestHeader("Authorization","bearer "+opt.token),xhr.responseType="json",xhr.onreadystatechange=function(){const{readyState,status,response}=xhr;if(200!==status)resolve(),dlSeries++;else{if(3===readyState&&resolve(),4===readyState){dlSeries++;let rsp=response||{};if("string"==typeof rsp&&(rsp=eval("("+rsp+")")),rsp.success){const{imgs,compress}=rsp.data;opt.study.SetSeriesDicom(imgs,compress,rsp.data)}}dlSeries===arrSeries.length&&(opt.study.CorrectScout(),opt.study.bAllMetaDl=!0,function(){window.mergeThread?RequestDicom():setTimeout(arguments.callee,10)}())}},xhr.send()})};(new simple.PromiseQueue).init({arr:arrSeries,func:getMate})},RequestBinaryData=function(url){var promise=$.Deferred(),xhr=new XMLHttpRequest;return xhr.open("GET",url,!0),xhr.responseType="arraybuffer",xhr.send(),xhr.onreadystatechange=function(){if(xhr.readyState==xhr.DONE&&200==xhr.status&&xhr.response)return promise.resolve(xhr.response)},xhr.onerror=function(e){return promise.reject(e)},promise}}function DVStudy(){var m_arrSeries=[],m_Imgs=[],annotations=[],self=(this.studyuuid,this.studyuid,this.age,this.hasseries,this.hospname,this.imgcount,this.imgs,this.modality,this.name,this.orginaltype,this.patientid,this.seriescount,this.studydate,this.sex,this.studyid,this.totaltype,this.wadourl,this.hospid,this.token,this.imageType,this.hasDesensitize,this.isKeyImage,this.isInternal,this.departCode,this.m_Max=99999,this);this.bAllMetaDl=!1,this.URLSearchParams={},this.vrtWsURl=void 0;this.setURLSearchParams=function(params){for(const key in this.URLSearchParams=params)Object.hasOwnProperty.call(params,key)&&(this[key]=params[key])},this.SetSeriesDicom=function(arrImages,compress,data){arrImages instanceof Array&&arrImages.forEach(function(dicom){dicom.compress=compress,dicom.seruuid=data.seruid||data.uuid,function(image){image.id=image.id;for(var i=0;i<m_arrSeries.length;i++)for(var dvseries=m_arrSeries[i],j=0;j<dvseries.arrImage.length;j++){var dicom=dvseries.arrImage[j];dicom.id==image.id&&(CBoBo.Draw.GetIsFromServer()&&(dicom.bLoadImage=!0),dicom.SetInfo({data:image}))}}(dicom)})},this.RequestCache=function(start,end,seriesImages){var arrDl,arrSel;this.bAllMetaDl&&(arrDl=[],start=Math.max(start-9,0),end=Math.min(end+9,seriesImages.length),arrSel=seriesImages.slice(start,end),seriesImages.forEach(function(dicom){(function(array,value){var bFind;if(array instanceof Array)return bFind=!1,array.forEach(function(val){val===value&&(bFind=!0)}),bFind})(arrSel,dicom)?dicom.bLoadImage||arrDl.push(dicom):(dicom.bLoadImage=!1,dicom.bProgress=!1,delete dicom.pixsBuffer)}),this.SwitchSeriesImagesInMemory(arrDl))},this.RequestSeriesDicom=function(){var arrItems,arrDicom,index;this.bAllMetaDl&&(arrItems=[],arrDicom=function(){for(var arrDicom=[],arrSeries=self.GetAllSeries(),i=0;i<arrSeries.length;i++)for(var series=arrSeries[i],j=0;j<Math.min(series.arrImage.length,1);j++){var dicom=series.arrImage[j];arrDicom.push(dicom)}var bPageSwitch=self.IsPageSwitch(),bSeries=self.GetStudyType();if(bPageSwitch&&bSeries)for(i=0;i<arrSeries.length;i++)for(series=arrSeries[i],j=1;j<Math.min(series.arrImage.length,10);j++){dicom=series.arrImage[j];arrDicom.push(dicom)}else for(i=0;i<arrSeries.length;i++)for(series=arrSeries[i],j=1;j<series.arrImage.length;j++){dicom=series.arrImage[j];arrDicom.push(dicom)}return arrDicom}(),this.GetStudyType(),index=0,arrDicom instanceof Array&&$.each(arrDicom,function(i,dicom){!function(dicom){var{isRGB:dicom,url,id,uid,col,row,patid}=dicom,imageType=self.URLSearchParams["imageType"];url={url:url||self.wadourl+"/GetBlock/"+id+"?blockIndex=0",id:id,uid:uid,imageType:imageType,bseries:!0,brgb:dicom,index:0,ratio:1,dcmWidth:col,dcmHeight:row,bsave:index<=self.m_Max,patid:patid,dicomInfo:{isRGB:dicom}};arrItems.push(url)}(this)}),mergeThread.postMessage({type:1,arrpriority:[],arrnormal:arrItems}))},this.GetSwitchInMemoryDicoms=function(arrAnnStatus){if(arrAnnStatus instanceof Array){var firstImgs=[],arrFirstItems=(arrAnnStatus.forEach(function(annStatus){annStatus.images.forEach(function(dicom,index){0!==index||dicom.bLoadImage||firstImgs.push(dicom)})}),[]);const imageType=self.URLSearchParams["imageType"];$.each(firstImgs,function(i,dicom){var{isRGB:dicom,url,id,uid,col,row,patid}=dicom,url={url:url||self.wadourl+"/GetBlock/"+id+"?blockIndex=0",id:id,uid:uid,imageType:imageType,bseries:!0,brgb:dicom,index:0,ratio:1,dcmWidth:col,dcmHeight:row,bsave:!0,patid:patid,dicomInfo:{isRGB:dicom}};arrFirstItems.push(url)}),mergeThread.postMessage({type:1,arrpriority:arrFirstItems,arrnormal:[]})}},this.SwitchSeriesImagesInMemory=function(arrDicoms){var arrFirstItems=[];const imageType=this.URLSearchParams["imageType"];$.each(arrDicoms,function(i,dicom){var{isRGB:dicom,url,id,col,row,seruid,patid}=dicom,url={url:url||self.wadourl+"/GetBlock/"+id+"?blockIndex=0",id:id,uid:uid,imageType:imageType,bseries:!0,brgb:dicom,index:0,ratio:1,dcmWidth:col,dcmHeight:row,seriesuid:seruid,bsave:!0,patid:patid,dicomInfo:{isRGB:dicom}};arrFirstItems.push(url)}),mergeThread.postMessage({type:2,arrpriority:arrFirstItems,arrnormal:[]})},this.IsPageSwitch=function(){return this.imgcount>this.m_Max},this.CompletePercent=function(id){var dl,id=this.GetSeries(id);return void 0!==id?(dl=0,id=id.GetAllDicom(),$.each(id,function(){this.bProgress&&dl++}),10<=(id=dl/id.length*100)?parseInt(id):id.toFixed(1)):100},this.GetStudyType=function(){var type;return"JPG"==this.totaltype?type="jpg":"RAW"==this.totaltype&&(type="series"),type},this.UpdateSort=function(){function SortImgs(arrImgs,desp){if(!(null==arrImgs||arrImgs.length<1))for(var key,tmp,i=0;i<arrImgs.length;i++)key=("FFP"==desp||"FFS"==desp||"FFDR"==desp||"FFDL"==desp?function(a,i){for(var k=i,j=i+1;j<a.length;++j)parseInt(a[k].num)<parseInt(a[j].num)&&(k=j);return k}:SelectMinKey)(arrImgs,i),(key=SelectMinKey(arrImgs,i))!=i&&(tmp=arrImgs[i],arrImgs[i]=arrImgs[key],arrImgs[key]=tmp)}function SelectMinKey(a,i){for(var k=i,j=i+1;j<a.length;++j)parseInt(a[k].num)>parseInt(a[j].num)&&(k=j);return k}0<m_arrSeries.length&&($.each(m_arrSeries,function(i,ser){SortImgs(ser.arrImage,ser.desp)}),SortImgs(m_arrSeries)),0<m_Imgs.length&&SortImgs(m_Imgs)},this.CorrectScout=function(requestDLImageScoutLine=!0){result=[],$.each(m_arrSeries,function(i,ser){$.each(ser.arrImage,function(i,img){result[img.uid]=img.seruid})});var result,el,seriesUidMap=result;let hasScount=!1;$.each(m_arrSeries,function(i,ser){ser.arrImage[0].strScount&&(hasScount=!0),$.each(ser.arrImage,function(i,img){var scount,saveScount;scount=img.strScount,saveScount=img.scount,scount&&null!=(scount=scount.split("|"))&&$.each(scount,function(i,value){var value=value.split("^"),value={uid:value[0],index:parseInt(value[1]),ptStart:new Point(parseInt(value[2]),parseInt(value[3])),ptEnd:new Point(parseInt(value[4]),parseInt(value[5]))},seriesUid=seriesUidMap[value.uid];seriesUid&&("[object Array]"!=Object.prototype.toString.apply(saveScount[seriesUid])&&(saveScount[seriesUid]=[]),saveScount[seriesUid].push(value))}),function(scount){$.each(scount,function(key,value){value.sort(function(a,b){return a.index-b.index})})}(img.scount),img.strScount=null})}),hasScount?(el=document.querySelector('span[title="定位线"]').parentElement,CBoBo.isShowScout=!0,el&&(el.style.display="flex")):requestDLImageScoutLine&&self.DLImageScoutLine()},this.DLImageScoutLine=function(){var uuid=this.studyuuid,hospId=this.hospid,departCode=this.departCode,uuid=this.wadourl+"/GetImageScoutLine?uuid="+uuid+"&hospId="+hospId+"&departCode="+departCode;const xhr=new XMLHttpRequest;xhr.timeout=18e4,xhr.open("GET",uuid,!0),xhr.responseType="json",xhr.send(),xhr.onreadystatechange=function(){if(xhr.readyState===xhr.DONE&&200===xhr.status&&xhr.response){let{success,statusCode,data,result}=xhr.response;!success&&200!==statusCode||($.each(m_arrSeries,function(i,ser){$.each(ser.arrImage,function(i,img){img.strScount=(data||result)[img.uid]})}),self.CorrectScout(!1))}}},this.SetStudyInfo=function(data){var sex;function getDesensitize(params){var paramsLen;return params?(paramsLen=params.length,params.slice(0,2)+"*".repeat(paramsLen<5?2:paramsLen-4)+params.slice(paramsLen-2)):"*"}null!=data&&(this.studyuid=data.studyuid,this.studyuuid=data.studyuuid,this.age=data.age,this.hasseries=parseInt(data.hasseries),this.hospname=data.hospname||data.orgname,this.imgcount=parseInt(data.imgcount),this.imgs=data.imgs,this.modality=data.modality,null!=this.modality&&""!=this.modality&&(this.modality=this.modality.toUpperCase()),this.name=data.name,null!=this.name&&""!=this.name&&(this.name=this.name.replace(/\^/g,"")),this.orginaltype=data.orginaltype,this.patientid=data.patientid,this.seriescount=data.seriescount,this.studydate=data.studydate,sex=String(data.sex).trim(),{requestDesensitize:sex,hasDesensitize:data}=(this.sex="M"===sex?"男":"F"===sex?"女":sex,this.studyid=data.studyid,this.totaltype="RAW",null!=this.totaltype&&""!=this.totaltype&&(this.totaltype=this.totaltype.toUpperCase()),this.hasseries?this.PushArrSeries(data.serieses):this.PushArrImgs(data.imgs),window.globalStudyInfo=this,data),sex)&&1!==data&&(this.name=this.name.slice(0,1)+"**",this.orgname=getDesensitize(this.hospname),this.patientid=getDesensitize(this.patientid))},this.PushArrSeries=function(arrSeries){var self,arrImgs;null!=arrSeries&&("RAW"==(self=this).totaltype?$.each(arrSeries,function(i,series){const index=String(i);series.customSeriesId=index;var dvser=new DVSeries(self.studyuid,self.hospid,self.departCode,series);$.each(series.imgs,function(j,img){img.customSeriesId=index,dvser.PushImage(img,self.wadourl)}),m_arrSeries.push(dvser)}):(arrImgs=[],$.each(arrSeries,function(i,series){arrImgs.push(series.imgs)}),$.each(arrImgs,function(i,imgs){i=String(i);imgs.customSeriesId=i,self.PushArrImgs(imgs)})))},this.PushArrImgs=function(arrImgs){var self;null!=arrImgs&&(self=this,$.each(arrImgs,function(i,img){var imgInfo=new DVImageInfo;imgInfo.id=img.id,imgInfo.num=img.num,imgInfo.imageicon=self.wadourl+"/GetImageThumb/"+img.id+"?sign="+img.sign,dicominfo.url=img.url,dicominfo.customSeriesId=img.customSeriesId,m_Imgs.push(imgInfo)}))},this.SetDicomData=function(rsp,id,type){for(var i=0;i<m_arrSeries.length;i++)for(var dvseries=m_arrSeries[i],j=0;j<dvseries.arrImage.length;j++){var dicom=dvseries.arrImage[j];dicom.id==id&&(1==type?dicom.setPixsBuffer(rsp):0==type&&dicom.SetInfo(rsp))}},this.GetSpecifyImage=function(seruid,idx){if(!(idx<0))for(var ser,i=0;i<m_arrSeries.length;i++)if((ser=m_arrSeries[i]).seruid==seruid){if(idx<ser.arrImage.length)return ser.arrImage[idx];break}},this.GetAllSeries=function(){return m_arrSeries},this.GetAllDicom=function(){var arrImg=[];return $.each(m_arrSeries,function(i,ser){$.each(ser.arrImage,function(i,img){arrImg.push(img)})}),arrImg},this.GetJpg=function(id){if(null==id)return m_Imgs;for(var bFind=!1,i=0;i<m_Imgs.length;i++)if((img=m_Imgs[i]).id==id)return bFind=!0,img;return!bFind&&-1<id&&id<m_Imgs.length?m_Imgs[id]:void 0},this.GetNextDicom=function(seriesUid,sopuid,type){for(var i=0;i<m_arrSeries.length;i++)if((ser=m_arrSeries[i]).uid===seriesUid)for(var j=0;j<ser.arrImage.length;j++)if((img=ser.arrImage[j]).sopuid==sopuid){if(0<type){if(j<=0)return;index=j-1}else{if(j>=ser.arrImage.length-1)return;index=j+1}return ser.arrImage[index]}},this.GetSpecialDicom=function(seriesUid,index){for(var i=0;i<m_arrSeries.length;i++)if((ser=m_arrSeries[i]).uid==seriesUid&&index<ser.arrImage.length)return ser.arrImage[index]},this.GetDicomById=function(id,name){for(var i=0;i<m_arrSeries.length;i++){ser=m_arrSeries[i];for(var j=0;j<ser.arrImage.length;j++)if((img=ser.arrImage[j]).id===id)return img}},this.GetWaitLoadSeries=({index,seriesId,params})=>{var m_arrSeriesLength=m_arrSeries.length;let arr=[];if(0<=(index=isNaN(index)&&seriesId?m_arrSeries.findIndex(item=>item.customSeriesId==seriesId):index)&&index<m_arrSeriesLength){m_arrSeriesLength=m_arrSeries[index].arrImage.filter(item=>!item.bLoadImage);if(params)return arr=m_arrSeriesLength.map(item=>item[params]);arr=m_arrSeriesLength}return arr},this.GetSeries=function(id){for(var ret,i=0;i<m_arrSeries.length;i++){ser=m_arrSeries[i];for(var j=0;j<ser.arrImage.length;j++)(img=ser.arrImage[j]).id==id&&(ret=ser)}return ret=null==ret&&id<m_arrSeries.length&&-1<id?m_arrSeries[id]:ret},this.GetSeriesLengthById=function(imgId){for(var i=0;i<m_arrSeries.length;i++){ser=m_arrSeries[i];for(var j=0;j<ser.arrImage.length;j++)if((img=ser.arrImage[j]).id==imgId)return ser.arrImage.length}},this.GetDicomNums=function(){for(var ret=0,i=0;i<m_arrSeries.length;i++)ret+=(ser=m_arrSeries[i]).arrImage.length;return ret},this.SetAnnotations=function(aiAnnotations){annotations=aiAnnotations},this.GetAnnotations=function(){return annotations}}function DVSeries(studyuid,hospid,departCode,series){const{desp,num,uid,uuid,customSeriesId,sign}=series;this.studyuid=studyuid,this.hospid=hospid,this.departCode=departCode,this.desp=desp,this.customSeriesId=customSeriesId,this.num=num,this.uid=uid,this.uuid=uuid,this.arrImage=[],this.PushImage=function(img,wado){var dicominfo=new DVDicomInfo;dicominfo.id=img.id,dicominfo.num=img.num,dicominfo.imageInstanceUid=img.imageInstanceUid,dicominfo.imageicon=wado+"/GetImageThumb/"+img.id+"?seriesId="+uuid+"&studyuid="+studyuid+"&hospitalid="+hospid+"&hospid="+hospid+"&departCode="+departCode+"&sign="+sign,dicominfo.url=img.url,dicominfo.customSeriesId=img.customSeriesId,this.arrImage.push(dicominfo)},this.GetAllDicom=function(){return this.arrImage}}function getIsRGB(phme,bita){return phme?["RGB","YBR_FULL","YBR_FULL_422","YBR_RCT","YBR_ICT"].includes(phme):bita<=8}function DVDicomInfo(){this.bProgress=!1,this.minGray,this.maxGray,this.id,this.num,this.imageicon,this.uid,this.pixsBuffer,this.bLoadImage=!1,this.name,this.sex,this.age,this.birth,this.patid,this.mod,this.accnum,this.stuid,this.stuuid,this.studes,this.serid,this.seruid,this.serdes,this.imgnum,this.sopuid,this.studt,this.stutm,this.acqdt,this.acqtm,this.wc,this.ww,this.ma,this.kv,this.sliceth,this.manu,this.inst,this.frames,this.row,this.col,this.pixx,this.pixy,this.bita,this.bits,this.hbit,this.rescin,this.rescsl,this.pixrep,this.sappix,this.phme,this.orl,this.ort,this.orr,this.orb,this.scount={},this.strScount,this.blocks,this.isRGB,this.isIMGAnalysis2,this.imageType,this.pixz,this.imgpos,this.url,this.panPos,this.seruuid,this.SetInfo=function(rsp){var stutm,arr;rsp&&(rsp=rsp.data)&&(this.compress=rsp.compress,this.seruuid=rsp.seruuid,this.name=rsp.name.replace(/\^/g,""),this.sex=rsp.sex,this.age=rsp.age,this.birth=rsp.birth,this.patid=rsp.patid,this.mod=rsp.mod,this.accnum=rsp.accnum,this.stuid=rsp.stuid,this.stuuid=rsp.stuuid,this.studes=rsp.studes,this.serid=parseInt(rsp.serid).toString(),this.seruid=rsp.seruid,this.serdes=rsp.serdes,this.imgnum=rsp.imgnum,this.sopuid=rsp.sopuid,this.uid=rsp.uid,this.blocks=parseInt(rsp.blocks),rsp.url&&(this.url=rsp.url),"string"!=typeof(stutm=rsp.stutm)||stutm.match(":")?this.stutm=stutm:this.stutm=[stutm.substring(0,2),stutm.substring(2,4),stutm.substring(4)].join(":"),"string"!=typeof(stutm=rsp.studt)||stutm.match("-")?this.studt=rsp.studt:this.studt=[stutm.substring(0,4),stutm.substring(4,6),stutm.substring(6)].join("-"),this.acqdt=rsp.acqdt,this.acqtm=rsp.acqtm,this.acqtm&&parseFloat(rsp.acqtm).toFixed(3),this.wc=parseInt(rsp.wc),this.ww=parseInt(rsp.ww),this.ma=rsp.ma,this.kv=rsp.kv,this.sliceth=rsp.sliceth,this.manu=rsp.manu,this.inst=rsp.inst,this.row=parseInt(rsp.row),this.col=parseInt(rsp.col),this.pixx=rsp.pixx,this.pixy=rsp.pixy,"string"==typeof this.pixx&&"string"==typeof this.pixy&&(-1!=rsp.pixx.indexOf(" ")&&2==(arr=rsp.pixx.split(" ")).length&&(this.pixx=parseFloat(arr[0]),this.pixy=parseFloat(arr[1])),this.pixx=parseFloat(this.pixx),this.pixy=parseFloat(this.pixy)),this.bita=parseInt(rsp.bita),this.bits=rsp.bits,this.hbit=rsp.hbit,this.rescin=parseInt(rsp.rescin),this.rescsl=parseFloat(rsp.rescsl),""!==rsp.rescin&&null!==rsp.rescin&&!isNaN(this.rescin)||(this.rescin=0),(""===rsp.rescsl||null===rsp.rescsl||isNaN(this.rescsl)||rsp.rescsl<1)&&(this.rescsl=1),this.pixrep=parseInt(rsp.pixrep),this.sappix=parseInt(rsp.sappix),this.phme=rsp.phme,this.panPos=rsp.panPos,this.orl=rsp.orl,this.ort=rsp.ort,this.orr=rsp.orr,this.orb=rsp.orb,this.strScount=rsp.scount,this.imgpos=rsp.imgpos,3==(arr=rsp.imgpos?rsp.imgpos.split("|"):[]).length&&(this.pixz=parseFloat(arr[2])),this.isRGB=getIsRGB(this.phme,this.bita))},this.setData=function(prams){if("object"!=typeof prams)throw new Error("prams is not object");for(const key in prams)this[key]=prams[key]},this.setPixsBuffer=function(buffer){void 0!==buffer&&(this.pixsBuffer=buffer,this.bLoadImage=!0,GetMaxMinGray.call(this))},this.getWwWc=function(){var{maxGray,minGray,rescin:intercept,rescsl:slope}=this,maxGray=maxGray*slope+intercept,minGray=minGray*slope+intercept;this.ww=parseInt(maxGray-minGray),this.wc=parseInt((maxGray+minGray)/2)},this.GetData=function(){return this.pixsBuffer};var GetMaxMinGray=function(){"use strict";for(var pix,min=1e6,max=-1e6,i=0;i<this.pixsBuffer.length;i++)max<(pix=this.pixsBuffer[i])&&(max=pix),pix<min&&(min=pix);this.minGray=min,this.maxGray=max}}function DVImageInfo(){this.id,this.num,this.imageicon,this.image,this.bLoaded}function Point(a,b){a instanceof Object&&1==arguments.length?(this.x=a.x,this.y=a.y):(this.x=a,this.y=b)}function Rect(left,top,right,bottom){this.left=left||0,this.top=top||0,this.right=right||0,this.bottom=bottom||0}"undefined"==typeof CBoBo&&(CBoBo={}),CBoBo.PTYPE_JPG=0,CBoBo.PTYPE_SERIES=1,CBoBo.PTYPE_DESERIES=2,CBoBo.TOOL_NULL=0,CBoBo.TOOL_WC=1,CBoBo.TOOL_MOVE=2,CBoBo.TOOL_ZOOM=3,CBoBo.TOOL_PAGE=4,CBoBo.TOOL_M_POINT=5,CBoBo.TOOL_M_LINE=6,CBoBo.TOOL_M_RECT=7,CBoBo.TOOL_M_ELLIPSE=8,CBoBo.TOOL_M_CURVE=9,CBoBo.TOOL_M_ANGLE=10,CBoBo.TOOL_LABEL=11,CBoBo.TOOL_MAG=12,CBoBo.TOOL_POLYGON=13,CBoBo.TOOL_ARROW=14,CBoBo.TOOL_LEFT=15,CBoBo.TOOL_RIGHT=16,CBoBo.TOOL_HEARDRATIO=17,CBoBo.DRAW_IMG=0,CBoBo.DRAW_ANN=1,CBoBo.MPR_ORIGINAL=0,CBoBo.MPR_LEVEL=1,CBoBo.MPR_VERTICAl=2,CBoBo.MPR_ANY=3,CBoBo.TOOLMENU_JPG=0,CBoBo.TOOLMENU_SERIES=1,CBoBo.TOOLMENU_DESERIES=2,CBoBo.TOOLMENU_PRINT_JPG=3,CBoBo.TOOLMENU_PRINT_RADIATE=4,CBoBo.TOOLMENU_MPR=5,CBoBo.TOOLMENU_AI=6,CBoBo.TOOLMENU_VRT=7,CBoBo.MSG_ALERT=0,CBoBo.MSG_SUCCESS=1,CBoBo.MSG_ERROR=2,CBoBo.SMOOTHING_ENABLED=!1,CBoBo.Scrollsize=20,CBoBo.IsMobile=!1,CBoBo.IsTablet=!1,CBoBo.isShowAi=!1,CBoBo.rootDom=null,CBoBo.store={db:{dbName:"DicomView",version:"1",storeName:"DicomStore",_enableImagesDB:localStorage.getItem("enableImagesDB")||!0,get enableImagesDB(){var res=this._enableImagesDB;return void 0===res?res:!!JSON.parse(res)},set enableImagesDB(params){params=params?1:0;this._enableImagesDB=params,localStorage.setItem("enableImagesDB",params)}},loadQueue:{waitSeriesID:new Map}},CBoBo.Manager=function(rootDom){"use strict";var self=this;this.isAIRequestFinished=!1,this.isAIFinished=!1;this.onTool={bShowScountLine:!1,stack:[]},this.handles={},this.privilege={bPrint:void 0,bMupStudy:!1},this.onCanvas={bLMouse:!1,bRMouse:!1,ptStart:{x:0,y:0},ptLast:{x:0,y:0},imgStatus:[],Ann:null,bEditAnn:!1,EditAnnData:null,curCanvas:null,ptLable:null,stampStart:null,bTouchMul:!1,lastScale:1},this.onObserver=function(eventType,handle){if(this.handles.hasOwnProperty(eventType)||(this.handles[eventType]=[]),"function"!=typeof handle)throw new Error("缺少回调函数");return this.handles[eventType].push(handle),this},this.onEmit=function(eventType,args){if(this.handles.hasOwnProperty(eventType))return this.handles[eventType].forEach((item,key,arr)=>{item.apply(null,args)}),this;throw new Error(`"${eventType}"事件未注册`)},this.onOff=function(eventType,handle){if(!this.handles.hasOwnProperty(eventType))throw new Error(`"${eventType}"事件未注册`);if("function"!=typeof handle)throw new Error("缺少回调函数");return this.handles[eventType].forEach((item,key,arr)=>{item==handle&&arr.splice(key,1)}),this},this.onThumb={bSeriesTile:!1},this.canvasManager,this.logo,this.dataManager,this.thumbManager,this.frame,this.annStatusManager,this.layoutCtrl,this.rotateCtrl,this.wwCtrl,this.lableCtrl,this.pseudocolorCtrl,this.mode,this.canvasCtxMenu,this.thumbCtxMenu,this.seriesPlayer,this.Mpr,this.VRT,this.printer,this.toolBar,this.configView,this.assistDiagnose,this.canvasMax,this.isKeyBoard=!1,this.rootDom=rootDom,this.GlobalInit=function(){$("body,a,img,span").bind("drop",function(ev){ev.preventDefault(),ev.stopPropagation()}),$("body").bind("touchmove",function(event){event.preventDefault()}),document.oncontextmenu=function(event){return event.cancelBubble=!0,event.returnValue=!1},document.onmousedown=function(event){if(window.Event){if(2==event.which||3==event.which)return!1}else if(2==event.button||3==event.button)return event.cancelBubble=!0,event.returnValue=!1},document.onkeydown=function(event){event=event||window.event||arguments.callee.caller.arguments[0];event&&self.KeyboardMsg(event)};var enableImagesDB=(window.screen&&window.resizeTo(screen.availWidth,screen.availHeight),CBoBo.store.db)["enableImagesDB"];void 0===enableImagesDB&&self.toggleImageBDHandle(confirm("是否开启图像缓存功能"))},this.KeyboardMsg=function(event){if(!self.isKeyBoard){var arrPrintImgs,{shiftKey,ctrlKey,keyCode}=event;switch(keyCode){case 80:self.privilege.bPrint&&(self.printer||(self.printer=new CBoBo.View.DVPrint({msgtransform:self.PrintView.MsgTransform,mode:self.mode})),self.onTool.MsgTransform({usermsg:"sdaf",btntitle:"胶片打印",btnforce:!0}),self.printer&&(arrPrintImgs=[],self.printer.bShow||self.printer.Show(!0),self.mode==CBoBo.PTYPE_SERIES&&ctrlKey?(arrAnnStatus=self.canvasManager.GetFocusMng().AnnStatusMng().GetAnnStatus(),$.each(arrAnnStatus,function(i,annStatus){arrPrintImgs.push(self.annStatusManager.GetCopyAnnStatus(annStatus))})):(arrAnnStatus=self.canvasManager.GetFocusCanvas().AnnStatus())&&(arrAnnStatus=self.annStatusManager.GetCopyAnnStatus(arrAnnStatus),arrPrintImgs.push(arrAnnStatus)),0<arrPrintImgs.length)&&self.printer.RequestPrint(arrPrintImgs),event.preventDefault());break;case 8:break;case 27:self.canvasMax&&self.canvasMax.bShow&&self.onCanvas.DbClick();break;case 9:case 112:case 117:case 121:case 122:case 114:case 115:case 118:event.preventDefault();case 46:if(shiftKey){var{dbName:arrAnnStatus,storeName,version}=CBoBo.store.db;const db=new simple.IndexedDB(arrAnnStatus,storeName,version);db.open().then(function(){db.dispatch("clear").then(function(){alert("图像缓存清除成功")})})}break;case 37:self.canvasMax&&self.canvasMax.bShow?self.canvasMax.secondCtrl.scroll&&self.canvasMax.secondCtrl.scroll.TriggerClick(1):self.canvasManager.scroll&&self.canvasManager.scroll.TriggerClick(1);break;case 38:this.onCanvas.NextPage(1);break;case 39:self.canvasMax&&self.canvasMax.bShow?self.canvasMax.secondCtrl.scroll&&self.canvasMax.secondCtrl.scroll.TriggerClick(-1):self.canvasManager.scroll&&self.canvasManager.scroll.TriggerClick(-1);break;case 40:this.onCanvas.NextPage(-1);break;case 83:ctrlKey&&event.preventDefault();break;case 82:ctrlKey?(self.onTool.ReLoadDicom(),event.preventDefault()):self.onTool.RestoreDicom();break;case 70:self.onTool.Negative();break;case 48:self.onTool.Pseudocolor("");break;case 49:self.onTool.Pseudocolor("彩虹");break;case 50:self.onTool.Pseudocolor("黑体");break;case 51:self.onTool.Pseudocolor("骨骼");break;case 52:self.onTool.Pseudocolor("心脏");break;case 53:self.onTool.Pseudocolor("流动");break;case 54:self.onTool.Pseudocolor("Ge色");break;case 55:self.onTool.Pseudocolor("彩虹1");break;case 56:self.onTool.Pseudocolor("红色血管");break;case 57:self.onTool.Pseudocolor("斯特恩")}}},this.DL={arrSpeed:{}},this.DL.OpenStudy=function(){var token,imageType,departCode,hasDesensitize,isKeyImage,isInternal,clientType,studyuidArr,studyuid,wado,hospid;void 0===self.dataManager&&(self.dataManager=new CBoBo.DataManager({render:self.DL.DLFirstProgress,manager:self})),0===arguments.length?(studyuid=CBoBo.Plugin.GetUrlParam("Studyuid")||$("#Studyuid").val()||$("#hdstuuid").val(),wado=CBoBo.Plugin.GetUrlParam("WadoURL")||$("#WadoURL").val()||$("#hdurl").val(),hospid=CBoBo.Plugin.GetUrlParam("Hospid")||$("#Hospid").val()||$("#hdhospid").val(),token=CBoBo.Plugin.GetUrlParam("token")||$("#token").val(),imageType=1==(CBoBo.Plugin.GetUrlParam("imageType")||$("#imageType").val())?1:0,departCode=CBoBo.Plugin.GetUrlParam("departCode")||$("#departCode").val()||0,hasDesensitize=CBoBo.Plugin.GetUrlParam("isDesens")||CBoBo.Plugin.GetUrlParam("hasDesensitize")||CBoBo.Plugin.GetUrlParam("hdsensitivity")||$("#isDesens").val()||$("#hasDesensitize").val()||$("#hdsensitivity").val(),isKeyImage=CBoBo.Plugin.GetUrlParam("isKeyImage")||$("#isKeyImage").val(),isInternal=CBoBo.Plugin.GetUrlParam("isInternal")||$("#isInternal").val(),clientType=CBoBo.Plugin.GetUrlParam("clientType")||$("#clientType").val()||0,""===studyuid?new CBoBo.Plugin.Error("Study not Found.","Studyuid is null."):""===wado?new CBoBo.Plugin.Error("Study not Found.","Wadourl is null."):""===hospid?new CBoBo.Plugin.Error("Study not Found.","Hospitaluid is null."):1<(studyuidArr=studyuid?studyuid.split(","):[]).length?self.dataManager.Request({wadourl:wado,hospid:hospid,studyuid:studyuidArr[0],token:token,imageType:imageType,departCode:departCode,hasDesensitize:JSON.parse(hasDesensitize||0)?1:0,isKeyImage:isKeyImage,isInternal:isInternal,clientType:clientType,serverRead:!1,progress:self.DL.DLFirstProgress,error:function(data){var time;data.bdicomdata?($.Msg(data.studyuid+":"+data.msg,CBoBo.MSG_ERROR),time=CBoBo.Plugin.GetTime(),console.log(time+"："+data.msg)):new CBoBo.Plugin.Error(data.msg)},success:function(study){self.Init();var thumb=self.thumbManager.GetThumb(study.studyuid);(thumb=void 0===thumb?self.thumbManager.AddThumb(study.studyuid):thumb).First(),self.DL.StudySuccess(study),self.DL.RequestHistoryStudy(studyuidArr,wado,hospid,!1)}}):self.dataManager.Request({wadourl:wado,hospid:hospid,studyuid:studyuid,token:token,imageType:imageType,departCode:departCode,hasDesensitize:JSON.parse(hasDesensitize||0)?1:0,isKeyImage:isKeyImage,isInternal:isInternal,clientType:clientType,serverRead:!1,progress:self.DL.DLFirstProgress,error:function(data){var time;data.bdicomdata?($.Msg(data.studyuid+":"+data.msg,CBoBo.MSG_ERROR),time=CBoBo.Plugin.GetTime(),console.log(time+"："+data.msg)):new CBoBo.Plugin.Error(data.msg)},success:function(study){self.Init();var thumb=self.thumbManager.GetThumb(study.studyuid);(thumb=void 0===thumb?self.thumbManager.AddThumb(study.studyuid):thumb).First(),self.DL.StudySuccess(study)}})):3==arguments.length&&(studyuid=arguments[2],wado=arguments[0],hospid=arguments[1],alert("dsad"),self.dataManager.Request({wadourl:wado,hospid:hospid,studyuid:studyuid,error:function(data){var time;data.bdicomdata?($.Msg(data.studyuid+":"+data.msg,CBoBo.MSG_ERROR),time=CBoBo.Plugin.GetTime(),console.log(time+"："+data.msg)):new CBoBo.Plugin.Error(data.msg)},success:function(study){self.privilege.bMupStudy=!1,self.Init();var thumb=self.thumbManager.GetThumb(study.studyuid);(thumb=void 0===thumb?self.thumbManager.AddThumb(study.studyuid):thumb).First(),self.DL.StudySuccess(study)}}))},this.DL.RequestHistoryStudy=function(historyStudyList,wado,hospid,serverRead){self.privilege.bMupStudy=!1,historyStudyList.splice(0,1),0<historyStudyList.length?historyStudyList.forEach(function(item,index){self.dataManager.Request({wadourl:wado,hospid:hospid,studyuid:item,serverRead:!1,progress:self.DL.DLFirstProgress,history:!0,error:function(data){var time;data.bdicomdata?($.Msg(data.studyuid+":"+data.msg,CBoBo.MSG_ERROR),time=CBoBo.Plugin.GetTime(),console.log(time+"："+data.msg)):new CBoBo.Plugin.Error(data.msg)},success:function(study){self.DL.StudySuccess(study);var thumb=self.thumbManager.GetThumb(study.studyuid);void 0===thumb&&self.thumbManager.AddThumb(study.studyuid)}})}):console.log("未检测到历史检查。")},this.DL.StudySuccess=function(study){var thumb=self.thumbManager.GetThumb(study.studyuid);null==thumb&&(thumb=self.thumbManager.AddThumb(study.studyuid)),self.DL.SetThumbHead(study,thumb),self.DL.SetThumbSeries(study,thumb)},this.DL.DLFirstProgress=function(image,study,progressValue,isMainStudy){image.col=null==image.col?512:image.col,image.row=null==image.row?512:image.row,self.UpdateCanvas(image),self.DL.DLProgress(image,study,progressValue)},this.DL.DLProgress=function(image,study,progressValue){var studyuid=study.studyuid,thumb=self.thumbManager.GetThumb(studyuid),studyuid=(void 0===self.DL.arrSpeed[studyuid]&&(self.DL.arrSpeed[studyuid]={dlnums:0,dlspeed:0,total:parseInt(study.imgcount),timer:null}),self.DL.arrSpeed[studyuid]);studyuid.dlnums++,studyuid.dlnums===studyuid.total&&($.Status("检查下载完毕!"),clearInterval(studyuid.timer)),self.DL.ProcessMode({study:study,seriespro:function(){thumb.SetProgress(image.seruid,progressValue)},deseriespro:function(){thumb.SetProgress(image.id,progressValue)},jpgpro:function(){thumb.SetProgress(image.id,100)}})},this.DL.SetThumbHead=function(study,thumb){if(void 0===thumb)throw"SetThumbHead:parameter study cannot be undefined";if(void 0===study)throw"SetThumbHead:parameter thumb cannot be undefined";""===study.sex&&(name=study.name+" / "+study.age),name=""===study.age||null===study.age?study.name+" / "+study.sex:("string"==typeof study.age&&0==parseInt(study.age.substring(0,1))&&(study.age=study.age.substring(1)),study.name+" / "+study.sex+" / "+study.age);var name,mode=study.modality,study=study.studydate;thumb.SetHeadInfo(name,mode,study)},this.DL.SetThumbSeries=function(study,thumb){self.DL.ProcessMode({study:study,seriespro:function(){for(var arrSeries=study.GetAllSeries(),i=0;i<arrSeries.length;i++){var dvimg,str,ser=arrSeries[i];thumb.PushSerisesItem(ser.uid),0<ser.arrImage.length&&(dvimg=arrSeries[i].arrImage[0],str="["+(i+1)+"] 共"+ser.arrImage.length+"图",thumb.SetItemInfo(ser.uid,str,"序列："+ser.num),thumb.SetItemIcon(ser.uid,dvimg.imageicon,dvimg.id,ser)),thumb.SetProgress(ser.uid,0)}},deseriespro:function(){for(var arrImg=study.GetAllDicom(),i=0;i<arrImg.length;i++){var img=arrImg[i],imgMark=img.id,str=(thumb.PushSerisesItem(imgMark),"["+(i+1)+"] 共1图");thumb.SetItemInfo(imgMark,str,img.num),thumb.SetItemIcon(imgMark,img.imageicon,img.id),thumb.SetProgress(imgMark,0)}},jpgpro:function(){var arrImgs=study.GetJpg();$.each(arrImgs,function(i,img){var imgMark=img.id,str=(thumb.PushSerisesItem(imgMark),"["+(i+1)+"] 共 1 张图");thumb.SetItemInfo(i,str,"编号："+img.num),thumb.SetItemIcon(i,img.imageicon,img.id),thumb.SetProgress(imgMark,0)})}}),thumb.UpdateStyle(),thumb.UpdateSeriesData()},this.DL.ProcessMode=function(options){if(void 0!==options){var opt=$.extend(!0,{study:null,seriespro:null,deseriespro:null,jpgpro:null},options);switch(opt.study.GetStudyType()){case"jpg":opt.jpgpro instanceof Function&&opt.jpgpro();break;case"series":opt.seriespro instanceof Function&&opt.seriespro();break;case"deseries":opt.deseriespro instanceof Function&&opt.deseriespro()}}},this.UpdateCanvas=function(dicominfo){var currentMng,annStatus,images,scrollValue,layout;self.canvasMax&&self.canvasMax.bShow?(currentMng=self.canvasMax.secondCtrl.GetMng()[0],(annStatus=currentMng.AnnStatusMng())&&(scrollValue=currentMng.scroll?currentMng.scroll.draggerPos:1,(void 0===(layout=currentMng.GetLayout())||layout.row<1||layout.col<1)&&(layout={row:1,col:1}),images=self.GetSelArray(annStatus.images,scrollValue,layout.row,layout.col),self.DrawAnnStatusForMng(annStatus,currentMng,!0),scrollValue=currentMng.GetAllCanvas(),$.each(scrollValue,function(index,dvCanvas){index<images.length&&(index=images[index]).id===dicominfo.id&&index.bLoadImage&&(dvCanvas.bAnimatStop||dvCanvas.StopLoadingAnimation(),annStatus.viewport.image=index,1===annStatus.viewport.scale?(CBoBo.ImageProcessor.Restore(annStatus.viewport),CBoBo.Draw.FitServerCanvas(annStatus.viewport,dvCanvas.canvas)):CBoBo.Draw.FitServerCanvas(annStatus.viewport,dvCanvas.canvas,!0),dvCanvas.DrawCornerInfo(annStatus.viewport))}))):(layout=self.canvasManager.GetMng(),$.each(layout,function(){var layout,images,scrollValue,annStatus=this.AnnStatusMng();annStatus&&(scrollValue=this.scroll?this.scroll.draggerPos:1,(void 0===(layout=this.GetLayout())||layout.row<1||layout.col<1)&&(layout={row:1,col:1}),images=self.GetSelArray(annStatus.images,scrollValue,layout.row,layout.col),scrollValue=this.GetAllCanvas(),$.each(scrollValue,function(index,dvCanvas){index<images.length&&(index=images[index]).id===dicominfo.id&&index.bLoadImage&&(dvCanvas.bAnimatStop||dvCanvas.StopLoadingAnimation(),annStatus.viewport.image=index,1===annStatus.viewport.scale?(CBoBo.ImageProcessor.Restore(annStatus.viewport),CBoBo.Draw.FitServerCanvas(annStatus.viewport,dvCanvas.canvas)):CBoBo.Draw.FitServerCanvas(annStatus.viewport,dvCanvas.canvas,!0),dvCanvas.DrawCornerInfo(annStatus.viewport))}))}))},this.InitMulStudyMode=function(){self.privilege.bMupStudy||self.mode==CBoBo.PTYPE_SERIES?self.privilege.bMupStudy=!0:(void 0!==this.canvasManager&&(this.canvasManager.Destroy(),delete this.canvasManager),void 0!==this.annStatusManager&&delete this.annStatusManager,self.privilege.bMupStudy=!0,this.Init())},this.Init=function(){void 0===self.frame&&(self.frame=new CBoBo.View.Frame(this.rootDom)),void 0===self.thumbManager&&(self.thumbManager=new CBoBo.View.ThumbManager({parent:"#"+self.frame.GetId("thumb"),msgtransform:self.onThumb.MsgTransform}));var toolType,msg,study=self.dataManager.GetStudy(0),studyType=study.GetStudyType();switch(self.InitAnnStatusStack(),studyType){case"jpg":toolType=CBoBo.TOOLMENU_JPG,msg=self.onTool.Jpg.MsgTransform;break;case"deseries":toolType=CBoBo.TOOLMENU_DESERIES,msg=self.onTool.MsgTransform;break;case"series":toolType=CBoBo.TOOLMENU_SERIES,msg=self.onTool.MsgTransform}var col,srow=1,scol=1,arrAnnStatus=(CBoBo.IsMobile&&0==CBoBo.IsTablet?(self.frame.HideToolBar(),InitCanvasManager(),void 0===self.toolBar&&(self.toolBar=new CBoBo.View.MobileMenuBall({msgtransform:msg})),self.toolBar.RequestToolBall(toolType,msg),self.toolBar.toolType="ww"):(self.WindowResize(),InitCanvasManager(CBoBo.IsTablet),void 0===self.toolBar&&(self.logo=new CBoBo.View.Logo("#"+self.frame.GetId("logo")).SetFont("影像源").SetLogo(""),self.toolBar=new CBoBo.View.PCToolBar({parent:"#"+self.frame.GetId("toolbar"),msgtransform:self.onTool.Main.MsgTransform})),self.toolBar.RequestGrayToolBar(toolType,msg),self.toolBar.toolType="zoom",self.toolBar.modalityType=study.modality,self.toolBar.ChangeBtnStatus("放缩",!0),self.toolBar.ChangeBtnStatus("显/隐四角信息",!0),self.toolBar.ChangeBtnStatus("本地缓存",CBoBo.store.db.enableImagesDB),{row:study,col}=JSON.parse(localStorage.getItem("seriesLayoutCount"))||{},scol=study&&col?(srow=study,col):"series"===studyType?(srow=2,3):srow=1),CBoBo.AnnStatusManager.Get()),study=(self.canvasManager.UpdateLayout(arrAnnStatus.length,srow,scol),self.canvasManager.GetMng());function InitCanvasManager(){var canvasboxid="#"+self.frame.GetId("canvasbox");self.canvasManager=new CBoBo.View.CMngSecondLayer({parent:canvasboxid,msgtransform:self.MsgTransform,scrollsize:CBoBo.Scrollsize})}void 0!==study&&$.each(study,function(i,mng){i<arrAnnStatus.length&&mng.UpdateLayout(arrAnnStatus[i].images.length,1,1)}),self.canvasManager.SetDefaultFocus(0,0),self.onTool.ReLoadDicom(),self.privilege.bPrint=!0,self.toolBar.EnableButton&&self.toolBar.EnableButton("胶片打印",!0)},this.WindowResize=function(){window.onresize=function(event){self.frame.UpdateStyle(),self.logo&&self.logo.SetStyle(),self.toolBar&&self.toolBar.UpdateStyle&&self.toolBar.UpdateStyle(),self.layoutCtrl&&self.layoutCtrl.UpdateStyle(),self.rotateCtrl&&self.rotateCtrl.UpdateStyle(),self.lableCtrl&&self.lableCtrl,self.pseudocolorCtrl&&self.pseudocolorCtrl.UpdateStyle(),self.thumbManager&&self.thumbManager.ForEach(function(thumb){thumb.UpdateStyle()}),self.canvasCtxMenu&&self.canvasCtxMenu.UpdateStyle(),self.Mpr&&(self.Mpr.UpdateStyle(),self.Mpr.mng.TriggerResize()),self.VRT&&(self.VRT.UpdateStyle(),self.VRT.mng.TriggerResize()),self.configView&&self.configView.TriggerResize(),self.canvasMax&&(self.canvasMax.UpdateStyle(),self.canvasMax.secondCtrl.TriggerResize()),self.canvasManager&&self.canvasManager.TriggerResize(event)}},this.InitAnnStatusStack=function(){var study=self.dataManager.GetStudy(0);if(void 0!==study){var type=study.GetStudyType();switch(CBoBo.AnnStatusManager.Clear(),type){case"jpg":var arrImgs=study.GetJpg();self.annStatusManager.NewAnnStatusArray(study.studyuid,arrImgs,type);break;case"deseries":(arrImgs=study.GetAllDicom())instanceof Array&&0<arrImgs.length&&$.each(arrImgs,function(){var annStatus=CBoBo.AnnStatusManager.Create(this,study.studyuid,type);CBoBo.ImageProcessor.Restore(annStatus.viewport)});break;case"series":$.each(study.GetAllSeries(),function(i,series){series=series.GetAllDicom(),series=CBoBo.AnnStatusManager.Create(series,study.studyuid,type);CBoBo.ImageProcessor.Restore(series.viewport)})}}},this.DrawAnnStatus=function(annStatus,dvCanvas,bFit,selStart,selNums,imgId=0){var images,start,end,arrCanvas=[],study=(dvCanvas instanceof Array?$.each(dvCanvas,function(){arrCanvas.push(this)}):arrCanvas.push(dvCanvas),images=void 0!==selStart&&void 0!==selNums?(start=Math.min(selStart,annStatus.images.length-1),end=Math.min(start+selNums,annStatus.images.length),annStatus.images.slice(start,end)):(start=0,end=arrCanvas.length,annStatus.images),self.dataManager.GetStudy(imgId));$.each(arrCanvas,function(i,dvCanvas){if(i<images.length){var imageInstanceUid,status,i=images[i];if(i.bLoadImage){if(self.canvasAIMax&&self.canvasAIMax.bShow){var serverAnns=study.GetAnnotations();if(!1===self.isAIFinished||!serverAnns.length)return dvCanvas.canvas.width=dvCanvas.canvas.width,dvCanvas.DrawCornerInfo(),void(dvCanvas.bAnimatStop&&dvCanvas.StartLoadingAnimation())}dvCanvas.bAnimatStop||dvCanvas.StopLoadingAnimation(),annStatus.viewport.image=i,(1===annStatus.viewport.scale&&0===annStatus.viewport.wc&&0===annStatus.viewport.ww||0===annStatus.viewport.wc&&0===annStatus.viewport.ww)&&(CBoBo.ImageProcessor.Restore(annStatus.viewport),CBoBo.Draw.FitServerCanvas(annStatus.viewport,dvCanvas.canvas,!1,!0)),annStatus.viewport.customWWWC||(annStatus.viewport.wc=parseInt(annStatus.viewport.image.wc),annStatus.viewport.ww=parseInt(annStatus.viewport.image.ww)),bFit?CBoBo.Draw.FitServerCanvas(annStatus.viewport,dvCanvas.canvas):CBoBo.Draw.DrawImage(annStatus.viewport,dvCanvas.canvas),self.toolBar&&self.toolBar.bShowCornerInfo?dvCanvas.DrawCornerInfo(annStatus.viewport):dvCanvas.DrawCornerInfo(),self.canvasAIMax&&self.canvasAIMax.bShow?(imageInstanceUid=i.imageInstanceUid,annStatus.anns[imageInstanceUid]instanceof Array||(annStatus.anns[imageInstanceUid]=[]),status=annStatus.viewport,$.each(serverAnns,function(index,serverAnn){var anns;serverAnn.imageInstanceUid!=imageInstanceUid||(anns=annStatus.anns[imageInstanceUid]).length||(serverAnn=serverAnn.annotation,$.each(serverAnn,function(index,ann){var startPoint=ann.points[0],ann=ann.points[1],startPoint=CBoBo.Annotation.NewAIAnnotation(status,dvCanvas.canvas,"rect",startPoint,ann);anns.push(startPoint)})),self.canvasAIMax.secondCtrl.SetDefaultFocus(0,0)}),annStatus.anns[imageInstanceUid]instanceof Array||(annStatus.anns[imageInstanceUid]=[]),CBoBo.Annotation.DrawAnnotation(annStatus.viewport,dvCanvas.canvas,annStatus.anns[imageInstanceUid])):(annStatus.anns[i.id]instanceof Array||(annStatus.anns[i.id]=[]),CBoBo.Annotation.DrawAnnotation(annStatus.viewport,dvCanvas.canvas,annStatus.anns[i.id]))}else if(dvCanvas.StartLoadingAnimation(),0==start){const canvas=dvCanvas.canvas;simple.canvasDrawImage(canvas,i.imageicon,{interceptors:()=>(dvCanvas.StopLoadingAnimation(),Promise.resolve(1===canvas.parentElement.childElementCount))}).catch(()=>{})}}else dvCanvas.canvas.width=dvCanvas.canvas.width,dvCanvas.DrawCornerInfo()})},this.DrawAnnStatusForMng=function(annStatus,mng,bFit,customWWWC){var scrollValue=mng.scroll?mng.scroll.draggerPos:1,layout=mng.GetLayout(),customWWWC=((void 0===layout||layout.row<1||layout.col<1)&&(layout={row:1,col:1}),annStatus.viewport.customWWWC=customWWWC,layout.row*layout.col),layout=(scrollValue-1)*customWWWC,scrollValue=mng.GetAllCanvas();self.DrawAnnStatus(annStatus,scrollValue,bFit,layout,customWWWC)},this.GetSelArray=function(array,index,row,col){if(null!=array&&null!=index&&null!=row&&null!=col)return(row=(index-1)*(index=row*col))>array.length-1||row<0?[]:(col=array.length-row,array.slice(row,(col<index?col:index)+row))},this.ChangeToolBar=function(event){var toolType,msg,annStatus=event.mng.AnnStatusMng();if(annStatus&&!annStatus.bPrint){switch(annStatus.type){case"series":toolType=CBoBo.TOOLMENU_SERIES,msg=self.onTool.MsgTransform;break;case"deseries":toolType=CBoBo.TOOLMENU_DESERIES,msg=self.onTool.MsgTransform;break;case"jpg":toolType=CBoBo.TOOLMENU_JPG,msg=self.onTool.Jpg.MsgTransform;break;case CBoBo.TOOLMENU_PRINT_JPG:toolType=annStatus.type;break;case CBoBo.TOOLMENU_PRINT_RADIATE:}self.toolBar.RequestToolBall&&self.toolBar.RequestToolBall(toolType,msg),self.toolBar.RequestGrayToolBar&&self.toolBar.RequestGrayToolBar(toolType,msg)}},this.GetContextMenu=function(type){return self.canvasCtxMenu&&self.canvasCtxMenu.Destroy(),self.canvasCtxMenu="jpg"==type?new CBoBo.View.ContextMenu({action:self.onTool.Jpg.MsgTransform,flash:!0,speed:300,items:[{text:"亮度/对比"},{text:"放缩"},{text:"移动"},{text:"删除图像"},{text:"负像"},{text:"恢复"}]}):new CBoBo.View.ContextMenu({action:self.onTool.MsgTransform,flash:!0,speed:300,items:[{text:"调窗"},{text:"放缩"},{text:"移动"},{text:"删除图像"},{text:"逆时针"},{text:"顺时针"},{text:"左右镜像"},{text:"上下镜像"},{text:"负像"},{text:"恢复"},{text:"DICOM信息"}]}),self.canvasCtxMenu},this.IsUIWaitId=function(id){var bFound=!1,arrCanvasMng=self.canvasManager.GetMng();return $.each(arrCanvasMng,function(){var scrollValue,layout,annStatus=this.AnnStatusMng();annStatus&&(scrollValue=this.scroll?this.scroll.draggerPos:1,(void 0===(layout=this.GetLayout())||layout.row<1||layout.col<1)&&(layout={row:1,col:1}),annStatus=self.GetSelArray(annStatus.images,scrollValue,layout.row,layout.col),$.each(annStatus,function(){this.id===id&&(bFound=!0)}))}),bFound},this.DRS={};let scrollLazyEndable=!0,scrollDebounce=simple.debounce(event=>{this.DRS.MsgTransform(event),scrollLazyEndable=!0},1500);this.DRS.MsgTransform=event=>{var annStatusMng,image,{type,value=1,firstmng,mng}=event,scrollLoadLazyNum=(scrollLoadLazyNum=simple.queryToObject().scrollLoadLazyNum||$("#scrollLoadLazyNum").val())?Number(scrollLoadLazyNum):void 0;switch(type){case"resize":this.DRS.Resize(event);break;case"click":case"scroll":(firstmng||mng)&&(image=(annStatusMng=(firstmng||mng).AnnStatusMng()).images[value-1],scrollLazyEndable?(scrollLazyEndable=!1,setTimeout(()=>{scrollLazyEndable=!0},1e3),scrollLoadLazyNum<0?this.downLoadLazySeriesHandle(image.customSeriesId,1,annStatusMng.studyuid):this.scrollDownLoadLazySeriesHandle(image.customSeriesId,1,value,scrollLoadLazyNum)):0==image.bLoadImage&&scrollDebounce(event)),self.DRS.Scroll(event);break;case"drag":self.DRS.DragImage(event)}},this.DRS.Resize=function(event){var currentMng,annStatus;self.Mpr&&self.Mpr.bShow&&(self.Mpr.mng.UpdateLayoutSp3(0,"left"),self.Mpr.mng.SetSpBoundaryColor(0,"#F00"),self.Mpr.mng.SetSpBoundaryColor(1,"#0F0"),self.Mpr.mng.SetSpBoundaryColor(2,"#00F"),annStatus=self.Mpr.mng.AnnStatusMng(),self.onCanvas.Mpr.UpdateCanvas(annStatus)),self.VRT&&self.VRT.bShow&&(annStatus=self.VRT.mng.AnnStatusMng(),self.onCanvas.VRT.UpdateCanvas(annStatus)),self.canvasMax&&self.canvasMax.bShow?(annStatus=(currentMng=self.canvasMax.secondCtrl.GetMng()[0]).AnnStatusMng())&&self.DrawAnnStatusForMng(annStatus,currentMng,!0):(annStatus=self.canvasManager.GetMng(),$.each(annStatus,function(i,mng){var annStatus=mng.AnnStatusMng();annStatus&&self.DrawAnnStatusForMng(annStatus,mng,!0)}))},this.DRS.Scroll=function(event){var scrollPos=event.value;if(event.firstmng)!(annStatus=(mng=event.firstmng).AnnStatusMng())||void 0===(layout=mng.GetLayout())||layout.row<1||layout.col<1||(layout=layout.row*layout.col,void 0!==(arrCanvas=mng.GetLayoutCanvas())&&(self.DrawAnnStatus(annStatus,arrCanvas,!1,(scrollPos-1)*layout,layout),self.onTool.ScountLine(!0)));else if(event.secondmng){var layout=CBoBo.AnnStatusManager.Get();if(self.canvasMax&&self.canvasMax.bShow){var event=self.canvasMax.secondCtrl.GetMng()[0],annStatus=layout[scrollPos-1];event.AnnStatusMng(annStatus),event.UpdateLayout(annStatus.images.length),self.DrawAnnStatusForMng(annStatus,event)}else for(var mng,arrCanvas,event=self.canvasManager.GetLayout(),arrSelAnnStatus=self.GetSelArray(layout,scrollPos,event.row,event.col),arrCanvasMng=self.canvasManager.GetMng(),i=0;i<arrCanvasMng.length;i++)0===(arrCanvas=(mng=arrCanvasMng[i]).GetLayoutCanvas()).length&&mng.UpdateLayout(0,1,1),i<arrSelAnnStatus.length?(annStatus=arrSelAnnStatus[i],mng.AnnStatusMng(annStatus),mng.UpdateLayout(annStatus.images.length),"series"===annStatus.type&&mng.checkbox.Show(!0),self.DrawAnnStatus(annStatus,arrCanvas,!0)):(mng.checkbox.Show(!1),$.each(arrCanvas,function(j,canvas){canvas.Clear(),canvas.DrawCornerInfo()}),mng.Clear())}},this.DRS.DragImage=function(event){var imgId=event.imgId,mng=event.mng,study=self.dataManager.GetStudy(imgId),event=study.GetStudyType();switch(event){case"jpg":Imgs=study.GetJpg(),mng.checkbox.Show(!1);break;case"deseries":Imgs=study.GetDicomById(imgId),mng.checkbox.Show(!1);break;case"series":var series=study.GetSeries(imgId),Imgs=series.GetAllDicom(),seriesId=series.customSeriesId,series=series.studyuid;self.downLoadLazySeriesHandle(seriesId,1,series),mng.checkbox.Show(!0)}var oldAnnStatus=mng.AnnStatusMng(),oldAnnStatus=CBoBo.AnnStatusManager.Replace(oldAnnStatus,Imgs,study.studyuid,event);void 0!==oldAnnStatus&&(mng.AnnStatusMng(oldAnnStatus),mng.UpdateLayout(oldAnnStatus.images.length),CBoBo.ImageProcessor.Restore(oldAnnStatus.viewport),event=mng.GetAllCanvas(),self.DrawAnnStatus(oldAnnStatus,event,!0,void 0,void 0,imgId))},this.onThumb.MsgTransform=function(event){switch(event.type){case"click":var seriesId,studyuid;event.series&&(seriesId=event.series.customSeriesId,studyuid=event.series.studyuid,self.downLoadLazySeriesHandle(seriesId,1,studyuid));break;case"mousedown":"head"==event.tag&&3==event.which&&(void 0===self.thumbCtxMenu&&(self.thumbCtxMenu=new CBoBo.View.ContextMenu({action:self.onThumb.ToolMsg,flash:!0,speed:300,items:[{text:"删除该检查"},{text:"清空全部检查"}]})),self.thumbCtxMenu.SetReserve(event.studyuid),self.thumbCtxMenu.SetPosition(event.clientX,event.clientY),self.thumbCtxMenu.Show(!0));break;case"doubletap":case"dblclick":self.onThumb.ThumbDbClick(event)}},this.onThumb.ThumbDbClick=function(event){var ev,event=parseInt(event.target.title);self.Mpr&&self.Mpr.bShow?self.onCanvas.Mpr.DragImage(event):((ev={type:"drag"}).imgId=event,self.canvasMax&&self.canvasMax.bShow?ev.mng=self.canvasMax.secondCtrl.GetMng()[0]:ev.mng=self.canvasManager.GetFocusMng(),self.DRS.MsgTransform(ev))},this.onThumb.ToolMsg=function(event){switch(event.usermsg||event.target.title){case"删除该检查":var studyuid=event.reservedata;self.thumbManager.DeleteThumb(studyuid),self.dataManager.DeleteStudy(studyuid),self.annStatusManager.DelAnnStatusMngByStudyUid?self.annStatusManager.DelAnnStatusMngByStudyUid(studyuid):self.annStatusManager.arrAnnStatus=[],self.onTool.ReLoadDicom(!0);break;case"清空全部检查":$.each(self.dataManager.arrStudy,function(){var studyuid=this.studyuid;self.thumbManager.DeleteThumb(studyuid),self.annStatusManager.DelAnnStatusMngByStudyUid?self.annStatusManager.DelAnnStatusMngByStudyUid(studyuid):self.annStatusManager.arrAnnStatus=[],self.onTool.ReLoadDicom(!0)}),self.dataManager.arrStudy=[],self.onTool.ReLoadDicom(!0)}self.Mpr&&self.onCanvas.Mpr.Clear(),$.Msg("检查删除成功",CBoBo.MSG_SUCCESS)},this.onTool.Main={},this.onTool.Main.MsgTransform=function(event){var scrollValue,mngLayout,arrAnnStatus,arrSelAnnStatus,annStatus,focusMng,browser=CBoBo.Plugin.GetBrowserInfo();switch(event.target.title){case"2D":browser.isMobile||self.toolBar.Request2DToolBar(),self.Mpr&&self.Mpr.Show(!1),self.VRT&&self.VRT.Show(!1),self.canvasAIMax&&(self.canvasAIMax.Show(!1),scrollValue=self.canvasManager.scroll?self.canvasManager.scroll.draggerPos:1,mngLayout=self.canvasManager.GetLayout(),arrAnnStatus=CBoBo.AnnStatusManager.Get(),arrSelAnnStatus=self.GetSelArray(arrAnnStatus,scrollValue,mngLayout.row,mngLayout.col),self.canvasManager.EachMng(function(mng,i){i<arrSelAnnStatus.length&&(annStatus=arrSelAnnStatus[i],mng.AnnStatusMng(annStatus),mng.AnnStatusMng()!==annStatus&&mng.UpdateLayout(annStatus.images.length),self.DrawAnnStatusForMng(annStatus,mng,!0))}));break;case"MPR":(self.seriesPlayer&&self.seriesPlayer.bShow&&(self.seriesPlayer.Show(!1),self.toolBar.ChangeBtnStatus("序列播放",!1)),self.canvasAIMax&&self.canvasAIMax.Show(!1),void 0===self.Mpr&&(self.Mpr=new CBoBo.View.MPR({parent:"#"+self.frame.GetId("canvasbox"),mode:self.mode,msgtransform:self.onCanvas.Mpr.MsgTransform}),self.Mpr.SetLayout(3)),browser.isMobile||self.toolBar.RequestToolBar(CBoBo.TOOLMENU_MPR,self.onTool.Mpr.MsgTransform),self.Mpr.Show(!0),focusMng=self.canvasManager.GetFocusMng())?(self.onCanvas.Mpr.LoadingAnimation(!0),function initCanvas(init=!0){var annStatus=focusMng.AnnStatusMng();if(annStatus)if(annStatus.images.length<10)$.Msg("重建的序列图像不能小于10张！"),self.onCanvas.Mpr.Clear();else{for(var bFond=!1,i=0;i<annStatus.images.length;i++)if(!annStatus.images[i].bLoadImage){bFond=!0;break}bFond?(init&&(self.downLoadCurrentSeriesHandle(annStatus.images),$.Msg("请等待，该组序列图像正在下载中...",CBoBo.MSG_ALERT)),self.onCanvas.Mpr.Clear(),setTimeout(()=>{initCanvas(!1)},2e3)):(self.onCanvas.Mpr.LoadingAnimation(),self.Mpr.Series(annStatus.images),self.onCanvas.Mpr.InitCanvas())}}()):$.Msg("请选择需要重建的序列！");break;case"AI":self.onEmit("aiClick");break;case"3D":(self.seriesPlayer&&self.seriesPlayer.bShow&&(self.seriesPlayer.Show(!1),self.toolBar.ChangeBtnStatus("序列播放",!1)),self.canvasAIMax&&self.canvasAIMax.Show(!1),self.Mpr&&(self.Mpr.Show(!1),self.Mpr=void 0),void 0===self.VRT&&(self.VRT=new CBoBo.View.VRT({parent:"#"+self.frame.GetId("canvasbox"),mode:self.mode,msgtransform:self.onCanvas.VRT.MsgTransform}),self.VRT.SetLayout()),browser.isMobile||self.toolBar.RequestToolBar(CBoBo.TOOLMENU_VRT,self.onTool.VRT.MsgTransform),self.VRT.Show(!0),focusMng=self.canvasManager.GetFocusMng())?(self.onCanvas.VRT.LoadingAnimation(!0),function initCanvas(init=!0){var annStatus=focusMng.AnnStatusMng();if(annStatus)if(annStatus.images.length<10)$.Msg("重建的序列图像不能小于10张！"),self.onCanvas.VRT.Clear();else{for(var bFond=!1,i=0;i<annStatus.images.length;i++)if(!annStatus.images[i].bLoadImage){bFond=!0;break}bFond?(init&&(self.downLoadCurrentSeriesHandle(annStatus.images),$.Msg("请等待，该组序列图像正在下载中...",CBoBo.MSG_ALERT)),self.onCanvas.VRT.Clear(),setTimeout(()=>{initCanvas(!1)},2e3)):(self.onCanvas.VRT.LoadingAnimation(),self.VRT.Series(annStatus.images),self.onCanvas.VRT.InitCanvas())}}()):$.Msg("请选择需要重建的序列！")}},this.MsgTransform=function(event){switch(event.type){case"click":case"resize":case"scroll":case"drag":return void self.DRS.MsgTransform(event)}var canvasMng=event.mng;if(canvasMng){canvasMng=canvasMng.AnnStatusMng();if(canvasMng){var msg,imgStatus=canvasMng.viewport;if("jpg"===canvasMng.type){if(!imgStatus.GetImage().bLoaded)return;msg=self.onCanvas.Jpg.MsgTransform}else{if(!imgStatus.image.bLoadImage)return;msg=self.onCanvas.MsgTransform}msg(event)}}},this.downLoadLazySeriesHandle=(seriesId,type=1,studyuid)=>{if(seriesId){var study=self.dataManager.GetStudy(studyuid),studyuid=study.GetWaitLoadSeries({seriesId:seriesId,params:"threadPostData"});if(studyuid.length){var preWaitLoadSeries=[];if(1==type){var key,waitSeriesIDMap=CBoBo.store.loadQueue.waitSeriesID;waitSeriesIDMap.delete(seriesId);for([key]of waitSeriesIDMap){var result=study.GetWaitLoadSeries({seriesId:key,params:"threadPostData"});result.length?preWaitLoadSeries.unshift(...result):waitSeriesIDMap.delete(key)}waitSeriesIDMap.set(seriesId)}window.mergeThread.postMessage({type:type,arrpriority:[...studyuid,...preWaitLoadSeries]})}}},this.scrollDownLoadLazySeriesHandle=(seriesId,type=1,index,scrollLoadLazyNum=7)=>{seriesId&&(seriesId=self.dataManager.arrStudy[0].GetWaitLoadSeries({seriesId:seriesId}).filter(({imgnum})=>index<=imgnum&&imgnum<=index+scrollLoadLazyNum).map(({threadPostData})=>threadPostData)).length&&window.mergeThread.postMessage({type:type,arrpriority:[...seriesId]})},this.downLoadCurrentSeriesHandle=(series,type=1)=>{series=series.filter(item=>!item.bLoadImage).map(({threadPostData})=>threadPostData);window.mergeThread.postMessage({type:type,arrpriority:[...series]})},this.toggleImageBDHandle=enable=>{if(void 0===enable&&(enableImagesDB=CBoBo.store.db["enableImagesDB"],enable=!enableImagesDB),enable=!!enable,window.mergeThread&&window.mergeThread.postMessage({store:{enableImagesDB:enable}}),!(CBoBo.store.db.enableImagesDB=enable)){var{dbName:enableImagesDB,storeName,version}=CBoBo.store.db;const db=new simple.IndexedDB(enableImagesDB,storeName,version);db.open().then(function(){db.dispatch("clear")})}return enable},this.UpdateAICanvas=function(){var mng,annStatus,index,maxCanvas,browser=CBoBo.Plugin.GetBrowserInfo(),browser=(self.seriesPlayer&&self.seriesPlayer.bShow&&(self.seriesPlayer.Show(!1),self.toolBar.ChangeBtnStatus("序列播放",!1)),self.Mpr&&self.Mpr.Show(!1),browser.isMobile||self.toolBar.RequestToolBar(CBoBo.TOOLMENU_AI),void 0===self.canvasAIMax&&(self.canvasAIMax=new CBoBo.View.AI({parent:"#"+self.frame.GetId("canvasbox"),refrence:"#"+self.frame.GetId("contain"),msgtransform:self.MsgTransform})),self.canvasAIMax.bShow=!0,self.canvasAIMax.Show(!0),CBoBo.AnnStatusManager.Get());self.canvasAIMax.bShow&&(mng=self.canvasManager.GetFocusMng(),annStatus=mng.AnnStatusMng(),index=CBoBo.AnnStatusManager.GetIndex(annStatus),self.canvasAIMax.secondCtrl.UpdateLayout(browser.length,1,1,(index=void 0===index?0:index)+1),index=mng.GetEventImageIndex(event.self),(mng=self.canvasAIMax.secondCtrl.GetMng()[0]).UpdateLayout(annStatus.images.length,1,1,index+1),mng.AnnStatusMng(annStatus),annStatus.viewport.image,maxCanvas=mng.GetAllCanvas()[0],$.each(browser,function(){CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,maxCanvas.canvas,!1,!0)}),self.DrawAnnStatusForMng(annStatus,mng),self.canvasAIMax.secondCtrl.SetDefaultFocus(0,0))},this.onCanvas.Jpg={},this.onCanvas.Jpg.MsgTransform=function(event){var canvas=event.self,imgStatus=(annStatus=canvas.AnnStatus()).status;switch(event.type){case"touchstart":case"mousedown":switch(self.onCanvas.stampStart=event.timeStamp,self.SaveStartStatus(event,imgStatus),"touchstart"==event.type?(touch=event.originalEvent.targetTouches[0],self.onCanvas.ptStart=CBoBo.Plugin.TransCoord(canvas,touch.pageX,touch.pageY),self.onCanvas.bLMouse=!0):self.onCanvas.ptStart=CBoBo.Plugin.TransCoord(canvas,event.pageX,event.pageY),event.which){case 1:self.onCanvas.bLMouse=!0;break;case 3:self.onCanvas.bRMouse=!0}self.ChangeToolBar(event);break;case"touchmove":case"mousemove":self.onCanvas.bLMouse?self.onCanvas.Jpg.MouseLMove(canvas,imgStatus,event):self.onCanvas.bRMouse?(ptc=CBoBo.Plugin.TransCoord(canvas,event.pageX,event.pageY),self.onCanvas.Jpg.BC(canvas,ptc)):("touchmove"==event.type?(touch=event.originalEvent.targetTouches[0],ptc=CBoBo.Plugin.TransCoord(canvas,touch.pageX,touch.pageY),len=event.originalEvent.targetTouches.length):ptc=CBoBo.Plugin.TransCoord(canvas,event.pageX,event.pageY),len&&2==len&&self.onCanvas.Jpg.Move(canvas,ptc));break;case"touchend":case"mouseup":case"mouseout":case"pinchend":self.onCanvas.bRMouse&&event.timeStamp-self.onCanvas.stampStart<200&&(touch=self.GetContextMenu(CBoBo.PTYPE_JPG))&&(touch.SetPosition(event.clientX,event.clientY),touch.Show(!0)),self.onCanvas.bLMouse=!1,self.onCanvas.bRMouse=!1,self.onCanvas.imgStatus=[];break;case"dblclick":case"tap":if(self.privilege.bMupStudy)self.onCanvas.DbClick(annStatus);else if(self.canvasManager.bMax){var len=self.onTool.stack.pop(),scrollPos=self.onTool.stack.pop(),ptc=self.onTool.stack.pop(),touch=self.onTool.stack.pop();if(null==touch||null==ptc)break;self.onTool.Jpg.MsgTransform({target:{title:"布局控件"},row:touch,col:ptc,max:!0,maxdata:{scrollpos:scrollPos,focusindex:len}})}else{self.onTool.stack.push(self.canvasManager.nLayoutRow),self.onTool.stack.push(self.canvasManager.nLayoutCol);var scrollPos=1,annStatus=(null!=self.canvasManager.scroll&&(scrollPos=self.canvasManager.scroll.draggerPos),self.onTool.stack.push(scrollPos),self.canvasManager.GetFocusCanvas().AnnStatus()),touch=self.canvasManager.GetCanvasIndex();self.onTool.stack.push(touch),self.onTool.Jpg.MsgTransform({target:{title:"布局控件"},row:1,col:1,max:!0,maxdata:{annstatus:annStatus,focusindex:touch}})}break;case"mousewheel":self.onCanvas.NextPage(event.deltaY);break;case"pinchstart":self.onCanvas.bLMouse=!1,self.SaveStartStatus();break;case"pinch":self.onCanvas.Jpg.Zoom(canvas,event.scale);break;case"message":self.onCanvas.Jpg.DrawImage(event)}},this.onCanvas.Jpg.MouseLMove=function(dvcanvas,imgStatus,event){var ptc,touch=(ptc="touchmove"==event.type?(touch=event.originalEvent.targetTouches[0],CBoBo.Plugin.TransCoord(dvcanvas,touch.pageX,touch.pageY)):CBoBo.Plugin.TransCoord(dvcanvas,event.pageX,event.pageY)).x-self.onCanvas.ptStart.x,y=ptc.y-self.onCanvas.ptStart.y;if(0!=touch||0!=y)switch(event.tooltype||self.toolBar.toolType){case CBoBo.TOOL_MOVE:self.onCanvas.Jpg.Move(dvcanvas,ptc);break;case CBoBo.TOOL_ZOOM:self.onCanvas.Jpg.Zoom(dvcanvas,ptc);break;case CBoBo.TOOL_WC:self.onCanvas.Jpg.BC(dvcanvas,ptc)}},this.onCanvas.Jpg.BC=function(canvas,ptc){var imgStatus,brightness,startStatus,x=ptc.x-self.onCanvas.ptStart.x,ptc=ptc.y-self.onCanvas.ptStart.y;0==x&&0==ptc||null==(imgStatus=canvas.AnnStatus().status)&&null==imgStatus.imageInfo||(brightness=(startStatus=self.onCanvas.imgStatus[0]).brightness,startStatus=startStatus.contrast,imgStatus.SetBriCon(brightness=100<(brightness=(brightness+=x>>2)<-100?-100:brightness)?100:brightness,startStatus=100<(startStatus=(startStatus+=ptc>>2)<-100?-100:startStatus)?100:startStatus),imgStatus.DrawImg(canvas))},this.onCanvas.Jpg.Move=function(canvas,ptc){var imgStatus,startStatus,x=ptc.x-self.onCanvas.ptStart.x,ptc=ptc.y-self.onCanvas.ptStart.y;0==x&&0==ptc||null==(imgStatus=canvas.AnnStatus().status)&&null==imgStatus.image||((startStatus={x:(startStatus=self.onCanvas.imgStatus[0]).ptLast.x,y:startStatus.ptLast.y}).x+=x>>0,startStatus.y+=ptc>>0,imgStatus.MoveImage(startStatus),imgStatus.DrawImg(canvas))},this.onCanvas.Jpg.Zoom=function(canvas,ptc){var imgStatus,rat,size,proccessType="number"==typeof ptc?!0:!1;if(!proccessType){var y=ptc.y-self.onCanvas.ptStart.y;if(0==y)return}0==y||null==(imgStatus=canvas.AnnStatus().status)&&null==imgStatus.image||(rat=self.onCanvas.imgStatus[0].zoomRatio,size=imgStatus.GetImageSize(),proccessType?rat*=ptc:rat-=3*y/size.width,imgStatus.ZoomImage((rat=10<(rat=rat<.02?.02:rat)?10:rat)*size.width,rat*size.height),imgStatus.DrawImg(canvas))},this.onCanvas.Jpg.DrawImage=function(event){var tmpcanvas,imgWidth,imgHeight,ptLast,imgSize,pox_x,dvcanvas=event.self,canvas=(dvcanvas.drawlock=!0,dvcanvas.GetCanvas()),annStatus=dvcanvas.AnnStatus();null!=annStatus&&(annStatus=annStatus.status,null!=event.data)&&((tmpcanvas=document.createElement("canvas")).width=event.data.width,tmpcanvas.height=event.data.height,console.log("3"),tmpcanvas.getContext("2d").putImageData(event.data,0,0),(event=canvas.getContext("2d")).clearRect(0,0,canvas.width,canvas.height),imgWidth=annStatus.scaledWidth,imgHeight=annStatus.scaledHeight,ptLast=annStatus.ptLast,imgSize=annStatus.GetImageSize(),pox_x=(canvas.width-imgWidth)/2+ptLast.x,canvas=(canvas.height-imgHeight)/2+ptLast.y,event.drawImage(tmpcanvas,0,0,imgSize.width,imgSize.height,pox_x,canvas,imgWidth,imgHeight),annStatus.DrawText(dvcanvas))},this.onTool.Jpg={},this.onTool.Jpg.MsgTransform=function(event){var arrSel,bMax,scrollPos,data,arrAnnStatus,arrCanvas,toolType=event.usermsg||event.target.title;switch(toolType){case"释放工具":self.toolBar.toolType=CBoBo.TOOL_NULL;break;case"重新加载":self.onTool.Jpg.ReLoad();break;case"图像布局":case"序列布局":null==self.layoutCtrl&&(self.layoutCtrl=new CBoBo.View.LayoutCtrl({msgtransform:self.onTool.Jpg.MsgTransform,radio:!1})),self.layoutCtrl.bShow?self.layoutCtrl.Show(!1):(self.layoutCtrl.SetPosition(event.clientX-8,.4*CBoBo.View.TOOLBAR_HEIGHT>>0),self.layoutCtrl.Show(!0),self.layoutCtrl.Type(toolType));break;case"恢复":self.onTool.Jpg.Restore();break;case"放缩":self.toolBar.toolType=CBoBo.TOOL_ZOOM;break;case"移动":self.toolBar.toolType=CBoBo.TOOL_MOVE;break;case"负像":self.onTool.Jpg.Negative();break;case"伪彩":null==self.pseudocolorCtrl&&(self.pseudocolorCtrl=new CBoBo.View.PseudoColorCtrl({msgtransform:self.onTool.Jpg.MsgTransform})),self.pseudocolorCtrl.bShow?self.pseudocolorCtrl.Show(!1):(self.pseudocolorCtrl.SetPosition(event.clientX,CBoBo.View.TOOLBAR_HEIGHT),self.pseudocolorCtrl.Show(!0));break;case"亮度/对比":case"亮/对比":case"调窗":self.toolBar.toolType=CBoBo.TOOL_WC;break;case"删除图像":self.onTool.Jpg.Delete();break;case"布局控件":self.privilege.bMupStudy?self.onTool.CanvasLayout(event):(bMax=!1,data=event.maxdata,event.max&&(null!=data.annstatus?(scrollPos=data.focusindex+1,(arrSel=[]).push(data.annstatus),bMax=!0):scrollPos=data.scrollpos),arrAnnStatus=self.annStatusManager.GetAnnStatus(),self.canvasManager.UpdateLayout(arrAnnStatus.length,event.row,event.col,scrollPos),arrCanvas=self.canvasManager.GetLayoutCanvas(),$.each(arrAnnStatus,function(i,annStatus){annStatus.status.FitCanvas(arrCanvas[0])}),null==scrollPos&&(scrollPos=1),bMax||(arrSel=self.GetSelArray(arrAnnStatus,scrollPos,event.row,event.col),null!=data&&self.canvasManager.Focus(data.focusindex)),self.FlushAnnStatusForCanvas(arrSel,arrCanvas));break;case"灰色":case"彩虹":case"黑体":case"骨骼":case"心脏":case"流动":case"Ge色":case"灰色彩虹":case"热绿":case"铬铁":case"热金属":case"饱和度1":case"饱和度2":case"红外":case"墨黑":case"骨骼-肌肉":case"NIH":case"彩虹1":case"彩虹2":case"彩虹3":case"比值":case"红色血管":case"光谱":case"斯特恩":case"UCLA":self.onTool.Pseudocolor(event.target.title);break;case"显/隐四角信息":self.onTool.MsgTransform({usermsg:"显/隐四角信息"});break;case"dragend":$.Msg("dragend");break;case"drag":$.Msg("drag");break;case"hold":$.Msg("hold");break;case"配置":case"胶片打印":self.onTool.MsgTransform(event);break;case"协同诊断":self.onTool.MsgTransform({usermsg:toolType})}CBoBo.Plugin.GetBrowserInfo().isMobile||!1===self.toolBar.ChangeBtnStatus(event.btntitle,event.btnforce)&&(self.toolBar.toolType=CBoBo.TOOL_NULL,self.toolBar.ChangeBtnStatus("释放工具"))},this.onTool.Jpg.Restore=function(){var canvas=self.canvasManager.GetFocusCanvas(),imgStatus=canvas.AnnStatus().status;null!=imgStatus&&(imgStatus.Restore(),imgStatus.FitCanvas(canvas).DrawImg(canvas))},this.onTool.Jpg.Delete=function(){var canvas,arrCanvas;self.privilege.bMupStudy?self.onTool.DeleteDicom():(canvas=self.canvasManager.GetFocusCanvas(),self.annStatusManager.DeleteAnnStatus(canvas.AnnStatus()),canvas=self.annStatusManager.GetAnnStatus(),self.canvasManager.UpdateLayout(canvas.length),arrCanvas=self.canvasManager.GetLayoutCanvas(),self.FlushAnnStatusForCanvas(canvas,arrCanvas,!0))},this.onTool.Jpg.ReLoad=function(bInitStack){self.onTool.MsgTransform({usermsg:"重新加载"})},this.onTool.Jpg.Negative=function(){var canvas=self.canvasManager.GetFocusCanvas(),imgStatus=canvas.AnnStatus().status;null!=imgStatus&&(imgStatus.SetNegative(!imgStatus.GetNegative()),imgStatus.DrawImg(canvas))},this.onCanvas.MsgTransform=function(event){var touch,annStatus=event.mng.AnnStatusMng(),imgIndex=event.mng.GetEventImageIndex(event.self);if(annStatus&&!(imgIndex>annStatus.images.length-1))switch(event.type){case"touchstart":case"mousedown":self.onCanvas.stampStart=event.timeStamp,"touchstart"==event.type?(self.onCanvas.lastScale=annStatus.viewport.scale,touch=event.originalEvent.targetTouches[0],self.onCanvas.ptStart=new Point(touch.pageX,touch.pageY),1===event.originalEvent.touches.length?self.onCanvas.which=1:self.onCanvas.bTouchMul=!0):(self.onTool.ScountLine(!0),self.onCanvas.which=event.which,self.onCanvas.ptStart=new Point(event.pageX,event.pageY)),"ww"==self.toolBar.toolType&&(self.onCanvas.which=3),0===self.toolBar.toolType&&(self.onCanvas.which=4),self.onCanvas.ptLast=new Point(self.onCanvas.ptStart),self.onCanvas.MouseDown(event),self.ChangeToolBar(event);break;case"touchmove":case"mousemove":0!==self.onCanvas.which||"touchmove"==event.type&&2===event.originalEvent.touches.length?self.onCanvas.MouseDowmMove(event):self.onCanvas.MouseMove(event);break;case"touchend":case"mouseup":case"mouseout":case"pinchend":self.onCanvas.MouseUp(event);break;case"click":break;case"dblclick":case"doubletap":self.onCanvas.DbClick(event);break;case"mousewheel":self.onCanvas.NextPage(event.deltaY);break;case"pinchstart":self.onCanvas.which=0;break;case"pinch":self.onCanvas.ZOOM(event.scale);break;case"hold":$.Msg("hold")}},this.onCanvas.MouseDown=function(event){var status,serverID,annStatus,imgIndex;1===self.onCanvas.which&&(status=(annStatus=event.mng.AnnStatusMng()).viewport,imgIndex=event.mng.GetEventImageIndex(event.self),void 0===(imgIndex=annStatus.images[imgIndex])||(serverID=self.canvasAIMax&&self.canvasAIMax.bShow?(serverID=imgIndex.imageInstanceUid,annStatus.anns[serverID]instanceof Array||(annStatus.anns[serverID]=[]),annStatus.anns[serverID]):(annStatus.anns[imgIndex.id]instanceof Array||(annStatus.anns[imgIndex.id]=[]),annStatus.anns[imgIndex.id]),annStatus=event.self.canvas,imgIndex=event.tooltype||self.toolBar.toolType,CBoBo.Annotation.ScanClickTextBox(status,annStatus,serverID,self.onCanvas.ptLast.x,self.onCanvas.ptLast.y),CBoBo.Annotation.ActiveAnnotation(serverID))||void 0!==(event=CBoBo.Annotation.NewAnnotation(status,annStatus,imgIndex,self.onCanvas.ptLast.x,self.onCanvas.ptLast.y))&&serverID.push(event))},this.onCanvas.MouseDowmMove=function(event){var ptc,deltaX=(ptc="touchmove"==event.type?new Point((touch=event.originalEvent.targetTouches[0]).pageX,touch.pageY):new Point(event.pageX,event.pageY)).x-self.onCanvas.ptLast.x,deltaY=ptc.y-self.onCanvas.ptLast.y;if(0!=deltaX||0!=deltaY){if(2==self.onCanvas.which||"touchmove"==event.type&&2===event.originalEvent.touches.length)self.onCanvas.MOVE(deltaX,deltaY);else if(3==self.onCanvas.which)self.onCanvas.WW(deltaX,deltaY);else if(4==self.onCanvas.which)5<Math.abs(deltaY)&&(0<deltaY?self.onCanvas.NextPage(-1):self.onCanvas.NextPage(1));else if(1==self.onCanvas.which){var serverID,touch=event.mng.AnnStatusMng(),status=touch.viewport,imgIndex=event.mng.GetEventImageIndex(event.self),imgIndex=touch.images[imgIndex];if(void 0===imgIndex)return;status.image=imgIndex;var anns=self.canvasAIMax&&self.canvasAIMax.bShow?(serverID=imgIndex.imageInstanceUid,touch.anns[serverID]instanceof Array||(touch.anns[serverID]=[]),touch.anns[serverID]):(touch.anns[imgIndex.id]instanceof Array||(touch.anns[imgIndex.id]=[]),touch.anns[imgIndex.id]),toolType=event.tooltype||self.toolBar.toolType,canvas=event.self.canvas;if(self.canvasAIMax&&self.canvasAIMax.bShow){if(!CBoBo.Annotation.MaybeServerModifyActiveAnn(status,canvas,anns,self.onCanvas.ptLast.x,self.onCanvas.ptLast.y,ptc.x,ptc.y))switch(toolType){case"sharpen":self.onCanvas.Sharpen(deltaX,deltaY);break;case"blur":self.onCanvas.Blur(deltaX,deltaY);break;case"zoom":self.onCanvas.ZOOM(deltaX,deltaY);break;case"ww":self.onCanvas.WW(deltaX,deltaY);break;case"move":self.onCanvas.MOVE(deltaX,deltaY)}}else if(!CBoBo.Annotation.MaybeModifyActiveAnn(status,canvas,anns,self.onCanvas.ptLast.x,self.onCanvas.ptLast.y,ptc.x,ptc.y))switch(toolType){case"sharpen":self.onCanvas.Sharpen(deltaX,deltaY);break;case"blur":self.onCanvas.Blur(deltaX,deltaY);break;case"zoom":self.onCanvas.ZOOM(deltaX,deltaY);break;case"ww":self.onCanvas.WW(deltaX,deltaY);break;case"move":self.onCanvas.MOVE(deltaX,deltaY);break;case"heartratio":case"r":case"l":case".":case"angle":case"arrow":case"ellipse":case"probe":case"rect":case"line":CBoBo.Annotation.UnfinishedAnn(status,canvas,anns,toolType,ptc.x,ptc.y)}}self.onCanvas.ptLast=ptc}},this.onCanvas.MouseUp=function(event){if(1===self.onCanvas.which||self.onCanvas.bTouchMul){var annStatus=event.mng.AnnStatusMng(),status=annStatus.viewport,imgIndex=event.mng.GetEventImageIndex(event.self),imgIndex=annStatus.images[imgIndex];if(void 0===imgIndex)return;status.image=imgIndex;var anns=self.canvasAIMax&&self.canvasAIMax.bShow?(serverID=imgIndex.imageInstanceUid,annStatus.anns[serverID]instanceof Array||(annStatus.anns[serverID]=[]),annStatus.anns[serverID]):(annStatus.anns[imgIndex.id]instanceof Array||(annStatus.anns[imgIndex.id]=[]),annStatus.anns[imgIndex.id]),serverID=event.tooltype||self.toolBar.toolType,canvas=event.self.canvas,annStatus=CBoBo.Annotation.GetMaybeSaveAnn(serverID,status,canvas);void 0!==annStatus?(anns.push(annStatus),CBoBo.Draw.GetIsFromServer()&&CBoBo.Annotation.ServerGetMaybeSaveAnn(serverID,status,canvas,annStatus).then(function(ann){CBoBo.ImageProcessor.DrawGrayImage(status,canvas),CBoBo.Annotation.DrawAnnotation(status,canvas,anns),CBoBo.Annotation.MaybeEndModifyAnn()})):CBoBo.Draw.GetIsFromServer()&&(imgIndex=new Point(event.pageX,event.pageY),console.log(imgIndex),annStatus=CBoBo.Annotation.ServerHoverAnnotation(status,canvas,anns,imgIndex.x,imgIndex.y),CBoBo.Annotation.ServerGetMaybeSaveAnn(serverID,status,canvas,annStatus).then(function(ann){CBoBo.ImageProcessor.DrawGrayImage(status,canvas),CBoBo.Annotation.DrawAnnotation(status,canvas,anns),CBoBo.Annotation.MaybeEndModifyAnn()})),CBoBo.Annotation.MaybeEndModifyAnn()}else 3===self.onCanvas.which&&"mouseup"===event.type&&(imgIndex=CBoBo.Annotation.Distance(new Point(event.pageX,event.pageY),self.onCanvas.ptStart),event.timeStamp-self.onCanvas.stampStart<200)&&imgIndex<1&&(serverID=self.GetContextMenu("series"))&&(serverID.SetPosition(event.clientX,event.clientY),serverID.Show(!0));self.onCanvas.bTouchMul=!1,self.onCanvas.which=0},this.onCanvas.MouseMove=function(event){var annStatus=event.mng.AnnStatusMng();if("touchmove"==event.type){if(1!==event.originalEvent.touches.length)return void(self.onCanvas.bTouchMul=!0);var touch=event.originalEvent.targetTouches[0],touch=new Point(touch.pageX,touch.pageY)}else touch=new Point(event.pageX,event.pageY);var deltaX=touch.x-self.onCanvas.ptLast.x,deltaY=touch.y-self.onCanvas.ptLast.y;if(0!=deltaX||0!=deltaY){deltaX=annStatus.viewport,deltaY=event.mng.GetEventImageIndex(event.self),deltaY=annStatus.images[deltaY];if(void 0!==deltaY){deltaX.image=deltaY,serverID=self.canvasAIMax&&self.canvasAIMax.bShow?(serverID=deltaY.imageInstanceUid,annStatus.anns[serverID]instanceof Array||(annStatus.anns[serverID]=[]),annStatus.anns[serverID]):(annStatus.anns[deltaY.id]instanceof Array||(annStatus.anns[deltaY.id]=[]),annStatus.anns[deltaY.id]);var serverID,annStatus=event.self.canvas,deltaY=event.tooltype||self.toolBar.toolType;if(0===self.onCanvas.which){deltaY=CBoBo.Annotation.UnfinishedAnn(deltaX,annStatus,serverID,deltaY,touch.x,touch.y);if(!deltaY&&(CBoBo.Annotation.ScanHoverAnnotation(deltaX,annStatus,serverID,touch.x,touch.y),"touchmove"==event.type)&&"pointer"==annStatus.style.cursor){switch(self.toolBar.toolType){case"line":self.toolBar.ChangeBtnStatus("直线");break;case"rect":self.toolBar.ChangeBtnStatus("矩形");break;case"ellipse":self.toolBar.ChangeBtnStatus("椭圆");break;case"angle":self.toolBar.ChangeBtnStatus("角度")}self.toolBar.toolType="."}}self.onCanvas.ptLast=touch,self.onTool.ScountLine(!0)}}},this.onCanvas.WW=function(deltaX,deltaY){var currentMng,annStatus,status;self.canvasAIMax&&self.canvasAIMax.bShow?(annStatus=(currentMng=self.canvasAIMax.secondCtrl.GetMng()[0]).AnnStatusMng())&&((status=annStatus.viewport).ww+=parseInt(deltaX*status.wwScale),status.wc+=parseInt(deltaY*status.wwScale),status.ww<2&&(status.ww=2),self.DrawAnnStatusForMng(annStatus,currentMng,!1,!0)):self.canvasMax&&self.canvasMax.bShow?(annStatus=(currentMng=self.canvasMax.secondCtrl.GetMng()[0]).AnnStatusMng())&&((status=annStatus.viewport).ww+=parseInt(deltaX*status.wwScale),status.wc+=parseInt(deltaY*status.wwScale),status.ww<2&&(status.ww=2),self.DrawAnnStatusForMng(annStatus,currentMng,!1,!0)):(status=self.canvasManager.GetActiveMng(),$.each(status,function(i,mng){var status,annStatus=mng.AnnStatusMng();annStatus&&((status=annStatus.viewport).ww+=parseInt(deltaX*status.wwScale),status.wc+=parseInt(deltaY*status.wwScale),status.ww<2&&(status.ww=2),self.DrawAnnStatusForMng(annStatus,mng,!1,!0))}))},this.onCanvas.MOVE=function(deltaX,deltaY){var currentMng,annStatus,status;self.canvasAIMax&&self.canvasAIMax.bShow?(annStatus=(currentMng=self.canvasAIMax.secondCtrl.GetMng()[0]).AnnStatusMng())&&((status=annStatus.viewport).translation.x+=parseInt(deltaX/status.scale),status.translation.y+=parseInt(deltaY/status.scale),self.DrawAnnStatusForMng(annStatus,currentMng)):self.canvasMax&&self.canvasMax.bShow?(annStatus=(currentMng=self.canvasMax.secondCtrl.GetMng()[0]).AnnStatusMng())&&((status=annStatus.viewport).translation.x+=parseInt(deltaX/status.scale),status.translation.y+=parseInt(deltaY/status.scale),self.DrawAnnStatusForMng(annStatus,currentMng)):(status=self.canvasManager.GetActiveMng(),$.each(status,function(i,mng){var status,annStatus=mng.AnnStatusMng();annStatus&&((status=annStatus.viewport).translation.x+=deltaX/status.scale,status.translation.y+=deltaY/status.scale,self.DrawAnnStatusForMng(annStatus,mng))}))},this.onCanvas.ZOOM=function(deltaX,deltaY){var currentMng,annStatus,status;self.canvasAIMax&&self.canvasAIMax.bShow?(annStatus=(currentMng=self.canvasAIMax.secondCtrl.GetMng()[0]).AnnStatusMng())&&(status=annStatus.viewport,void 0===deltaY?status.scale=self.onCanvas.lastScale*deltaX:status.scale+=deltaY/100,status.scale<.01&&(status.scale=.01),status.scale=parseFloat(status.scale.toFixed(2)),self.DrawAnnStatusForMng(annStatus,currentMng)):self.canvasMax&&self.canvasMax.bShow?(annStatus=(currentMng=self.canvasMax.secondCtrl.GetMng()[0]).AnnStatusMng())&&(status=annStatus.viewport,void 0===deltaY?status.scale=self.onCanvas.lastScale*deltaX:status.scale+=deltaY/100,status.scale<.01&&(status.scale=.01),status.scale=parseFloat(status.scale.toFixed(2)),self.DrawAnnStatusForMng(annStatus,currentMng)):(status=self.canvasManager.GetActiveMng(),$.each(status,function(i,mng){var status,annStatus=mng.AnnStatusMng();annStatus&&(status=annStatus.viewport,void 0===deltaY?status.scale=self.onCanvas.lastScale*deltaX:status.scale+=deltaY/100,status.scale<.01&&(status.scale=.01),status.scale=parseFloat(status.scale.toFixed(2)),self.DrawAnnStatusForMng(annStatus,mng))}))},this.onCanvas.Sharpen=function(deltaX,deltaY){var currentMng;const goDrawAnnStatusForMng=currentMng=>{var annStatus=currentMng.AnnStatusMng();if(annStatus){var status=annStatus.viewport;let sharpen=status["sharpen"];(sharpen+=deltaY/5e3)<0&&(sharpen=0),status.sharpen=parseFloat(sharpen.toFixed(4)),self.DrawAnnStatusForMng(annStatus,currentMng)}};self.canvasAIMax&&self.canvasAIMax.bShow?(currentMng=self.canvasAIMax.secondCtrl.GetMng()[0],goDrawAnnStatusForMng(currentMng)):self.canvasMax&&self.canvasMax.bShow?(currentMng=self.canvasMax.secondCtrl.GetMng()[0],goDrawAnnStatusForMng(currentMng)):(currentMng=self.canvasManager.GetActiveMng(),$.each(currentMng,function(i,mng){goDrawAnnStatusForMng(mng)}))},this.onCanvas.Blur=function(deltaX,deltaY){var currentMng;const goDrawAnnStatusForMng=currentMng=>{var annStatus=currentMng.AnnStatusMng();if(annStatus){var status=annStatus.viewport;let blur=status["blur"];(blur+=deltaY/2e3)<0&&(blur=0),status.blur=parseFloat(blur.toFixed(4)),self.DrawAnnStatusForMng(annStatus,currentMng)}};self.canvasAIMax&&self.canvasAIMax.bShow?(currentMng=self.canvasAIMax.secondCtrl.GetMng()[0],goDrawAnnStatusForMng(currentMng)):self.canvasMax&&self.canvasMax.bShow?(currentMng=self.canvasMax.secondCtrl.GetMng()[0],goDrawAnnStatusForMng(currentMng)):(currentMng=self.canvasManager.GetActiveMng(),$.each(currentMng,function(i,mng){goDrawAnnStatusForMng(mng)}))},this.onCanvas.NextPage=function(delta){var currentMng;self.canvasMax&&self.canvasMax.bShow?(currentMng=self.canvasMax.secondCtrl.GetMng()[0]).scroll&&currentMng.scroll.TriggerClick(delta):self.canvasAIMax&&self.canvasAIMax.bShow?(currentMng=self.canvasAIMax.secondCtrl.GetMng()[0]).scroll&&currentMng.scroll.TriggerClick(delta):(currentMng=self.canvasManager.GetActiveMng(),$.each(currentMng,function(i,mng){mng.scroll&&mng.scroll.TriggerClick(delta)}))},this.onCanvas.DbClick=function(event){if(!self.canvasAIMax||!self.canvasAIMax.bShow){var layout=self.canvasManager.GetLayout();if(1===layout.row&&1===layout.col)if(1===(layout=(mng=self.canvasManager.GetFocusMng()).GetLayout()).row&&1===layout.col)return;self.seriesPlayer&&self.seriesPlayer.bShow&&(self.seriesPlayer.Show(!1),self.toolBar.ChangeBtnStatus("序列播放",!1)),void 0===self.canvasMax&&(self.canvasMax=new CBoBo.View.CanvasMax({parent:"#"+self.frame.GetId("canvasbox"),msgtransform:self.MsgTransform})),self.canvasMax.bShow=!self.canvasMax.bShow;var mng,maxCanvas,arrSelAnnStatus,annStatus,layout=self.canvasMax.bShow,arrAnnStatus=(self.canvasMax.Show(layout),CBoBo.AnnStatusManager.Get());layout?(annStatus=(mng=event.mng).AnnStatusMng(),layout=CBoBo.AnnStatusManager.GetIndex(annStatus),self.canvasMax.secondCtrl.UpdateLayout(arrAnnStatus.length,1,1,(layout=void 0===layout?0:layout)+1),layout=mng.GetEventImageIndex(event.self),(mng=self.canvasMax.secondCtrl.GetMng()[0]).UpdateLayout(annStatus.images.length,1,1,layout+1),mng.AnnStatusMng(annStatus),maxCanvas=mng.GetAllCanvas()[0],$.each(arrAnnStatus,function(){CBoBo.Draw.FitServerCanvas(this.viewport,maxCanvas.canvas,!1,!0)}),self.DrawAnnStatusForMng(annStatus,mng),self.canvasMax.secondCtrl.SetDefaultFocus(0,0)):(event=self.canvasManager.scroll?self.canvasManager.scroll.draggerPos:1,layout=self.canvasManager.GetLayout(),arrSelAnnStatus=self.GetSelArray(arrAnnStatus,event,layout.row,layout.col),self.canvasManager.EachMng(function(mng,i){i<arrSelAnnStatus.length&&(annStatus=arrSelAnnStatus[i],mng.AnnStatusMng(annStatus),mng.AnnStatusMng()!==annStatus&&mng.UpdateLayout(annStatus.images.length),self.DrawAnnStatusForMng(annStatus,mng,!0))}))}},this.onTool.MsgTransform=function(event){var dicom,toolType=event.usermsg||event.target.title;switch(toolType){case"释放工具":self.toolBar.toolType=CBoBo.TOOL_NULL;break;case"重新加载":void 0!==self.lableCtrl&&self.lableCtrl.Show(!1),self.onTool.ReLoadDicom(!0);break;case"序列布局":case"图像布局":null==self.layoutCtrl&&(self.layoutCtrl=new CBoBo.View.LayoutCtrl({msgtransform:self.onTool.MsgTransform,radio:!1})),self.layoutCtrl.bShow?self.layoutCtrl.Show(!1):(self.layoutCtrl.SetPosition(event.clientX-8,.4*CBoBo.View.TOOLBAR_HEIGHT>>0),self.layoutCtrl.Show(!0),self.layoutCtrl.Type(toolType));break;case"恢复":self.onTool.RestoreDicom();break;case"定位线":self.onTool.bShowScountLine?($.Msg("定位线已关闭。",CBoBo.MSG_SUCCESS),self.onTool.bShowScountLine=!1,arrMng=self.canvasManager.GetMng(),$.each(arrMng,function(i,mng){var annStatus=mng.AnnStatusMng();annStatus&&self.DrawAnnStatusForMng(annStatus,mng)})):($.Msg("定位线已开启。",CBoBo.MSG_SUCCESS),self.onTool.bShowScountLine=!0,self.onTool.ScountLine());break;case"序列播放":null==self.seriesPlayer&&(self.seriesPlayer=new CBoBo.View.SeriesPlayer({msgtransform:self.onTool.MsgTransform})),self.seriesPlayer.bShow?self.seriesPlayer.Show(!1):(left=(range=(mng=(self.canvasMax&&self.canvasMax.bShow?self.canvasMax.secondCtrl:self.canvasManager).GetFocusMng()).GetBoundary()).left+(range.width-300>>1),range=range.top+range.height-45,self.seriesPlayer.SetPosition(left,range),left=1,(range=mng.AnnStatusMng())&&1==(left=(images=range.images).length)&&(left=images[0].frames),self.seriesPlayer.SaveSeriesTag(mng),self.seriesPlayer.SetRange(left),self.seriesPlayer.Show(!0),self.seriesPlayer.TriggerClick(2));break;case"放缩":self.toolBar.toolType="zoom";break;case"移动":self.toolBar.toolType="move";break;case"旋转":null==self.rotateCtrl&&(self.rotateCtrl=new CBoBo.View.RotateCtrl({msgtransform:self.onTool.MsgTransform})),self.rotateCtrl.bShow?self.rotateCtrl.Show(!1):(self.rotateCtrl.SetPosition(event.clientX,CBoBo.View.TOOLBAR_HEIGHT),self.rotateCtrl.Show(!0));break;case"负像":self.onTool.Negative();break;case"伪彩":null==self.pseudocolorCtrl&&(self.pseudocolorCtrl=new CBoBo.View.PseudoColorCtrl({msgtransform:self.onTool.MsgTransform})),self.pseudocolorCtrl.bShow?self.pseudocolorCtrl.Show(!1):(self.pseudocolorCtrl.SetPosition(event.clientX,CBoBo.View.TOOLBAR_HEIGHT),self.pseudocolorCtrl.Show(!0));break;case"调窗":self.toolBar.toolType="ww";break;case"自定义调窗 ":null==self.wwCtrl&&(self.wwCtrl=new CBoBo.View.wwCtrl({msgtransform:self.onTool.MsgTransform,modalityType:self.dataManager.GetStudy(0).modality})),self.wwCtrl.bShow?self.wwCtrl.Show(!1):(self.wwCtrl.SetPosition(event.clientX,CBoBo.View.TOOLBAR_HEIGHT),self.wwCtrl.Show(!0));break;case"锐化":self.toolBar.toolType="sharpen";break;case"平滑":self.toolBar.toolType="blur";break;case"直线":self.toolBar.toolType="line";break;case"矩形":self.toolBar.toolType="rect";break;case"椭圆":self.toolBar.toolType="ellipse";break;case"角度":self.toolBar.toolType="angle";break;case"CT":self.toolBar.toolType="probe";break;case"文本":self.toolBar.toolType="text";break;case"箭头":self.toolBar.toolType="arrow";break;case"左标记":self.toolBar.toolType="l";break;case"右标记":self.toolBar.toolType="r";break;case"撤销":if(range=(mng=self.canvasMax&&self.canvasMax.bShow?self.canvasMax.secondCtrl.GetMng()[0]:self.canvasManager.GetFocusMng()).AnnStatusMng()){var status=range.viewport,images=mng.GetFocusCanvas();if(void 0===images)break;var index=mng.GetEventImageIndex(images),left=range.images[index];if(void 0===left)return;if(status.image=left,!(range.anns[left.id]instanceof Array))break;0<range.anns[left.id].length&&range.anns[left.id].pop();var canvas=images.canvas;CBoBo.Draw.DrawImage(status,canvas),CBoBo.Annotation.DrawAnnotation(status,canvas,range.anns[left.id])}break;case"删除图像":self.onTool.DeleteDicom();break;case"布局控件":self.onTool.CanvasLayout(event);break;case"逆时针":case"顺时针":case"左右镜像":case"上下镜像":self.onTool.RotateDicom(event.target.title);break;case"灰色":case"彩虹":case"黑体":case"骨骼":case"心脏":case"流动":case"Ge色":case"灰色彩虹":case"热绿":case"铬铁":case"热金属":case"饱和度1":case"饱和度2":case"红外":case"墨黑":case"骨骼-肌肉":case"NIH":case"彩虹1":case"彩虹2":case"彩虹3":case"比值":case"红色血管":case"光谱":case"斯特恩":case"UCLA":self.onTool.Pseudocolor(event.target.title);break;case"seriesplay":var range,mng=self.seriesPlayer.GetSeriesTag();if("userdocument"==event.userdocument){if(!self.seriesPlayer.bShow)return;images=(self.canvasMax&&self.canvasMax.bShow?self.canvasMax.secondCtrl:self.canvasManager).GetFocusMng();mng!=images&&(self.seriesPlayer.Show(!1),event.btntitle="序列播放",event.btnforce=!1)}else null!=event.target?mng.scroll&&self.seriesPlayer.SetRange(mng.scroll.rangeMap,mng.scroll.draggerPos):mng.scroll?mng.scroll.TriggerDragger(event.value):(status=(range=mng.AnnStatusMng()).viewport,left=mng.GetCanvas(),status.scale=status.scale1,status.image=range.images[0],status.frames=event.value,CBoBo.ImageProcessor.FitCanvas(status,left[0].canvas,!0));break;case"胶片打印":self.privilege.bPrint&&(null==self.printer&&(self.printer=new CBoBo.View.DVPrint({msgtransform:self.PrintView.MsgTransform,mode:self.mode})),self.printer.bShow?self.printer.Show():self.printer.Show(!0));break;case"心胸比":self.toolBar.toolType="heartratio";break;case"DICOM信息":self.dicomScan&&self.dicomScan.bShow?(self.dicomScan.Show(!1),delete self.dicomScan):(self.dicomScan=new CBoBo.View.DicomScan({msgtransform:self.onTool.MsgTransform}),canvas=(self.canvasMax&&self.canvasMax.bShow?canvasMng=self.canvasMax.secondCtrl.GetMng()[0]:(canvasMng=self.canvasManager.GetFocusMng(),self.canvasManager)).GetFocusCanvas(),(range=canvasMng.AnnStatusMng())&&(index=canvasMng.GetEventImageIndex(canvas),dicom=range.images[index]),self.dicomScan.SetDicomInfo(dicom),console.log(dicom),self.dicomScan.Show(!0),event.btnstatus=canvasMng={title:"DICOM信息",bseled:!0});break;case"显/隐四角信息":self.toolBar.bShowCornerInfo=!self.toolBar.bShowCornerInfo,(canvasMng={title:"显/隐四角信息"}).bseled=self.toolBar.bShowCornerInfo,event.btnstatus=canvasMng;var canvasMng,arrMng=self.canvasManager.GetMng();$.each(arrMng,function(i,mng){var annStatus=mng.AnnStatusMng();annStatus&&self.DrawAnnStatusForMng(annStatus,mng)});break;case"打印图像":self.KeyboardMsg({keyCode:80});break;case"打印序列":self.KeyboardMsg({keyCode:80,ctrlKey:!0});break;case"MPR":self.onTool.Main.MsgTransform({target:{title:"MPR"}});break;case"2D":self.onTool.Main.MsgTransform({target:{title:"2D"}});break;case"配置":void 0===self.configView&&(self.configView=new CBoBo.View.Config);images=self.toolBar.GetButtonDOM("配置");self.configView.bShow?(self.configView.Show(!1),$(images).css("pointer-events","")):(self.configView.Show(!0),$(images).css("pointer-events","auto"));break;case"协同诊断":null==self.assistDiagnose&&(self.assistDiagnose=new CBoBo.View.AssistDiagnose({server:"localhost:80",msgtransform:self.Assist.MsgTransform}),self.assistDiagnose.Login()),self.assistDiagnose.Show(!self.assistDiagnose.bShow);break;case"本地缓存":self.toggleImageBDHandle();break;case"按键说明":self.iconInfo&&self.iconInfo.bShow?(self.iconInfo.Show(!1),delete self.iconInfo):(self.iconInfo=new CBoBo.View.IconInfo({msgtransform:self.onTool.MsgTransform}),self.iconInfo.SetInfo(),self.iconInfo.Show(!0));break;case"CPR直线":case"CPR曲线":case"切面调窗":case"十字切面":self.onTool.Mpr.MsgTransform(event);break;case"Abodmen":case"Lung":case"Brain":case"Bone":case"Chest":case"Head/Neck":self.onTool.WW(toolType);break;case"CustomWWWC":self.onTool.BindAlert()}CBoBo.Plugin.GetBrowserInfo().isMobile||!1===self.toolBar.ChangeBtnStatus(event.btntitle,event.btnforce)&&(self.toolBar.toolType=CBoBo.TOOL_NULL,self.toolBar.ChangeBtnStatus("释放工具"))},this.onTool.BindAlert=function(){var cusWW,cusWC,arrMng=self.canvasManager.GetActiveMng(),arrMng=($.each(arrMng,function(i,mng){var mng=mng.AnnStatusMng();mng&&(mng=mng.viewport,cusWW=mng.ww,cusWC=mng.wc)}),self.isKeyBoard=!0,'<div class="layer-wrap"><div class="layer-content"><div class="layer-iptdiv"><label>窗宽:</label><input type="text" id="customWW"    class="layer-ipt" value="'+cusWW+'"></div><div class="layer-iptdiv"><label>窗位:</label><input type="text" id="customWC"  class="layer-ipt" value="'+cusWC+'"></div></div><div class="footer"><span id="btn-ok-custom" class="darkgreen">确定</span><span id="btn-cancel-custom">取消</span></div></div>'),loading=layer.open({title:"请输入窗宽窗位",type:1,skin:"layui-layer-rim",area:["420px","210px"],content:arrMng,cancel:function(){change()}});function change(){self.isKeyBoard=!1}$("#btn-ok-custom").click(function(){var customWWk=$("#customWW").val(),customWCk=$("#customWC").val();isNaN(customWCk)||isNaN(customWWk)?alert("请输入正确数字"):(self.onTool.CustomWW(parseInt(customWWk),parseInt(customWCk)),layer.close(loading),change())}),$("#btn-cancel-custom").click(function(){layer.close(loading),change()})},this.onTool.CustomWW=function(ww,wc){var currentMng,annStatus,status;self.canvasMax&&self.canvasMax.bShow?(annStatus=(currentMng=self.canvasMax.secondCtrl.GetMng()[0]).AnnStatusMng())&&((status=annStatus.viewport).ww=parseInt(ww),status.wc=parseInt(wc),status.ww<2&&(status.ww=2),self.DrawAnnStatusForMng(annStatus,currentMng,!1,!0)):(status=self.canvasManager.GetActiveMng(),$.each(status,function(i,mng){var status,annStatus=mng.AnnStatusMng();annStatus&&((status=annStatus.viewport).ww=ww,status.wc=wc,status.ww<2&&(status.ww=2),self.DrawAnnStatusForMng(annStatus,mng,!1,!0))}))},this.onTool.WW=function(type){var currentMng;if(self.canvasAIMax&&self.canvasAIMax.bShow){if(annStatus=(currentMng=self.canvasMax.secondCtrl.GetMng()[0]).AnnStatusMng()){var status=annStatus.viewport;switch(type){case"Abodmen":status.ww=400,status.wc=60;break;case"Lung":status.ww=1500,status.wc=-600;break;case"Brain":status.ww=80,status.wc=40;break;case"Bone":status.ww=1500,status.wc=300;break;case"Chest":status.ww=400,status.wc=40;break;case"Head/Neck":status.ww=350,status.wc=90}status.ww<2&&(status.ww=2),self.DrawAnnStatusForMng(annStatus,currentMng,!1,!0)}}else if(self.canvasMax&&self.canvasMax.bShow){if(annStatus=(currentMng=self.canvasMax.secondCtrl.GetMng()[0]).AnnStatusMng()){status=annStatus.viewport;switch(type){case"Abodmen":status.ww=400,status.wc=60;break;case"Lung":status.ww=1500,status.wc=-600;break;case"Brain":status.ww=80,status.wc=40;break;case"Bone":status.ww=1500,status.wc=300;break;case"Chest":status.ww=400,status.wc=40;break;case"Head/Neck":status.ww=350,status.wc=90}status.ww<2&&(status.ww=2),self.DrawAnnStatusForMng(annStatus,currentMng,!1,!0)}}else{var annStatus=self.canvasManager.GetActiveMng();$.each(annStatus,function(i,mng){var annStatus=mng.AnnStatusMng();if(annStatus){var status=annStatus.viewport;switch(type){case"Abodmen":status.ww=400,status.wc=60;break;case"Lung":status.ww=1500,status.wc=-600;break;case"Brain":status.ww=80,status.wc=40;break;case"Bone":status.ww=1500,status.wc=300;break;case"Chest":status.ww=400,status.wc=40;break;case"Head/Neck":status.ww=350,status.wc=90}status.ww<2&&(status.ww=2),self.DrawAnnStatusForMng(annStatus,mng,!1,!0)}})}},this.onTool.Negative=function(){var currentMng,annStatus;self.canvasMax&&self.canvasMax.bShow?(annStatus=(currentMng=self.canvasMax.secondCtrl.GetMng()[0]).AnnStatusMng())&&(annStatus.viewport.invert=!annStatus.viewport.invert,self.DrawAnnStatusForMng(annStatus,currentMng)):(annStatus=self.canvasManager.GetActiveMng(),$.each(annStatus,function(i,mng){var annStatus=mng.AnnStatusMng();annStatus&&(annStatus.viewport.invert=!annStatus.viewport.invert,self.DrawAnnStatusForMng(annStatus,mng))}))},this.onTool.RotateDicom=function(type){if(self.canvasMax&&self.canvasMax.bShow){var currentMng=self.canvasMax.secondCtrl.GetMng()[0],annStatus=currentMng.AnnStatusMng();if(annStatus){switch(type){case"逆时针":annStatus.viewport.rotation+=-90;break;case"顺时针":annStatus.viewport.rotation+=90;break;case"左右镜像":annStatus.viewport.hflip=!annStatus.viewport.hflip;break;case"上下镜像":annStatus.viewport.vflip=!annStatus.viewport.vflip}-360!==annStatus.viewport.rotation&&360!==annStatus.viewport.rotation||(annStatus.viewport.rotation=0),self.DrawAnnStatusForMng(annStatus,currentMng)}}else{currentMng=self.canvasManager.GetActiveMng();$.each(currentMng,function(i,mng){var annStatus=mng.AnnStatusMng();if(annStatus){switch(type){case"逆时针":annStatus.viewport.rotation+=-90;break;case"顺时针":annStatus.viewport.rotation+=90;break;case"左右镜像":annStatus.viewport.hflip=!annStatus.viewport.hflip;break;case"上下镜像":annStatus.viewport.vflip=!annStatus.viewport.vflip}-360!==annStatus.viewport.rotation&&360!==annStatus.viewport.rotation||(annStatus.viewport.rotation=0),self.DrawAnnStatusForMng(annStatus,mng)}})}},this.onTool.ReLoadDicom=function(bInitStack){self.canvasMax&&self.canvasMax.bShow&&self.canvasMax.Show(!1),bInitStack&&self.InitAnnStatusStack();for(var bInitStack=self.dataManager.GetStudy(0),type=bInitStack.GetStudyType(),bPageSwitch=bInitStack.IsPageSwitch(),arrAnnStatus=("series"===type&&bPageSwitch&&bInitStack.RequestSeriesDicom(),CBoBo.AnnStatusManager.Get()),arrCanvasMng=(self.canvasManager.UpdateLayout(arrAnnStatus.length),self.canvasManager.GetMng()),i=0;i<arrCanvasMng.length;i++){var annStatus,mng=arrCanvasMng[i],arrCanvas=mng.GetLayoutCanvas();0===arrCanvas.length&&mng.UpdateLayout(0,1,1),i<arrAnnStatus.length?(annStatus=arrAnnStatus[i],mng.AnnStatusMng(annStatus),mng.UpdateLayout(annStatus.images.length),"series"===annStatus.type&&mng.checkbox.Show(!0),window.devicePixelRatio=1,self.DrawAnnStatus(annStatus,arrCanvas,!0)):(mng.checkbox.Show(!1),$.each(arrCanvas,function(j,canvas){canvas.Clear(),canvas.DrawCornerInfo()}),mng.Clear())}},this.onTool.DeleteDicom=function(){var annStatus,arrAnnStatus,currentMng;self.canvasMax&&self.canvasMax.bShow?(annStatus=(currentMng=self.canvasMax.secondCtrl.GetMng()[0]).AnnStatusMng())&&(annStatus=CBoBo.AnnStatusManager.Delete(annStatus),arrAnnStatus=CBoBo.AnnStatusManager.Get(),annStatus=Math.min(annStatus,arrAnnStatus.length-1),self.canvasMax.secondCtrl.UpdateLayout(arrAnnStatus.length,1,1,(annStatus<0?0:annStatus)+1),annStatus<arrAnnStatus.length&&-1<annStatus?(arrAnnStatus=arrAnnStatus[annStatus])&&(currentMng.UpdateLayout(arrAnnStatus.images.length),currentMng.AnnStatusMng(arrAnnStatus),self.DrawAnnStatusForMng(arrAnnStatus,currentMng)):(currentMng.UpdateLayout(0),currentMng.AnnStatusMng(null),(arrAnnStatus=(annStatus=currentMng.GetAllCanvas()[0]).canvas).width=arrAnnStatus.width,annStatus.DrawCornerInfo())):(currentMng=self.canvasManager.GetActiveMng(),$.each(currentMng,function(i,mng){mng=mng.AnnStatusMng();CBoBo.AnnStatusManager.Delete(mng)}),self.onTool.ReLoadDicom())},this.onTool.RestoreDicom=function(){var currentMng,annStatus;self.canvasMax&&self.canvasMax.bShow?(annStatus=(currentMng=self.canvasMax.secondCtrl.GetMng()[0]).AnnStatusMng())&&(CBoBo.ImageProcessor.Restore(annStatus.viewport),annStatus.anns={},self.DrawAnnStatusForMng(annStatus,currentMng,!0,!1)):(annStatus=self.canvasManager.GetActiveMng(),$.each(annStatus,function(i,mng){var annStatus=mng.AnnStatusMng();annStatus&&(CBoBo.ImageProcessor.Restore(annStatus.viewport),annStatus.anns={},self.DrawAnnStatusForMng(annStatus,mng,!0,!1))}))},this.onTool.Pseudocolor=function(type){var currentMng,annStatus;self.canvasMax&&self.canvasMax.bShow?(annStatus=(currentMng=self.canvasMax.secondCtrl.GetMng()[0]).AnnStatusMng())&&(annStatus.viewport.pseudo=type,self.DrawAnnStatusForMng(annStatus,currentMng)):(annStatus=self.canvasManager.GetActiveMng(),$.each(annStatus,function(i,mng){var annStatus=mng.AnnStatusMng();annStatus&&(annStatus.viewport.pseudo=type,self.DrawAnnStatusForMng(annStatus,mng))}))},this.onTool.CanvasLayout=function(event){switch(event.ctrltype){case"图像布局":self.canvasMax&&self.canvasMax.bShow?(annStatus=(currentMng=self.canvasMax.secondCtrl.GetMng()[0]).AnnStatusMng())&&(currentMng.UpdateLayout(annStatus.images.length,event.row,event.col),arrCanvas=currentMng.GetAllCanvas(),self.DrawAnnStatus(annStatus,arrCanvas,!0),void 0===currentMng.GetFocusCanvas())&&currentMng.Focus(arrCanvas.length-1):void 0!==(currentMng=self.canvasManager.GetFocusMng())&&(annStatus=currentMng.AnnStatusMng())&&(currentMng.UpdateLayout(annStatus.images.length,event.row,event.col),arrCanvas=currentMng.GetAllCanvas(),self.DrawAnnStatus(annStatus,arrCanvas,!0),void 0===currentMng.GetFocusCanvas())&&currentMng.Focus(arrCanvas.length-1);break;case"序列布局":self.canvasMax&&self.canvasMax.bShow&&self.canvasMax.Show(!1),localStorage.setItem("seriesLayoutCount",JSON.stringify({row:event.row,col:event.col}));var arrAnnStatus=CBoBo.AnnStatusManager.Get(),annStatus=(self.canvasManager.UpdateLayout(arrAnnStatus.length,event.row,event.col),self.canvasManager.GetMng()),currentMng=($.each(annStatus,function(i,mng){var arrCanvas;i<arrAnnStatus.length?(i=arrAnnStatus[i])&&(mng.UpdateLayout(i.images.length),mng.AnnStatusMng(i),"series"===i.type?(mng.checkbox.Show(!0),mng.checkbox.On_Off(i.compare)):mng.checkbox.Show(!1),arrCanvas=mng.GetLayoutCanvas(),self.DrawAnnStatus(i,arrCanvas,!0)):(mng.UpdateLayout(0),mng.checkbox.Show(!1))}),self.canvasManager.focusIndex),arrCanvas=self.canvasManager.GetLayout(),annStatus=(arrCanvas=void 0===arrCanvas||arrCanvas.row<1||arrCanvas.col<1?{row:1,col:1}:arrCanvas).row*arrCanvas.col-1;annStatus<currentMng&&self.canvasManager.SetDefaultFocus(annStatus,0)}},this.onTool.ScountLine=function(bFlush){if(self.onTool.bShowScountLine){var focusMng=self.canvasManager.GetFocusMng(),focusAnnStatus=focusMng.AnnStatusMng();if(!focusAnnStatus)return;bFlush&&(arrMng=self.canvasManager.GetMng(),$.each(arrMng,function(i,mng){var annStatus=mng.AnnStatusMng();annStatus&&self.DrawAnnStatusForMng(annStatus,mng)}));for(var seriesuid,arrLayoutCanvas=self.canvasManager.GetLayoutCanvas(),arrUid=[],i=0;i<arrLayoutCanvas.length;i++){var dvcanvas=arrLayoutCanvas[i];0===i?index=focusMng.GetEventImageIndex(dvcanvas):index++,index<focusAnnStatus.images.length&&(image=focusAnnStatus.images[index],void 0===seriesuid&&(seriesuid=image.seruid),arrUid.push(image.uid))}for(var bShowIndex=!0,arrMng=(1<arrUid.length&&(bShowIndex=!1),self.canvasManager.GetMng()),i=0;i<arrMng.length;i++){var mng=arrMng[i],annStatus=mng.AnnStatusMng();if(annStatus!==focusAnnStatus&&annStatus)for(var arrCanvas=mng.GetAllCanvas(),index=0,j=0;j<arrCanvas.length;j++){var image,arrLine,canvas,ctx,len,dvcanvas=arrCanvas[j];0===j?index=mng.GetEventImageIndex(dvcanvas):index++,index<annStatus.images.length&&void 0!==(arrLine=(image=annStatus.images[index]).scount[seriesuid])&&0<arrLine.length&&(canvas=dvcanvas.canvas,ctx=canvas.getContext("2d"),2<arrLine.length&&(DrawScountLine(ctx,canvas,annStatus.viewport,arrLine[0].ptStart,arrLine[0].ptEnd,arrLine[0].index,!1,!0),len=arrLine.length-1,DrawScountLine(ctx,canvas,annStatus.viewport,arrLine[len].ptStart,arrLine[len].ptEnd,arrLine[len].index,!1,!0)),$.each(arrLine,function(k,line){$.each(arrUid,function(j,uid){uid==line.uid&&DrawScountLine(ctx,canvas,annStatus.viewport,line.ptStart,line.ptEnd,line.index,!0,bShowIndex)})}))}}}function DrawScountLine(ctx,canvas,imgStatus,startPt,endPt,imgIndex,bDashed,bShowIndex){var endPt=startPt.x<endPt.x?(ptMin=startPt,endPt):(ptMin=endPt,startPt),startPt=CBoBo.ImageProcessor.PixelToCanvas(imgStatus,canvas,ptMin),ptMin=CBoBo.ImageProcessor.PixelToCanvas(imgStatus,canvas,endPt);ctx.save(),ctx.strokeStyle="#fff",ctx.fillStyle="#FFF",ctx.shadowColor="#000",ctx.shadowOffsetX="1",ctx.shadowOffsetY="1",ctx.lineWidth="1",ctx.beginPath(),0==bDashed&&ctx.setLineDash([2,3]),ctx.moveTo(startPt.x,startPt.y),ctx.lineTo(ptMin.x,ptMin.y),ctx.stroke(),bShowIndex&&(new Point(0,0),startPt.y-3<5?ctx.fillText(imgIndex,startPt.x-3,startPt.y):ctx.fillText(imgIndex,startPt.x,startPt.y-3)),ctx.restore()}},this.onCanvas.VRT={},this.onCanvas.VRT.WebDcmSocket=null,this.onCanvas.VRT.Seruuid=null,this.onCanvas.VRT.canvas3D=null,this.onCanvas.VRT.annStatus3D=null,this.onCanvas.VRT.MsgTransform=function(event){if(self.VRT.bMsg||"drag"===event.type)switch(event.type){case"touchstart":case"mousedown":var touch;"touchstart"===event.type?(touch=new Point((touch=event.originalEvent.targetTouches[0]).pageX,touch.pageY),self.onCanvas.which=1):(touch=new Point(event.pageX,event.pageY),self.onCanvas.which=event.which),self.VRT.ptLast=touch,self.onCanvas.VRT.MouseDown(event);break;case"touchmove":case"mousemove":0!==self.onCanvas.which&&self.onCanvas.VRT.MouseDownMove(event);break;case"touchend":case"mouseup":case"mouseout":self.onCanvas.VRT.MouseUp(event),self.onCanvas.which=0;break;case"click":break;case"dblclick":case"doubletap":break;case"mousewheel":self.onCanvas.VRT.MouseWheel(event);break;case"drag":self.onCanvas.VRT.DragImage(event.imgId)}},this.onCanvas.VRT.MouseDown=function(event){1===self.onCanvas.which&&self.onCanvas.VRT.Slicing(event)},this.onCanvas.VRT.Slicing=function(event){point="touchmove"==event.type||"touchstart"==event.type?new Point((touch=event.originalEvent.targetTouches[0]).pageX,touch.pageY):new Point(event.pageX,event.pageY);var touch,point,pt,dicom,canvas=event.self.canvas,annStatus=self.VRT.mng.AnnStatusMng(),status=annStatus.viewport,arrCanvas=self.VRT.mng.GetCanvas(),images=self.VRT.Series();switch(self.VRT.mng.GetEventImageIndex(event.self)){case 1:status.scale=status.scale1,status.image=annStatus.images[0],pt=CBoBo.ImageProcessor.PageToPixel(status,canvas,point.x,point.y),CBoBo.ImageProcessor.FitCanvas(status,canvas),self.onCanvas.VRT.DrawCanvasLine(event.self,{point:pt,lcolor:"#0F0",vcolor:"#00F"}),self.VRT.ptO=pt;var ptData=self.onCanvas.VRT.GetMapCoord({type:CBoBo.MPR_ORIGINAL,point:pt,index:self.VRT.oIndex});self.onCanvas.VRT.DrawMprDicom(arrCanvas[2],pt,180),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[2],ptData[CBoBo.MPR_LEVEL]),self.onCanvas.VRT.DrawMprDicom(arrCanvas[3],pt,90),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[3],ptData[CBoBo.MPR_VERTICAl]);break;case 2:status.scale=status.scale2,status.image=annStatus.images[180],pt=CBoBo.ImageProcessor.PageToPixel(status,canvas,point.x,point.y),self.VRT.ptL=pt,CBoBo.ImageProcessor.FitCanvas(status,arrCanvas[2].canvas,!1,!1,!0),self.onCanvas.VRT.DrawCanvasLine(event.self,{point:pt,lcolor:"#F00",vcolor:"#00F"}),self.VRT.oIndex=pt.y,(dicom=images[self.VRT.oIndex-1])&&(ptData=self.onCanvas.VRT.GetMapCoord({type:CBoBo.MPR_LEVEL,point:pt}),status.image=dicom,annStatus.images[0]=dicom,CBoBo.ImageProcessor.FitCanvas(status,arrCanvas[1].canvas),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[1],ptData[CBoBo.MPR_ORIGINAL]),self.onCanvas.VRT.DrawMprDicom(arrCanvas[3],self.VRT.ptO,90),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[3],ptData[CBoBo.MPR_VERTICAl]));break;case 3:status.scale=status.scale3,status.image=annStatus.images[90],pt=CBoBo.ImageProcessor.PageToPixel(status,canvas,point.x,point.y),self.VRT.ptV=pt,CBoBo.ImageProcessor.FitCanvas(status,arrCanvas[3].canvas,!1,!1,!0),self.onCanvas.VRT.DrawCanvasLine(event.self,{point:pt,lcolor:"#F00",vcolor:"#0F0"}),self.VRT.oIndex=pt.y,(dicom=images[self.VRT.oIndex-1])&&(ptData=self.onCanvas.VRT.GetMapCoord({type:CBoBo.MPR_VERTICAl,point:pt}),status.image=dicom,annStatus.images[0]=dicom,CBoBo.ImageProcessor.FitCanvas(status,arrCanvas[1].canvas),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[1],ptData[CBoBo.MPR_ORIGINAL]),self.onCanvas.VRT.DrawMprDicom(arrCanvas[2],self.VRT.ptO,180),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[2],ptData[CBoBo.MPR_LEVEL]))}},this.onCanvas.VRT.MouseDownMove=function(event){if(1===self.onCanvas.which)if(0==self.VRT.mng.GetEventImageIndex(event.self))switch(self.onTool.VRT.type){case"手术刀内":case"手术刀外":self.onCanvas.VRT.KnifeMove(event);break;default:self.onCanvas.VRT.Rotate(event)}else self.onCanvas.VRT.Slicing(event);else 3===self.onCanvas.which?0==self.VRT.mng.GetEventImageIndex(event.self)?self.onCanvas.VRT.WindowsLevel(event):self.onCanvas.VRT.WW(event):2===self.onCanvas.which&&0==self.VRT.mng.GetEventImageIndex(event.self)&&self.onCanvas.VRT.Pan(event)},this.onCanvas.VRT.WW=function(event){var touch,status,event=(touch="touchmove"==event.type?new Point((touch=event.originalEvent.targetTouches[0]).pageX,touch.pageY):new Point(event.pageX,event.pageY)).x-self.VRT.ptLast.x,deltaY=touch.y-self.VRT.ptLast.y;0==event&&0==deltaY||(self.VRT.ptLast=touch,(status=(touch=self.VRT.mng.AnnStatusMng()).viewport).ww+=parseInt(event/status.scale),status.wc+=parseInt(deltaY/status.scale),status.ww<2&&(status.ww=2),self.onCanvas.VRT.UpdateCanvas(touch))},this.onCanvas.VRT.MouseUp=function(event){if(1===self.onCanvas.which&&0==self.VRT.mng.GetEventImageIndex(event.self))switch(self.onTool.VRT.type){case"手术刀内":case"手术刀外":self.onCanvas.VRT.KnifeEnd(),self.toolBar.ChangeBtnStatus(self.onTool.VRT.type,null),self.onTool.VRT.type=""}},this.onCanvas.VRT.MouseWheel=function(event){console.log("MouseWheel");var arrCanvas=self.VRT.mng.GetCanvas(),deltaY=event.deltaY,arrImages=self.VRT.Series(),annStatus=self.VRT.mng.AnnStatusMng();switch(index=self.VRT.mng.GetEventImageIndex(event.self)){case 1:var index=self.VRT.oIndex;self.VRT.oIndex=0<deltaY?--self.VRT.oIndex<1?1:self.VRT.oIndex:++self.VRT.oIndex>arrImages.length?arrImages.length:self.VRT.oIndex,index!==self.VRT.oIndex&&(dicom=arrImages[self.VRT.oIndex-1],annStatus.viewport.image=dicom,annStatus.images[0]=dicom,CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,event.self.canvas),self.onCanvas.VRT.DrawCanvasLine(event.self,{point:self.VRT.ptO,lcolor:"#0F0",vcolor:"#00F"}),ptData=self.onCanvas.VRT.GetMapCoord({type:CBoBo.MPR_ORIGINAL,point:self.VRT.ptO,index:self.VRT.oIndex}),annStatus.viewport.image=annStatus.images[180],CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[2].canvas,!1,!1,!0),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[2],ptData[CBoBo.MPR_LEVEL]),annStatus.viewport.scale=1,annStatus.viewport.image=annStatus.images[90],CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[3].canvas,!1,!1,!0),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[3],ptData[CBoBo.MPR_VERTICAl]),annStatus.viewport.image=annStatus.images[0],arrCanvas[1].DrawCornerInfo(annStatus.viewport),arrCanvas[2].DrawCornerInfo(annStatus.viewport),arrCanvas[3].DrawCornerInfo(annStatus.viewport));break;case 2:var dicom=arrImages[0],height=parseInt(dicom.row),index=self.VRT.ptO.y;self.VRT.ptO.y=0<deltaY?--self.VRT.ptO.y<1?1:self.VRT.ptO.y:++self.VRT.ptO.y>height?height:self.VRT.ptO.y,self.VRT.ptV.x=self.VRT.ptO.y,index!==self.VRT.ptO.y&&(ptData=self.onCanvas.VRT.GetMapCoord({type:CBoBo.MPR_ORIGINAL,point:self.VRT.ptO,index:self.VRT.oIndex}),self.onCanvas.VRT.DrawMprDicom(arrCanvas[2],self.VRT.ptO,180),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[2],ptData[CBoBo.MPR_LEVEL]),annStatus.viewport.image=annStatus.images[90],CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[3].canvas,!1,!1,!0),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[3],ptData[CBoBo.MPR_VERTICAl]),ptData=self.onCanvas.VRT.GetMapCoord({type:CBoBo.MPR_VERTICAl,point:self.VRT.ptV}),dicom=arrImages[self.VRT.oIndex-1],annStatus.viewport.image=dicom,annStatus.images[0]=dicom,CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[1].canvas),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[1],ptData[CBoBo.MPR_ORIGINAL]));break;case 3:dicom=arrImages[0];var ptData,height=parseInt(dicom.col),index=self.VRT.ptO.x;self.VRT.ptO.x=0<deltaY?--self.VRT.ptO.x<1?1:self.VRT.ptO.x:++self.VRT.ptO.x>height?height:self.VRT.ptO.x,self.VRT.ptL.x=self.VRT.ptO.x,index!==self.VRT.ptO.x&&(ptData=self.onCanvas.VRT.GetMapCoord({type:CBoBo.MPR_ORIGINAL,point:self.VRT.ptO,index:self.VRT.oIndex}),self.onCanvas.VRT.DrawMprDicom(arrCanvas[3],self.VRT.ptO,90),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[3],ptData[CBoBo.MPR_VERTICAl]),annStatus.viewport.image=annStatus.images[180],CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[2].canvas,!1,!1,!0),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[2],ptData[CBoBo.MPR_LEVEL]),ptData=self.onCanvas.VRT.GetMapCoord({type:CBoBo.MPR_LEVEL,point:self.VRT.ptL}),dicom=arrImages[self.VRT.oIndex-1],annStatus.viewport.image=dicom,annStatus.images[0]=dicom,CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[1].canvas),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[1],ptData[CBoBo.MPR_ORIGINAL]));break;case 0:self.onCanvas.VRT.Zoom(event)}},this.onCanvas.VRT.DragImage=function(imgId,init=!0){self.onCanvas.VRT.LoadingAnimation(!0);var series=self.dataManager.GetSeries(imgId);if(series){var images=series.GetAllDicom();if(images.length<10)$.Msg("重建的序列图像不能小于10张！",CBoBo.MSG_ALERT),self.onCanvas.VRT.Clear();else{for(var bFond=!1,i=0;i<images.length;i++)if(!images[i].bLoadImage){bFond=!0;break}bFond?(init&&(self.downLoadCurrentSeriesHandle(images),$.Msg("请等待，该组序列图像正在下载中...",CBoBo.MSG_ALERT)),self.onCanvas.VRT.Clear(),setTimeout(()=>{this.DragImage(imgId,!1)},2e3)):(self.onCanvas.VRT.LoadingAnimation(),self.VRT.Series(images),self.onCanvas.VRT.InitCanvas())}}else $.Msg("不能进行MPR重建！")},this.onCanvas.VRT.LoadingAnimation=function(open){var arrCanvas=self.VRT.mng.GetCanvas();if(void 0!==arrCanvas)for(const canvas of arrCanvas)open?canvas.StartLoadingAnimation():canvas.StopLoadingAnimation()},this.onCanvas.VRT.InitCanvas=function(){var annStatus,defSelIndex,images,canvas,arrCanvas=self.VRT.mng.GetCanvas();void 0!==arrCanvas&&(images=self.VRT.Series())&&(annStatus=CBoBo.AnnStatusManager.Create(images[0],"","",!0),self.VRT.mng.AnnStatusMng(annStatus),self.onCanvas.VRT.canvas3D=arrCanvas[0],self.onCanvas.VRT.canvas3D.StartLoadingAnimation(),self.onCanvas.VRTannStatus3D=annStatus,self.onCanvas.VRT.canvas3D.DrawCornerInfo(annStatus.viewport),self.onCanvas.VRT.DrawVrtDicom(annStatus.viewport),canvas=arrCanvas[1],defSelIndex=Math.floor(images.length/2),images=images[(self.VRT.oIndex=defSelIndex)-1],annStatus.viewport.image=images,annStatus.images[0]=images,CBoBo.ImageProcessor.Restore(annStatus.viewport).FitCanvas(annStatus.viewport,canvas.canvas),canvas.DrawCornerInfo(annStatus.viewport),annStatus.viewport.scale1=annStatus.viewport.scale,images=new Point(parseInt(images.col)>>1,parseInt(images.row)>>1),self.VRT.ptO=images,self.onCanvas.VRT.DrawCanvasLine(canvas,{point:images,lcolor:"#0F0",vcolor:"#00F"}),canvas=self.onCanvas.VRT.GetMapCoord({type:CBoBo.MPR_ORIGINAL,point:images,index:defSelIndex}),self.onCanvas.VRT.DrawMprDicom(arrCanvas[2],images,180),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[2],canvas[CBoBo.MPR_LEVEL]),arrCanvas[2].DrawCornerInfo(annStatus.viewport),annStatus.viewport.scale2=annStatus.viewport.scale,self.onCanvas.VRT.DrawMprDicom(arrCanvas[3],images,90),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[3],canvas[CBoBo.MPR_VERTICAl]),arrCanvas[3].DrawCornerInfo(annStatus.viewport),annStatus.viewport.scale3=annStatus.viewport.scale,self.VRT.ptL=canvas[CBoBo.MPR_LEVEL].point,self.VRT.ptV=canvas[CBoBo.MPR_VERTICAl].point)},this.onCanvas.VRT.DrawCanvasLine=function(dvCanvas,data){var canvas,status,ptImg,lcolor,ptImgVerticalStart,dicom,ptImgRowStart,imgWidth;if(void 0!==data)return canvas=dvCanvas.canvas,dvCanvas=dvCanvas.canvas.getContext("2d"),dicom=(status=self.VRT.mng.AnnStatusMng().viewport).image,ptImg=data.point,lcolor=data.lcolor,data=data.vcolor,imgWidth=dicom.col,dicom=dicom.row,ptImgRowStart=new Point(0,ptImg.y),imgWidth=new Point(imgWidth,ptImg.y),ptImgVerticalStart=new Point(ptImg.x,0),dicom=new Point(ptImg.x,dicom),ptImgRowStart=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,ptImgRowStart),imgWidth=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,imgWidth),dvCanvas.setTransform(1,0,0,1,0,0),dvCanvas.save(),dvCanvas.strokeStyle=lcolor,Line(dvCanvas,ptImgRowStart,imgWidth),ptImgRowStart=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,ptImgVerticalStart),imgWidth=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,dicom),dvCanvas.strokeStyle=data,Line(dvCanvas,ptImgRowStart,imgWidth),dvCanvas.restore(),ptImg;function Line(ctx,p,p2){ctx.beginPath(),ctx.moveTo(p.x,p.y),ctx.lineTo(p2.x,p2.y),ctx.stroke()}},this.onCanvas.VRT.DrawMprDicom=function(dvCanvas,point,angle){var ptStart={},ptEnd={},images=self.VRT.Series();images&&(90===angle?(ptStart.x=point.x,ptStart.y=0,ptEnd.x=point.x,ptEnd.y=images[0].row):(ptStart.x=0,ptStart.y=point.y,ptEnd.x=images[0].col,ptEnd.y=point.y),images=CBoBo.Mpr.GetPointsFromLine(ptStart,ptEnd),point=CBoBo.Mpr.GenerateNormalPlane(self.VRT.Series(),images),(ptStart=self.VRT.mng.AnnStatusMng()).images[angle]=point,ptStart.viewport.image=point,CBoBo.ImageProcessor.FitCanvas(ptStart.viewport,dvCanvas.canvas,!1,!1,!0))},this.onCanvas.VRT.DrawVrtDicom=function(viewport){var{vrtWsURl,hospid,studyuid,wadourl}=self.dataManager.GetStudy(0),viewport=viewport.image["seruuid"],wadourl=wadourl+"/GetImagesPath?seruuid="+viewport+"&hospcode="+hospid+"&studyuid="+studyuid;if(vrtWsURl||alert("vrtWsURl is undefined"),null!=self.onCanvas.VRT.WebDcmSocket){if(self.onCanvas.VRT.Seruuid==viewport)return void self.onCanvas.VRT.Refresh();self.onCanvas.VRT.WebDcmSocket.close()}self.onCanvas.VRT.Seruuid=viewport;hospid=vrtWsURl+"/Wado?serurl="+encodeURIComponent(wadourl);self.onCanvas.VRT.WebDcmSocket=new WebSocket(hospid),self.onCanvas.VRT.WebDcmSocket.onclose=function(){console.log("Connection closed")},self.onCanvas.VRT.WebDcmSocket.onopen=function(){console.log("Connection opened")},self.onCanvas.VRT.WebDcmSocket.onerror=function(e){console.log("An error occured",e)},self.onCanvas.VRT.WebDcmSocket.onmessage=function(evt){var reader;"string"!=typeof evt.data&&((reader=new FileReader).onload=function(evt){var image;evt.target.readyState==FileReader.DONE&&((image=new Image).src=this.result,image.onload=()=>{self.onCanvas.VRT.canvas3D.StopLoadingAnimation();var new_width,status=self.VRT.mng.AnnStatusMng().viewport,canvas=self.onCanvas.VRT.canvas3D.canvas,dx=canvas.getContext("2d"),div_width=canvas.width,canvas=canvas.height,old_width=image.width,old_height=image.height,scale_x=div_width/old_width,scale_y=canvas/old_height,scale_y=scale_y<scale_x?(status.scale0=parseFloat(scale_y.toFixed(2)),new_width=old_width*scale_y,old_height*scale_y):(status.scale0=parseFloat(scale_x.toFixed(2)),new_width=old_width*scale_x,old_height*scale_x);dx.drawImage(image,(div_width-new_width)/2,(canvas-scale_y)/2,new_width,scale_y),status.scale=status.scale0,self.onCanvas.VRT.canvas3D.DrawCornerInfo(status)})},reader.readAsDataURL(evt.data))}},this.onCanvas.VRT.GetMapCoord=function(option){if(null!=option){var retData={};switch(option.type){case CBoBo.MPR_ORIGINAL:var point=option.point,index=option.index;(data=retData[CBoBo.MPR_LEVEL]={}).point=new Point(point.x,index),data.lcolor="#F00",data.vcolor="#00F",(data=retData[CBoBo.MPR_VERTICAl]={}).point=new Point(point.y,index),data.lcolor="#F00",data.vcolor="#0F0";break;case CBoBo.MPR_LEVEL:var point=option.point,data=retData[CBoBo.MPR_ORIGINAL]={},data=(self.VRT.ptO.x=point.x,data.point=self.VRT.ptO,data.lcolor="#0F0",data.vcolor="#00F",retData[CBoBo.MPR_VERTICAl]={});self.VRT.ptV.y=point.y,data.point=self.VRT.ptV,data.lcolor="#F00",data.vcolor="#0F0";break;case CBoBo.MPR_VERTICAl:index=option.point,data=retData[CBoBo.MPR_ORIGINAL]={},data=(self.VRT.ptO.y=index.x,data.point=self.VRT.ptO,data.lcolor="#0F0",data.vcolor="#00F",retData[CBoBo.MPR_LEVEL]={});self.VRT.ptL.y=index.y,data.point=self.VRT.ptL,data.lcolor="#F00",data.vcolor="#00F";break;case CBoBo.MPR_ANY:}return retData}},this.onCanvas.VRT.Clear=function(){self.VRT.mng.AnnStatusMng(null);var arrCanvas=self.VRT.mng.GetCanvas();void 0!==arrCanvas&&($.each(arrCanvas,function(i,canvas){canvas.canvas.width=canvas.canvas.width,canvas.DrawCornerInfo()}),self.VRT.bMsg=!1)},this.onCanvas.VRT.UpdateCanvas=function(annStatus){self.onCanvas.VRT.Refresh();var arrCanvas=self.VRT.mng.GetCanvas(),ptData=(annStatus.viewport.image=annStatus.images[0],CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[1].canvas),annStatus.viewport.scale1=annStatus.viewport.scale,self.onCanvas.VRT.DrawCanvasLine(arrCanvas[1],{point:self.VRT.ptO,lcolor:"#0F0",vcolor:"#00F"}),self.onCanvas.VRT.GetMapCoord({type:CBoBo.MPR_ORIGINAL,point:self.VRT.ptO,index:self.VRT.oIndex}));annStatus.viewport.image=annStatus.images[180],CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[2].canvas,!1,!1,!0),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[2],ptData[CBoBo.MPR_LEVEL]),annStatus.viewport.scale2=annStatus.viewport.scale,annStatus.viewport.image=annStatus.images[90],CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[3].canvas,!1,!1,!0),self.onCanvas.VRT.DrawCanvasLine(arrCanvas[3],ptData[CBoBo.MPR_VERTICAl]),annStatus.viewport.scale3=annStatus.viewport.scale,annStatus.viewport.image=annStatus.images[0],annStatus.viewport.scale=annStatus.viewport.scale1,arrCanvas[1].DrawCornerInfo(annStatus.viewport),annStatus.viewport.scale=annStatus.viewport.scale2,arrCanvas[2].DrawCornerInfo(annStatus.viewport),annStatus.viewport.scale=annStatus.viewport.scale3,arrCanvas[3].DrawCornerInfo(annStatus.viewport)},this.onCanvas.VRT.Rotate=function(event){var clientX,touch,obj,deltaX=(touch="touchmove"==event.type?new Point((touch=event.originalEvent.targetTouches[0]).pageX,touch.pageY):new Point(event.pageX,event.pageY)).x-self.VRT.ptLast.x,deltaY=touch.y-self.VRT.ptLast.y;0==deltaX&&0==deltaY||(deltaX=self.VRT.ptLast.x,deltaY=self.VRT.ptLast.y,self.VRT.ptLast=touch,touch=event.self.canvas.getBoundingClientRect(),clientX=parseInt(touch.left+window.pageXOffset),touch=parseInt(touch.top+window.pageYOffset),(obj={Cmd:1}).LastPosition=new Array,obj.LastPosition[0]=deltaX-clientX,obj.LastPosition[1]=deltaY-touch,obj.NowPosition=new Array,obj.NowPosition[0]=event.pageX-clientX,obj.NowPosition[1]=event.pageY-touch,self.onCanvas.VRT.WebDcmSocket.send(JSON.stringify(obj)))},this.onCanvas.VRT.Pan=function(event){var clientX,touch,obj,deltaX=(touch="touchmove"==event.type?new Point((touch=event.originalEvent.targetTouches[0]).pageX,touch.pageY):new Point(event.pageX,event.pageY)).x-self.VRT.ptLast.x,deltaY=touch.y-self.VRT.ptLast.y;0==deltaX&&0==deltaY||(deltaX=self.VRT.ptLast.x,deltaY=self.VRT.ptLast.y,self.VRT.ptLast=touch,clientX=(touch=event.self.canvas.getBoundingClientRect()).left+window.pageXOffset,touch=touch.top+window.pageYOffset,(obj={Cmd:2}).LastPosition=new Array,obj.LastPosition[0]=deltaX-clientX,obj.LastPosition[1]=deltaY-touch,obj.NowPosition=new Array,obj.NowPosition[0]=event.pageX-clientX,obj.NowPosition[1]=event.pageY-touch,self.onCanvas.VRT.WebDcmSocket.send(JSON.stringify(obj)))},this.onCanvas.VRT.WindowsLevel=function(event){var clientX,touch,obj,deltaX=(touch="touchmove"==event.type?new Point((touch=event.originalEvent.targetTouches[0]).pageX,touch.pageY):new Point(event.pageX,event.pageY)).x-self.VRT.ptLast.x,deltaY=touch.y-self.VRT.ptLast.y;0==deltaX&&0==deltaY||(deltaX=self.VRT.ptLast.x,deltaY=self.VRT.ptLast.y,self.VRT.ptLast=touch,clientX=(touch=event.self.canvas.getBoundingClientRect()).left+window.pageXOffset,touch=touch.top+window.pageYOffset,(obj={Cmd:4}).LastPosition=new Array,obj.LastPosition[0]=deltaX-clientX,obj.LastPosition[1]=deltaY-touch,obj.NowPosition=new Array,obj.NowPosition[0]=event.pageX-clientX,obj.NowPosition[1]=event.pageY-touch,self.onCanvas.VRT.WebDcmSocket.send(JSON.stringify(obj)))},this.onCanvas.VRT.Zoom=function(event){var obj={Cmd:3};obj.DeltaY=event.deltaY,self.onCanvas.VRT.WebDcmSocket.send(JSON.stringify(obj))},this.onCanvas.VRT.Reset=function(){var obj={Cmd:0};self.onCanvas.VRT.WebDcmSocket.send(JSON.stringify(obj))},this.onCanvas.VRT.Refresh=function(){var obj={Cmd:99};self.onCanvas.VRT.WebDcmSocket.send(JSON.stringify(obj))},this.onCanvas.VRT.KnifeMove=function(event){var touch,clientX,clientY,obj,deltaX=(touch="touchmove"==event.type?new Point((touch=event.originalEvent.targetTouches[0]).pageX,touch.pageY):new Point(event.pageX,event.pageY)).x-self.VRT.ptLast.x,deltaY=touch.y-self.VRT.ptLast.y;0==deltaX&&0==deltaY||(deltaX=self.VRT.ptLast.x,deltaY=self.VRT.ptLast.y,self.VRT.ptLast=touch,clientX=(touch=event.self.canvas.getBoundingClientRect()).left+window.pageXOffset,clientY=touch.top+window.pageYOffset,(obj={Cmd:5}).LastPosition=new Array,obj.LastPosition[0]=deltaX-clientX,obj.LastPosition[1]=deltaY-clientY,obj.NowPosition=new Array,obj.ViewWidth=touch.width,obj.ViewHeight=touch.height,obj.NowPosition[0]=event.pageX-clientX,obj.NowPosition[1]=event.pageY-clientY,self.onCanvas.VRT.WebDcmSocket.send(JSON.stringify(obj)))},this.onCanvas.VRT.KnifeEnd=function(){var obj={Cmd:8};self.onCanvas.VRT.WebDcmSocket.send(JSON.stringify(obj))},this.onCanvas.VRT.KnifeBegin=function(option){var obj;"KnifeIn"==option&&(obj={Cmd:7},self.onCanvas.VRT.WebDcmSocket.send(JSON.stringify(obj))),"KnifeOut"==option&&(obj={Cmd:6},self.onCanvas.VRT.WebDcmSocket.send(JSON.stringify(obj)))},this.onTool.VRT={type:""},this.onTool.VRT.MsgTransform=function(event){var toolType=event.usermsg||event.target.title;switch(toolType){case"手术刀内":self.onCanvas.VRT.KnifeBegin("KnifeIn"),self.toolBar.ChangeBtnStatus(event.btntitle,event.btnforce);break;case"手术刀外":self.onCanvas.VRT.KnifeBegin("KnifeOut"),self.toolBar.ChangeBtnStatus(event.btntitle,event.btnforce);break;case"重置三维视图":self.onCanvas.VRT.Reset()}self.onTool.VRT.type=toolType},this.onCanvas.Mpr={},this.onCanvas.Mpr.MsgTransform=function(event){if(self.Mpr.bMsg||"drag"===event.type)switch(event.type){case"touchstart":case"mousedown":var touch;"touchstart"===event.type?(touch=new Point((touch=event.originalEvent.targetTouches[0]).pageX,touch.pageY),self.onCanvas.which=1):(touch=new Point(event.pageX,event.pageY),self.onCanvas.which=event.which),self.Mpr.ptLast=touch,self.onCanvas.Mpr.MouseDown(event);break;case"touchmove":case"mousemove":0!==self.onCanvas.which&&self.onCanvas.Mpr.MouseDownMove(event);break;case"touchend":case"mouseup":case"mouseout":self.onCanvas.Mpr.MouseUp(event),self.onCanvas.which=0;break;case"click":break;case"dblclick":case"doubletap":break;case"mousewheel":self.onCanvas.Mpr.MouseWheel(event);break;case"drag":self.onCanvas.Mpr.DragImage(event.imgId)}},this.onCanvas.Mpr.MouseDown=function(event){if(1===self.onCanvas.which)switch(self.onTool.Mpr.type){case"切面调窗":break;case"十字切面":self.onCanvas.Mpr.Slicing(event);break;case"CPR曲线":self.onCanvas.Mpr.curvePoints=[];var pt=CBoBo.Annotation.PageCoods2Canvas(event.self.canvas,self.Mpr.ptLast.x,self.Mpr.ptLast.y);self.onCanvas.Mpr.curvePoints.push(pt)}},this.onCanvas.Mpr.MouseDownMove=function(event){if(1===self.onCanvas.which)switch(self.onTool.Mpr.type){case"切面调窗":self.onCanvas.Mpr.WW(event);break;case"十字切面":self.onCanvas.Mpr.Slicing(event);break;case"CPR直线":self.onCanvas.Mpr.CprLine(event);break;case"CPR曲线":self.onCanvas.Mpr.CprCurve(event);break;case"切图":self.onCanvas.Mpr.MoveMpr(event)}else 3===self.onCanvas.which&&self.onCanvas.Mpr.WW(event)},this.onCanvas.Mpr.MouseUp=function(event){if(1===self.onCanvas.which&&"切面调窗"!==self.onTool.Mpr.type&&"十字切面"!==self.onTool.Mpr.type&&"切图"!==self.onTool.Mpr.type){var newDicom,annStatus=self.Mpr.mng.AnnStatusMng(),index=self.Mpr.mng.GetEventImageIndex(event.self);switch(index){case 0:annStatus.viewport.image=annStatus.images[0];break;case 1:annStatus.viewport.image=annStatus.images[90];break;case 2:annStatus.viewport.image=annStatus.images[180];break;case 3:return}switch(CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,event.self.canvas,!0,!0,!0),self.onTool.Mpr.type){case"CPR直线":touch="touchend"==event.type?new Point((touch=event.originalEvent.targetTouches[0]).pageX,touch.pageY):new Point(event.pageX,event.pageY);var touch,ptStart=CBoBo.ImageProcessor.PageToPixel(annStatus.viewport,event.self.canvas,self.Mpr.ptLast.x,self.Mpr.ptLast.y),ptEnd=CBoBo.ImageProcessor.PageToPixel(annStatus.viewport,event.self.canvas,touch.x,touch.y),points=CBoBo.Mpr.GetPointsFromLine(ptStart,ptEnd);switch(index){case 0:newDicom=CBoBo.Mpr.GenerateNormalPlane(self.Mpr.Series(),points);break;case 1:newDicom=CBoBo.Mpr.GenerateSlopePlane(self.Mpr.Series(),ptStart,ptEnd,90);break;case 2:newDicom=CBoBo.Mpr.GenerateSlopePlane(self.Mpr.Series(),ptStart,ptEnd,180);break;case 3:return}break;case"CPR曲线":for(var imgpoints=[],points=($.each(self.onCanvas.Mpr.curvePoints,function(){var pt=CBoBo.ImageProcessor.PageToPixel(annStatus.viewport,event.self.canvas,this.x,this.y,"cpr");imgpoints.push(pt)}),[]),i=0;i<imgpoints.length;i++){var pt1=imgpoints[i],pt2=imgpoints[i+1];if(void 0===pt2)break;pt1=CBoBo.Mpr.GetPointsFromLine(pt1,pt2);$.each(pt1,function(){points.push(this)})}switch(console.log(points.length),index){case 0:newDicom=CBoBo.Mpr.GenerateNormalPlane(self.Mpr.Series(),points);break;case 1:case 2:newDicom=CBoBo.Mpr.GenerateSurface(self.Mpr.Series(),points);break;case 3:return}}annStatus.viewport.image=newDicom;var arrCanvas=self.Mpr.mng.GetCanvas();CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[3].canvas,!0,!1,!0)}},this.onCanvas.Mpr.Slicing=function(event){point="touchmove"==event.type||"touchstart"==event.type?new Point((touch=event.originalEvent.targetTouches[0]).pageX,touch.pageY):new Point(event.pageX,event.pageY);var touch,point,pt,dicom,canvas=event.self.canvas,annStatus=self.Mpr.mng.AnnStatusMng(),status=annStatus.viewport,arrCanvas=self.Mpr.mng.GetCanvas();self.Mpr.Series();switch(self.Mpr.mng.GetEventImageIndex(event.self)){case CBoBo.MPR_ORIGINAL:status.image=annStatus.images[0],status.scale=status.scale1,pt=CBoBo.ImageProcessor.PageToPixel(status,canvas,point.x,point.y),CBoBo.ImageProcessor.FitCanvas(status,canvas),self.onCanvas.Mpr.DrawCanvasLine(event.self,{point:pt,lcolor:"#0F0",vcolor:"#00F"}),self.Mpr.ptO=pt;var ptData=self.onCanvas.Mpr.GetMapCoord({type:CBoBo.MPR_ORIGINAL,point:pt,index:self.Mpr.oIndex});self.onCanvas.Mpr.DrawMprDicom(arrCanvas[1],pt,180),self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[1],ptData[CBoBo.MPR_LEVEL]),self.onCanvas.Mpr.DrawMprDicom(arrCanvas[2],pt,90),self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[2],ptData[CBoBo.MPR_VERTICAl]);break;case CBoBo.MPR_LEVEL:status.image=annStatus.images[180],status.scale=status.scale2,pt=CBoBo.ImageProcessor.PageToPixel(status,canvas,point.x,point.y),self.Mpr.ptL=pt,CBoBo.ImageProcessor.FitCanvas(status,arrCanvas[1].canvas,!1,!1,!0),self.onCanvas.Mpr.DrawCanvasLine(event.self,{point:pt,lcolor:"#F00",vcolor:"#00F"}),self.Mpr.oIndex=pt.y,(dicom=CBoBo.Mpr.GenerateMipNomalPlane(self.Mpr.Series(),self.Mpr.oIndex-1,self.onTool.Mpr.thicKness,self.onTool.Mpr.Miptype))&&(ptData=self.onCanvas.Mpr.GetMapCoord({type:CBoBo.MPR_LEVEL,point:pt}),status.image=dicom,annStatus.images[0]=dicom,CBoBo.ImageProcessor.FitCanvas(status,arrCanvas[0].canvas),self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[0],ptData[CBoBo.MPR_ORIGINAL]),self.onCanvas.Mpr.DrawMprDicom(arrCanvas[2],self.Mpr.ptO,90),self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[2],ptData[CBoBo.MPR_VERTICAl]));break;case CBoBo.MPR_VERTICAl:status.image=annStatus.images[90],status.scale=status.scale3,pt=CBoBo.ImageProcessor.PageToPixel(status,canvas,point.x,point.y),self.Mpr.ptV=pt,CBoBo.ImageProcessor.FitCanvas(status,arrCanvas[2].canvas,!1,!1,!0),self.onCanvas.Mpr.DrawCanvasLine(event.self,{point:pt,lcolor:"#F00",vcolor:"#0F0"}),self.Mpr.oIndex=pt.y,(dicom=CBoBo.Mpr.GenerateMipNomalPlane(self.Mpr.Series(),self.Mpr.oIndex-1,self.onTool.Mpr.thicKness,self.onTool.Mpr.Miptype))&&(ptData=self.onCanvas.Mpr.GetMapCoord({type:CBoBo.MPR_VERTICAl,point:pt}),status.image=dicom,annStatus.images[0]=dicom,CBoBo.ImageProcessor.FitCanvas(status,arrCanvas[0].canvas),self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[0],ptData[CBoBo.MPR_ORIGINAL]),self.onCanvas.Mpr.DrawMprDicom(arrCanvas[1],self.Mpr.ptO,180),self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[1],ptData[CBoBo.MPR_LEVEL]))}},this.onCanvas.Mpr.CprCurve=function(event){var annStatus,ctx,touch;self.Mpr.mng.GetCanvas()[3]!==event.self&&(touch="touchmove"==event.type||"touchstart"==event.type?new Point((touch=event.originalEvent.targetTouches[0]).pageX,touch.pageY):new Point(event.pageX,event.pageY),annStatus=self.Mpr.mng.AnnStatusMng(),self.onCanvas.Mpr.UpdateCanvas(annStatus),annStatus=CBoBo.Annotation.PageCoods2Canvas(event.self.canvas,touch.x,touch.y),self.onCanvas.Mpr.curvePoints.push(annStatus),(ctx=event.self.canvas.getContext("2d")).beginPath(),ctx.strokeStyle="#FF0",touch=self.onCanvas.Mpr.curvePoints[0],ctx.moveTo(touch.x,touch.y),$.each(self.onCanvas.Mpr.curvePoints,function(){ctx.lineTo(this.x,this.y)}),ctx.stroke())},this.onCanvas.Mpr.CprLine=function(event){var annStatus,touch;self.Mpr.mng.GetCanvas()[3]!==event.self&&(touch="touchmove"==event.type||"touchstart"==event.type?new Point((touch=event.originalEvent.targetTouches[0]).pageX,touch.pageY):new Point(event.pageX,event.pageY),annStatus=self.Mpr.mng.AnnStatusMng(),self.onCanvas.Mpr.UpdateCanvas(annStatus),annStatus=CBoBo.Annotation.PageCoods2Canvas(event.self.canvas,self.Mpr.ptLast.x,self.Mpr.ptLast.y),touch=CBoBo.Annotation.PageCoods2Canvas(event.self.canvas,touch.x,touch.y),self.onCanvas.Mpr.DrawCprLine(event.self,annStatus,touch))},this.onCanvas.Mpr.DrawCprLine=function(dvCanvas,ptStart,ptEnd){dvCanvas=dvCanvas.canvas.getContext("2d");dvCanvas.beginPath(),dvCanvas.strokeStyle="#FF0",dvCanvas.moveTo(ptStart.x,ptStart.y),dvCanvas.lineTo(ptEnd.x,ptEnd.y),dvCanvas.stroke()},this.onCanvas.Mpr.WW=function(event){var touch,status,event=(touch="touchmove"==event.type?new Point((touch=event.originalEvent.targetTouches[0]).pageX,touch.pageY):new Point(event.pageX,event.pageY)).x-self.Mpr.ptLast.x,deltaY=touch.y-self.Mpr.ptLast.y;0==event&&0==deltaY||(self.Mpr.ptLast=touch,(status=(touch=self.Mpr.mng.AnnStatusMng()).viewport).ww+=parseInt(event/status.scale),status.wc+=parseInt(deltaY/status.scale),status.ww<2&&(status.ww=2),self.onCanvas.Mpr.UpdateCanvas(touch))},this.onCanvas.Mpr.UpdateCanvas=function(annStatus){var arrCanvas=self.Mpr.mng.GetCanvas(),ptData=(annStatus.viewport.image=annStatus.images[0],CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[0].canvas),self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[0],{point:self.Mpr.ptO,lcolor:"#0F0",vcolor:"#00F"}),self.onCanvas.Mpr.GetMapCoord({type:CBoBo.MPR_ORIGINAL,point:self.Mpr.ptO,index:self.Mpr.oIndex}));annStatus.viewport.image=annStatus.images[180],CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[1].canvas,!1,!1,!0),self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[1],ptData[CBoBo.MPR_LEVEL]),annStatus.viewport.image=annStatus.images[90],CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[2].canvas,!1,!1,!0),self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[2],ptData[CBoBo.MPR_VERTICAl]),annStatus.viewport.image=annStatus.images[0],arrCanvas[0].DrawCornerInfo(annStatus.viewport),arrCanvas[1].DrawCornerInfo(annStatus.viewport),arrCanvas[2].DrawCornerInfo(annStatus.viewport)},this.onCanvas.Mpr.MouseWheel=function(event){console.log("MouseWheel");var arrCanvas=self.Mpr.mng.GetCanvas(),deltaY=event.deltaY,arrImages=self.Mpr.Series(),annStatus=self.Mpr.mng.AnnStatusMng();switch(index=self.Mpr.mng.GetEventImageIndex(event.self)){case CBoBo.MPR_ORIGINAL:var index=self.Mpr.oIndex;self.Mpr.oIndex=0<deltaY?--self.Mpr.oIndex<1?1:self.Mpr.oIndex:++self.Mpr.oIndex>arrImages.length?arrImages.length:self.Mpr.oIndex,index!==self.Mpr.oIndex&&(dicom=CBoBo.Mpr.GenerateMipNomalPlane(self.Mpr.Series(),self.Mpr.oIndex-1,self.onTool.Mpr.thicKness,self.onTool.Mpr.Miptype),annStatus.viewport.image=dicom,annStatus.images[0]=dicom,CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,event.self.canvas),self.onCanvas.Mpr.DrawCanvasLine(event.self,{point:self.Mpr.ptO,lcolor:"#0F0",vcolor:"#00F"}),ptData=self.onCanvas.Mpr.GetMapCoord({type:CBoBo.MPR_ORIGINAL,point:self.Mpr.ptO,index:self.Mpr.oIndex}),annStatus.viewport.image=annStatus.images[180],CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[1].canvas,!1,!1,!0),self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[1],ptData[CBoBo.MPR_LEVEL]),annStatus.viewport.scale=1,annStatus.viewport.image=annStatus.images[90],CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[2].canvas,!1,!1,!0),self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[2],ptData[CBoBo.MPR_VERTICAl]),annStatus.viewport.image=annStatus.images[0],arrCanvas[0].DrawCornerInfo(annStatus.viewport),arrCanvas[1].DrawCornerInfo(annStatus.viewport),arrCanvas[2].DrawCornerInfo(annStatus.viewport));break;case CBoBo.MPR_LEVEL:var dicom=arrImages[0],height=parseInt(dicom.row),index=self.Mpr.ptO.y;self.Mpr.ptO.y=0<deltaY?--self.Mpr.ptO.y<1?1:self.Mpr.ptO.y:++self.Mpr.ptO.y>height?height:self.Mpr.ptO.y,self.Mpr.ptV.x=self.Mpr.ptO.y,index!==self.Mpr.ptO.y&&(ptData=self.onCanvas.Mpr.GetMapCoord({type:CBoBo.MPR_ORIGINAL,point:self.Mpr.ptO,index:self.Mpr.oIndex}),self.onCanvas.Mpr.DrawMprDicom(arrCanvas[1],self.Mpr.ptO,180),self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[1],ptData[CBoBo.MPR_LEVEL]),annStatus.viewport.image=annStatus.images[90],CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[2].canvas,!1,!1,!0),self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[2],ptData[CBoBo.MPR_VERTICAl]),ptData=self.onCanvas.Mpr.GetMapCoord({type:CBoBo.MPR_VERTICAl,point:self.Mpr.ptV}),dicom=CBoBo.Mpr.GenerateMipNomalPlane(self.Mpr.Series(),self.Mpr.oIndex-1,self.onTool.Mpr.thicKness,self.onTool.Mpr.Miptype),annStatus.viewport.image=dicom,annStatus.images[0]=dicom,CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[0].canvas),self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[0],ptData[CBoBo.MPR_ORIGINAL]));break;case CBoBo.MPR_VERTICAl:dicom=arrImages[0];var ptData,height=parseInt(dicom.col),index=self.Mpr.ptO.x;self.Mpr.ptO.x=0<deltaY?--self.Mpr.ptO.x<1?1:self.Mpr.ptO.x:++self.Mpr.ptO.x>height?height:self.Mpr.ptO.x,self.Mpr.ptL.x=self.Mpr.ptO.x,index!==self.Mpr.ptO.x&&(ptData=self.onCanvas.Mpr.GetMapCoord({type:CBoBo.MPR_ORIGINAL,point:self.Mpr.ptO,index:self.Mpr.oIndex}),self.onCanvas.Mpr.DrawMprDicom(arrCanvas[2],self.Mpr.ptO,90),self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[2],ptData[CBoBo.MPR_VERTICAl]),annStatus.viewport.image=annStatus.images[180],CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[1].canvas,!1,!1,!0),self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[1],ptData[CBoBo.MPR_LEVEL]),ptData=self.onCanvas.Mpr.GetMapCoord({type:CBoBo.MPR_LEVEL,point:self.Mpr.ptL}),dicom=CBoBo.Mpr.GenerateMipNomalPlane(self.Mpr.Series(),self.Mpr.oIndex-1,self.onTool.Mpr.thicKness,self.onTool.Mpr.Miptype),annStatus.viewport.image=dicom,annStatus.images[0]=dicom,CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,arrCanvas[0].canvas),self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[0],ptData[CBoBo.MPR_ORIGINAL]));break;case CBoBo.MPR_ANY:}},this.onCanvas.Mpr.MoveMpr=function(event){console.log("MoveMpr"),(touch="touchmove"==event.type?new Point((touch=event.originalEvent.targetTouches[0]).pageX,touch.pageY):new Point(event.pageX,event.pageY)).x,self.Mpr.ptLast.x;var touch,arrImages,annStatus,index,deltaY=touch.y-self.Mpr.ptLast.y;0!=deltaY&&(self.Mpr.ptLast=touch,touch=self.Mpr.mng.GetCanvas(),arrImages=self.Mpr.Series(),annStatus=self.Mpr.mng.AnnStatusMng(),(index=self.Mpr.mng.GetEventImageIndex(event.self))===CBoBo.MPR_ORIGINAL)&&(index=self.Mpr.oIndex,self.Mpr.oIndex=0<deltaY?--self.Mpr.oIndex<1?1:self.Mpr.oIndex:++self.Mpr.oIndex>arrImages.length?arrImages.length:self.Mpr.oIndex,index!==self.Mpr.oIndex)&&(deltaY=arrImages[self.Mpr.oIndex-1],annStatus.viewport.image=deltaY,annStatus.images[0]=deltaY,CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,event.self.canvas),self.onCanvas.Mpr.DrawCanvasLine(event.self,{point:self.Mpr.ptO,lcolor:"#0F0",vcolor:"#00F"}),index=self.onCanvas.Mpr.GetMapCoord({type:CBoBo.MPR_ORIGINAL,point:self.Mpr.ptO,index:self.Mpr.oIndex}),annStatus.viewport.image=annStatus.images[180],CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,touch[1].canvas,!1,!1,!0),self.onCanvas.Mpr.DrawCanvasLine(touch[1],index[CBoBo.MPR_LEVEL]),annStatus.viewport.scale=1,annStatus.viewport.image=annStatus.images[90],CBoBo.ImageProcessor.FitCanvas(annStatus.viewport,touch[2].canvas,!1,!1,!0),self.onCanvas.Mpr.DrawCanvasLine(touch[2],index[CBoBo.MPR_VERTICAl]),annStatus.viewport.image=annStatus.images[0],touch[0].DrawCornerInfo(annStatus.viewport),touch[1].DrawCornerInfo(annStatus.viewport),touch[2].DrawCornerInfo(annStatus.viewport))},this.onCanvas.Mpr.DragImage=function(imgId,init=!0){self.onCanvas.Mpr.LoadingAnimation(!0);var series=self.dataManager.GetSeries(imgId);if(series){var images=series.GetAllDicom();if(images.length<10)$.Msg("重建的序列图像不能小于10张！",CBoBo.MSG_ALERT),self.onCanvas.Mpr.Clear();else{for(var bFond=!1,i=0;i<images.length;i++)if(!images[i].bLoadImage){bFond=!0;break}bFond?(init&&(self.downLoadCurrentSeriesHandle(images),$.Msg("请等待，该组序列图像正在下载中...",CBoBo.MSG_ALERT)),self.onCanvas.Mpr.Clear(),setTimeout(()=>{this.DragImage(imgId,!1)},2e3)):(self.onCanvas.Mpr.LoadingAnimation(),self.Mpr.Series(images),self.onCanvas.Mpr.InitCanvas())}}else $.Msg("不能进行MPR重建！")},this.onCanvas.Mpr.LoadingAnimation=function(open){var arrCanvas=self.Mpr.mng.GetCanvas();if(void 0!==arrCanvas)for(const canvas of arrCanvas)open?canvas.StartLoadingAnimation():canvas.StopLoadingAnimation()},this.onCanvas.Mpr.InitCanvas=function(){var annStatus,images,dicom,canvas,arrCanvas=self.Mpr.mng.GetCanvas();void 0!==arrCanvas&&(images=self.Mpr.Series())&&(annStatus=CBoBo.AnnStatusManager.Create(images[0],"","",!0),self.Mpr.mng.AnnStatusMng(annStatus),canvas=arrCanvas[0],images=Math.floor(images.length/2),self.Mpr.oIndex=images,dicom=CBoBo.Mpr.GenerateMipNomalPlane(self.Mpr.Series(),images-1,self.onTool.Mpr.thicKness,self.onTool.Mpr.Miptype),annStatus.viewport.image=dicom,annStatus.images[0]=dicom,CBoBo.ImageProcessor.Restore(annStatus.viewport).FitCanvas(annStatus.viewport,canvas.canvas),annStatus.viewport.scale1=annStatus.viewport.scale,canvas.DrawCornerInfo(annStatus.viewport),dicom=new Point(parseInt(dicom.col)>>1,parseInt(dicom.row)>>1),self.Mpr.ptO=dicom,self.onCanvas.Mpr.DrawCanvasLine(canvas,{point:dicom,lcolor:"#0F0",vcolor:"#00F"}),canvas=self.onCanvas.Mpr.GetMapCoord({type:CBoBo.MPR_ORIGINAL,point:dicom,index:images}),self.onCanvas.Mpr.DrawMprDicom(arrCanvas[1],dicom,180),annStatus.viewport.scale2=annStatus.viewport.scale,self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[1],canvas[CBoBo.MPR_LEVEL]),arrCanvas[1].DrawCornerInfo(annStatus.viewport),self.onCanvas.Mpr.DrawMprDicom(arrCanvas[2],dicom,90),annStatus.viewport.scale3=annStatus.viewport.scale,self.onCanvas.Mpr.DrawCanvasLine(arrCanvas[2],canvas[CBoBo.MPR_VERTICAl]),arrCanvas[2].DrawCornerInfo(annStatus.viewport),self.Mpr.ptL=canvas[CBoBo.MPR_LEVEL].point,self.Mpr.ptV=canvas[CBoBo.MPR_VERTICAl].point)},this.onCanvas.Mpr.DrawCanvasLine=function(dvCanvas,data){var canvas,status,ptImg,lcolor,ptImgVerticalStart,dicom,ptImgRowStart,imgWidth;if(void 0!==data)return canvas=dvCanvas.canvas,dvCanvas=dvCanvas.canvas.getContext("2d"),dicom=(status=self.Mpr.mng.AnnStatusMng().viewport).image,ptImg=data.point,lcolor=data.lcolor,data=data.vcolor,imgWidth=dicom.col,dicom=dicom.row,ptImgRowStart=new Point(0,ptImg.y),imgWidth=new Point(imgWidth,ptImg.y),ptImgVerticalStart=new Point(ptImg.x,0),dicom=new Point(ptImg.x,dicom),ptImgRowStart=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,ptImgRowStart),imgWidth=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,imgWidth),dvCanvas.setTransform(1,0,0,1,0,0),dvCanvas.save(),dvCanvas.strokeStyle=lcolor,Line(dvCanvas,ptImgRowStart,imgWidth),ptImgRowStart=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,ptImgVerticalStart),imgWidth=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,dicom),dvCanvas.strokeStyle=data,Line(dvCanvas,ptImgRowStart,imgWidth),dvCanvas.restore(),ptImg;function Line(ctx,p,p2){ctx.beginPath(),ctx.moveTo(p.x,p.y),ctx.lineTo(p2.x,p2.y),ctx.stroke()}},this.onCanvas.Mpr.DrawMprDicom=function(dvCanvas,point,angle){var ptStart={},ptEnd={},images=self.Mpr.Series();images&&(90===angle?(ptStart.x=point.x,ptStart.y=0,ptEnd.x=point.x,ptEnd.y=images[0].row):(ptStart.x=0,ptStart.y=point.y,ptEnd.x=images[0].col,ptEnd.y=point.y),images=CBoBo.Mpr.GetPointsFromLine(ptStart,ptEnd),point=CBoBo.Mpr.GenerateNormalPlane(self.Mpr.Series(),images,self.onTool.Mpr.thicKness,self.onTool.Mpr.Miptype),(ptStart=self.Mpr.mng.AnnStatusMng()).images[angle]=point,ptStart.viewport.image=point,CBoBo.ImageProcessor.FitCanvas(ptStart.viewport,dvCanvas.canvas,!1,!1,!0))},this.onCanvas.Mpr.GetMprDicom=function(images,point,angle){var buff,width=images[0].col,height=images[0].row,sliceth=parseFloat(images[0].sliceth),pixy=parseFloat(images[0].pixy),newDicom=new DVDicomInfo,index=(newDicom.SetInfo({data:images[0]}),newDicom.pixy=sliceth,newDicom.sliceth=pixy,newDicom.id=CBoBo.Plugin.GetRandom(),angle%180==0?(newDicom.row=images.length,newDicom.col=width):angle%90==0&&(newDicom.row=images.length,newDicom.col=height),newDicom.pixsBuffer=new Int16Array(newDicom.row*newDicom.col),0),start=width*point.y;return $.each(images,function(i,dicom){if(buff=dicom.pixsBuffer,angle%180==0)for(i=0;i<width;i++){var pix=buff[i+start];newDicom.pixsBuffer[index]=pix,index++}else if(angle%90==0)for(i=0;i<height;i++){pix=buff[i*width+point.x];newDicom.pixsBuffer[index]=pix,index++}}),newDicom.setPixsBuffer(newDicom.pixsBuffer),newDicom},this.onCanvas.Mpr.GetMapCoord=function(option){if(null!=option){var retData={};switch(option.type){case CBoBo.MPR_ORIGINAL:var point=option.point,index=option.index;(data=retData[CBoBo.MPR_LEVEL]={}).point=new Point(point.x,index),data.lcolor="#F00",data.vcolor="#00F",(data=retData[CBoBo.MPR_VERTICAl]={}).point=new Point(point.y,index),data.lcolor="#F00",data.vcolor="#0F0";break;case CBoBo.MPR_LEVEL:var point=option.point,data=retData[CBoBo.MPR_ORIGINAL]={},data=(self.Mpr.ptO.x=point.x,data.point=self.Mpr.ptO,data.lcolor="#0F0",data.vcolor="#00F",retData[CBoBo.MPR_VERTICAl]={});self.Mpr.ptV.y=point.y,data.point=self.Mpr.ptV,data.lcolor="#F00",data.vcolor="#0F0";break;case CBoBo.MPR_VERTICAl:index=option.point,data=retData[CBoBo.MPR_ORIGINAL]={},data=(self.Mpr.ptO.y=index.x,data.point=self.Mpr.ptO,data.lcolor="#0F0",data.vcolor="#00F",retData[CBoBo.MPR_LEVEL]={});self.Mpr.ptL.y=index.y,data.point=self.Mpr.ptL,data.lcolor="#F00",data.vcolor="#00F";break;case CBoBo.MPR_ANY:}return retData}},this.onCanvas.Mpr.Clear=function(){self.Mpr.mng.AnnStatusMng(null);var arrCanvas=self.Mpr.mng.GetCanvas();void 0!==arrCanvas&&($.each(arrCanvas,function(i,canvas){canvas.canvas.width=canvas.canvas.width,canvas.DrawCornerInfo()}),self.Mpr.bMsg=!1)},this.onCanvas.Mpr.MipCreat=function(thicKness,blendMode){alert(thicKness+blendMode)},this.onTool.Mpr={type:"十字切面",Miptype:void 0,thicKness:1},this.onTool.Mpr.MsgTransform=function(event){var annStatus,toolType=event.usermsg||event.target.title;switch(toolType){case"CPR直线":case"CPR曲线":self.Mpr.SetLayout(4);break;case"切面调窗":return"切面调窗"!=self.onTool.Mpr.type&&self.toolBar.ChangeBtnStatus(self.onTool.Mpr.type),self.onTool.Mpr.type="切面调窗",self.Mpr.SetLayout(3),void self.onCanvas.Mpr.InitCanvas();case"十字切面":"十字切面"!=self.onTool.Mpr.type&&self.toolBar.ChangeBtnStatus(self.onTool.Mpr.type),self.onTool.Mpr.type="十字切面",self.Mpr.SetLayout(3);case"倒序":return self.Mpr.Series().reverse(),void self.onCanvas.Mpr.InitCanvas();case"最大密度投影":case"最小密度投影":case"平均密度投影":self.onTool.Mpr.Miptype=toolType;break;case"层厚":self.onTool.Mpr.thicKness=event.target.value}if("层厚"!=toolType&&!1===self.toolBar.ChangeBtnStatus(event.btntitle,event.btnforce))return self.onTool.Mpr.type="十字切面",void(null!=self.onTool.Mpr.Miptype&&(self.onTool.Mpr.Miptype=void 0,self.onCanvas.Mpr.InitCanvas()));"平均密度投影"!=toolType&&"最小密度投影"!=toolType&&"最大密度投影"!=toolType&&"层厚"!=toolType&&(self.onTool.Mpr.type=toolType),null!=self.onTool.Mpr.Miptype&&1!=self.onTool.Mpr.thicKness?self.onCanvas.Mpr.InitCanvas():(annStatus=self.Mpr.mng.AnnStatusMng(),self.onCanvas.Mpr.UpdateCanvas(annStatus))},this.PrintView={},this.PrintView.MsgTransform=function(event){if(event.self){var webWorkerType=event.self.webWorkerType;switch(event.type){case"dblclick":case"doubletap":case"mousewheel":return;case"message":webWorkerType==CBoBo.PTYPE_JPG?self.onCanvas.Jpg.DrawImage(event):self.onCanvas.DrawDicom(event)}(webWorkerType==CBoBo.PTYPE_JPG?self.onCanvas.Jpg:self.onCanvas).MsgTransform(event)}else switch(event.toolbtnresponse&&self.onTool.MsgTransform(event),event.type){case"click":return;case"draw":var arrAnnStatus=event.arrannstatus,arrCanvas=event.arrcanvas;self.FlushAnnStatusForCanvas(arrAnnStatus,arrCanvas,event.bforce,!0)}},this.Assist={},this.Assist.MsgTransform=function(event){if("object"==typeof event)switch(event.type){case"btnfocus":self.toolBar.ChangeBtnStatus(event.btntitle,event.btnforce);break;case"command":self.Assist.AnalyzeStatus(event.data);break;case"addstudy":var status=self.Assist.GetTransferStatus();self.assistDiagnose.SendCommand(status)}},this.Assist.GetTransferStatus=function(){var defaultStatus={wadourl:"",hospid:"",studyuid:"",mode:"2d",bd:{mode:0,layout:{row:1,col:1,arrlayout:[]},focus:{index1:1,index2:1},bshowcornerinfo:1,annstatus:[]}},m_dicomstatus={voi:{ww:0,wc:0},translation:{x:0,y:0},invert:0,rotation:0,pseudocolor:"",arrann:{}},study=self.dataManager.GetStudy(0);return defaultStatus.studyuid=study.stuuid,defaultStatus.wadourl=study.wadourl,defaultStatus.hospid=study.hospid,void 0!==self.Mpr&&self.Mpr.bShow?defaultStatus.mode="mpr":defaultStatus.mode="2d","2d"==defaultStatus.mode?(defaultStatus.bd.mode=self.mode,defaultStatus.bd.mode==CBoBo.PTYPE_SERIES?(defaultStatus.bd.layout.row=self.canvasManager.nLayoutRow,defaultStatus.bd.layout.col=self.canvasManager.nLayoutCol,defaultStatus.bd.focus.index1=self.canvasManager.focusIndex,defaultStatus.bd.focus.index2=self.canvasManager.GetFocusMng().focusIndex,$.each(self.annStatusManager.GetAnnStatusMng(),function(i,annStatusMng){var newAnnStatus=$.extend(!0,m_dicomstatus,{});$.each(annStatusMng.arrAnnStatus,function(j,annStatus){var status=annStatus.status;0==j&&(newAnnStatus.voi.ww=status.ww,newAnnStatus.voi.wc=status.wc,newAnnStatus.translation.x=status.ptLast.x,newAnnStatus.translation.y=status.ptLast.y,newAnnStatus.invert=status.negative,newAnnStatus.rotation=status.rotateState,newAnnStatus.pseudocolor=""),void 0===status.imageInfo&&null===status.imageInfo||(j=status.imageInfo.id,status=annStatus.ann,newAnnStatus.arrann[j]=CBoBo.Plugin.CloneObj(status.arrAnn))}),defaultStatus.bd.annstatus.push(newAnnStatus)}),$.each(self.canvasManager.arrFirstLayer,function(){defaultStatus.bd.layout.arrlayout.push({row:this.nLayoutRow,col:this.nLayoutCol})})):(defaultStatus.bd.layout.row=self.canvasManager.nLayoutRow,defaultStatus.bd.layout.col=self.canvasManager.nLayoutCol,defaultStatus.bd.focus.index1=self.canvasManager.focusIndex,$.each(self.annStatusManager.GetAnnStatus(),function(i,annStatus){var id,ann,status,newAnnStatus=$.extend(!0,{},m_dicomstatus);annStatus.type==CBoBo.PTYPE_DESERIES?(status=annStatus.status,newAnnStatus.voi.ww=status.ww,newAnnStatus.voi.wc=status.wc,newAnnStatus.translation.x=status.ptLast.x,newAnnStatus.translation.y=status.ptLast.y,newAnnStatus.invert=status.negative,newAnnStatus.rotation=status.rotateState,newAnnStatus.pseudocolor="",void 0===status.imageInfo&&null===status.imageInfo||(id=status.imageInfo.id,ann=annStatus.ann,newAnnStatus.arrann[id]=CBoBo.Plugin.CloneObj(ann.arrAnn))):(status=annStatus.status,newAnnStatus.voi.ww=status.brightness,newAnnStatus.voi.wc=status.contrast,newAnnStatus.translation.x=status.ptLast.x,newAnnStatus.translation.y=status.ptLast.y,newAnnStatus.invert=status.Negative,newAnnStatus.rotation=status.rotateState,newAnnStatus.pseudocolor=""),defaultStatus.bd.annstatus.push(newAnnStatus)})),defaultStatus.bd.bshowcornerinfo=self.toolBar.bShowCornerInfo):"mpr"==defaultStatus.mode&&(defaultStatus.mpr={}),defaultStatus},this.Assist.AnalyzeStatus=function(statusblod){var ostatus,data,arrAnnStatusMng,arrServerLyt,arrLocalLyt,arrAnnStatus;statusblod instanceof Object&&(ostatus=self.Assist.GetTransferStatus(),console.log(statusblod),statusblod.hospid==ostatus.hospid&&ostatus.studyuid==statusblod.studyuid||(self.onThumb.ToolMsg({usermsg:"清空全部检查"}),void 0!==self.canvasManager&&(self.canvasManager.Destroy(),delete self.canvasManager,self.canvasManager=void 0),void 0!==self.annStatusManager&&(delete self.annStatusManager,self.annStatusManager=void 0),self.OpenStudy(statusblod.wadourl,statusblod.hospid,statusblod.studyuid)),"2d"==(data=statusblod).mode&&void 0!==self.canvasManager&&((data=data.bd).mode==CBoBo.PTYPE_SERIES?(ostatus.bd.layout.row==data.layout.row&&ostatus.bd.layout.col==data.layout.col||(arrAnnStatusMng=self.annStatusManager.GetAnnStatusMng(),self.canvasManager.UpdateLayout(arrAnnStatusMng.length,data.layout.row,data.layout.col),self.canvasManager.EachMng(function(i,mng){var arrAnnStatus;i<arrAnnStatusMng.length?null!==(i=arrAnnStatusMng[i])&&(arrAnnStatus=i.GetAnnStatus(),mng.UpdateLayout(arrAnnStatus.length),mng.AnnStatusMng(i),0<arrAnnStatus.length)&&(arrAnnStatus[0].type==CBoBo.PTYPE_SERIES?mng.checkbox.Show(!0):mng.checkbox.Show(!1)):(mng.UpdateLayout(0),mng.checkbox.Show(!1))})),arrServerLyt=data.layout.arrlayout,arrLocalLyt=ostatus.bd.layout.arrlayout,arrServerLyt instanceof Array&&self.canvasManager.EachMng(function(i,mng){var serverLyt;i<arrServerLyt.length&&(serverLyt=arrServerLyt[i],(i=arrLocalLyt[i]).row==serverLyt.row&&i.col==serverLyt.col||(null!==mng.annStatusMng?mng.UpdateLayout(mng.annStatusMng.arrAnnStatus.length,serverLyt.row,serverLyt.col):mng.UpdateLayout(0,serverLyt.row,serverLyt.col)))})):ostatus.bd.layout.row==data.layout.row&&ostatus.bd.layout.col==data.layout.col||(arrAnnStatus=self.annStatusManager.GetAnnStatus(),self.canvasManager.UpdateLayout(arrAnnStatus.length,data.layout.row,data.layout.col))),function(data){"2d"==data.mode&&(data=data.bd,ostatus.bd.focus.index1!=data.focus.index1||ostatus.bd.focus.index2!=data.focus.index2)&&self.canvasManager.SetDefaultFocus(data.focus.index1,data.focus.index2)}(statusblod),function(data){var arrAnnStatus;"2d"==data.mode&&(data=data.bd,arrAnnStatus=data.annstatus,data.mode==CBoBo.PTYPE_SERIES)&&arrAnnStatus instanceof Array&&$.each(arrAnnStatus,function(i,annStatus){})}(statusblod))},self.GlobalInit(),self.DL.OpenStudy()},"undefined"==typeof CBoBo&&(CBoBo={}),CBoBo.Plugin={},CBoBo.Plugin.RadianToDegree=function(a){return 57.29578*a},CBoBo.Plugin.DegreeToRadian=function(a){return.0174532*a},CBoBo.Plugin.GetClockDirection=function(pt0,pt1,pt2){var h=pt1.x-pt0.x,pt1=pt1.y-pt0.y,i=pt2.x-pt0.x,pt2=pt2.y-pt0.y,pt0=Math.sqrt(Math.pow(h,2)+Math.pow(pt1,2)),pt0=(h/=pt0,pt1/=pt0,Math.sqrt(Math.pow(i,2)+Math.pow(pt2,2))),h=0<h*(pt2/=pt0)-(i/=pt0)*pt1;return h},CBoBo.Plugin.GetDegree=function(pt0,pt1,pt2){var dis1=CBoBo.Plugin.GetDistance(pt0,pt1),pt0=CBoBo.Plugin.GetDistance(pt0,pt2),pt1=CBoBo.Plugin.GetDistance(pt1,pt2);return 0==dis1||0==pt0?0:((pt2=(dis1*dis1-pt1*pt1+pt0*pt0)/(2*dis1*pt0))<-1?pt2=-1:1<pt2&&(pt2=1),pt1=Math.acos(pt2),CBoBo.Plugin.RadianToDegree(pt1))},CBoBo.Plugin.GetDistance=function(pt0,pt1){pt0=(pt0.x-pt1.x)*(pt0.x-pt1.x)+(pt0.y-pt1.y)*(pt0.y-pt1.y);return Math.sqrt(pt0)},CBoBo.Plugin.GetRectAera=function(pt0,pt1){var w=pt1.x-pt0.x,pt1=pt1.y-pt0.y;return Math.abs(w*pt1)},CBoBo.Plugin.GetEllipseAera=function(pt0,pt1){pt0.x,pt0.x,pt1.x,pt0.y,pt0.y,pt1.y;return Math.abs(Math.PI*sw*sh)},CBoBo.Plugin.GetDrawTextCoord=function(lt_nums,rt_nums,rb_nums,lb_nums,canvasRect,fontSize){for(var drawTextCoord={lt:[],rt:[],rb:[],lb:[],dp:[]},canvasWidth=canvasRect.right-canvasRect.left,canvasHeight=canvasRect.bottom-canvasRect.top,i=0;i<lt_nums;i++)drawTextCoord.lt.push({x:2,y:i*fontSize+4*i+8});for(i=0;i<rt_nums;i++)drawTextCoord.rt.push({x:canvasWidth-2,y:i*fontSize+4*i+8});for(i=0;i<rb_nums;i++)drawTextCoord.rb.push({x:canvasWidth-2,y:canvasHeight-i*fontSize-8-4*i});for(i=0;i<lb_nums;i++)drawTextCoord.lb.push({x:0,y:canvasHeight-i*fontSize-8-4*i});return drawTextCoord.dp.push({x:5,y:(canvasHeight/2).toFixed(0)}),drawTextCoord.dp.push({x:canvasWidth/2>>0,y:8}),drawTextCoord.dp.push({x:canvasWidth-10,y:canvasHeight/2>>0}),drawTextCoord.dp.push({x:canvasWidth/2>>0,y:canvasHeight-10}),drawTextCoord},CBoBo.Plugin.PolygonArea=function(ptArr){pt0=ptArr[0];for(var area=0,count=ptArr.length,i=1;i<count-1;i++)area=area+(ptArr[i].x-pt0.x)*(ptArr[i+1].y-pt0.y)-(ptArr[i].y-pt0.y)*(ptArr[i+1].x-pt0.x);return(area=.5*Math.abs(area)).toFixed(0)},CBoBo.Plugin.GetDcmDistance=function(dicom,canvasRect,pt0,pt1){return pt0=dicom.ClientToImage_point(pt0,canvasRect).pointSource,pt1=dicom.ClientToImage_point(pt1,canvasRect).pointSource,CBoBo.Plugin.GetDistance(pt0,pt1)},CBoBo.Plugin.GetDcmRectAera=function(dicom,canvasRect,pt0,pt1){return pt0=dicom.ClientToImage_point(pt0,canvasRect).pointSource,pt1=dicom.ClientToImage_point(pt1,canvasRect).pointSource,CBoBo.Plugin.GetRectAera(pt0,pt1)},CBoBo.Plugin.GetDcmEllipseAera=function(dicom,canvasRect,pt0,pt1){return pt0=dicom.ClientToImage_point(pt0,canvasRect).pointSource,pt1=dicom.ClientToImage_point(pt1,canvasRect).pointSource,CBoBo.Plugin.GetEllipseAera(pt0,pt1)},CBoBo.Plugin.TransCoord=function(dvCanvas,x,y){dvCanvas=dvCanvas.GetCanvas().getBoundingClientRect();return{x:x-dvCanvas.left,y:y-dvCanvas.top}},CBoBo.Plugin.GetRandom=function(start,end){if(null==start||null==end)return(1e12*Math.random()>>0)+(new Date).getTime();try{var distance=end-start,rand=(1e12*Math.random()>>0)%end;return rand<start&&(rand+=distance),rand=0==rand?end:rand}catch(e){console.log(e.message)}},CBoBo.Plugin.SetDrawTextCoord=function(width,height,lt_nums,rt_nums,rb_nums,lb_nums,fontsize){fontsize=fontsize||10;for(var drawTextCoord={lt:[],rt:[],rb:[],lb:[],dp:[]},distance=(fontsize*=1.1)>>1,i=0;i<lt_nums;i++)drawTextCoord.lt.push({x:2,y:i*fontsize+distance});for(i=0;i<rt_nums;i++)drawTextCoord.rt.push({x:width-2,y:i*fontsize+distance});for(i=0;i<rb_nums;i++)drawTextCoord.rb.push({x:width-2,y:height-i*fontsize-distance});for(i=0;i<lb_nums;i++)drawTextCoord.lb.push({x:0,y:height-i*fontsize-distance});return drawTextCoord.dp.push({x:5,y:height/2>>0}),drawTextCoord.dp.push({x:width/2>>0,y:8}),drawTextCoord.dp.push({x:width-distance,y:height/2>>0}),drawTextCoord.dp.push({x:width/2>>0,y:height-distance}),drawTextCoord},CBoBo.Plugin.GetUrlParam=function(name){name=new RegExp("(^|&)"+name+"=([^&]*)(&|$)"),name=window.location.search.substr(1).match(name);return null!=name?unescape(name[2]):null},CBoBo.Plugin.GetUrlParamArray=function(){for(var key,value,str=location.href,num=str.indexOf("?"),arr=(str=str.substr(num+1)).split("&"),ret={},i=0;i<arr.length;i++)0<(num=arr[i].indexOf("="))&&(key=arr[i].substring(0,num),value=arr[i].substr(num+1),ret[key]=value);return ret},CBoBo.Plugin.GetBrowserInfo=function(){var browser_versions=function(){var u=navigator.userAgent;navigator.appVersion;return{trident:-1<u.indexOf("Trident"),presto:-1<u.indexOf("Presto"),webKit:-1<u.indexOf("AppleWebKit"),gecko:-1<u.indexOf("Gecko")&&-1==u.indexOf("KHTML"),mobile:!!u.match(/AppleWebKit.*Mobile.*/),ios:!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:-1<u.indexOf("Android")||-1<u.indexOf("Linux"),iPhone:-1<u.indexOf("iPhone"),iPad:-1<u.indexOf("iPad"),webApp:-1==u.indexOf("Safari"),isTablet:-1<u.indexOf("NHG47K")||-1<u.indexOf("rk3399")||-1<u.indexOf("RK3399")}}();return{language:navigator.userAgent,isMobile:browser_versions.mobile,isIOS:browser_versions.ios,isAndroid:browser_versions.android,isIPhone:browser_versions.iPhone,isIpad:browser_versions.iPad,isTablet:browser_versions.isTablet}},CBoBo.Plugin.Error=function(msg,error){var text=msg,compositionAtop="source-atop",compositionNormal="source-over",msg="<canvas id='"+(id="c"+CBoBo.Plugin.GetRandom())+"'></canvas>",canvas=($(msg).appendTo($("body")),$("#"+id).css({"z-index":100,position:"absolute",top:"0px",left:"0px",background:"#000"}),document.getElementById(id)),fontSize=(canvas.width=$(window).width(),canvas.height=$(window).height(),canvas.width/text.length*.8>>0),engine=canvas.getContext("2d"),patternCanvas=document.createElement("canvas"),patternEngine=patternCanvas.getContext("2d"),pixels=[],pixelStops=[],moveSpeed=2,speedTicker=1,targetLook=1,targetLookReverse=2*targetLook,drawMode=!1,sensitivity=3,pixelMultiplier=1,pixelSize=2,highlightTickerStart=0,highlightTicker=highlightTickerStart,highlightTickerMax=180,color="rgb(200, 200, 200)",gradient=null,changeTime=6e3,textBound={left:0,top:0,width:0,height:0},request=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(cb){return setTimeout(cb,20)},setup=(this.run=function(){setTimeout(changeDrawMode,500),canvas.setAttribute("width",window.innerWidth),canvas.setAttribute("height",window.innerHeight),patternCanvas.setAttribute("width",window.innerWidth),patternCanvas.setAttribute("height",window.innerHeight),patternEngine.fillStyle="#fff",patternEngine.font="italic bold ".concat(fontSize).concat("px ").concat("Helvetica"),gradient=engine.createLinearGradient(0,0,window.innerWidth,0);for(var color,i=0;i<10;i++)color="hsl(".concat(36*i).concat(", 50%, 50%)"),gradient.addColorStop(i/10||0,color);setup(),tick()},function(){prepareText(),generatePixels()}),changeDrawMode=function(){if(speedTicker=1,drawMode=!drawMode){highlightTicker=highlightTickerStart;for(var i=0;i<pixels.length;i++)pixels[i].moveX=0,pixels[i].moveY=0}},prepareText=function(){pixelStops=[];var m=patternEngine.measureText(text),imgData=(patternEngine.clearRect(0,0,window.innerWidth,window.innerHeight),patternEngine.fillText(text,window.innerWidth/2-m.width/2,window.innerHeight/2-fontSize/2),patternEngine.getImageData(0,0,window.innerWidth,window.innerHeight));textBound.left=window.innerWidth/2-m.width/2,textBound.top=window.innerHeight/2-fontSize/2-fontSize,textBound.width=m.width,textBound.height=fontSize;for(var y=0;y<window.innerHeight;y+=sensitivity)for(var x=0;x<window.innerWidth;x+=sensitivity)0!=imgData.data[4*(y*window.innerWidth+x)]&&pixelStops.push({x:x,y:y,color:"hsl("+(360/textBound.width*x-textBound.left)+", 50%, 50%)"})},generatePixels=function(){pixels=[];for(var i=0,max=Math.ceil(pixelStops.length*pixelMultiplier);i<max;i++){var speed=10*Math.random(),split=Math.random(),speedX=.5-Math.random()<0?split*speed:0-split*speed,speed=.5-Math.random()<0?(1-split)*speed:0-(1-split)*speed;pixels.push({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,dirX:speedX,dirY:speed,split:split,oldX:0,oldY:0,moveX:0,moveY:0})}},tick=function(){engine.clearRect(0,0,window.innerWidth,window.innerHeight),drawMode&&(speedTicker+=.01,window.innerWidth,window.innerHeight,window.innerWidth,window.innerHeight),engine.fillStyle=color;for(var moving=!1,i=0;i<pixels.length;i++)i<pixelStops.length?engine.fillStyle=pixelStops[i].color:engine.fillStyle=color,drawMode&&i<pixelStops.length?drawText(i)&&(moving=!0):drawNormal(pixels[i]);drawMode&&!moving&&drawHighlight(),request(tick)},drawHighlight=function(){var left;0<++highlightTicker&&highlightTicker<=highlightTickerMax&&(engine.globalCompositeOperation=compositionAtop,engine.fillStyle="#fff",left=textBound.left-20+(textBound.width+40)/highlightTickerMax*highlightTicker,engine.fillRect(left,textBound.top-20,10,textBound.height+40),engine.fillRect(10+left+5,textBound.top-20,5,textBound.height+40),engine.globalCompositeOperation=compositionNormal,highlightTicker==highlightTickerMax)&&(setTimeout(changeDrawMode,500),setTimeout(changeDrawMode,changeTime))},drawText=function(pixelIterator){return arc(pixels[pixelIterator].x,pixels[pixelIterator].y),engine.fill(),textMoving(pixelIterator)},range=function(pixel,target,dim){return Math.abs(pixel[dim]-target[dim])},textMoving=function(pixelIterator){var moving=!1,target=pixelStops[pixelIterator],pixelIterator=pixels[pixelIterator];return target.x!=pixelIterator.x&&(range(pixelIterator,target,"x")<targetLookReverse?pixelIterator.x=target.x:(pixelIterator.x>target.x?0<pixelIterator.moveX?pixelIterator.moveX-=targetLookReverse:pixelIterator.moveX-=targetLook:pixelIterator.moveX<0?pixelIterator.moveX+=targetLookReverse:pixelIterator.moveX+=targetLook,moving=!0,pixelIterator.x+=pixelIterator.moveX)),target.y!=pixelIterator.y&&(range(pixelIterator,target,"y")<targetLookReverse?pixelIterator.y=target.y:(pixelIterator.y>target.y?0<pixelIterator.moveY?pixelIterator.moveY-=targetLookReverse:pixelIterator.moveY-=targetLook:pixelIterator.moveY<0?pixelIterator.moveY+=targetLookReverse:pixelIterator.moveY+=targetLook,moving=!0,pixelIterator.y+=pixelIterator.moveY)),moving},drawNormal=function(pixel){move(pixel),bound(pixel),arc(pixel.x,pixel.y),engine.fill()},arc=function(x,y){engine.fillRect(x|=0,y|=0,pixelSize,pixelSize)},move=function(pixel){pixel.x+=pixel.dirX,pixel.y+=pixel.dirY},bound=function(pixel){pixel.x<0?pixel.dirX=Math.abs(pixel.dirX):pixel.x>window.innerWidth&&(pixel.dirX=0-pixel.dirX),pixel.y<0?pixel.dirY=Math.abs(pixel.dirY):pixel.y>window.innerHeight&&(pixel.dirY=0-pixel.dirY)},error=(this.run(),function(error){void 0===error&&(error="CLEAR DICOMVIEWER 2016"),$("<div>"+error+"</div>").appendTo($("body")).css({position:"absolute",bottom:0,color:"rgba(100,100,100,0.2)","font-size":"20px","z-index":"101",cursor:"default"})}(error))},CBoBo.Plugin.Error404=function(){function Particle(x,y,c,r){this.x=x||0,this.y=y||0,this.vx=rsgn()*rand(.5,.125),this.vy=rsgn()*rand(.5,.125),this.ax=0,this.ay=GRAVITY,this.c=c||"white",this.alpha=1,this.r=r||rand(3,.5),this.evolve=function(){this.alpha-=.008,this.vx+=this.ax,this.vy+=this.ay,this.x+=this.vx,this.y+=this.vy,this.y>.5*w-this.r&&(this.y=.5*w-this.r,this.vx*=.95,this.vy*=-.9),Math.abs(this.x)>.5*w+2*this.r||this.y<-.5*h-2*this.r||this.alpha<=0?this.destroy():this.draw()},this.draw=function(){ct.fillStyle=this.c,ct.globalAlpha=this.alpha,ct.beginPath(),ct.arc(this.x,this.y,this.r,0,2*Math.PI),ct.closePath(),ct.fill()},this.destroy=function(){var idx=particles.indexOf(this);particles.splice(idx,1)}}function size(){w=c.width=window.innerWidth,h=c.height=window.innerHeight,cr=.25*Math.min(h,w),ct.restore(),ct.save(),ct.translate(.5*w,.5*h)}function ani(B){var light,_r=cr*(2+Math.sin(.73*B))/2,x=_r*Math.cos(B),y=_r*Math.sin(B),hue=~~(.183*B/Math.PI*360)%360,n=particles.length;ct.beginPath(),ct.clearRect(-.5*w,-.5*h,w,h);for(var i=0;i<n;i++)particles[i].evolve(),particles.length!=n&&(n--,i--);for(i=0;i<32;i++)light=40*(1+Math.random()),(light=new Particle(x+rsgn()*rand(8),y+rsgn()*rand(8),"hsl("+hue+",100%,"+light+"%)")).draw(),particles.push(light);requestAnimationFrame(ani.bind(this,B+M))}var w,h,cr,str="<canvas id='"+(id="c"+CBoBo.Plugin.GetRandom())+"'></canvas>",c=($(str).appendTo($("body")),$("#"+id).css({"z-index":100,position:"absolute",top:"0px",left:"0px"}),document.getElementById(id)),GRAVITY=(c.width=$(window).width(),c.height=$(window).height(),.01),M=Math.PI/90,ct=c.getContext("2d"),particles=[],rand=function(max,min,is_int){max=(min=min||0)+((max=(max-1||0)+1)-min)*Math.random();return is_int?Math.round(max):max},rsgn=function(k){return Math.random()<(k||.5)?-1:1};size(),ani(0),addEventListener("resize",size,!1)},CBoBo.Plugin.Error405=function(){var tickHueMultiplied,str="<canvas id='"+(id="c"+CBoBo.Plugin.GetRandom())+"'></canvas>",str=($(str).appendTo($("body")),$("#"+id).css({"z-index":100,position:"absolute",top:"0px",left:"0px"}),document.getElementById(id)),w=str.width=window.innerWidth,h=str.height=window.innerHeight,ctx=str.getContext("2d"),opts={rays:30,maxRadius:Math.sqrt(w*w/4+h*h/4),circleRadiusIncrementAcceleration:2,radiantSpan:.4,rayAngularVelSpan:.005,rayAngularVelLineWidthMultiplier:60,rayAngularAccWaveInputBaseIncrementer:.03,rayAngularAccWaveInputAddedIncrementer:.02,rayAngularAccWaveMultiplier:3e-4,baseWaveInputIncrementer:.01,addedWaveInputIncrementer:.01,circleNumWaveIncrementerMultiplier:.1,circleNumLineWidthMultiplier:2,cx:w/2,cy:h/2,tickHueMultiplier:1,shadowBlur:0,repaintAlpha:.2},rays=[],tick=0;function loop(){window.requestAnimationFrame(loop),++tick,ctx.globalCompositeOperation="source-over",ctx.shadowBlur=0,ctx.fillStyle="rgba(0,0,0,alp)".replace("alp",opts.repaintAlpha),ctx.clearRect(0,0,w,h),ctx.shadowBlur=opts.shadowBlur,ctx.globalCompositeOperation="lighter",tickHueMultiplied=opts.tickHueMultiplier*tick,rays.map(function(ray){ray.step()})}function Ray(){this.circles=[new Circle(2)],this.rot=Math.random()*Math.PI*2,this.angularVel=Math.random()*opts.rayAngularVelSpan*(Math.random()<.5?1:-1),this.angularAccWaveInput=Math.random()*Math.PI*2,this.angularAccWaveInputIncrementer=opts.rayAngularAccWaveInputBaseIncrementer+opts.rayAngularAccWaveInputAddedIncrementer*Math.random();for(var security=100,count=0;0<--security&&this.circles[count].radius<opts.maxRadius;)this.circles.push(new Circle(++count))}function Circle(n){this.radius=opts.circleRadiusIncrementAcceleration*Math.pow(n,2),this.waveInputIncrementer=(opts.baseWaveInputIncrementer+opts.addedWaveInputIncrementer*Math.random())*(Math.random()<.5?1:-1)*opts.circleNumWaveIncrementerMultiplier*n,this.waveInput=Math.random()*Math.PI*2,this.radiant=Math.random()*opts.radiantSpan*(Math.random()<.5?1:-1)}Ray.prototype.step=function(){this.rot+=this.angularVel+=Math.sin(this.angularAccWaveInput+=this.angularAccWaveInputIncrementer)*opts.rayAngularAccWaveMultiplier;var rot=this.rot,x=opts.cx,y=opts.cy;ctx.lineWidth=Math.min(1e-5/Math.abs(this.angularVel),10/opts.rayAngularVelLineWidthMultiplier)*opts.rayAngularVelLineWidthMultiplier,ctx.beginPath(),ctx.moveTo(x,y);for(var i=0;i<this.circles.length;++i){var circle=this.circles[i],x2=(circle.step(),rot+=circle.radiant,opts.cx+Math.sin(rot)*circle.radius),circle=opts.cy+Math.cos(rot)*circle.radius;ctx.quadraticCurveTo(x,y,(x+x2)/2,(y+circle)/2),x=x2,y=circle}ctx.strokeStyle=ctx.shadowColor="hsl(hue,80%,50%)".replace("hue",(rot+this.rot)/2%(2*Math.PI)/Math.PI*30+tickHueMultiplied),ctx.stroke()},Circle.prototype.step=function(){this.waveInput+=this.waveInputIncrementer,this.radiant=Math.sin(this.waveInput)*opts.radiantSpan};for(var i=rays.length=0;i<opts.rays;++i)rays.push(new Ray);0===tick&&loop()},CBoBo.Plugin.GetTime=function(){var date=new Date,month=(month=date.getMonth()+1)<10?"0"+month:month;return date.getFullYear()+"/"+month+"/"+date.getDate()+" "+date.getHours()+":"+date.getMinutes()+":"+date.getSeconds()},CBoBo.Plugin.SetCookie=function(cname,cvalue,exdays){var d=new Date,exdays=(d.setTime(d.getTime()+24*exdays*60*60*1e3),"expires="+d.toUTCString());document.cookie=cname+"="+cvalue+"; "+exdays+";path=/;"},CBoBo.Plugin.GetCookie=function(cname){for(var name=cname+"=",ca=document.cookie.split(";"),i=0;i<ca.length;i++){for(var c=ca[i];" "==c.charAt(0);)c=c.substring(1);if(-1!=c.indexOf(name))return c.substring(name.length,c.length)}return""},CBoBo.Plugin.ClearCookie=function(name){CBoBo.Plugin.SetCookie(name,"",-1)},CBoBo.Plugin.FullScreen=function(bFscreen){var rfs;bFscreen?(bFscreen=document.documentElement,void 0!==(rfs=bFscreen.requestFullScreen||bFscreen.webkitRequestFullScreen||bFscreen.mozRequestFullScreen||bFscreen.msRequestFullScreen)&&rfs?rfs.call(bFscreen):void 0!==window.ActiveXObject&&null!=(rfs=new ActiveXObject("WScript.Shell"))&&rfs.SendKeys("{F11}")):function(){var el=document,cfs=el.cancelFullScreen||el.webkitCancelFullScreen||el.mozCancelFullScreen||el.exitFullScreen;void 0!==cfs&&cfs?cfs.call(el):void 0!==window.ActiveXObject&&null!=(cfs=new ActiveXObject("WScript.Shell"))&&cfs.SendKeys("{F11}")}()},CBoBo.Plugin.CloneObj=function(obj){var key,newO={};for(key in obj instanceof Array&&(newO=[]),obj){var val=obj[key];newO[key]="object"==typeof val?arguments.callee(val):val}return newO},"undefined"==typeof CBoBo&&(CBoBo={}),!function(CBoBo){var wadoURl,isFromServer=!1;CBoBo.Draw={GetIsFromServer:function(){return isFromServer},SetIsFromServer:function(isServer){isFromServer=isServer},FitServerCanvas:function(status,canvas,bForce,bDontDraw,bDontDrawDirection){isFromServer?CBoBo.ImageProcessor.FitServerCanvas(status,canvas,bForce,bDontDraw,bDontDrawDirection):CBoBo.ImageProcessor.FitCanvas(status,canvas,bForce,bDontDraw,bDontDrawDirection)},DrawImage:function(status,canvas,bForce,bDontDrawDirection){isFromServer?CBoBo.ImageProcessor.DrawServerGrayImage(status,canvas,bForce,bDontDrawDirection):CBoBo.ImageProcessor.DrawGrayImage(status,canvas,bForce,bDontDrawDirection)},SetWadoUrl:function(wadoUrl){wadoURl=wadoUrl},GetWadoUrl:function(){return wadoURl}}}(CBoBo),"undefined"==typeof CBoBo&&(CBoBo={}),!function(CBoBo){"use strict";var cacheMax=24,arrStatusImage=[];function GetCacheData(status){for(var i=0;i<arrStatusImage.length;i++){var item=arrStatusImage[i];if(item.id===status.id&&item.imageid===status.image.id)return item}}function SetCacheData(status){arrStatusImage.length>=cacheMax&&arrStatusImage.shift(),arrStatusImage.push(status)}function DelCacheData(status){for(var i=0;i<arrStatusImage.length;i++){var item=arrStatusImage[i];item.id===status.id&&item.imageid===status.imageid&&arrStatusImage.splice(i,1)}}function GetRenderImage(status,bForce,ELCanvas){var item=GetCacheData(status),breRender=NeedToBeRendered(item,status),{isRGB,isIMGAnalysis2}=status.image;if(bForce||void 0===item||item.canvas.width!==status.image.col||item.canvas.height!==status.image.row){void 0!==item&&DelCacheData(item);var bForce={},canvas=(bForce.id=status.id,bForce.imageid=status.image.id,bForce.ww=status.ww,bForce.wc=status.wc,bForce.invert=status.invert,bForce.pseudo=status.pseudo,bForce.sharpen=status.sharpen,bForce.blur=status.blur,1<status.image.frames&&(self.CBoBo.Manager.toolBar.IsEnable("序列播放")||(self.CBoBo.Manager.toolBar.EnableButton("序列播放",!0),self.CBoBo.Manager.toolBar.GetButtonDOM("序列播放").click())),document.createElement("canvas")),ctx=(canvas.width=status.image.col,canvas.height=status.image.row,canvas.getContext("2d")),imagedata=ctx.getImageData(0,0,canvas.width,canvas.height);if(isRGB)!function(arrBuffer,canvasImageDataData,isIMGAnalysis2){var canvasImageDataIndex=0,storedPixelDataIndex=0,localNumPixels=arrBuffer.length,uint8Buffer=canvasImageDataData,localPixelData=arrBuffer;for(;storedPixelDataIndex<localNumPixels;)uint8Buffer[canvasImageDataIndex++]=localPixelData[storedPixelDataIndex++],uint8Buffer[canvasImageDataIndex++]=localPixelData[storedPixelDataIndex++],uint8Buffer[canvasImageDataIndex++]=localPixelData[storedPixelDataIndex++],uint8Buffer[canvasImageDataIndex++]=isIMGAnalysis2?localPixelData[storedPixelDataIndex++]:255}(status.image.pixsBuffer,imagedata.data,isIMGAnalysis2);else{if(1==status.image.imageType&&status.image.bita<=8&&"MONOCHROME2"==status.image.phme)for(var isIMGAnalysis2=status.image.pixsBuffer,canvasImageDataData=imagedata.data,frames=status.frames,canvasImageDataIndex=(isNaN(frames)||null==frames?frames=0:--frames,0),uint8Buffer=canvasImageDataData,canvasNumPixels=canvasImageDataData.length,localPixelData=isIMGAnalysis2,storedPixelDataIndex=frames*canvasNumPixels/4;canvasImageDataIndex<canvasNumPixels;)uint8Buffer[canvasImageDataIndex++]=localPixelData[storedPixelDataIndex],uint8Buffer[canvasImageDataIndex++]=localPixelData[storedPixelDataIndex],uint8Buffer[canvasImageDataIndex++]=localPixelData[storedPixelDataIndex],uint8Buffer[canvasImageDataIndex++]=255,storedPixelDataIndex++;else StoreImageData(status.image.pixsBuffer,status.image.minGray,status.image.maxGray,status.ww,status.wc,status.invert,status.pseudo,status.image.rescsl,status.image.rescin,imagedata.data);imagedata=sharpenImageData(imagedata,status.sharpen),blurImageData2(ELCanvas,status.blur)}return ctx.putImageData(imagedata,0,0),bForce.canvas=canvas,bForce.ctx=ctx,bForce.imagedata=imagedata,SetCacheData(bForce),canvas}return void 0!==item&&breRender?isRGB||(StoreImageData(status.image.pixsBuffer,status.image.minGray,status.image.maxGray,status.ww,status.wc,status.invert,status.pseudo,status.image.rescsl,status.image.rescin,item.imagedata.data),item.imagedata=sharpenImageData(item.imagedata,status.sharpen),blurImageData2(ELCanvas,status.blur),item.ctx.putImageData(item.imagedata,0,0),item.ww=status.ww,item.wc=status.wc,item.invert=status.invert,item.pseudo=status.pseudo,item.sharpen=status.sharpen,item.blur=status.blur):isRGB||blurImageData2(ELCanvas,status.blur),item.canvas}function NeedToBeRendered(dStatus,oStatus){return void 0!==dStatus&&void 0!==oStatus&&(dStatus.ww!==oStatus.ww||dStatus.wc!==oStatus.wc||dStatus.invert!==oStatus.invert||dStatus.pseudo!==oStatus.pseudo||dStatus.sharpen!==oStatus.sharpen||dStatus.blur!==oStatus.blur)}function StoreImageData(arrBuffer,minGray,maxGray,ww,wc,invert,pseudo,rescaleSlope,rescaleIntercept,canvasImageDataData){!function(arrPixs,lutData,minGray,canvasImageDataData){var pix,minPixelValue=minGray,canvasImageDataIndex=0,storedPixelDataIndex=0,localNumPixels=arrPixs.length,localPixelData=arrPixs,rlut=lutData.r,glut=lutData.g,blut=lutData.b,uint8Buffer=canvasImageDataData;if(minPixelValue<0)for(;storedPixelDataIndex<localNumPixels;)pix=localPixelData[storedPixelDataIndex++]+-minPixelValue,uint8Buffer[canvasImageDataIndex++]=rlut[pix],uint8Buffer[canvasImageDataIndex++]=glut[pix],uint8Buffer[canvasImageDataIndex++]=blut[pix],uint8Buffer[canvasImageDataIndex++]=255;else for(;storedPixelDataIndex<localNumPixels;)pix=localPixelData[storedPixelDataIndex++],uint8Buffer[canvasImageDataIndex++]=rlut[pix],uint8Buffer[canvasImageDataIndex++]=glut[pix],uint8Buffer[canvasImageDataIndex++]=blut[pix],uint8Buffer[canvasImageDataIndex++]=255}(arrBuffer,function(ww,wc,minGray,maxGray,rescaleSlope,rescaleIntercept,bInvert,pseudoType){var voiLutValue,clampedValue,storedValue,lut=[],maxPixelValue=maxGray,slope=rescaleSlope,intercept=rescaleIntercept,localWindowWidth=ww,localWindowCenter=wc,offset=(maxGray=minGray)<0?maxGray:0;if(bInvert)for(storedValue=maxGray;storedValue<=maxPixelValue;storedValue++)voiLutValue=255*((parseInt(storedValue*slope+intercept)+-localWindowCenter)/localWindowWidth+.5),clampedValue=Math.min(Math.max(voiLutValue,0),255),lut[storedValue+-offset]=Math.round(255-clampedValue);else for(storedValue=maxGray;storedValue<=maxPixelValue;storedValue++)voiLutValue=255*((parseFloat(storedValue*slope+intercept)+-localWindowCenter)/localWindowWidth+.5),clampedValue=Math.min(Math.max(voiLutValue,0),255),lut[storedValue+-offset]=Math.round(clampedValue);if(""===pseudoType||"灰色"===pseudoType)return{r:lut,g:lut,b:lut};for(var pix,pseudo=GetPseudoColor(pseudoType),rlut=new Int16Array(lut.length),glut=new Int16Array(lut.length),i=0;i<lut.length;i++)rlut[i]=pseudo.r[pix=lut[i]],glut[i]=pseudo.g[pix],lut[i]=pseudo.b[pix];return{r:rlut,g:glut,b:lut}}(ww,wc,minGray,maxGray,rescaleSlope,rescaleIntercept,invert,pseudo),minGray,canvasImageDataData)}function convolution(pixels,kernel){var side=Math.round(Math.sqrt(kernel.length)),halfSide=Math.floor(side/2),src=pixels.data,canvasWidth=pixels.width,canvasHeight=pixels.height,outputData=document.createElement("canvas").getContext("2d").createImageData(canvasWidth,canvasHeight);for(let y=0;y<canvasHeight;y++)for(let x=0;x<canvasWidth;x++){let dstOff=4*(y*canvasWidth+x),sumReds=0,sumGreens=0,sumBlues=0;for(let kernelY=0;kernelY<side;kernelY++)for(let kernelX=0;kernelX<side;kernelX++){var currentKernelY=y+kernelY-halfSide,currentKernelX=x+kernelX-halfSide;0<=currentKernelY&&currentKernelY<canvasHeight&&0<=currentKernelX&&currentKernelX<canvasWidth&&(currentKernelY=4*(currentKernelY*canvasWidth+currentKernelX),currentKernelX=kernel[kernelY*side+kernelX],sumReds+=src[currentKernelY]*currentKernelX,sumGreens+=src[1+currentKernelY]*currentKernelX,sumBlues+=src[2+currentKernelY]*currentKernelX)}outputData.data[dstOff]=sumReds,outputData.data[1+dstOff]=sumGreens,outputData.data[2+dstOff]=sumBlues,outputData.data[3+dstOff]=255}return outputData}function sharpenImageData(imagedata,amount){return amount?convolution(imagedata,[0-amount,-.2-amount,0-amount,-.2-amount,1.8+8*amount,-.2-amount,0-amount,-.2-amount,0-amount]):imagedata}function blurImageData2(canvas,amount){canvas.setAttribute("style",`filter:blur(${amount}px)`)}function GetPseudoColor(type){switch(type){case"灰色":return;case"彩虹":return{r:rainbow_red,g:rainbow_green,b:rainbow_blue};case"黑体":return{r:blackbody_red,g:blackbody_green,b:blackbody_blue};case"骨骼":return{r:bones_red,g:bones_green,b:bones_blue};case"心脏":return{r:cardiac_red,g:cardiac_green,b:cardiac_blue};case"流动":return{r:flow_red,g:flow_green,b:flow_blue};case"Ge色":return{r:ge_color_red,g:ge_color_green,b:ge_color_blue};case"灰色彩虹":return{r:gray_rainbow_red,g:gray_rainbow_green,b:gray_rainbow_blue};case"热绿":return{r:hot_green_red,g:hot_green_green,b:hot_green_blue};case"铬铁":return{r:hot_iron_red,g:hot_iron_green,b:hot_iron_blue};case"热金属":return{r:hot_metal_red,g:hot_metal_green,b:hot_metal_blue};case"饱和度1":return{r:hue1_red,g:hue1_green,b:hue1_blue};case"饱和度2":return{r:hue2_red,g:hue2_green,b:hue2_blue};case"红外":return{r:ired_red,g:ired_green,b:ired_blue};case"墨黑":return{r:jet_red,g:jet_green,b:jet_blue};case"骨骼-肌肉":return{r:muscles_bones_red,g:muscles_bones_green,b:muscles_bones_blue};case"NIH":return{r:nih_red,g:nih_green,b:nih_blue};case"彩虹1":return{r:rainbow1_red,g:rainbow1_green,b:rainbow1_blue};case"彩虹2":return{r:rainbow2_red,g:rainbow2_green,b:rainbow2_blue};case"彩虹3":return{r:rainbow3_red,g:rainbow3_green,b:rainbow3_blue};case"比值":return{r:ratio_red,g:ratio_green,b:ratio_blue};case"红色血管":return{r:red_vessels_red,g:red_vessels_green,b:red_vessels_blue};case"光谱":return{r:spectrum_red,g:spectrum_green,b:spectrum_blue};case"斯特恩":return{r:stern_red,g:stern_green,b:stern_blue};case"UCLA":return{r:ucla_red,g:ucla_green,b:ucla_blue}}}function GetImageSize(status){return void 0===status.image?{width:0,height:0}:0===status.rotation||180===status.rotation?{width:status.image.col,height:status.image.row}:{width:status.image.row,height:status.image.col}}function CalculateTransform(status,canvas,scale){var transform=new Transform,canvas=(transform.translate(canvas.width/2,canvas.height/2),status.rotation),widthScale=(0!==canvas&&transform.rotate(canvas*Math.PI/180),status.scale),heightScale=status.scale;return status.image.pixy<status.image.pixx?widthScale*=status.image.pixx/status.image.pixy:status.image.pixx<status.image.pixy&&(heightScale*=status.image.pixy/status.image.pixx),transform.scale(widthScale,heightScale),0!==canvas&&transform.rotate(-canvas*Math.PI/180),transform.translate(status.translation.x,status.translation.y),0!==canvas&&transform.rotate(canvas*Math.PI/180),void 0!==scale&&transform.scale(scale,scale),status.hflip&&transform.scale(-1,1),status.vflip&&transform.scale(1,-1),transform.translate(-status.image.col/2,-status.image.row/2),transform}function DrawLine(context,startx,starty,endx,endy){context.moveTo(Math.round(startx),Math.round(starty)),context.lineTo(Math.round(endx),Math.round(endy))}function DrawRuler(status,context,canvasWidth,canvasHeight){if(status.image.pixx&&status.image.pixy&&!(canvasHeight<150||canvasWidth<150)){var width=status.image.col,height=status.image.row,t=status.scale,pixx=status.image.pixx,status=status.image.pixy,B=canvasWidth/3*width*pixx/(u=width*t),z=canvasWidth/2*width*pixx/u,H=canvasHeight/3*height*status/(t=height*t),F=canvasHeight/2*height*status/t,arrLines=new Array(1,2,3,5,10,15,20,25,30,50,100,150,200,250,300,500,1e3,1500,2e3,2500,3e3,5e3,1e4),i=0,referenceValue=0,I=0;for(i=0;i<arrLines.length&&(referenceValue<.01&&B<arrLines[i]&&z>arrLines[i]&&(referenceValue=arrLines[i]),I<.01&&H<arrLines[i]&&F>arrLines[i]&&(I=arrLines[i]),!(.01<=referenceValue&&.01<=I));i++);referenceValue<.01&&(referenceValue=Math.round((z+B)/2)),I<.01&&(I=Math.round((F+H)/2));height=referenceValue*u/(pixx*width);if(!(1e4<referenceValue||referenceValue<1||1e4<I||I<1)){for(var status="mm",t=(1e3<=referenceValue?height=3e3<referenceValue?(status="m",1e3*(referenceValue=Math.round(referenceValue/1e3))*u/(pixx*width)):(status="dm",100*(referenceValue=Math.round(referenceValue/100))*u/(pixx*width)):100<=referenceValue?height=300<referenceValue?(status="dm",100*(referenceValue=Math.round(referenceValue/100))*u/(pixx*width)):(status="cm",10*(referenceValue=Math.round(referenceValue/10))*u/(pixx*width)):10<=referenceValue&&30<referenceValue&&(status="cm",height=10*(referenceValue=Math.round(referenceValue/10))*u/(pixx*width)),context.save(),context.setTransform(1,0,0,1,0,0),context.beginPath(),context.translate(.5,.5),context.strokeStyle="white",context.fillStyle="white",canvasHeight/20),rulerStartX=(canvasWidth-height)/2,rulerStartY=canvasHeight-t,u=(canvasWidth+height)/2,pixx=canvasHeight-t,x=(DrawLine(context,rulerStartX,rulerStartY,u,pixx),referenceValue),S=(x<=10&&(x*=10),height/x),startY=(10<x&&S<5&&(S=height/(x/=10)),rulerStartY),endX=0,endY=0,i=0;i<=x;i++){var P=i*S,endY=i%10==0||i%5==0?(endX=rulerStartX+P,rulerStartY-15):(endX=rulerStartX+P,rulerStartY-10);DrawLine(context,rulerStartX+P,startY,endX,endY)}context.stroke(),context.fillText(referenceValue+" "+status,Math.round(10+u),Math.round(pixx)),context.restore()}}}function DrawDirection(status,canvas,context){var textWidths_left,textWidths_right,textWidths_bottom,image=status.image;(image.orl||image.ort||image.orr||image.orb)&&(context.setTransform(1,0,0,1,0,0),image=function(status,canvas){var width=status.image.col,height=status.image.row,coords={x:width/2,y:12};return{top:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,coords),bottom:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,{x:width/2,y:height-12}),left:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,{x:12,y:height/2}),right:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,{x:width-12,y:height/2})}}(status,canvas),canvas=context.measureText(status.image.ort).width,textWidths_left=context.measureText(status.image.orl).width,textWidths_right=context.measureText(status.image.orr).width,textWidths_bottom=context.measureText(status.image.orb).width,context.fillText(status.image.ort,image.top.x-canvas/2,image.top.y),context.fillText(status.image.orl,image.left.x-textWidths_left/2,image.left.y),context.fillText(status.image.orr,image.right.x-textWidths_right/2,image.right.y),context.fillText(status.image.orb,image.bottom.x-textWidths_bottom/2,image.bottom.y))}function Transform(){this.reset()}CBoBo.ImageProcessor={GetDefaultStatus:function(){return{id:function(start,end){if(void 0===start||void 0===end)return(1e12*Math.random()>>0)+(new Date).getTime();try{var distance=end-start,rand=(1e12*Math.random()>>0)%end;return rand<start&&(rand+=distance),rand=0===rand?end:rand}catch(e){console.log(e.message)}}(),image:void 0,ww:0,wc:0,rotation:0,scale:1,scale0:1,scale1:1,scale2:1,scale3:1,translation:{x:0,y:0},hflip:!1,vflip:!1,pseudo:"",invert:!1,wwScale:1,customWWWC:!1}},Restore:function(status){return status.image.bLoadImage&&(status.customWWWC=!1,status.wc=parseInt(status.image.wc),status.ww=parseInt(status.image.ww),(isNaN(status.wc)||isNaN(status.ww)||0===status.ww)&&(status.ww=status.image.maxGray-status.image.minGray,status.wc=status.image.minGray+(status.ww>>1)),status.scale=1,status.translation.x=0,status.translation.y=0,"MONOCHROME1"===status.image.phme?status.invert=!0:status.invert=!1,status.image.isIMGAnalysis2&&(status.invert=!1),status.pseudo="",status.rotation=0,status.hflip=!1,status.vflip=!1,(status.image.isIMGAnalysis2||(status.wwScale=Math.abs(status.wc).toString().slice(0,1),status.wc.toString().length<=2))&&(status.wwScale=.5),status.sharpen=0,status.blur=0),this},FitCanvas:function(status,canvas,bForce,bDontDraw,bDontDrawDirection){var verticalScale,imageSize;void 0!==status.image&&status.image.bLoadImage&&(imageSize=GetImageSize(status),verticalScale=status.image.pixx===status.image.pixy||isNaN(status.image.pixx)||isNaN(status.image.pixy)?canvas.height/imageSize.height:canvas.height/(imageSize.height*status.image.pixy/status.image.pixx),imageSize=canvas.width/imageSize.width,status.scale=imageSize<verticalScale?imageSize:verticalScale,status.scale=parseFloat(status.scale.toFixed(2)),status.translation.x=0,status.translation.y=0,bDontDraw||this.DrawGrayImage(status,canvas,bForce,bDontDrawDirection))},DrawGrayImage:function(status,canvas,bForce,bDontDrawDirection){if(!(status instanceof Object))throw"CBoBo.ImageProcessor.DrawGrayImage: incorrect status.";if(void 0===canvas)throw"CBoBo.ImageProcessor.DrawGrayImage: canvas is undefined.";if(!status.image.bLoadImage)return this;var context=canvas.getContext("2d"),bForce=GetRenderImage(status,bForce,canvas),width=status.image.col,height=status.image.row,transform=(context.imageSmoothingQuality="high",context.imageSmoothingEnabled=!0,context.shadowColor="#000000",context.shadowOffsetX=1,context.shadowOffsetY=1,context.shadowBlur=.5,context.fillStyle="white",context.clearRect(0,0,canvas.width,canvas.height),CalculateTransform(status,canvas));context.setTransform(transform.m[0],transform.m[1],transform.m[2],transform.m[3],transform.m[4],transform.m[5],transform.m[6]),status.image.pixx===status.image.pixy||isNaN(status.image.pixx)||isNaN(status.image.pixy)?context.drawImage(bForce,0,0,width,height,0,0,width,height):context.drawImage(bForce,0,0,width,height),bDontDrawDirection?context.setTransform(1,0,0,1,0,0):DrawDirection(status,canvas,context),"ECG"!=status.image.mod&&DrawRuler(status,context,canvas.width,canvas.height)},DrawGrayImage1:function(status,canvas,bForce,bDontDrawDirection){if(!(status instanceof Object))throw"CBoBo.ImageProcessor.DrawGrayImage: incorrect status.";if(void 0===canvas)throw"CBoBo.ImageProcessor.DrawGrayImage: canvas is undefined.";if(!status.image.bLoadImage)return this;for(var context=canvas.getContext("2d"),bForce=GetRenderImage(status,bForce),width=status.image.col,height=status.image.row,transform=(context.shadowColor="#000000",context.shadowOffsetX=1,context.shadowOffsetY=1,context.shadowBlur=.5,context.fillStyle="white",context.clearRect(0,0,canvas.width,canvas.height),CalculateTransform(status,canvas)),imageData=(context.setTransform(transform.m[0],transform.m[1],transform.m[2],transform.m[3],transform.m[4],transform.m[5],transform.m[6]),context.drawImage(bForce,0,0,width,height,0,0,width,height),context.getImageData(0,0,width,height)),canvas1=document.createElement("canvas"),canvas1=(canvas1.width=canvas.width,canvas1.height=canvas.height,canvas1.getContext("2d")),transform=(canvas1.shadowColor="#000000",canvas1.shadowOffsetX=1,canvas1.shadowOffsetY=1,canvas1.shadowBlur=.5,canvas1.fillStyle="white",canvas1.clearRect(0,0,canvas.width,canvas.height),canvas1.imageSmoothingEnabled=!1,canvas1.setTransform(transform.m[0],transform.m[1],transform.m[2],transform.m[3],transform.m[4],transform.m[5],transform.m[6]),canvas1.drawImage(bForce,0,0,width,height,0,0,width,height),canvas1.getImageData(0,0,width,height)),px=imageData.data,px1=transform.data,i=0;i<px.length;i+=4){var r=px1[i],g=px1[i+1],b=px1[i+2];255!==r&&0!==r||(px[i]=r,px[i+1]=g,px[i+2]=b)}bDontDrawDirection?context.setTransform(1,0,0,1,0,0):DrawDirection(status,canvas,context),DrawRuler(status,context,canvas.width,canvas.height)},PageToPixel:function(status,canvas,pageX,pageY,mod){if(void 0===status.image)throw"PageToPixel:image has not been loaded yet.";mod=null==mod?{x:pageX-(mod=canvas.getBoundingClientRect()).left-window.pageXOffset,y:pageY-mod.top-window.pageYOffset}:{x:pageX,y:pageY};pageX=CalculateTransform(status,canvas);return pageX.invert(),function(pt,rect){pt.x<rect.x&&(pt.x=rect.x),pt.y<rect.y&&(pt.y=rect.y);var right=rect.x+rect.width,rect=rect.y+rect.height;pt.x>right&&(pt.x=right),pt.y>rect&&(pt.y=rect),pt.x=parseInt(pt.x),pt.y=parseInt(pt.y)}(mod=pageX.transformPoint(mod.x,mod.y),{x:0,y:0,width:status.image.col,height:status.image.row}),mod},PixelToCanvas:function(status,canvas,pt){return CalculateTransform(status,canvas).transformPoint(pt.x,pt.y)},FitServerCanvas:function(status,canvas,bForce,bDontDraw,bDontDrawDirection){var verticalScale,imageSize;void 0!==status.image&&status.image.bLoadImage&&(imageSize=GetImageSize(status),verticalScale=canvas.height/imageSize.height,imageSize=canvas.width/imageSize.width,status.scale=imageSize<verticalScale?imageSize:verticalScale,status.scale=parseFloat(status.scale.toFixed(2)),status.translation.x=0,status.translation.y=0,bDontDraw||this.DrawServerGrayImage(status,canvas,bForce,bDontDrawDirection))},DrawServerGrayImage:function(status,canvas,bForce,bDontDrawDirection){if(!(status instanceof Object))throw"CBoBo.ImageProcessor.DrawGrayImage: incorrect status.";if(void 0===canvas)throw"CBoBo.ImageProcessor.DrawGrayImage: canvas is undefined.";if(!status.image.bLoadImage)return this;var context=canvas.getContext("2d");!function(status,bForce){var serverImage,item=GetCacheData(status),breRender=NeedToBeRendered(item,status),promise=$.Deferred();if(bForce||void 0===item||item.canvas.width!==status.image.col||item.canvas.height!==status.image.row)void 0!==item&&DelCacheData(item),(serverImage=new Image).src=CBoBo.Draw.GetWadoUrl()+"/GetImageData?id="+status.image.id+"&contentType=image/jpeg&windowWidth="+status.ww+"&windowCenter="+status.wc+"&efficioncy=80",serverImage.onload=function(){var saveStatus={};return saveStatus.id=status.id,saveStatus.imageid=status.image.id,saveStatus.ww=status.ww,saveStatus.wc=status.wc,saveStatus.invert=status.invert,saveStatus.pseudo=status.pseudo,saveStatus.canvas=this,SetCacheData(saveStatus),promise.resolve(this)};else{if(void 0===item||!breRender)return promise.resolve(item.canvas);void 0!==item&&DelCacheData(item),(serverImage=new Image).src=CBoBo.Draw.GetWadoUrl()+"/GetImageData?id="+status.image.id+"&contentType=image/jpeg&windowWidth="+status.ww+"&windowCenter="+status.wc+"&efficioncy=80",serverImage.onload=function(){var saveStatus={};return saveStatus.id=status.id,saveStatus.imageid=status.image.id,saveStatus.ww=status.ww,saveStatus.wc=status.wc,saveStatus.invert=status.invert,saveStatus.pseudo=status.pseudo,saveStatus.canvas=this,SetCacheData(saveStatus),promise.resolve(this)}}return promise}(status,bForce).then(function(image){var width=status.image.col,height=status.image.row,transform=(context.shadowColor="#000000",context.shadowOffsetX=1,context.shadowOffsetY=1,context.shadowBlur=.5,context.fillStyle="white",context.clearRect(0,0,canvas.width,canvas.height),CalculateTransform(status,canvas));context.setTransform(transform.m[0],transform.m[1],transform.m[2],transform.m[3],transform.m[4],transform.m[5],transform.m[6]),context.drawImage(image,0,0,width,height,0,0,width,height),bDontDrawDirection?context.setTransform(1,0,0,1,0,0):DrawDirection(status,canvas,context),DrawRuler(status,context,canvas.width,canvas.height)})}},Transform.prototype.reset=function(){this.m=[1,0,0,1,0,0]},Transform.prototype.clone=function(){var transform=new Transform;return transform.m[0]=this.m[0],transform.m[1]=this.m[1],transform.m[2]=this.m[2],transform.m[3]=this.m[3],transform.m[4]=this.m[4],transform.m[5]=this.m[5],transform},Transform.prototype.multiply=function(matrix){var m11=this.m[0]*matrix.m[0]+this.m[2]*matrix.m[1],m12=this.m[1]*matrix.m[0]+this.m[3]*matrix.m[1],m21=this.m[0]*matrix.m[2]+this.m[2]*matrix.m[3],m22=this.m[1]*matrix.m[2]+this.m[3]*matrix.m[3],dx=this.m[0]*matrix.m[4]+this.m[2]*matrix.m[5]+this.m[4],matrix=this.m[1]*matrix.m[4]+this.m[3]*matrix.m[5]+this.m[5];this.m[0]=m11,this.m[1]=m12,this.m[2]=m21,this.m[3]=m22,this.m[4]=dx,this.m[5]=matrix},Transform.prototype.invert=function(){var d=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),m0=this.m[3]*d,m1=-this.m[1]*d,m2=-this.m[2]*d,m3=this.m[0]*d,m4=d*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),d=d*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);this.m[0]=m0,this.m[1]=m1,this.m[2]=m2,this.m[3]=m3,this.m[4]=m4,this.m[5]=d},Transform.prototype.rotate=function(rad){var c=Math.cos(rad),rad=Math.sin(rad),m11=this.m[0]*c+this.m[2]*rad,m12=this.m[1]*c+this.m[3]*rad,m21=this.m[0]*-rad+this.m[2]*c,rad=this.m[1]*-rad+this.m[3]*c;this.m[0]=m11,this.m[1]=m12,this.m[2]=m21,this.m[3]=rad},Transform.prototype.translate=function(x,y){this.m[4]+=this.m[0]*x+this.m[2]*y,this.m[5]+=this.m[1]*x+this.m[3]*y},Transform.prototype.scale=function(sx,sy){this.m[0]*=sx,this.m[1]*=sx,this.m[2]*=sy,this.m[3]*=sy},Transform.prototype.transformPoint=function(px,py){var x=px,y=py;return{x:px=x*this.m[0]+y*this.m[2]+this.m[4],y:py=x*this.m[1]+y*this.m[3]+this.m[5]}}}(CBoBo),"undefined"==typeof CBoBo&&(CBoBo={}),!function(CBoBo){"use strict";function GetPointsFromLine(ptStart,ptEnd,bDontInteger){var arrRet=[];if(ptStart.x===ptEnd.x&&ptStart.y===ptEnd.y)arrRet.push(ptStart);else if(ptStart.x===ptEnd.x)if(ptStart.y>ptEnd.y)for(var y=ptStart.y;y>=ptEnd.y;y--)arrRet.push({x:ptStart.x,y:y});else for(y=ptStart.y;y<=ptEnd.y;y++)arrRet.push({x:ptStart.x,y:y});else if(ptStart.y===ptEnd.y)if(ptStart.x>ptEnd.x)for(var x=ptStart.x;x>=ptEnd.x;x--)arrRet.push({x:x,y:ptStart.y});else for(x=ptStart.x;x<=ptEnd.x;x++)arrRet.push({x:x,y:ptStart.y});else{var k=(ptEnd.y-ptStart.y)/(ptEnd.x-ptStart.x);if(Math.abs(ptStart.x-ptEnd.x)>Math.abs(ptStart.y-ptEnd.y))if(ptStart.x>ptEnd.x)for(x=ptStart.x;x>=ptEnd.x;x--){y=k*(x-ptStart.x)+ptStart.y;bDontInteger||(y=Math.round(y)),arrRet.push({x:x,y:y})}else for(x=ptStart.x;x<=ptEnd.x;x++){y=k*(x-ptStart.x)+ptStart.y;bDontInteger||(y=Math.round(y)),arrRet.push({x:x,y:y})}else if(ptStart.y>ptEnd.y)for(y=ptStart.y;y>=ptEnd.y;y--){x=(y-ptStart.y)/k+ptStart.x;bDontInteger||(x=Math.round(x)),arrRet.push({x:x,y:y})}else for(y=ptStart.y;y<=ptEnd.y;y++){x=(y-ptStart.y)/k+ptStart.x;bDontInteger||(x=Math.round(x)),arrRet.push({x:x,y:y})}}return arrRet}function IsInteger(obj){return"number"==typeof obj&&obj%1==0}!function(CBoBo){CBoBo.Mpr={GenerateMipNomalPlane:function(images,index,thicKness,blendMode){if(null==blendMode||6!=blendMode.length)return images[index];images[index].col,images[index].row;var newDicom=new DVDicomInfo,MaxV=(newDicom.id=CBoBo.Plugin.GetRandom(),newDicom.SetInfo({data:images[index]}),0),MinV=0,MeanV=0,pixz=Math.abs(images[0].pixz-images[1].pixz),thick=parseInt(thicKness/pixz);newDicom.pixsBuffer=new Int16Array(newDicom.row*newDicom.col);for(var leth=newDicom.pixsBuffer.length,pixIndex=0;pixIndex<leth;pixIndex++){for(var value,MaxV=-32768,MinV=32767,MeanV=0,j=0;j<thick;j++)j<images.length-index&&(MeanV+=(value=images[j+index].pixsBuffer[pixIndex])/thick,MaxV<value&&(MaxV=value),value<MinV)&&(MinV=value);"最大密度投影"==blendMode?newDicom.pixsBuffer[pixIndex]=MaxV:"最小密度投影"==blendMode?newDicom.pixsBuffer[pixIndex]=MinV:"平均密度投影"==blendMode&&(newDicom.pixsBuffer[pixIndex]=MeanV)}return newDicom.setPixsBuffer(newDicom.pixsBuffer),newDicom},GenerateNormalPlane:function(images,points,thicKness,blendMode){var width,newDicom,index;return null!=blendMode&&6==blendMode.length?function(images,points,thicKness,blendMode){var width=images[0].col,newDicom=(images[0].row,new DVDicomInfo),thick=(newDicom.id=CBoBo.Plugin.GetRandom(),newDicom.SetInfo({data:images[0]}),1),MaxV=0,MinV=0,MeanV=0,planeMode=0;planeMode=points[0].x==points[1].x?1:2;newDicom.row=images.length,newDicom.col=points.length,newDicom.pixy=Math.abs(images[0].pixz-images[1].pixz),thick=parseInt(thicKness/newDicom.pixx),newDicom.pixsBuffer=new Int16Array(newDicom.row*newDicom.col);var index=0;return $.each(images,function(i,dicom){$.each(points,function(){MaxV=-32768,MinV=32767;for(var j=MeanV=0;j<thick;j++){2==planeMode&&(pixIndex=width*(this.y+j)+this.x),1==planeMode&&(pixIndex=width*this.y+this.x+j);var pixIndex,value=dicom.pixsBuffer[pixIndex];MeanV+=value/thick,MaxV<value&&(MaxV=value),value<MinV&&(MinV=value)}"最大密度投影"==blendMode?newDicom.pixsBuffer[index]=MaxV:"最小密度投影"==blendMode?newDicom.pixsBuffer[index]=MinV:"平均密度投影"==blendMode&&(newDicom.pixsBuffer[index]=MeanV),index++})}),newDicom.setPixsBuffer(newDicom.pixsBuffer),newDicom}(images,points,thicKness,blendMode):(width=images[0].col,thicKness=Math.abs(images[0].pixz-images[1].pixz),(newDicom=new DVDicomInfo).SetInfo({data:images[0]}),newDicom.pixy=thicKness,newDicom.id=CBoBo.Plugin.GetRandom(),newDicom.row=images.length,newDicom.col=points.length,newDicom.pixsBuffer=new Int16Array(newDicom.row*newDicom.col),index=0,$.each(images,function(i,dicom){$.each(points,function(){var pixIndex=width*this.y+this.x;newDicom.pixsBuffer[index]=dicom.pixsBuffer[pixIndex],index++})}),newDicom.setPixsBuffer(newDicom.pixsBuffer),newDicom)},GenerateSlopePlane:function(images,ptStart,ptEnd,type){var pixIndex,pix,newDicom=new DVDicomInfo,sliceth=(newDicom.SetInfo({data:images[0]}),newDicom.id=CBoBo.Plugin.GetRandom(),parseFloat(images[0].sliceth)),angle=function(ptStart,ptEnd){return ptStart.x===ptEnd.x&&ptStart.y===ptEnd.y?0:ptStart.x===ptEnd.x?90:ptStart.y===ptEnd.y?0:Math.abs(180*Math.atan((ptEnd.y-ptStart.y)/(ptEnd.x-ptStart.x))/Math.PI)}(ptStart,ptEnd),arrPoints=(newDicom.pixx=(sliceth-newDicom.pixx)/90*angle+newDicom.pixx,GetPointsFromLine(ptStart,ptEnd,!0)),index=(newDicom.col=arrPoints.length,0);if(90===type){newDicom.row=images[0].row,newDicom.pixsBuffer=new Int16Array(newDicom.row*newDicom.col);for(var i=0;i<newDicom.row;i++)$.each(arrPoints,function(){var indexDown,dicom1,indexUp;pixIndex=parseInt(i*images[0].col+this.x),pix=IsInteger(this.y)?(this.y=Math.max(0,Math.min(images.length-1,this.y)),images[this.y].pixsBuffer[pixIndex]):(indexUp=(indexDown=Math.floor(this.y))+1,indexUp=Math.max(0,Math.min(images.length-1,indexUp)),indexDown=Math.max(0,Math.min(images.length-1,indexDown)),dicom1=images[indexDown],indexUp=images[indexUp],indexDown=this.y-indexDown,dicom1=dicom1.pixsBuffer[pixIndex],indexUp=indexUp.pixsBuffer[pixIndex],pix=dicom1*(1-indexDown)+indexUp*indexDown,Math.round(pix)),newDicom.pixsBuffer[index]=pix,index++})}else{if(180!==type)return;newDicom.row=images[0].col,newDicom.pixsBuffer=new Int16Array(newDicom.row*newDicom.col);for(i=0;i<newDicom.row;i++)$.each(arrPoints,function(){var indexDown,dicom1,indexUp;pixIndex=images[0].col*parseInt(this.x)+i,pix=IsInteger(this.y)?(this.y=Math.max(0,Math.min(images.length-1,this.y)),images[this.y].pixsBuffer[pixIndex]):(indexUp=(indexDown=Math.floor(this.y))+1,indexUp=Math.max(0,Math.min(images.length-1,indexUp)),indexDown=Math.max(0,Math.min(images.length-1,indexDown)),dicom1=images[indexDown],indexUp=images[indexUp],indexDown=this.y-indexDown,dicom1=dicom1.pixsBuffer[pixIndex],indexUp=indexUp.pixsBuffer[pixIndex],pix=dicom1*(1-indexDown)+indexUp*indexDown,Math.round(pix)),newDicom.pixsBuffer[index]=pix,index++})}return newDicom.setPixsBuffer(newDicom.pixsBuffer),newDicom},GenerateSurface:function(images,points){for(var imgpoints=[],i=0;i<points.length;i++){var pt1=points[i],pt2=points[i+1];if(void 0===pt2)break;pt1=GetPointsFromLine(pt1,pt2);$.each(pt1,function(){imgpoints.push(this)})}var newDicom=new DVDicomInfo,index=(newDicom.SetInfo({data:images[0]}),newDicom.id=CBoBo.Plugin.GetRandom(),newDicom.pixy=parseFloat(images[0].sliceth),newDicom.row=images.length,newDicom.col=imgpoints.length,newDicom.pixsBuffer=new Int16Array(newDicom.row*newDicom.col),0);return $.each(images,function(i,dicom){$.each(imgpoints,function(){var pixIndex=images[0].col*this.y+this.x;newDicom.pixsBuffer[index]=dicom.pixsBuffer[pixIndex],index++})}),newDicom.setPixsBuffer(newDicom.pixsBuffer),newDicom},GetPointsFromLine:GetPointsFromLine}}(CBoBo),function(CBoBo){CBoBo.Mip={GenerateMipPlane:function(images,points,planeMode,thicKness,blendMode){var width=images[0].col,newDicom=(images[0].row,new DVDicomInfo),thick=(newDicom.id=CBoBo.Plugin.GetRandom(),newDicom.SetInfo({data:images[0]}),1),MaxV=0,MinV=0,MeanV=0;if(0==planeMode){var pixz=Math.abs(images[0].pixz-images[1].pixz),thick=parseInt(thicKness/pixz);newDicom.pixsBuffer=new Int16Array(newDicom.row*newDicom.col);for(var leth=newDicom.pixsBuffer.length,pixIndex=0;i<leth;pixIndex++)for(var value,MaxV=65535,MinV=-65535,MeanV=0,j=points;j<thick;j++)j<images.length&&(value=images[j].pixsBuffer[pixIndex],MeanV+=value/thick,MaxV<value&&(MaxV=value),value<MinV)&&(MinV=value);"Max"==blendMode?newDicom.pixsBuffer[index]=MaxV:"Min"==blendMode?newDicom.pixsBuffer[index]=MinV:"Mean"==blendMode&&(newDicom.pixsBuffer[index]=MeanV)}else{newDicom.row=images.length,newDicom.col=points.length,newDicom.pixy=Math.abs(images[0].pixz-images[1].pixz),thick=parseInt(thicKness/newDicom.pixx),newDicom.pixsBuffer=new Int16Array(newDicom.row*newDicom.col);var index=0;$.each(images,function(i,dicom){$.each(points,function(){MinV=-(MaxV=65535);for(var j=MeanV=0;j<thick;j++){2==planeMode&&(pixIndex=width*(this.y+j)+this.x),1==planeMode&&(pixIndex=width*this.y+this.x+j);var pixIndex,value=dicom.pixsBuffer[pixIndex];MeanV+=value,MaxV<value&&(MaxV=value),value<MinV&&(MinV=value)}MeanV/=thick,"Max"==blendMode?newDicom.pixsBuffer[index]=MaxV:"Min"==blendMode?newDicom.pixsBuffer[index]=MinV:"Mean"==blendMode&&(newDicom.pixsBuffer[index]=MeanV),index++})})}return newDicom.setPixsBuffer(newDicom.pixsBuffer),newDicom}}}(CBoBo)}(CBoBo),"undefined"==typeof CBoBo&&(CBoBo={}),!function(CBoBo){"use strict";var configManager=new function(){var defaultColor="#ff8000",activeColor="#dd0",fillColor="transparent",defaultFontSize=15,defaultFont=defaultFontSize+"px Arial",defaultBackgroundColor="transparent",defaultWidth=1;this.setFillColor=function(color){fillColor=color},this.getFillColor=function(){return fillColor},this.setToolColor=function(color){defaultColor=color},this.getToolColor=function(){return defaultColor},this.setActiveToolColor=function(color){activeColor=color},this.getActiveToolColor=function(){return activeColor},this.getColorIfActive=function(active){return active?activeColor:defaultColor},this.setToolWidth=function(width){defaultWidth=width},this.getToolWidth=function(){return defaultWidth},this.setFont=function(font){defaultFont=font},this.getFont=function(){return defaultFont},this.setFontSize=function(fontSize){defaultFontSize=fontSize},this.getFontSize=function(){return defaultFontSize},this.setBackgroundColor=function(backgroundColor){defaultBackgroundColor=backgroundColor},this.getBackgroundColor=function(){return defaultBackgroundColor},this.getshadowColor=function(){return"#000000"},this.getshadowOffsetX=function(){return 1},this.getshadowOffsetY=function(){return 1},this.GetHandleColor=function(){return"#ff0"}},cacheAnnotationManager={recordAnn:void 0,SetRecordAnn:function(ann){this.recordAnn=ann},GetRecordAnn:function(){return this.recordAnn},newAnn:void 0,SetNewAnn:function(ann){this.newAnn=ann},GetNewAnn:function(){return this.newAnn},modifyAnn:void 0,SetModifyAnn:function(ann){this.modifyAnn=ann},GetModifyAnn:function(){return this.modifyAnn}};function Sqr(x){return x*x}function Dist2(v,w){return Sqr(v.x-w.x)+Sqr(v.y-w.y)}function DistanceToPoint(lineSegment,point){return Math.sqrt(function(lineSegment,point){var l2=Dist2(lineSegment.start,lineSegment.end);return Dist2(point,0===l2||(point=((point.x-lineSegment.start.x)*(lineSegment.end.x-lineSegment.start.x)+(point.y-lineSegment.start.y)*(lineSegment.end.y-lineSegment.start.y))/l2)<0?lineSegment.start:1<point?lineSegment.end:{x:lineSegment.start.x+point*(lineSegment.end.x-lineSegment.start.x),y:lineSegment.start.y+point*(lineSegment.end.y-lineSegment.start.y)})}(lineSegment,point))}function DrawTextBox(context,textLines,x,y,color,options){textLines instanceof Array||(textLines=[textLines]);var font=configManager.getFont(),fontSize=configManager.getFontSize(),backgroundColor=configManager.getBackgroundColor(),maxWidth=(context.save(),context.font=font,context.textBaseline="top",context.strokeStyle=color,0),font=(textLines.forEach(function(text){text=context.measureText(text).width;maxWidth=Math.max(maxWidth,text)}),context.fillStyle=backgroundColor,{width:maxWidth+10,height:5+textLines.length*(fontSize+5)});return options&&options.centering&&!0===options.centering.x&&(x-=font.width/2),options&&options.centering&&!0===options.centering.y&&(y-=font.height/2),font.left=x,font.top=y,options&&!0===options.debug&&(context.fillStyle="#FF0000"),context.fillRect(font.left,font.top,font.width,font.height),textLines.forEach(function(text,index){context.fillStyle=color,context.fillText(text,x+5,y+5+index*(fontSize+5))}),context.restore(),font}function Distance(from,to){return Math.sqrt(function(from,to){from=function(lhs,rhs){return{x:lhs.x-rhs.x,y:lhs.y-rhs.y}}(from,to);return from.x*from.x+from.y*from.y}(from,to))}function FindClosestPoint(sources,target){for(var minDistance,arrdistances=[],i=0;i<sources.length;i++){var distance=Distance(sources[i],target);arrdistances.push(distance),minDistance=0===i?distance:Math.min(distance,minDistance)}return sources[arrdistances.indexOf(minDistance)]}function DrawHandles(context,points){if(context.save(),context.strokeStyle=configManager.GetHandleColor(),points instanceof Array&&!(points.length<1)){for(var i=0;i<points.length;i++){context.beginPath();var point=points[i];context.fillStyle="#00FF00",context.arc(point.x,point.y,10,0,2*Math.PI),context.fill()}context.restore()}}function PixlePoints2CanvasPoints(status,canvas,pixlePoints){for(var points=[],i=0;i<pixlePoints.length;i++){var ptPixle=pixlePoints[i],ptPixle=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,ptPixle);points.push(ptPixle)}return points}function PointInNearPonits(point,points){for(var i=0;i<points.length;i++)if(Distance(points[i],point)<40)return i;return-1}function InsideRect(point,rect){return!(point.x<rect.left||point.x>rect.left+rect.width||point.y<rect.top||point.y>rect.top+rect.height)}function PageCoods2Canvas(canvas,pageX,pageY){canvas=canvas.getBoundingClientRect();return{x:pageX-canvas.left-window.pageXOffset,y:pageY-canvas.top-window.pageYOffset}}function InitContext(canvas){canvas=canvas.getContext("2d");return canvas.lineWidth=configManager.getToolWidth(),canvas.shadowColor=configManager.getshadowColor(),canvas.shadowOffsetX=configManager.getshadowOffsetX(),canvas.shadowOffsetY=configManager.getshadowOffsetY(),canvas.shadowBlur=.5,canvas.setTransform(1,0,0,1,0,0),canvas}function GetStoredPixels(image,x,y,width,height){if(void 0===image)throw"GetStoredPixels: parameter image must not be undefined.";x=Math.round(x),y=Math.round(y);for(var storedPixels=[],index=0,pixelData=image.pixsBuffer,row=0;row<height;row++)for(var column=0;column<width;column++){var spIndex=(row+y)*image.col+(column+x);storedPixels[index++]=pixelData[spIndex]}return storedPixels}function GetPixels(image,x,y,width,height){var localSlope,localIntercept,x=GetStoredPixels(image,x,y,width,height);return 1===image.rescsl&&0===image.rescin?x:x.map((y=image.rescsl,width=image.rescin,localSlope=parseInt(y),isNaN(localSlope)&&(localSlope=1),localIntercept=parseInt(width),isNaN(localIntercept)&&(localIntercept=0),function(sp){return sp*localSlope+localIntercept}))}function Point(a,b){a instanceof Object&&1==arguments.length?(this.x=a.x,this.y=a.y):(this.x=a,this.y=b)}function AnnPoint(){this.type="probe",this.active=!1,this.handles={end:{x:0,y:0}}}function AnnLine(){this.type="line",this.active=!1,this.length=0,this.invalid=!0,this.index=-1,this.handles={start:{x:0,y:0},end:{x:0,y:0}},this.textBox={active:!1,hasMoved:!1,x:0,y:0,text:"",boundingBox:{}}}function AnnRect(){this.type="rect",this.active=!1,this.index=-1,this.area=0,this.invalid=!0,this.isServer=!1,this.handles={start:{x:0,y:0},end:{x:0,y:0}},this.textBox={active:!1,hasMoved:!1,x:0,y:0,boundingBox:{}},this.ellipse={left:0,top:0,width:0,height:0},this.meanStdDev={count:0,mean:0,variance:0,stdDev:0}}function AnnEllipse(){this.type="ellipse",this.active=!1,this.index=-1,this.invalid=!0,this.isServer=!1,this.handles={start:{x:0,y:0},end:{x:0,y:0}},this.textBox={active:!1,hasMoved:!1,x:0,y:0,boundingBox:{}},this.ellipse={left:0,top:0,width:0,height:0},this.meanStdDev={count:0,mean:0,variance:0,stdDev:0}}function AnnArrow(){this.type="arrow",this.active=!1,this.index=-1,this.handles={start:{x:0,y:0},end:{x:0,y:0}}}function AnnAngle(){this.type="angle",this.active=!1,this.index=-1,this.angle=0,this.invalid=!0,this.createHitNums=0,this.handles={start:{x:0,y:0},center:{x:0,y:0},end:{x:0,y:0}},this.textBox={active:!1,hasMoved:!1,x:0,y:0,boundingBox:{}}}function AnnText(){this.type="text",this.text="",this.textBox={active:!1,x:0,y:0,boundingBox:{}},this.text=prompt("请输入文本:","")}function AnnLR(type){this.type=type,this.active=!1,this.handles={start:{x:0,y:0},end:{x:0,y:0}}}function AnnHeartRatio(){this.type="heartratio",this.active=!1,this.index=-1,this.lineIndex=-1,this.ratio=0,this.invalid=!0,this.topline={start:{x:0,y:0},end:{x:0,y:0}},this.downline={start:{x:0,y:0},end:{x:0,y:0}},this.textBox={active:!1,hasMoved:!1,x:0,y:0,boundingBox:{}}}AnnPoint.prototype.Draw=function(status,canvas,context){var intercept,text,sp,slope,color=configManager.getColorIfActive(this.active),handleStartCanvas=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.end),handleStartCanvas=[{x:handleStartCanvas.x,y:handleStartCanvas.y-4},{x:handleStartCanvas.x-4,y:handleStartCanvas.y},{x:handleStartCanvas.x,y:handleStartCanvas.y+4},{x:handleStartCanvas.x+4,y:handleStartCanvas.y}],handleStartCanvas=(context.beginPath(),context.strokeStyle=color,context.moveTo(handleStartCanvas[0].x,handleStartCanvas[0].y),context.lineTo(handleStartCanvas[2].x,handleStartCanvas[2].y),context.moveTo(handleStartCanvas[1].x,handleStartCanvas[1].y),context.lineTo(handleStartCanvas[3].x,handleStartCanvas[3].y),context.stroke(),this.active&&DrawHandles(context,PixlePoints2CanvasPoints(status,canvas,[this.handles.end])),context.fillStyle=color,Math.round(this.handles.end.x)),y=Math.round(this.handles.end.y);handleStartCanvas<0||y<0||handleStartCanvas>=status.image.col||y>=status.image.row||(status.image.color||(sp=GetStoredPixels(status.image,handleStartCanvas,y,1,1)[0],slope=parseInt(status.image.rescsl),intercept=parseInt(status.image.rescin),text="x : "+handleStartCanvas+", y : "+y,sp="sp: "+sp+" mo: "+parseFloat((sp*slope+intercept).toFixed(3))),handleStartCanvas={x:this.handles.end.x+3,y:this.handles.end.y-5},y=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,handleStartCanvas),slope=configManager.getFontSize(),DrawTextBox(context,sp,y.x,y.y+slope+5,color),DrawTextBox(context,text,y.x,y.y,color))},AnnPoint.prototype.PointIsPointNear=function(status,canvas,ptCanvas){ptCanvas=PointInNearPonits(ptCanvas,PixlePoints2CanvasPoints(status,canvas,[this.handles.end]));return-1!==(this.index=ptCanvas)},AnnPoint.prototype.Modify=function(deltaX,deltaY){this.handles.end.x+=deltaX,this.handles.end.y+=deltaY},AnnLine.prototype.Draw=function(status,canvas,context){var points,color=configManager.getColorIfActive(this.active||this.textBox.active),handleStartCanvas=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.start),handleEndCanvas=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.end),suffix=(context.beginPath(),context.strokeStyle=color,context.moveTo(handleStartCanvas.x,handleStartCanvas.y),context.lineTo(handleEndCanvas.x,handleEndCanvas.y),context.stroke(),this.active&&DrawHandles(context,points=PixlePoints2CanvasPoints(status,canvas,points=this.GetHandlePoints())),context.fillStyle=color,this.invalid&&this.Calculate(status)," mm"),suffix=(status.image.pixx&&status.image.pixy||(suffix=" pixels"),""+this.length.toFixed(2)+suffix),coords=(this.textBox.hasMoved||((coords={x:Math.max(this.handles.start.x,this.handles.end.x)}).x===this.handles.start.x?coords.y=this.handles.start.y:coords.y=this.handles.end.y,this.textBox.x=coords.x,this.textBox.y=coords.y),CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.textBox)),status=(coords.x+=10,DrawTextBox(context,suffix,coords.x,coords.y,color));this.textBox.boundingBox=status,this.textBox.hasMoved&&(points=[handleStartCanvas,handleEndCanvas,{x:(handleStartCanvas.x+handleEndCanvas.x)/2,y:(handleStartCanvas.y+handleEndCanvas.y)/2}],(canvas={start:{},end:{}}).end.x=coords.x,canvas.end.y=coords.y,canvas.start=FindClosestPoint(points,canvas.end),suffix=[{x:status.left+status.width/2,y:status.top},{x:status.left,y:status.top+status.height/2},{x:status.left+status.width/2,y:status.top+status.height},{x:status.left+status.width,y:status.top+status.height/2}],canvas.end=FindClosestPoint(suffix,canvas.start),context.save(),context.beginPath(),context.strokeStyle=color,context.setLineDash([2,3]),context.moveTo(canvas.start.x,canvas.start.y),context.lineTo(canvas.end.x,canvas.end.y),context.stroke(),context.restore())},AnnLine.prototype.PointIsLineNear=function(status,canvas,ptCanvas){return DistanceToPoint({start:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.start),end:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.end)},ptCanvas)<10},AnnLine.prototype.PointIsPointNear=function(status,canvas,ptCanvas){ptCanvas=PointInNearPonits(ptCanvas,PixlePoints2CanvasPoints(status,canvas,this.GetHandlePoints()));return-1!==(this.index=ptCanvas)},AnnLine.prototype.GetHandlePoints=function(){var points=[];return points.push(this.handles.start),points.push(this.handles.end),points},AnnLine.prototype.PointIsInTextBox=function(status,canvas,pageX,pageY){return InsideRect(PageCoods2Canvas(canvas,pageX,pageY),this.textBox.boundingBox)},AnnLine.prototype.Calculate=function(status){var dx=(this.handles.end.x-this.handles.start.x)*(status.image.pixy||1),status=(this.handles.end.y-this.handles.start.y)*(status.image.pixx||1),dx=Math.sqrt(dx*dx+status*status);this.length=dx,this.invalid=!1},AnnLine.prototype.Modify=function(deltaX,deltaY){var bCalculate=!0;if(this.textBox.active)this.textBox.hasMoved=!0,this.textBox.x+=deltaX,this.textBox.y+=deltaY;else{switch(this.index){case 0:this.handles.start.x+=deltaX,this.handles.start.y+=deltaY;break;case 1:this.handles.end.x+=deltaX,this.handles.end.y+=deltaY;break;default:this.handles.start.x+=deltaX,this.handles.start.y+=deltaY,this.handles.end.x+=deltaX,this.handles.end.y+=deltaY,bCalculate=!1}this.invalid=bCalculate}},AnnRect.prototype.Draw=function(status,canvas,context,isAIDescription,serverDescritpion){var points,color=configManager.getColorIfActive(this.active||this.textBox.active),handleStartCanvas=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.start),handleEndCanvas=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.end),widthCanvas=Math.abs(handleStartCanvas.x-handleEndCanvas.x),heightCanvas=Math.abs(handleStartCanvas.y-handleEndCanvas.y),leftCanvas=Math.min(handleStartCanvas.x,handleEndCanvas.x),handleStartCanvas=Math.min(handleStartCanvas.y,handleEndCanvas.y),heightCanvas=(context.beginPath(),context.strokeStyle=color,context.rect(leftCanvas,handleStartCanvas,widthCanvas,heightCanvas),context.stroke(),this.active&&DrawHandles(context,points=PixlePoints2CanvasPoints(status,canvas,points=this.GetHandlePoints())),this.invalid&&(width=Math.abs(this.handles.start.x-this.handles.end.x),height=Math.abs(this.handles.start.y-this.handles.end.y),handleEndCanvas=Math.min(this.handles.start.x,this.handles.end.x),leftCanvas=Math.min(this.handles.start.y,this.handles.end.y),this.ellipse=handleStartCanvas={left:handleEndCanvas,top:leftCanvas,width:width,height:height},this.context=context,CBoBo.Draw.GetIsFromServer()||(widthCanvas=GetPixels(status.image,handleEndCanvas,leftCanvas,width,height),this.Calculate(widthCanvas,handleStartCanvas),this.area=width*(status.image.pixx||1)*(height*(status.image.pixy||1)),this.invalid=!1)),CBoBo.Draw.GetIsFromServer()&&(this.area=width*(status.image.pixx||1)*(height*(status.image.pixy||1)))," mm²"),handleEndCanvas=(status.image.pixx&&status.image.pixy||(heightCanvas=" pixel²"),"Area: "+this.area.toFixed(2)+heightCanvas),widthCanvas=(this.textBox.hasMoved||(leftCanvas=this.GetHandlePoints(),status.hflip?(this.textBox.bRight=leftCanvas[1].x>status.image.col>>1,this.textBox.x=(this.textBox.bRight?leftCanvas[0]:leftCanvas[2]).x):(this.textBox.bRight=leftCanvas[1].x<status.image.col>>1,this.textBox.x=(this.textBox.bRight?leftCanvas[2]:leftCanvas[0]).x),status.vflip?this.textBox.y=leftCanvas[4].y:this.textBox.y=leftCanvas[0].y),CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.textBox)),handleStartCanvas=context.measureText(heightCanvas),height=(this.textBox.bRight?widthCanvas.x+=8:(width=context.measureText(handleEndCanvas),widthCanvas.x=widthCanvas.x-handleStartCanvas.width-width.width-8),""),leftCanvas=("CT"===status.image.mod&&(height=" HU"),context.fillStyle=color,"Mean: "+this.meanStdDev.mean.toFixed(2)+height),heightCanvas="StdDev: "+this.meanStdDev.stdDev.toFixed(2)+height,handleStartCanvas=[],width=(handleStartCanvas.push(leftCanvas),handleStartCanvas.push(heightCanvas),handleStartCanvas.push(handleEndCanvas),DrawTextBox(context,handleStartCanvas,widthCanvas.x,widthCanvas.y,color));this.textBox.boundingBox=width,this.textBox.hasMoved&&(height={start:{},end:{}},points=PixlePoints2CanvasPoints(status,canvas,points=this.GetHandlePoints()),height.end.x=widthCanvas.x,height.end.y=widthCanvas.y,height.start=FindClosestPoint(points,height.end),leftCanvas=[{x:width.left+width.width/2,y:width.top},{x:width.left,y:width.top+width.height/2},{x:width.left+width.width/2,y:width.top+width.height},{x:width.left+width.width,y:width.top+width.height/2}],height.end=FindClosestPoint(leftCanvas,height.start),context.save(),context.beginPath(),context.strokeStyle=color,context.setLineDash([2,3]),context.moveTo(height.start.x,height.start.y),context.lineTo(height.end.x,height.end.y),context.stroke(),context.restore())},AnnRect.prototype.GetHandlePoints=function(){var points=[],leftCanvas=Math.min(this.handles.start.x,this.handles.end.x),topCanvas=Math.min(this.handles.start.y,this.handles.end.y),rightCanvas=Math.max(this.handles.start.x,this.handles.end.x),bottomCanvas=Math.max(this.handles.start.y,this.handles.end.y),centerX=this.handles.start.x+this.handles.end.x>>1,centerY=this.handles.start.y+this.handles.end.y>>1;return points.push(new Point(leftCanvas,topCanvas)),points.push(new Point(centerX,topCanvas)),points.push(new Point(rightCanvas,topCanvas)),points.push(new Point(rightCanvas,centerY)),points.push(new Point(rightCanvas,bottomCanvas)),points.push(new Point(centerX,bottomCanvas)),points.push(new Point(leftCanvas,bottomCanvas)),points.push(new Point(leftCanvas,centerY)),points},AnnRect.prototype.Calculate=function(sp,ellipse){for(var sum=0,sumSquared=0,count=0,index=0,y=ellipse.top;y<ellipse.top+ellipse.height;y++)for(var x=ellipse.left;x<ellipse.left+ellipse.width;x++)sum+=sp[index],sumSquared+=sp[index]*sp[index],count++,index++;0===count&&(this.meanStdDev={count:count,mean:0,variance:0,stdDev:0});var mean=sum/count,variance=sumSquared/count-mean*mean;this.meanStdDev={count:count,mean:mean,variance:variance,stdDev:Math.sqrt(variance)}},AnnRect.prototype.PointIsLineNear=function(status,canvas,ptCanvas){var points=this.GetHandlePoints();return DistanceToPoint({start:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,points[0]),end:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,points[2])},ptCanvas)<20||DistanceToPoint({start:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,points[2]),end:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,points[4])},ptCanvas)<20||DistanceToPoint({start:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,points[4]),end:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,points[6])},ptCanvas)<20||DistanceToPoint({start:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,points[0]),end:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,points[6])},ptCanvas)<20},AnnRect.prototype.PointIsPointNear=function(status,canvas,ptCanvas){ptCanvas=PointInNearPonits(ptCanvas,PixlePoints2CanvasPoints(status,canvas,this.GetHandlePoints()));return-1!==(this.index=ptCanvas)},AnnRect.prototype.PointIsInTextBox=function(status,canvas,pageX,pageY){return InsideRect(PageCoods2Canvas(canvas,pageX,pageY),this.textBox.boundingBox)},AnnRect.prototype.Modify=function(deltaX,deltaY){if(this.textBox.active)this.textBox.hasMoved=!0,this.textBox.x+=deltaX,this.textBox.y+=deltaY;else{var left=this.handles.start.x,top=this.handles.start.y,right=this.handles.end.x,bottom=this.handles.end.y;switch(this.index){case 0:left+=deltaX,top+=deltaY;break;case 1:top+=deltaY;break;case 2:right+=deltaX,top+=deltaY;break;case 3:right+=deltaX;break;case 4:right+=deltaX,bottom+=deltaY;break;case 5:bottom+=deltaY;break;case 6:left+=deltaX,bottom+=deltaY;break;case 7:left+=deltaX;break;default:left+=deltaX,top+=deltaY,right+=deltaX,bottom+=deltaY}this.handles.start.x=left,this.handles.start.y=top,this.handles.end.x=right,this.handles.end.y=bottom,this.invalid=!0}},AnnRect.prototype.ServerModify=function(deltaX,deltaY){this.textBox.active&&(this.textBox.hasMoved=!0,this.textBox.x+=deltaX,this.textBox.y+=deltaY)},AnnRect.prototype.CorrectPoint=function(){var left=Math.min(this.handles.start.x,this.handles.end.x),top=Math.min(this.handles.start.y,this.handles.end.y),right=Math.max(this.handles.start.x,this.handles.end.x),bottom=Math.max(this.handles.start.y,this.handles.end.y);this.handles.start.x=left,this.handles.start.y=top,this.handles.end.x=right,this.handles.end.y=bottom},AnnEllipse.prototype.Draw=function(status,canvas,context){var points,color=configManager.getColorIfActive(this.active||this.textBox.active),handleStartCanvas=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.start),handleEndCanvas=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.end),leftCanvas=Math.min(handleStartCanvas.x,handleEndCanvas.x),topCanvas=Math.min(handleStartCanvas.y,handleEndCanvas.y),widthCanvas=Math.abs(handleStartCanvas.x-handleEndCanvas.x),handleStartCanvas=Math.abs(handleStartCanvas.y-handleEndCanvas.y),leftCanvas=(context.beginPath(),context.strokeStyle=color,this.DrawEllipse(context,leftCanvas,topCanvas,widthCanvas,handleStartCanvas),context.closePath(),this.active&&DrawHandles(context,points=PixlePoints2CanvasPoints(status,canvas,points=this.GetHandlePoints())),this.invalid&&(handleEndCanvas=Math.abs(this.handles.start.x-this.handles.end.x),leftCanvas=Math.abs(this.handles.start.y-this.handles.end.y),topCanvas=Math.min(this.handles.start.x,this.handles.end.x),widthCanvas=Math.min(this.handles.start.y,this.handles.end.y),this.ellipse=handleStartCanvas={left:topCanvas,top:widthCanvas,width:handleEndCanvas,height:leftCanvas},this.context=context,CBoBo.Draw.GetIsFromServer()||(topCanvas=GetPixels(status.image,topCanvas,widthCanvas,handleEndCanvas,leftCanvas),this.Calculate(topCanvas,handleStartCanvas),this.invalid=!1),widthCanvas=status.image.pixx||1,handleEndCanvas=status.image.pixy||1,this.area=Math.PI*(handleStartCanvas.width*widthCanvas/2)*(handleStartCanvas.height*handleEndCanvas/2)),""),topCanvas=("CT"===status.image.mod&&(leftCanvas=" HU")," mm²"),widthCanvas=(status.image.pixx&&status.image.pixy||(topCanvas=" pixel²"),"Area: "+this.area.toFixed(2)+topCanvas),handleEndCanvas=(this.textBox.hasMoved||(handleStartCanvas=this.GetHandlePoints(),status.hflip?(this.textBox.bRight=handleStartCanvas[0].x>status.image.col>>1,this.textBox.x=(this.textBox.bRight?handleStartCanvas[3]:handleStartCanvas[1]).x):(this.textBox.bRight=handleStartCanvas[0].x<status.image.col>>1,this.textBox.x=(this.textBox.bRight?handleStartCanvas[1]:handleStartCanvas[3]).x),status.vflip?this.textBox.y=handleStartCanvas[2].y:this.textBox.y=handleStartCanvas[0].y),CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.textBox)),handleStartCanvas=context.measureText(topCanvas),handleStartCanvas=(this.textBox.bRight?handleEndCanvas.x+=8:(topCanvas=context.measureText(widthCanvas),handleEndCanvas.x=handleEndCanvas.x-handleStartCanvas.width-topCanvas.width-5),context.fillStyle=color,"Mean: "+this.meanStdDev.mean.toFixed(2)+leftCanvas),topCanvas="StdDev: "+this.meanStdDev.stdDev.toFixed(2)+leftCanvas,leftCanvas=[],handleStartCanvas=(leftCanvas.push(handleStartCanvas),leftCanvas.push(topCanvas),leftCanvas.push(widthCanvas),DrawTextBox(context,leftCanvas,handleEndCanvas.x,handleEndCanvas.y,color));this.textBox.boundingBox=handleStartCanvas,this.textBox.hasMoved&&(topCanvas={start:{},end:{}},points=PixlePoints2CanvasPoints(status,canvas,points=this.GetHandlePoints()),topCanvas.end.x=handleEndCanvas.x,topCanvas.end.y=handleEndCanvas.y,topCanvas.start=FindClosestPoint(points,topCanvas.end),widthCanvas=[{x:handleStartCanvas.left+handleStartCanvas.width/2,y:handleStartCanvas.top},{x:handleStartCanvas.left,y:handleStartCanvas.top+handleStartCanvas.height/2},{x:handleStartCanvas.left+handleStartCanvas.width/2,y:handleStartCanvas.top+handleStartCanvas.height},{x:handleStartCanvas.left+handleStartCanvas.width,y:handleStartCanvas.top+handleStartCanvas.height/2}],topCanvas.end=FindClosestPoint(widthCanvas,topCanvas.start),context.save(),context.beginPath(),context.strokeStyle=color,context.setLineDash([2,3]),context.moveTo(topCanvas.start.x,topCanvas.start.y),context.lineTo(topCanvas.end.x,topCanvas.end.y),context.stroke(),context.restore())},AnnEllipse.prototype.DrawEllipse=function(context,x,y,w,h){var ox=w/2*.5522848,oy=h/2*.5522848,xe=x+w,ye=y+h,w=x+w/2,h=y+h/2;context.beginPath(),context.moveTo(x,h),context.bezierCurveTo(x,h-oy,w-ox,y,w,y),context.bezierCurveTo(w+ox,y,xe,h-oy,xe,h),context.bezierCurveTo(xe,h+oy,w+ox,ye,w,ye),context.bezierCurveTo(w-ox,ye,x,h+oy,x,h),context.closePath(),context.stroke()},AnnEllipse.prototype.GetHandlePoints=function(){var points=[],leftCanvas=(Math.abs(this.handles.start.x-this.handles.end.x),Math.abs(this.handles.start.y-this.handles.end.y),Math.min(this.handles.start.x,this.handles.end.x)),topCanvas=Math.min(this.handles.start.y,this.handles.end.y),rightCanvas=Math.max(this.handles.start.x,this.handles.end.x),bottomCanvas=Math.max(this.handles.start.y,this.handles.end.y),centerX=this.handles.start.x+this.handles.end.x>>1,centerY=this.handles.start.y+this.handles.end.y>>1;return points.push(new Point(centerX,topCanvas)),points.push(new Point(rightCanvas,centerY)),points.push(new Point(centerX,bottomCanvas)),points.push(new Point(leftCanvas,centerY)),points},AnnEllipse.prototype.PointInEllipse=function(ellipse,location){var center_x,xRadius=ellipse.width/2,yRadius=ellipse.height/2;return!(xRadius<=0||yRadius<=0)&&(center_x=ellipse.left+xRadius,ellipse=ellipse.top+yRadius,(center_x=location.x-center_x)*center_x/(xRadius*xRadius)+(center_x=location.y-ellipse)*center_x/(yRadius*yRadius)<=1)},AnnEllipse.prototype.Calculate=function(sp,ellipse){for(var sum=0,sumSquared=0,count=0,index=0,y=ellipse.top;y<ellipse.top+ellipse.height;y++)for(var x=ellipse.left;x<ellipse.left+ellipse.width;x++)!0===this.PointInEllipse(ellipse,{x:x,y:y})&&(sum+=sp[index],sumSquared+=sp[index]*sp[index],count++),index++;0===count&&(this.meanStdDev={count:count,mean:0,variance:0,stdDev:0});var mean=sum/count,variance=sumSquared/count-mean*mean;this.meanStdDev={count:count,mean:mean,variance:variance,stdDev:Math.sqrt(variance)}},AnnEllipse.prototype.PointIsLineNear=function(status,canvas,ptCanvas){var startCanvas=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.start),status=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.end),canvas={left:Math.min(startCanvas.x,status.x)+7.5,top:Math.min(startCanvas.y,status.y)+7.5,width:Math.abs(startCanvas.x-status.x)-15,height:Math.abs(startCanvas.y-status.y)-15},startCanvas={left:Math.min(startCanvas.x,status.x)-7.5,top:Math.min(startCanvas.y,status.y)-7.5,width:Math.abs(startCanvas.x-status.x)+15,height:Math.abs(startCanvas.y-status.y)+15},status=this.PointInEllipse(canvas,ptCanvas);return!(!this.PointInEllipse(startCanvas,ptCanvas)||status)},AnnEllipse.prototype.PointIsPointNear=function(status,canvas,ptCanvas){ptCanvas=PointInNearPonits(ptCanvas,PixlePoints2CanvasPoints(status,canvas,this.GetHandlePoints()));return-1!==(this.index=ptCanvas)},AnnEllipse.prototype.PointIsInTextBox=function(status,canvas,pageX,pageY){return InsideRect(PageCoods2Canvas(canvas,pageX,pageY),this.textBox.boundingBox)},AnnEllipse.prototype.Modify=function(deltaX,deltaY){if(this.textBox.active)this.textBox.hasMoved=!0,this.textBox.x+=deltaX,this.textBox.y+=deltaY;else{var left=this.handles.start.x,top=this.handles.start.y,right=this.handles.end.x,bottom=this.handles.end.y;switch(this.index){case 0:top+=deltaY;break;case 1:right+=deltaX;break;case 2:bottom+=deltaY;break;case 3:left+=deltaX;break;default:left+=deltaX,top+=deltaY,right+=deltaX,bottom+=deltaY}this.handles.start.x=left,this.handles.start.y=top,this.handles.end.x=right,this.handles.end.y=bottom,this.invalid=!0}},AnnEllipse.prototype.CorrectPoint=function(){var left=Math.min(this.handles.start.x,this.handles.end.x),top=Math.min(this.handles.start.y,this.handles.end.y),right=Math.max(this.handles.start.x,this.handles.end.x),bottom=Math.max(this.handles.start.y,this.handles.end.y);this.handles.start.x=left,this.handles.start.y=top,this.handles.end.x=right,this.handles.end.y=bottom},AnnArrow.prototype.Draw=function(status,canvas,context){var color=configManager.getColorIfActive(this.active),handleStartCanvas=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.start),handleEndCanvas=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.end);context.strokeStyle=color,context.fillStyle=color,this.DrawArrow(context,handleStartCanvas,handleEndCanvas),this.active&&DrawHandles(context,PixlePoints2CanvasPoints(status,canvas,this.GetHandlePoints()))},AnnArrow.prototype.DrawArrow=function(context,ptStart,ptEnd){var x1=ptStart.x,ptStart=ptStart.y,x2=ptEnd.x,ptEnd=ptEnd.y,x1=new Array(x1,ptStart),ptStart=new Array(x2,ptEnd),x2=(context.beginPath(),context.translate(0,0),context.moveTo(x1[0],x1[1]),context.lineTo(ptStart[0],ptStart[1]),context.fill(),context.stroke(),context.save(),context.translate(ptStart[0],ptStart[1]),(ptStart[0]-x1[0])/(ptStart[1]-x1[1])),x2=Math.atan(x2);0<=ptStart[1]-x1[1]?context.rotate(-x2):context.rotate(Math.PI-x2),context.lineTo(-5,-10),context.lineTo(0,-5),context.lineTo(5,-10),context.lineTo(0,0),context.fill(),context.restore(),context.closePath()},AnnArrow.prototype.PointIsLineNear=function(status,canvas,ptCanvas){return DistanceToPoint({start:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.start),end:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.end)},ptCanvas)<10},AnnArrow.prototype.PointIsPointNear=function(status,canvas,ptCanvas){ptCanvas=PointInNearPonits(ptCanvas,PixlePoints2CanvasPoints(status,canvas,this.GetHandlePoints()));return-1!==(this.index=ptCanvas)},AnnArrow.prototype.GetHandlePoints=function(){var points=[];return points.push(this.handles.start),points.push(this.handles.end),points},AnnArrow.prototype.Modify=function(deltaX,deltaY){switch(this.index){case 0:this.handles.start.x+=deltaX,this.handles.start.y+=deltaY;break;case 1:this.handles.end.x+=deltaX,this.handles.end.y+=deltaY;break;default:this.handles.start.x+=deltaX,this.handles.start.y+=deltaY,this.handles.end.x+=deltaX,this.handles.end.y+=deltaY}},AnnAngle.prototype.Draw=function(status,canvas,context){var self,centerX,left,points,right,color=configManager.getColorIfActive(this.active||this.textBox.active),ptAngle={start:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.start),center:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.center),end:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.end)};context.strokeStyle=color,context.fillStyle=color,0!==this.handles.center.x&&0!==this.handles.center.y&&0===this.handles.end.x&&0===this.handles.end.y?(context.beginPath(),context.moveTo(ptAngle.start.x,ptAngle.start.y),context.lineTo(ptAngle.center.x,ptAngle.center.y),context.stroke()):(this.DrawAngle(context,ptAngle),this.active&&DrawHandles(context,points=PixlePoints2CanvasPoints(status,canvas,points=this.GetHandlePoints())),this.textBox.hasMoved||(ptAngle=this.GetHandlePoints(),left=Math.min(ptAngle[0].x,ptAngle[1].x,ptAngle[2].x),Math.min(ptAngle[0].y,ptAngle[1].y,ptAngle[2].y),centerX=left+((right=Math.max(ptAngle[0].x,ptAngle[1].x,ptAngle[2].x))-left>>1),Math.max(ptAngle[0].y,ptAngle[1].y,ptAngle[2].y),status.hflip?(this.textBox.bRight=centerX>status.image.col>>1,this.textBox.x=this.textBox.bRight?left:right):(this.textBox.bRight=centerX<status.image.col>>1,this.textBox.x=this.textBox.bRight?right:left),self=this,ptAngle.forEach(function(pt){pt.x===self.textBox.x&&(self.textBox.y=pt.y)})),centerX=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.textBox),right=this.angle.toFixed(2)+" °",this.textBox.bRight?centerX.x+=8:(left=context.measureText(right),centerX.x=centerX.x-left.width),ptAngle=DrawTextBox(context,right,centerX.x,centerX.y,color),this.textBox.boundingBox=ptAngle,this.textBox.hasMoved&&(left={start:{},end:{}},points=PixlePoints2CanvasPoints(status,canvas,points=this.GetHandlePoints()),left.end.x=centerX.x,left.end.y=centerX.y,left.start=FindClosestPoint(points,left.end),right=[{x:ptAngle.left+ptAngle.width/2,y:ptAngle.top},{x:ptAngle.left,y:ptAngle.top+ptAngle.height/2},{x:ptAngle.left+ptAngle.width/2,y:ptAngle.top+ptAngle.height},{x:ptAngle.left+ptAngle.width,y:ptAngle.top+ptAngle.height/2}],left.end=FindClosestPoint(right,left.start),context.save(),context.beginPath(),context.strokeStyle=color,context.setLineDash([2,3]),context.moveTo(left.start.x,left.start.y),context.lineTo(left.end.x,left.end.y),context.stroke(),context.restore()))},AnnAngle.prototype.DrawAngle=function(context,ptAngle){var startX=ptAngle.start.x,startY=ptAngle.start.y,centerX=ptAngle.center.x,centerY=ptAngle.center.y,endX=ptAngle.end.x,endY=ptAngle.end.y,ptEnd=(context.save(),context.translate(.5,.5),context.beginPath(),context.moveTo(startX,startY),context.lineTo(centerX,centerY),context.moveTo(startX,startY),context.lineTo(endX,endY),endX=ptAngle.start,endY=ptAngle.center,ptEnd=ptAngle.end,h=endY.x-endX.x,endY=endY.y-endX.y,i=ptEnd.x-endX.x,ptEnd=ptEnd.y-endX.y,endX=Math.sqrt(Math.pow(h,2)+Math.pow(endY,2)),h/=endX,endY/=endX,endX=Math.sqrt(Math.pow(i,2)+Math.pow(ptEnd,2)),h=0<h*(ptEnd/=endX)-(i/=endX)*endY),endX=this.angle,i=(this.invalid&&(endX=function(ptStart,ptCenter,ptEnd){var d=Distance(ptStart,ptCenter),ptStart=Distance(ptStart,ptEnd),ptCenter=Distance(ptCenter,ptEnd);return 0==d||0==ptStart?0:((ptEnd=(d*d-ptCenter*ptCenter+ptStart*ptStart)/(2*d*ptStart))<-1?ptEnd=-1:1<ptEnd&&(ptEnd=1),57.29578*Math.acos(ptEnd))}(ptAngle.start,ptAngle.center,ptAngle.end),this.angle=endX,this.invalid=!1),endX*=.0174532,(centerY-startY)/(centerX-startX)),endY=centerY-startY<=0?i<=0?(i=Math.abs(i),2*Math.PI-Math.atan(i)):Math.PI+Math.atan(i):i<0?(i=Math.abs(i),Math.PI-Math.atan(i)):Math.atan(i),h=Distance(ptAngle.start,ptAngle.center),centerX=Distance(ptAngle.start,ptAngle.end),centerY=Math.min(h,centerX)/6;30<centerY&&(centerY=30),context.moveTo(startX,startY),ptEnd?context.arc(startX,startY,centerY,endY,endY+endX,!1):context.arc(startX,startY,centerY,endY,endY-endX,!0),context.stroke(),context.restore()},AnnAngle.prototype.GetHandlePoints=function(){var points=[];return points.push(this.handles.start),points.push(this.handles.center),points.push(this.handles.end),points},AnnAngle.prototype.PointIsLineNear=function(status,canvas,ptCanvas){return DistanceToPoint({start:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.start),end:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.center)},ptCanvas)<10||DistanceToPoint({start:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.start),end:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.end)},ptCanvas)<10},AnnAngle.prototype.PointIsPointNear=function(status,canvas,ptCanvas){ptCanvas=PointInNearPonits(ptCanvas,PixlePoints2CanvasPoints(status,canvas,this.GetHandlePoints()));return-1!==(this.index=ptCanvas)},AnnAngle.prototype.PointIsInTextBox=function(status,canvas,pageX,pageY){return InsideRect(PageCoods2Canvas(canvas,pageX,pageY),this.textBox.boundingBox)},AnnAngle.prototype.Modify=function(deltaX,deltaY){var bCalculate=!0;if(this.textBox.active)this.textBox.hasMoved=!0,this.textBox.x+=deltaX,this.textBox.y+=deltaY;else{this.handles.start.x,this.handles.start.y,this.handles.end.x,this.handles.end.y;switch(this.index){case 0:this.handles.start.x+=deltaX,this.handles.start.y+=deltaY;break;case 1:this.handles.center.x+=deltaX,this.handles.center.y+=deltaY;break;case 2:this.handles.end.x+=deltaX,this.handles.end.y+=deltaY;break;default:this.handles.start.x+=deltaX,this.handles.start.y+=deltaY,this.handles.center.x+=deltaX,this.handles.center.y+=deltaY,this.handles.end.x+=deltaX,this.handles.end.y+=deltaY,bCalculate=!1}this.invalid=bCalculate}},AnnText.prototype.Draw=function(status,canvas,context){var color=configManager.getColorIfActive(this.textBox.active),status=(context.fillStyle=color,CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.textBox)),canvas=DrawTextBox(context,this.text,status.x,status.y,color);this.textBox.boundingBox=canvas},AnnText.prototype.PointIsInTextBox=function(status,canvas,pageX,pageY){return InsideRect(PageCoods2Canvas(canvas,pageX,pageY),this.textBox.boundingBox)},AnnText.prototype.Modify=function(deltaX,deltaY){this.textBox.active&&(this.textBox.x+=deltaX,this.textBox.y+=deltaY)},AnnLR.prototype.Draw=function(status,canvas,context){var color=configManager.getColorIfActive(this.active),color=(context.fillStyle=color,context.strokeStyle=color,CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.start)),status=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.end),canvas=color.x+status.x>>1,centerY=color.y+status.y>>1,color=Distance(color,status)>>1;this.DrawLR(context,{x:canvas,y:centerY},color,this.type)},AnnLR.prototype.DrawLR=function(context,pt,radius,type){context.beginPath(),context.arc(pt.x,pt.y,radius,0,2*Math.PI),context.stroke(),context.save(),context.font=radius+"px lighter";radius=context.measureText("L").width>>1;"l"===type?context.fillText("L",pt.x-radius,pt.y+radius):context.fillText("R",pt.x-radius,pt.y+radius),context.restore()},AnnLR.prototype.PointIsLineNear=function(status,canvas,ptCanvas){var start=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.start),status=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.handles.end),canvas=Distance(start,status)>>1;return function(ptTarget,ptArcCenter,radius){return Distance(ptTarget,ptArcCenter)<=radius}(ptCanvas,{x:start.x+status.x>>1,y:start.y+status.y>>1},canvas)},AnnLR.prototype.Modify=function(deltaX,deltaY){this.handles.start.x+=deltaX,this.handles.start.y+=deltaY,this.handles.end.x+=deltaX,this.handles.end.y+=deltaY},AnnHeartRatio.prototype.Draw=function(status,canvas,context){var points,color=configManager.getColorIfActive(this.active||this.textBox.active),topStartCanvas=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.topline.start),topEndCanvas=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.topline.end),downStartCanvas=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.downline.start),downEndCanvas=CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.downline.end),topCenterX=topStartCanvas.x+topEndCanvas.x>>1,topCenterY=topStartCanvas.y+topEndCanvas.y>>1,downCenterX=downStartCanvas.x+downEndCanvas.x>>1,downCenterY=downStartCanvas.y+downEndCanvas.y>>1,topCenterX=(context.beginPath(),context.strokeStyle=color,context.moveTo(topStartCanvas.x,topStartCanvas.y),context.lineTo(topEndCanvas.x,topEndCanvas.y),context.stroke(),context.beginPath(),context.save(),context.setLineDash([2,3]),context.moveTo(topCenterX,topCenterY),context.lineTo(downCenterX,downCenterY),context.stroke(),context.restore(),context.beginPath(),context.moveTo(downStartCanvas.x,downStartCanvas.y),context.lineTo(downEndCanvas.x,downEndCanvas.y),context.stroke(),this.active&&DrawHandles(context,points=PixlePoints2CanvasPoints(status,canvas,points=this.GetHandlePoints())),this.invalid&&(topStartCanvas=Distance(this.topline.start,this.topline.end),topEndCanvas=Distance(this.downline.start,this.downline.end),this.ratio=topStartCanvas/topEndCanvas,this.invalid=!1),"ratio: "+this.ratio.toFixed(2)),downEndCanvas=(this.textBox.hasMoved||(topCenterY=Math.min(this.topline.start.x,this.topline.end.x,this.downline.start.x,this.downline.end.x),downCenterX=Math.max(this.topline.start.x,this.topline.end.x,this.downline.start.x,this.downline.end.x),downCenterY=Math.min(this.topline.start.y,this.topline.end.y,this.downline.start.y,this.downline.end.y),downStartCanvas=Math.max(this.topline.start.y,this.topline.end.y,this.downline.start.y,this.downline.end.y),status.hflip?(this.textBox.bRight=topCenterY+downCenterX>>1>status.image.col>>1,this.textBox.x=this.textBox.bRight?topCenterY:downCenterX):(this.textBox.bRight=topCenterY<status.image.col>>1,this.textBox.x=this.textBox.bRight?downCenterX:topCenterY),status.vflip?this.textBox.y=downStartCanvas:this.textBox.y=downCenterY),CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.textBox)),topEndCanvas=(this.textBox.bRight?downEndCanvas.x+=8:(topStartCanvas=context.measureText(topCenterX),downEndCanvas.x=downEndCanvas.x-topStartCanvas.width-8),context.fillStyle=color,DrawTextBox(context,topCenterX,downEndCanvas.x,downEndCanvas.y,color));this.textBox.boundingBox=topEndCanvas,this.textBox.hasMoved&&(downCenterX={start:{},end:{}},points=PixlePoints2CanvasPoints(status,canvas,points=this.GetHandlePoints()),downCenterX.end.x=downEndCanvas.x,downCenterX.end.y=downEndCanvas.y,downCenterX.start=FindClosestPoint(points,downCenterX.end),topCenterY=[{x:topEndCanvas.left+topEndCanvas.width/2,y:topEndCanvas.top},{x:topEndCanvas.left,y:topEndCanvas.top+topEndCanvas.height/2},{x:topEndCanvas.left+topEndCanvas.width/2,y:topEndCanvas.top+topEndCanvas.height},{x:topEndCanvas.left+topEndCanvas.width,y:topEndCanvas.top+topEndCanvas.height/2}],downCenterX.end=FindClosestPoint(topCenterY,downCenterX.start),context.save(),context.beginPath(),context.strokeStyle=color,context.setLineDash([2,3]),context.moveTo(downCenterX.start.x,downCenterX.start.y),context.lineTo(downCenterX.end.x,downCenterX.end.y),context.stroke(),context.restore())},AnnHeartRatio.prototype.GetHandlePoints=function(){var points=[];return points.push(this.topline.start),points.push(this.topline.end),points.push(this.downline.end),points.push(this.downline.start),points},AnnHeartRatio.prototype.PointIsLineNear=function(status,canvas,ptCanvas){return DistanceToPoint({start:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.topline.start),end:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.topline.end)},ptCanvas)<10?!(this.lineIndex=0):DistanceToPoint({start:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.downline.start),end:CBoBo.ImageProcessor.PixelToCanvas(status,canvas,this.downline.end)},ptCanvas)<10&&(this.lineIndex=1,!0)},AnnHeartRatio.prototype.PointIsPointNear=function(status,canvas,ptCanvas){ptCanvas=PointInNearPonits(ptCanvas,PixlePoints2CanvasPoints(status,canvas,this.GetHandlePoints()));return-1!==(this.index=ptCanvas)},AnnHeartRatio.prototype.PointIsInTextBox=function(status,canvas,pageX,pageY){return InsideRect(PageCoods2Canvas(canvas,pageX,pageY),this.textBox.boundingBox)},AnnHeartRatio.prototype.Modify=function(deltaX,deltaY){if(this.textBox.active)this.textBox.hasMoved=!0,this.textBox.x+=deltaX,this.textBox.y+=deltaY;else{switch(this.index){case 0:this.topline.start.x+=deltaX,this.topline.start.y+=deltaY;break;case 1:this.topline.end.x+=deltaX,this.topline.end.y+=deltaY;break;case 2:this.downline.end.x+=deltaX,this.downline.end.y+=deltaY;break;case 3:this.downline.start.x+=deltaX,this.downline.start.y+=deltaY;break;default:0===this.lineIndex?(this.topline.start.x+=deltaX,this.topline.start.y+=deltaY,this.topline.end.x+=deltaX,this.topline.end.y+=deltaY):1===this.lineIndex&&(this.downline.end.x+=deltaX,this.downline.end.y+=deltaY,this.downline.start.x+=deltaX,this.downline.start.y+=deltaY)}this.invalid=!0}},CBoBo.Annotation={NewAIAnnotation:function(status,canvas,type,startPoint,endPoint){var ann;switch(type){case"probe":(ann=new AnnPoint).handles.end=pt;var context=InitContext(canvas);ann.Draw(status,canvas,context);break;case"line":(ann=new AnnLine).handles.start=pt;break;case"rect":return(ann=new AnnRect).handles.start=startPoint,ann.handles.end=endPoint,ann.id=status.image.id,ann.invalid=!0,ann;case"ellipse":(ann=new AnnEllipse).handles.start=pt,ann.id=status.image.id;break;case"arrow":(ann=new AnnArrow).handles.start=pt;break;case"angle":void 0===(ann=cacheAnnotationManager.GetNewAnn())?((ann=new AnnAngle).handles.start=pt,ann.createHitNums++):1===ann.createHitNums?(ann.handles.center=pt,ann.createHitNums++):2===ann.createHitNums&&(ann.handles.end=pt,ann.createHitNums=0);break;case"text":if((ann=new AnnText).textBox.x=pt.x,ann.textBox.y=pt.y,""!==ann.text&&null!==ann.text)return context=InitContext(canvas),ann.Draw(status,canvas,context),ann;break;case"l":case"r":(ann=new AnnLR(type)).handles.start=pt;break;case"heartratio":(ann=new AnnHeartRatio).topline.start=pt}cacheAnnotationManager.SetNewAnn(ann)},NewAnnotation:function(status,canvas,type,pageX,pageY){var ann,pt=CBoBo.ImageProcessor.PageToPixel(status,canvas,pageX,pageY);switch(type){case"probe":(ann=new AnnPoint).handles.end=pt;var context=InitContext(canvas);ann.Draw(status,canvas,context);break;case"line":(ann=new AnnLine).handles.start=pt;break;case"rect":(ann=new AnnRect).handles.start=pt,ann.id=status.image.id;break;case"ellipse":(ann=new AnnEllipse).handles.start=pt,ann.id=status.image.id;break;case"arrow":(ann=new AnnArrow).handles.start=pt;break;case"angle":void 0===(ann=cacheAnnotationManager.GetNewAnn())?((ann=new AnnAngle).handles.start=pt,ann.createHitNums++):1===ann.createHitNums?(ann.handles.center=pt,ann.createHitNums++):2===ann.createHitNums&&(ann.handles.end=pt,ann.createHitNums=0);break;case"text":if((ann=new AnnText).textBox.x=pt.x,ann.textBox.y=pt.y,""!==ann.text&&null!==ann.text)return context=InitContext(canvas),ann.Draw(status,canvas,context),ann;break;case"l":case"r":(ann=new AnnLR(type)).handles.start=pt;break;case"heartratio":(ann=new AnnHeartRatio).topline.start=pt}cacheAnnotationManager.SetNewAnn(ann)},UnfinishedAnn:function(status,canvas,arrAnnotation,type,pageX,pageY){var editAnn=cacheAnnotationManager.GetNewAnn();if(void 0===editAnn)return!1;CBoBo.ImageProcessor.DrawGrayImage(status,canvas);var context=CBoBo.Annotation.DrawAnnotation(status,canvas,arrAnnotation),pt=CBoBo.ImageProcessor.PageToPixel(status,canvas,pageX,pageY);switch(type){case"heartratio":editAnn.topline.end.x=pt.x,editAnn.topline.end.y=editAnn.topline.start.y,editAnn.downline.start.x=editAnn.topline.start.x,editAnn.downline.start.y=pt.y,editAnn.downline.end=pt,editAnn.invalid=!0,editAnn.Draw(status,canvas,context);break;case"r":case"l":case"arrow":case"ellipse":case"probe":case"rect":case"line":editAnn.handles.end=pt,editAnn.invalid=!0,editAnn.Draw(status,canvas,context);break;case"angle":1===editAnn.createHitNums?editAnn.handles.center=pt:2===editAnn.createHitNums&&(editAnn.handles.end=pt),editAnn.invalid=!0,editAnn.Draw(status,canvas,context)}return!0},GetMaybeSaveAnn:function(type,status,canvas){var ann=cacheAnnotationManager.GetNewAnn();if(void 0!==ann)switch(type){case"probe":return cacheAnnotationManager.SetNewAnn(),ann;case"line":if(cacheAnnotationManager.SetNewAnn(),1<ann.length)return ann;break;case"ellipse":case"rect":if(cacheAnnotationManager.SetNewAnn(),1<ann.area)return ann.CorrectPoint&&ann.CorrectPoint(),ann;break;case"l":case"r":case"arrow":if(cacheAnnotationManager.SetNewAnn(),2<Distance(ann.handles.start,ann.handles.end)&&(0!==ann.handles.end.x||0!==ann.handles.end.y))return ann;break;case"angle":if((0!==ann.handles.end.x||0!==ann.handles.end.y)&&(cacheAnnotationManager.SetNewAnn(),1<ann.angle))return ann;break;case"heartratio":if(cacheAnnotationManager.SetNewAnn(),0!==ann.topline.start.x&&0!==ann.topline.start.y&&0!==ann.downline.start.x&&0!==ann.downline.start.y)return ann}},DrawAnnotation:function(status,canvas,annotations){for(var context=InitContext(canvas),i=0;i<annotations.length;i++)annotations[i].Draw(status,canvas,context);return context},ScanHoverAnnotation:function(status,canvas,annotations,pageX,pageY){if(annotations instanceof Array&&!(annotations.length<1)){for(var foundAnn,pt=PageCoods2Canvas(canvas,pageX,pageY),bFoundPoint=!1,i=0;i<annotations.length;i++)(ann=annotations[i]).PointIsPointNear&&(ann.PointIsPointNear(status,canvas,pt)&&void 0===foundAnn?bFoundPoint=(foundAnn=ann).active=!0:ann.active=!1),ann.textBox&&(ann.textBox.active=!1);if(void 0===foundAnn)for(var ann,i=0;i<annotations.length;i++)(ann=annotations[i]).PointIsLineNear&&(ann.PointIsLineNear(status,canvas,pt)&&void 0===foundAnn?(ann.active=!0,foundAnn=ann):ann.active=!1);bFoundPoint?canvas.style.cursor="pointer":"default"!==canvas.style.cursor&&(canvas.style.cursor="default"),foundAnn!==cacheAnnotationManager.GetRecordAnn()&&(CBoBo.ImageProcessor.DrawGrayImage(status,canvas),this.DrawAnnotation(status,canvas,annotations),cacheAnnotationManager.SetRecordAnn(foundAnn))}},ScanClickTextBox:function(status,canvas,annotations,pageX,pageY){if(annotations instanceof Array&&!(annotations.length<1)){for(var foundAnn,i=0;i<annotations.length;i++){var ann=annotations[i];ann.PointIsInTextBox&&(ann.PointIsInTextBox(status,canvas,pageX,pageY)&&void 0===foundAnn?(ann.textBox.active=!0,foundAnn=ann):ann.textBox.active=!1)}var recordAnn=cacheAnnotationManager.GetRecordAnn();if(foundAnn!==recordAnn)return CBoBo.Draw.DrawImage(status,canvas),canvas.getContext("2d"),this.DrawAnnotation(status,canvas,annotations),cacheAnnotationManager.SetRecordAnn(foundAnn),foundAnn}},ActiveAnnotation:function(annotations){for(var i=0;i<annotations.length;i++){var ann=annotations[i];if(ann.active||ann.textBox&&ann.textBox.active)return cacheAnnotationManager.SetModifyAnn(ann),!0}return!1},MaybeModifyActiveAnn:function(status,canvas,annotations,ptStartPageX,ptStartPageY,ptEndPageX,ptEndPageY){var ann=cacheAnnotationManager.GetModifyAnn();if(void 0===ann)return!1;CBoBo.Draw.DrawImage(status,canvas);ptStartPageX=CBoBo.ImageProcessor.PageToPixel(status,canvas,ptStartPageX,ptStartPageY),ptStartPageY=CBoBo.ImageProcessor.PageToPixel(status,canvas,ptEndPageX,ptEndPageY),ptEndPageX=ptStartPageY.x-ptStartPageX.x,ptEndPageY=ptStartPageY.y-ptStartPageX.y;return ann.Modify&&ann.Modify(ptEndPageX,ptEndPageY),this.DrawAnnotation(status,canvas,annotations),!0},MaybeServerModifyActiveAnn:function(status,canvas,annotations,ptStartPageX,ptStartPageY,ptEndPageX,ptEndPageY){var ann=cacheAnnotationManager.GetModifyAnn();if(void 0===ann)return!1;CBoBo.Draw.DrawImage(status,canvas);ptStartPageX=CBoBo.ImageProcessor.PageToPixel(status,canvas,ptStartPageX,ptStartPageY),ptStartPageY=CBoBo.ImageProcessor.PageToPixel(status,canvas,ptEndPageX,ptEndPageY),ptEndPageX=ptStartPageY.x-ptStartPageX.x,ptEndPageY=ptStartPageY.y-ptStartPageX.y;return ann.ServerModify&&ann.ServerModify(ptEndPageX,ptEndPageY),this.DrawAnnotation(status,canvas,annotations),!0},MaybeEndModifyAnn:function(){var ann=cacheAnnotationManager.GetModifyAnn();void 0!==ann&&ann.CorrectPoint&&ann.CorrectPoint(),cacheAnnotationManager.SetModifyAnn()},Distance:Distance,PageCoods2Canvas:PageCoods2Canvas,ServerGetMaybeSaveAnn:function(type,status,canvas,ann){var promise=$.Deferred();if(void 0!==ann)switch(type){case"probe":return cacheAnnotationManager.SetNewAnn(),ann;case"line":if(cacheAnnotationManager.SetNewAnn(),1<ann.length)return ann;break;case"ellipse":cacheAnnotationManager.SetNewAnn();var url=CBoBo.Draw.GetWadoUrl()+"/GetMeasureData";$.ajax({url:url,type:"get",data:{id:ann.id,type:"ellipse",left:ann.ellipse.left,top:ann.ellipse.top,width:ann.ellipse.width,height:ann.ellipse.height},dataType:"json",complete:function(response){return 200==response.status&&response.responseJSON?(response=response.responseJSON.data,ann.meanStdDev={count:response.count,mean:response.mean,variance:response.stdDev,stdDev:response.variance},promise.resolve(ann)):promise.reject()}});break;case"rect":cacheAnnotationManager.SetNewAnn();url=CBoBo.Draw.GetWadoUrl()+"/GetMeasureData";$.ajax({url:url,type:"get",data:{id:ann.id,type:"Rect",left:ann.ellipse.left,top:ann.ellipse.top,width:ann.ellipse.width,height:ann.ellipse.height},complete:function(response){return 200==response.status&&response.responseJSON?(response=response.responseJSON.data,ann.meanStdDev={count:response.count,mean:response.mean,variance:response.stdDev,stdDev:response.variance},promise.resolve(ann)):promise.reject()}});break;case"l":case"r":case"arrow":if(cacheAnnotationManager.SetNewAnn(),2<Distance(ann.handles.start,ann.handles.end)&&(0!==ann.handles.end.x||0!==ann.handles.end.y))return ann;break;case"angle":if(0===ann.handles.end.x&&0===ann.handles.end.y)return;if(cacheAnnotationManager.SetNewAnn(),1<ann.angle)return ann;break;case"heartratio":if(cacheAnnotationManager.SetNewAnn(),0!==ann.topline.start.x&&0!==ann.topline.start.y&&0!==ann.downline.start.x&&0!==ann.downline.start.y)return ann}return promise},ServerHoverAnnotation:function(status,canvas,annotations,pageX,pageY){if(annotations instanceof Array&&!(annotations.length<1)){for(var foundAnn,pt=PageCoods2Canvas(canvas,pageX,pageY),i=0;i<annotations.length;i++){var ann=annotations[i];if(ann.PointIsPointNear)if(ann.PointIsPointNear(status,canvas,pt)&&void 0===foundAnn)return foundAnn=ann}if(void 0===foundAnn)for(i=0;i<annotations.length;i++){ann=annotations[i];if(ann.PointIsLineNear)if(ann.PointIsLineNear(status,canvas,pt)&&void 0===foundAnn)return foundAnn=ann}}}}}(CBoBo),"undefined"==typeof CBoBo&&(CBoBo={}),!function(CBoBo){"use strict";var m_ArrAnnStatus=[];function CreateAnnStatus(image,studyuid,type,bDontSave){var imgs=[],image=(image instanceof Array?imgs=image:imgs.push(image),{images:imgs,viewport:CBoBo.ImageProcessor.GetDefaultStatus(),anns:{},compare:!1,studyuid:studyuid,type:type});return image.viewport.image=imgs[0],bDontSave||m_ArrAnnStatus.push(image),image}function Foreach(callback){if(callback instanceof Function)for(var i=0;i<m_ArrAnnStatus.length;i++)callback(m_ArrAnnStatus[i],i)}CBoBo.AnnStatusManager={Create:CreateAnnStatus,Get:function(mark){return void 0===mark?m_ArrAnnStatus:mark instanceof Number?m_ArrAnnStatus[mark]:void 0},Set:function(annStatus){annStatus instanceof Object&&(annStatus.status.ww<2&&(annStatus.status.ww=2),annStatus.status.scale<.01&&(annStatus.status.scale=.01),360!==annStatus.status.rotation&&-360!==annStatus.status.rotation||(annStatus.status.rotation=0),Foreach(function(value,index){value===annStatus&&(m_ArrAnnStatus[index]=annStatus)}))},Clear:function(){m_ArrAnnStatus=[]},Delete:function(annStatus){var ret=0;return Foreach(function(value,index){value===annStatus&&(m_ArrAnnStatus.splice(index,1),ret=index)}),ret},Replace:function(annStatus,image,studyuid,type){var ret;return Foreach(function(value,index){value===annStatus&&(ret=m_ArrAnnStatus[index]=CreateAnnStatus(image,studyuid,type,!0))}),ret=void 0===ret?CreateAnnStatus(image,studyuid,type):ret},GetIndex:function(annStatus){var index;if(void 0!==annStatus)return Foreach(function(value,i){value===annStatus&&(index=i)}),index},IsExist:function(dicom){var bFind=!1;return Foreach(function(annStatus){annStatus.images.forEach(function(image){dicom.id==image.id&&(bFind=!0)})}),bFind}}}(CBoBo),ImageStatus.prototype.GetBrightness=function(){return this.brightness},ImageStatus.prototype.GetContrast=function(){return this.contrast},ImageStatus.prototype.SetBriCon=function(bri,con){this.brightness=bri,this.contrast=con},ImageStatus.prototype.SetImage=function(image){this.image=image},ImageStatus.prototype.GetImage=function(){return this.image},ImageStatus.prototype.GetImageSize=function(){var ret;if(null!=this.image)return(ret={}).width=this.image.image.width,ret.height=this.image.image.height,ret},ImageStatus.prototype.ZoomImage=function(scaledWidth,scaledHeight){this.scaledWidth=scaledWidth,this.scaledHeight=scaledHeight},ImageStatus.prototype.Restore=function(){return this.brightness=0,this.contrast=0,this.rotateState=0,this.ptMove={x:0,y:0},this.Negative=!1,this.pseudoColor=null,this},ImageStatus.prototype.GetZoomRatio=function(){if(null!=this.image){var h=this.image.image.height;if(!(h<=0))return this.scaledHeight/h}},ImageStatus.prototype.GetMovePoint=function(){return this.ptMove},ImageStatus.prototype.MoveImage=function(pt){this.ptMove.x=pt.x>>0,this.ptMove.y=pt.y>>0},ImageStatus.prototype.SetNegative=function(neg){this.Negative=neg},ImageStatus.prototype.GetNegative=function(){return this.Negative},ImageStatus.prototype.SetPseudoColor=function(arrR,arrG,arrB){this.pseudoColor=null==arrR||null==arrG||null==arrB?void 0:{red:arrR,green:arrG,blue:arrB}},ImageStatus.prototype.GetPseudoColor=function(){return this.pseudoColor},ImageStatus.prototype.FitCanvas=function(dvCanvas){var imgSize;return null!=this.image&&this.image.bLoaded&&null!=dvCanvas?(dvCanvas=dvCanvas.GetCanvas(),null!=(imgSize=this.GetImageSize())?(dvCanvas=Math.min(dvCanvas.width/imgSize.width,dvCanvas.height/imgSize.height),this.ZoomImage(dvCanvas*imgSize.width>>0,dvCanvas*imgSize.height>>0),this):void 0):this},ImageStatus.prototype.DrawImg=function(dvCanvas){null!=dvCanvas&&(null!=this.image?this.image.bLoaded?(dvCanvas.bStop||dvCanvas.StopLoadingAnimation(),dvCanvas.drawlock&&(dvCanvas.drawlock=!1,dvCanvas.imgProcessWorker.postMessage({type:2,brightness:this.brightness,contrast:this.contrast,pseudocolor:this.pseudoColor,nagative:this.Negative}))):dvCanvas.StartLoadingAnimation():dvCanvas.canvas.getContext("2d").clearRect(0,0,dvCanvas.canvas.width,dvCanvas.canvas.height))},ImageStatus.prototype.DrawText=function(dvCanvas){var ctx,minWidth;this.bDrawText&&((minWidth=(minWidth=(dvCanvas=dvCanvas.GetCanvas()).width<dvCanvas.height?dvCanvas.width:dvCanvas.height)/55>>0)<10&&(minWidth=10),(ctx=dvCanvas.getContext("2d")).fillStyle="#fff",ctx.textBaseline="middle",ctx.textAlign="right",ctx.font=minWidth+"px lighter",ctx.shadowColor="#000",ctx.shadowOffsetX=1,ctx.shadowOffsetY=1,minWidth=ctx.measureText("字").width,dvCanvas=CBoBo.Plugin.SetDrawTextCoord(dvCanvas.width,dvCanvas.height,0,0,3,0,minWidth),index=0,ctx.fillText("对比度:"+this.GetContrast(),dvCanvas.rb[index].x,dvCanvas.rb[index].y),index++,ctx.fillText(" 亮度:"+this.GetBrightness(),dvCanvas.rb[index].x,dvCanvas.rb[index].y),index++,null!=(minWidth=this.GetZoomRatio()))&&ctx.fillText("放缩倍数:"+minWidth.toFixed(2),dvCanvas.rb[index].x,dvCanvas.rb[index].y)},ImageStatus.prototype.SetDrawTextFlag=function(bDraw){this.bDrawText=bDraw},plain_blue=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255],plain_green=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255],plain_red=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255],plain_inverse_blue=[254,253,252,251,250,249,248,247,246,245,244,243,242,241,240,239,238,237,236,235,234,233,232,231,230,229,228,227,226,225,224,223,222,221,220,219,218,217,216,215,214,213,212,211,210,209,208,207,206,205,204,203,202,201,200,199,198,197,196,195,194,193,192,191,190,189,188,187,186,185,184,183,182,181,180,179,178,177,176,175,174,173,172,171,170,169,168,167,166,165,164,163,162,161,160,159,158,157,156,155,154,153,152,151,150,149,148,147,146,145,144,143,142,141,140,139,138,137,136,135,134,133,132,131,130,129,128,127,126,125,124,123,122,121,120,119,118,117,116,115,114,113,112,111,110,109,108,107,106,105,104,103,102,101,100,99,98,97,96,95,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0],plain_inverse_green=[254,253,252,251,250,249,248,247,246,245,244,243,242,241,240,239,238,237,236,235,234,233,232,231,230,229,228,227,226,225,224,223,222,221,220,219,218,217,216,215,214,213,212,211,210,209,208,207,206,205,204,203,202,201,200,199,198,197,196,195,194,193,192,191,190,189,188,187,186,185,184,183,182,181,180,179,178,177,176,175,174,173,172,171,170,169,168,167,166,165,164,163,162,161,160,159,158,157,156,155,154,153,152,151,150,149,148,147,146,145,144,143,142,141,140,139,138,137,136,135,134,133,132,131,130,129,128,127,126,125,124,123,122,121,120,119,118,117,116,115,114,113,112,111,110,109,108,107,106,105,104,103,102,101,100,99,98,97,96,95,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0],plain_inverse_red=[254,253,252,251,250,249,248,247,246,245,244,243,242,241,240,239,238,237,236,235,234,233,232,231,230,229,228,227,226,225,224,223,222,221,220,219,218,217,216,215,214,213,212,211,210,209,208,207,206,205,204,203,202,201,200,199,198,197,196,195,194,193,192,191,190,189,188,187,186,185,184,183,182,181,180,179,178,177,176,175,174,173,172,171,170,169,168,167,166,165,164,163,162,161,160,159,158,157,156,155,154,153,152,151,150,149,148,147,146,145,144,143,142,141,140,139,138,137,136,135,134,133,132,131,130,129,128,127,126,125,124,123,122,121,120,119,118,117,116,115,114,113,112,111,110,109,108,107,106,105,104,103,102,101,100,99,98,97,96,95,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0],rainbow_blue=[0,4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76,80,84,88,92,96,100,104,108,112,116,120,124,128,132,136,140,144,148,152,156,160,164,168,172,176,180,184,188,192,196,200,204,208,212,216,220,224,228,232,236,240,244,248,252,255,247,239,231,223,215,207,199,191,183,175,167,159,151,143,135,127,119,111,103,95,87,79,71,63,55,47,39,31,23,15,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],rainbow_green=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,253,251,249,247,245,243,241,239,237,235,233,231,229,227,225,223,221,219,217,215,213,211,209,207,205,203,201,199,197,195,193,192,189,186,183,180,177,174,171,168,165,162,159,156,153,150,147,144,141,138,135,132,129,126,123,120,117,114,111,108,105,102,99,96,93,90,87,84,81,78,75,72,69,66,63,60,57,54,51,48,45,42,39,36,33,30,27,24,21,18,15,12,9,6,3],rainbow_red=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,62,64,62,60,58,56,54,52,50,48,46,44,42,40,38,36,34,32,30,28,26,24,22,20,18,16,14,12,10,8,6,4,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76,80,84,88,92,96,100,104,108,112,116,120,124,128,132,136,140,144,148,152,156,160,164,168,172,176,180,184,188,192,196,200,204,208,212,216,220,224,228,232,236,240,244,248,252,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],blackbody_blue=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,6,9,12,15,18,21,24,27,30,33,36,39,42,45,48,51,54,57,60,63,66,69,72,75,78,81,84,87,90,93,96,99,102,105,108,111,114,117,120,123,126,129,132,135,138,141,144,147,150,153,156,159,162,165,168,171,174,177,180,183,186,189,192,195,198,201,204,207,210,213,216,219,222,225,228,231,234,237,240,243,246,249,252,255],blackbody_green=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,6,9,12,15,18,21,24,27,30,33,36,39,42,45,48,51,54,57,60,63,66,69,72,75,78,81,84,87,90,93,96,99,102,105,108,111,114,117,120,123,126,129,132,135,138,141,144,147,150,153,156,159,162,165,168,171,174,177,180,183,186,189,192,195,198,201,204,207,210,213,216,219,222,225,228,231,234,237,240,243,246,249,252,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],blackbody_red=[0,3,6,9,12,15,18,21,24,27,30,33,36,39,42,45,48,51,54,57,60,63,66,69,72,75,78,81,84,87,90,93,96,99,102,105,108,111,114,117,120,123,126,129,132,135,138,141,144,147,150,153,156,159,162,165,168,171,174,177,180,183,186,189,192,195,198,201,204,207,210,213,216,219,222,225,228,231,234,237,240,243,246,249,252,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],bones_blue=[0,0,0,0,1,1,1,2,2,2,2,3,3,3,4,4,4,4,5,5,5,6,6,6,6,7,7,7,8,8,8,9,9,9,9,10,10,10,11,11,11,11,12,12,12,13,13,13,13,14,14,14,15,15,15,16,16,16,16,17,17,17,18,18,18,18,19,19,19,20,20,20,20,21,21,21,22,22,22,23,23,23,23,24,24,24,25,25,25,25,26,26,26,27,27,27,27,28,28,28,29,29,29,29,30,30,30,31,31,31,32,32,32,32,33,33,33,34,34,34,34,35,35,35,36,36,36,36,36,37,37,37,37,37,38,38,38,38,39,39,39,39,39,40,40,40,40,40,41,41,41,41,42,42,42,42,42,43,43,43,43,44,44,44,44,44,45,45,45,45,45,46,46,46,46,47,47,47,47,47,48,48,48,48,48,49,49,49,49,50,50,50,50,50,51,51,51,51,51,52,52,52,53,53,53,54,54,54,55,55,55,56,56,56,56,57,57,57,58,58,58,59,59,59,60,60,60,61,61,61,62,62,62,63,63,63,64,64,64,65,65,65,66,66,66,67,84,101,118,135,152,169,186,203,220,237],bones_green=[0,1,2,3,4,6,7,8,9,11,12,13,14,16,17,18,19,20,22,23,24,25,27,28,29,30,32,33,34,35,37,38,39,40,41,43,44,45,46,48,49,50,51,53,54,55,56,57,59,60,61,62,64,65,66,67,69,70,71,72,74,75,76,77,78,80,81,82,83,85,86,87,88,90,91,92,93,94,96,97,98,99,101,102,103,104,106,107,108,109,111,112,113,114,115,117,118,119,120,122,123,124,125,127,128,129,130,131,133,134,135,136,138,139,140,141,143,144,145,146,148,149,150,151,152,153,153,154,154,155,156,156,157,158,158,159,160,160,161,162,162,163,164,164,165,166,166,167,168,168,169,170,170,171,172,172,173,174,174,175,175,176,177,177,178,179,179,180,181,181,182,183,183,184,185,185,186,187,187,188,189,189,190,191,191,192,193,193,194,195,195,196,196,197,198,198,199,200,200,201,202,203,204,205,206,207,208,209,210,211,213,214,215,216,217,218,219,220,221,222,223,224,226,227,228,229,230,231,232,233,234,235,236,237,239,240,241,242,243,244,245,246,247,248,249,250,251,251,252,252,252,253,253,253,254,254],bones_red=[0,1,3,5,7,8,10,12,14,15,17,19,21,22,24,26,28,29,31,33,35,37,38,40,42,44,45,47,49,51,52,54,56,58,59,61,63,65,67,68,70,72,74,75,77,79,81,82,84,86,88,89,91,93,95,96,98,100,102,104,105,107,109,111,112,114,116,118,119,121,123,125,126,128,130,132,134,135,137,139,141,142,144,146,148,149,151,153,155,156,158,160,162,164,165,167,169,171,172,174,176,178,179,181,183,185,186,188,190,192,193,195,197,199,201,202,204,206,208,209,211,213,215,216,217,217,218,218,219,219,220,220,221,221,222,222,223,223,224,224,225,225,226,226,227,227,228,228,229,229,230,230,231,231,232,232,233,233,234,234,235,235,236,236,237,237,238,238,239,239,240,240,241,241,242,242,243,243,244,244,245,245,246,246,247,247,248,248,249,249,250,250,251,251,252,252,253,253,254,254,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],cardiac_blue=[3,12,20,29,37,46,54,63,71,80,88,97,105,114,122,131,139,146,154,161,168,175,183,190,197,204,212,219,226,233,241,248,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,253,252,250,249,247,246,244,243,241,239,238,236,235,233,232,230,229,227,226,224,223,221,220,218,217,215,214,212,211,209,208,206,203,201,198,196,193,191,188,186,183,180,178,175,173,170,168,165,163,161,159,157,155,153,151,149,146,144,142,140,138,136,134,132,127,123,118,113,109,104,99,95,90,85,80,76,71,66,62,57,53,50,46,43,39,36,32,29,25,21,18,14,11,7,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,2,3,4,5,5,6,7,8,8,9,10,11,11,12,11,11,10,10,9,9,8,8,7,6,6,5,5,4,3],cardiac_green=[193,195,197,198,200,202,204,206,208,209,211,213,215,217,218,220,222,222,222,222,222,222,222,222,222,222,222,222,222,222,222,222,222,216,211,205,200,194,188,183,177,171,166,160,155,149,143,138,132,128,125,121,118,114,110,107,103,99,96,92,89,85,81,78,74,70,67,63,60,56,52,49,45,41,38,34,31,27,23,20,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,4,6,8,10,12,14,17,19,21,23,25,27,29,31,33,37,41,45,50,54,58,62,66,70,74,78,83,87,91,95,99,103,107,111,116,120,124,128,132,136,140,144,149,153,157,161,165,170,174,179,184,188,193,197,202,207,211,216,221,225,230,234,239,238,237,236,235,234,233,232,231,229,228,227,226,225,224,223,222,220,218,217,215,213,211,209,208,206,204,202,200,198,197,193],cardiac_red=[73,72,70,69,68,66,65,63,62,61,59,58,57,55,54,52,51,48,45,41,38,35,32,29,26,22,19,16,13,10,6,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,21,22,22,23,24,25,25,26,27,28,28,29,30,31,31,32,36,39,43,47,50,54,57,61,65,68,72,76,79,83,86,90,95,99,104,109,113,118,123,128,132,137,142,146,151,156,160,165,169,172,176,179,183,186,190,194,197,201,204,208,211,215,218,222,224,226,228,230,232,234,236,239,241,243,245,247,249,251,253,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,250,245,240,236,231,226,221,216,211,206,201,197,192,187,182,177,171,164,158,151,145,138,132,125,119,112,106,99,93,86,73],flow_blue=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,251,247,244,240,236,232,228,225,221,217,213,209,206,202,198,194,190,186,183,179,175,171,167,164,160,156,152,148,145,141,137,133,129,126,122,118,114,110,107,103,99,95,91,88,84,80,76,72,69,65,61,57,53,49,46,42,38,34,30,27,23,19,15,11,8,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,255],flow_green=[200,197,194,191,188,185,182,179,176,173,170,167,164,161,158,155,152,149,146,143,140,137,134,131,128,125,122,119,116,113,110,107,104,101,98,95,92,89,86,83,80,77,74,71,68,65,62,59,56,53,50,47,44,41,38,35,32,29,26,23,20,20,20,19,19,19,19,18,18,18,17,17,17,16,16,16,16,15,15,15,14,14,14,13,13,13,13,12,12,12,11,11,11,10,10,10,10,9,9,9,8,8,8,7,7,7,7,6,6,6,5,5,5,4,4,4,4,3,3,3,2,2,2,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,6,10,14,18,22,26,30,34,38,42,46,50,54,58,62,66,70,74,78,82,86,90,94,98,102,106,110,114,118,122,126,130,134,138,142,146,150,154,158,162,166,170,174,178,182,186,190,194,198,202,206,210,214,218,222,226,230,234,238,242,246,250,255],flow_red=[32,32,32,32,31,31,31,31,31,30,30,30,30,30,29,29,29,29,29,28,28,28,28,28,27,27,27,27,27,26,26,26,26,26,25,25,25,25,25,24,24,24,24,24,23,23,23,23,23,22,22,22,22,22,21,21,21,21,21,20,20,20,20,19,19,19,19,18,18,18,17,17,17,16,16,16,16,15,15,15,14,14,14,13,13,13,13,12,12,12,11,11,11,10,10,10,10,9,9,9,8,8,8,7,7,7,7,6,6,6,5,5,5,4,4,4,4,3,3,3,2,2,2,1,1,1,1,0,0,0,4,8,12,16,20,24,28,32,36,40,45,49,53,57,61,65,69,73,77,81,85,89,93,97,101,105,109,113,117,121,125,130,134,138,142,146,150,154,158,162,166,170,174,178,182,186,190,194,198,202,206,210,215,219,223,227,231,235,239,243,247,251,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],ge_color_blue=[0,1,3,5,7,9,11,13,15,17,19,21,23,25,27,29,31,33,35,37,39,41,43,45,47,49,51,53,55,57,59,61,63,65,67,69,71,73,75,77,79,81,83,85,87,89,91,93,95,97,99,101,103,105,107,109,111,113,115,117,119,121,123,125,127,129,131,133,135,137,139,141,143,145,147,149,151,153,155,157,159,161,163,165,167,169,171,173,175,177,179,181,183,185,187,189,191,193,195,197,199,201,203,205,207,209,211,213,215,217,219,221,223,225,227,229,231,233,235,237,239,241,243,245,247,249,251,253,255,252,248,244,240,236,232,228,224,220,216,212,208,204,200,196,192,188,184,180,176,172,168,164,160,156,152,148,144,140,136,132,128,124,120,116,112,108,104,100,96,92,88,84,80,76,72,68,64,60,56,52,48,44,40,36,32,28,24,20,16,12,8,4,0,4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76,80,85,89,93,97,101,105,109,113,117,121,125,129,133,137,141,145,149,153,157,161,165,170,174,178,182,186,190,194,198,202,206,210,214,218,222,226,230,234,238,242,246,250,255],ge_color_green=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,62,65,67,69,71,73,75,77,79,81,83,85,87,89,91,93,95,97,99,101,103,105,107,109,111,113,115,117,119,121,123,125,128,126,124,122,120,118,116,114,112,110,108,106,104,102,100,98,96,94,92,90,88,86,84,82,80,78,76,74,72,70,68,66,64,63,61,59,57,55,53,51,49,47,45,43,41,39,37,35,33,31,29,27,25,23,21,19,17,15,13,11,9,7,5,3,1,0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,62,64,66,68,70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,102,104,106,108,110,112,114,116,118,120,122,124,126,128,130,132,134,136,138,140,142,144,146,148,150,152,154,156,158,160,162,164,166,168,170,172,174,176,178,180,182,184,186,188,190,192,194,196,198,200,202,204,206,208,210,212,214,216,218,220,222,224,226,228,230,232,234,236,238,240,242,244,246,248,250,252,255],ge_color_red=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,3,5,7,9,11,13,15,17,19,21,23,25,27,29,31,33,35,37,39,41,43,45,47,49,51,53,55,57,59,61,63,65,67,69,71,73,75,77,79,81,83,85,86,88,90,92,94,96,98,100,102,104,106,108,110,112,114,116,118,120,122,124,126,128,130,132,134,136,138,140,142,144,146,148,150,152,154,156,158,160,162,164,166,168,170,171,173,175,177,179,181,183,185,187,189,191,193,195,197,199,201,203,205,207,209,211,213,215,217,219,221,223,225,227,229,231,233,235,237,239,241,243,245,247,249,251,253,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],gray_rainbow_blue=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,255,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,255,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,255,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,255,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,255,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,255,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,205,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,125,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,45,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,0,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,0,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,0,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,0,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,0,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,0,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255],gray_rainbow_green=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,0,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,0,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,0,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,65,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,145,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,225,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,255,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,255,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,255,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,255,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,255,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,255,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,235,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,155,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,75,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255],gray_rainbow_red=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,175,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,95,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,15,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,0,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,0,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,0,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,0,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,0,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,0,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,35,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,115,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,195,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,255,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,255,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,255,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255],hot_green_blue=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,6,10,13,16,20,23,26,30,33,37,40,43,47,50,53,57,60,64,67,70,74,77,80,84,87,90,94,97,101,104,107,111,114,117,121,124,128,131,134,138,141,144,148,151,154,158,161,165,168,171,175,178,181,185,188,192,195,198,202,205,208,212,215,218,222,225,229,232,235,239,242,245,249,252],hot_green_green=[0,1,3,4,6,7,9,10,12,13,15,16,18,19,21,22,24,25,27,28,30,31,33,34,36,37,39,40,42,43,45,46,48,49,51,52,54,55,57,58,60,61,63,64,66,67,69,70,72,73,75,76,78,79,81,82,84,85,87,88,90,91,93,94,96,97,99,100,102,103,105,106,108,109,111,112,114,115,117,118,120,121,123,124,126,127,129,130,132,133,135,136,138,139,141,142,144,145,147,148,150,151,153,154,156,157,159,160,162,163,165,166,168,169,171,172,174,175,177,178,180,181,183,184,186,187,189,190,192,193,195,196,198,199,201,202,204,205,207,208,210,211,213,214,216,217,219,220,222,223,225,226,228,229,231,232,234,235,237,238,240,241,243,244,246,247,249,250,252,253,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],hot_green_red=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,3,5,7,8,10,12,14,16,17,19,21,23,24,26,28,30,32,33,35,37,39,40,42,44,46,48,49,51,53,55,56,58,60,62,64,65,67,69,71,72,74,76,78,80,81,83,85,87,88,90,92,94,96,97,99,101,103,104,106,108,110,112,113,115,117,119,120,122,124,126,128,129,131,133,135,136,138,140,142,144,145,147,149,151,152,154,156,158,160,161,163,165,167,168,170,172,174,176,177,179,181,183,184,186,188,190,192,193,195,197,199,200,202,204,206,208,209,211,213,215,216,218,220,222,224,225,227,229,231,232,234,236,238,240,241,243,245,247,248,250,252,254],hot_iron_blue=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76,80,84,88,92,96,100,104,108,112,116,120,124,128,132,136,140,144,148,152,156,160,164,168,172,176,180,184,188,192,196,200,204,208,212,216,220,224,228,232,236,240,244,248,252,255],hot_iron_green=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,62,64,66,68,70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,102,104,106,108,110,112,114,116,118,120,122,124,126,128,130,132,134,136,138,140,142,144,146,148,150,152,154,156,158,160,162,164,166,168,170,172,174,176,178,180,182,184,186,188,190,192,194,196,198,200,202,204,206,208,210,212,214,216,218,220,222,224,226,228,230,232,234,236,238,240,242,244,246,248,250,252,255],hot_iron_red=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,62,64,66,68,70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,102,104,106,108,110,112,114,116,118,120,122,124,126,128,130,132,134,136,138,140,142,144,146,148,150,152,154,156,158,160,162,164,166,168,170,172,174,176,178,180,182,184,186,188,190,192,194,196,198,200,202,204,206,208,210,212,214,216,218,220,222,224,226,228,230,232,234,236,238,240,242,244,246,248,250,252,254,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],hot_metal_blue=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,7,11,15,19,23,27,31,35,39,43,47,51,55,59,63,67,71,75,79,83,87,91,95,99,103,107,111,115,119,123,127,131,135,139,143,147,151,155,159,163,167,171,175,179,183,187,191,195,199,203,207,211,215,219,223,227,231,235,239,243,247,251],hot_metal_green=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,5,8,11,14,16,19,22,25,28,30,33,36,39,42,44,47,50,53,56,58,61,64,67,70,72,75,78,81,84,86,89,92,95,98,100,103,106,109,112,114,117,120,123,126,128,131,134,137,140,142,145,148,151,154,156,159,162,165,168,170,173,176,179,182,184,187,190,193,196,198,201,204,207,210,212,215,218,221,224,226,229,232,235,238,240,243,246,249,252,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],hot_metal_red=[0,1,2,4,5,7,8,9,11,12,14,15,16,18,19,21,22,23,25,26,28,29,30,32,33,35,36,37,39,40,42,43,44,46,47,49,50,51,53,54,56,57,58,60,61,63,64,65,67,68,70,71,72,74,75,77,78,79,81,82,84,85,86,88,89,91,92,93,95,96,98,99,100,102,103,105,106,107,109,110,112,113,114,116,117,119,120,121,123,124,126,127,128,130,131,133,134,135,137,138,140,141,142,144,145,147,148,149,151,152,154,155,156,158,159,161,162,163,165,166,168,169,170,172,173,175,176,177,179,180,182,183,184,186,187,189,190,191,193,194,196,197,198,200,201,203,204,205,207,208,210,211,212,214,215,217,218,219,221,222,224,225,226,228,229,231,232,233,235,236,238,239,240,242,243,245,246,247,249,250,252,253,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],hue1_blue=[3,3,13,17,23,30,37,44,50,57,63,70,76,82,89,95,101,107,114,120,126,132,138,144,149,155,161,167,172,178,184,189,195,200,205,211,216,221,227,232,237,242,247,252,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,253,250,247,244,242,239,236,234,231,229,226,224,221,219,217,214,212,210,208,206,204,202,200,198,196,194,192,191,189,187,186,184,183,181,180,179,177,176,175,174,173,172,171,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,251],hue1_green=[0,0,1,2,3,4,5,6,7,8,9,13,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,87,92,97,102,107,111,116,121,125,130,134,139,143,147,152,156,160,164,168,172,176,180,184,188,192,196,199,203,207,210,214,217,221,224,228,231,234,238,241,244,247,250,253,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,254,253,252,251,251,250,249,249,248,247,247,246,246,246,245,245,245,245,244,244,244,244,244,244,245,245,245,245,246,246,246,247,247,248,249,249,250,251,251,251],hue1_red=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,252,247,242,237,233,228,223,219,214,210,205,201,196,192,188,184,179,175,171,167,163,159,155,151,147,144,140,136,133,129,125,122,118,115,112,108,105,102,99,95,92,89,86,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,172,175,177,180,183,186,188,191,194,196,199,201,203,206,208,210,213,215,217,219,221,223,225,227,229,230,232,234,236,237,239,240,242,243,245,246,247,248,250,251,252,253,254,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],hue2_blue=[253,253,252,251,250,249,248,248,247,247,246,246,245,245,244,244,244,244,243,243,243,243,243,243,243,243,244,244,244,244,245,245,246,246,247,247,248,249,250,250,251,252,253,254,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,253,250,247,244,241,237,234,231,227,224,220,217,213,210,206,203,199,195,191,187,183,179,175,171,167,163,159,155,150,146,142,137,133,128,124,119,114,110,105,100,95,90,86,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17,16,15,14,13,12,11,13,9,8,7,6,5,4,3,2,2],hue2_green=[253,253,252,251,250,249,248,247,246,245,244,243,242,241,240,239,238,237,236,235,234,233,232,231,230,229,228,227,226,225,224,223,222,221,220,219,218,217,216,215,214,213,212,211,210,209,208,207,206,205,204,203,202,201,200,199,198,197,196,195,194,193,192,191,190,189,188,187,186,185,184,183,182,181,180,179,178,177,176,175,174,173,172,171,170,169,169,169,170,171,172,173,174,176,177,178,180,181,183,184,186,188,189,191,193,195,197,199,201,203,205,207,209,211,214,216,218,221,223,226,228,231,233,236,239,241,244,247,250,253,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,252,247,242,237,232,226,221,216,211,205,200,194,189,183,178,172,166,160,155,149,143,137,131,125,119,113,107,100,94,88,81,75,69,62,56,49,42,36,29,29],hue2_red=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,254,253,252,251,249,248,247,246,244,243,241,240,238,237,235,233,231,230,228,226,224,222,220,218,216,213,211,209,207,204,202,199,197,194,192,189,187,184,181,178,175,172,170,168,167,166,165,164,163,162,161,160,159,158,157,156,155,154,153,152,151,150,149,148,147,146,145,144,143,142,141,140,139,138,137,136,135,134,133,132,131,130,129,128,127,126,125,124,123,122,121,120,119,118,117,116,115,114,113,112,111,110,109,108,107,106,105,104,103,102,101,100,99,98,97,96,95,94,93,92,91,90,89,88,87,86,85,85,84,84,88,91,94,97,100,103,107,110,114,117,121,124,128,131,135,139,143,146,150,154,158,162,166,170,174,179,183,187,191,196,200,205,209,214,218,223,228,233,237,242,247,252,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],ired_blue=[255,254,253,252,251,250,249,248,247,246,245,244,243,242,241,240,239,238,237,236,235,234,233,232,231,230,229,228,227,226,225,224,223,222,221,220,219,218,217,216,215,214,213,212,211,210,209,208,207,206,205,204,203,202,201,200,199,198,197,196,195,194,193,192,191,190,189,188,187,186,185,184,183,182,181,180,179,178,177,176,175,174,173,172,171,170,169,168,167,166,165,164,163,162,161,160,159,158,157,156,155,154,153,152,151,150,149,148,147,146,145,144,143,142,141,140,139,138,137,136,135,134,133,132,131,130,129,128,127,126,125,124,123,122,121,120,119,118,117,116,115,114,113,112,111,110,109,108,107,106,105,104,103,102,101,100,99,98,97,96,95,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,1],ired_green=[255,254,253,252,251,250,249,248,247,246,245,244,243,242,241,240,239,238,237,236,235,234,233,232,231,230,229,228,227,226,225,224,223,222,221,220,219,218,217,216,215,214,213,212,211,210,209,208,207,206,205,204,203,202,201,200,199,198,197,196,195,194,193,192,191,190,189,188,187,186,185,184,183,182,181,180,179,178,177,176,175,174,173,172,171,170,169,168,167,166,165,164,163,162,161,160,159,158,157,156,155,154,153,152,151,150,149,148,147,146,145,144,143,142,141,140,139,138,137,136,135,134,133,132,131,130,129,128,127,126,125,124,123,122,121,120,119,118,117,116,115,114,113,112,111,110,109,108,107,106,105,104,103,102,101,100,99,98,97,96,95,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,1],ired_red=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],jet_blue=[142,146,149,153,156,160,163,167,170,174,177,181,184,188,191,195,198,202,205,209,212,216,219,223,226,230,233,237,240,244,247,251,255,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,250,250,250,250,246,242,239,235,231,227,223,219,215,211,207,203,199,195,192,188,184,180,176,172,168,164,160,156,152,148,144,141,137,133,129,125,121,117,113,109,105,101,97,94,90,86,82,78,74,70,66,62,58,54,50,47,43,39,35,31,27,23,19,15,11,7,3,0,0,0,0,0,0,1,1,1,1,1,2,2,2,2,2,3,3,3,3,3,4,4,4,4,4,5,5,5,5,5,6,6,6,6,6,7,7,7,7,7,8,8,8,8,8,9,9,9,9,9,10,10,10,10,10,11,11,11,11,11,12,12,12,12,12,12,12,11,11,11,11,11,10,10,10,10,10,9,9,9,9,9,8,8,8,8,8,7,7,7,7,7,6,6,6],jet_green=[5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,9,9,13,16,20,24,28,32,35,39,43,47,51,54,58,62,66,70,73,77,81,85,89,92,96,100,104,108,112,115,119,123,127,131,134,138,142,146,150,153,157,161,165,169,172,176,180,184,188,191,195,199,203,207,211,214,218,222,226,230,233,237,241,245,249,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,250,250,250,250,250,250,250,250,250,247,243,240,236,233,229,225,222,218,215,211,208,204,201,197,194,190,187,183,180,176,173,169,165,162,158,155,151,148,144,141,137,134,130,127,123,120,116,113,109,105,102,98,95,91,88,84,81,77,74,70,67,63,60,56,53,49,45,42,38,35,31,28,24,24,24,23,23,22,22,22,21,21,20,20,20,19,19,19,18,18,17,17,17,16,16,15,15,15,14,14,14,13,13,12],jet_red=[17,18,18,19,19,19,20,20,21,21,22,22,22,23,23,24,24,25,25,26,26,26,27,27,28,28,29,29,29,30,30,31,31,31,31,31,31,30,30,30,30,30,30,30,29,29,29,29,29,29,28,28,28,28,28,28,28,27,27,27,27,27,27,27,26,26,26,26,26,26,25,25,25,25,25,25,25,24,24,24,24,24,24,24,23,23,23,23,23,23,22,22,22,22,22,22,22,25,29,32,36,40,43,47,50,54,57,61,65,68,72,75,79,83,86,90,93,97,101,104,108,111,115,118,122,126,129,133,136,140,144,147,151,154,158,162,165,169,172,176,179,183,187,190,194,197,201,205,208,212,215,219,223,226,230,233,237,240,244,248,251,251,251,251,251,251,251,251,251,251,251,251,251,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,253,253,253,253,253,253,253,253,249,245,241,237,233,229,225,221,217,213,209,206,202,198,194,190,186,182,178,174,170,166,162,158,154,151,147,143,139,135,131],muscles_bones_blue=[0,0,0,0,1,1,1,2,2,2,2,3,3,3,4,4,4,5,5,5,5,6,6,6,7,7,7,7,8,8,8,9,9,9,10,10,10,10,11,11,11,12,12,12,12,13,13,13,14,14,14,15,15,15,15,16,16,16,17,17,17,17,18,18,18,19,19,19,20,20,20,20,21,21,21,22,22,22,22,23,23,23,24,24,24,25,25,25,25,26,26,26,27,27,27,27,27,27,26,26,26,25,25,25,24,24,24,23,23,22,22,22,21,21,21,20,20,20,19,19,19,18,18,18,17,17,16,16,16,15,15,15,14,14,14,13,13,13,12,12,11,11,11,10,10,10,9,9,10,10,11,11,12,12,13,13,14,15,15,16,16,17,17,18,18,19,19,20,21,21,22,22,23,23,24,24,25,26,26,27,27,28,28,29,29,30,31,31,32,32,33,33,34,34,35,36,36,37,37,38,38,39,43,47,51,55,58,62,66,70,74,78,82,86,90,94,98,102,105,109,113,117,121,125,129,133,137,141,145,149,153,156,160,164,168,172,176,180,184,188,192,196,200,204,207,211,215,219,223,227,231,235,239,243,247,251],muscles_bones_green=[0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,3,4,4,4,4,5,5,5,5,6,6,6,6,6,7,7,7,7,8,8,8,8,9,9,9,9,9,10,10,10,10,11,11,11,11,12,12,12,12,12,13,13,13,13,14,14,14,14,15,15,15,15,15,16,16,16,16,17,17,17,17,18,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,21,24,27,30,33,36,39,42,45,48,51,54,57,60,63,66,69,72,75,78,81,84,87,90,93,96,99,102,105,108,111,114,117,120,123,126,129,131,134,137,140,143,146,149,152,155,158,161,164,167,170,173,176,177,179,180,181,182,183,185,186,187,188,189,191,192,193,194,195,197,198,199,200,201,203,204,205,206,207,209,210,211,212,213,215,216,217,218,220,221,222,223,224,226,227,228,229,230,232,233,234,235,236,238,239,240,241,241,242,242,242,242,243,243,243,243,244,244,244,244,245,245,245,245,246,246,246,246,247,247,247,247,248,248,248,248,248,249,249,249,249,250,250,250,250,251,251,251,251,252,252,252,252,253,253,253,253,254,254,254,254],muscles_bones_red=[0,2,5,8,10,13,16,18,21,24,26,29,32,34,37,40,42,45,48,51,53,56,59,61,64,67,69,72,75,77,80,83,85,88,91,93,96,99,102,104,107,110,112,115,118,120,123,126,128,131,134,136,139,142,144,147,150,153,155,158,161,163,166,169,171,174,177,179,182,185,187,190,193,195,198,201,204,206,209,212,214,217,220,222,225,228,230,233,236,238,241,244,246,249,252,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],nih_blue=[0,11,22,34,45,56,68,79,90,102,113,124,136,147,158,170,164,159,154,148,143,138,132,127,122,116,111,106,100,95,90,85,90,95,100,106,111,116,122,127,132,138,143,148,154,159,164,170,175,180,185,191,196,201,207,212,217,223,228,233,239,244,249,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,249,244,239,233,228,223,217,212,207,201,196,191,185,180,175,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,159,148,138,127,116,106,95,85,74,63,53,42,31,21,10,0,5,10,15,21,26,31,37,42,47,53,58,63,69,74,79,85,79,74,69,63,58,53,47,42,37,31,26,21,15,10,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255],nih_green=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,10,15,21,26,31,37,42,47,53,58,63,69,74,79,85,90,95,100,106,111,116,122,127,132,138,143,148,154,159,164,170,175,180,185,191,196,201,207,212,217,223,228,233,239,244,249,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,249,244,239,233,228,223,217,212,207,201,196,191,185,180,175,170,164,159,154,148,143,138,132,127,122,116,111,106,100,95,90,85,81,78,75,71,68,65,62,58,55,52,49,45,42,39,35,32,29,26,22,19,16,13,9,6,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255],nih_red=[0,5,11,17,22,28,34,39,45,51,56,62,68,73,79,85,79,74,69,63,58,53,47,42,37,31,26,21,15,10,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,10,15,21,26,31,37,42,47,53,58,63,69,74,79,85,95,106,116,127,138,148,159,170,180,191,201,212,223,233,244,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,252,250,248,246,243,241,239,237,234,232,230,228,225,223,221,219,216,214,212,210,208,205,203,201,199,196,194,192,190,187,185,183,181,178,176,174,255,255],rainbow1_blue=[0,4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76,80,84,88,92,96,100,104,108,112,116,120,124,128,132,136,140,144,148,152,156,160,164,168,172,176,180,184,188,192,196,200,204,208,212,216,220,224,228,232,236,240,244,248,252,255,247,239,231,223,215,207,199,191,183,175,167,159,151,143,135,127,119,111,103,95,87,79,71,63,55,47,39,31,23,15,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],rainbow1_green=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120,128,136,144,152,160,168,176,184,192,200,208,216,224,232,240,248,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,253,251,249,247,245,243,241,239,237,235,233,231,229,227,225,223,221,219,217,215,213,211,209,207,205,203,201,199,197,195,193,192,189,186,183,180,177,174,171,168,165,162,159,156,153,150,147,144,141,138,135,132,129,126,123,120,117,114,111,108,105,102,99,96,93,90,87,84,81,78,75,72,69,66,63,60,57,54,51,48,45,42,39,36,33,30,27,24,21,18,15,12,9,6,3],rainbow1_red=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,62,64,62,60,58,56,54,52,50,48,46,44,42,40,38,36,34,32,30,28,26,24,22,20,18,16,14,12,10,8,6,4,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76,80,84,88,92,96,100,104,108,112,116,120,124,128,132,136,140,144,148,152,156,160,164,168,172,176,180,184,188,192,196,200,204,208,212,216,220,224,228,232,236,240,244,248,252,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],rainbow2_blue=[0,3,7,10,14,19,23,28,32,38,43,48,53,59,63,68,72,77,81,86,91,95,100,104,109,113,118,122,127,132,136,141,145,150,154,159,163,168,173,177,182,186,191,195,200,204,209,214,218,223,227,232,236,241,245,250,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,246,242,238,233,225,220,216,212,203,199,195,191,187,178,174,170,165,157,152,148,144,135,131,127,123,114,110,106,102,97,89,84,80,76,67,63,59,55,46,42,38,34,25,21,16,12,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],rainbow2_green=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,8,16,21,25,29,38,42,46,51,55,63,67,72,76,84,89,93,97,106,110,114,119,127,131,135,140,144,152,157,161,165,174,178,182,187,195,199,203,208,216,220,225,229,233,242,246,250,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,250,242,238,233,229,221,216,212,208,199,195,191,187,178,174,170,165,161,153,148,144,140,131,127,123,119,110,106,102,97,89,85,80,76,72,63,59,55,51,42,38,34,29,21,17,12,8,0],rainbow2_red=[0,4,9,13,18,22,27,31,36,40,45,50,54,58,61,64,68,69,72,74,77,79,80,82,83,85,84,86,87,88,86,87,87,87,85,84,84,84,83,79,78,77,76,71,70,68,66,60,58,55,53,46,43,40,36,33,25,21,16,12,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,8,12,21,25,29,33,42,46,51,55,63,67,72,76,80,89,93,97,101,110,114,119,123,131,135,140,144,153,157,161,165,169,178,182,187,191,199,203,208,212,221,225,229,233,242,246,250,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],rainbow3_blue=[255,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,250,247,241,238,232,229,223,220,214,211,205,202,196,193,187,184,178,175,169,166,160,157,151,148,142,139,133,130,125,121,116,112,107,103,98,94,89,85,80,76,71,67,62,58,53,49,44,40,35,31,26,22,17,13,8,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],rainbow3_green=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,6,11,15,20,24,29,33,38,42,47,51,56,60,65,69,74,78,83,87,92,96,101,105,110,114,119,122,128,131,137,140,146,149,155,158,164,167,173,176,182,185,191,194,200,203,209,212,218,221,227,230,236,240,245,249,254,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,252,247,243,238,234,229,225,220,216,211,207,202,198,193,189,184,180,175,171,166,162,157,153,148,144,139,135,131,126,122,117,113,108,104,99,95,90,86,81,77,72,68,63,59,54,50,45,41,36,32,27,23,18,14,9,5,5],rainbow3_red=[124,124,120,115,111,106,102,97,93,88,84,79,75,70,66,61,57,52,48,43,39,34,30,25,21,16,12,7,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,5,13,14,19,23,28,32,37,41,46,50,55,59,64,68,73,77,82,86,91,95,100,104,109,113,118,123,126,132,135,141,144,150,153,159,162,168,171,177,180,186,189,195,198,204,207,213,216,222,225,231,234,240,243,249,252,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,254,255,255,255],ratio_blue=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,254,252,250,248,246,244,242,240,238,236,234,232,230,228,226,224,222,220,218,216,214,212,210,208,206,204,202,200,198,196,194,192,190,188,186,184,182,180,178,176,174,172,170,168,166,164,162,160,158,156,154,152,150,148,146,144,142,140,138,136,134,132,130,128,126,124,122,120,118,116,114,112,110,108,106,104,102,100,98,96,94,92,90,88,86,84,82,80,78,76,74,72,70,68,66,64,62,60,58,56,54,52,50,48,46,44,42,40,38,36,34,32,30,28,26,24,22,20,18,16,14,12,10,8,6,4,2,0],ratio_green=[0,1,3,5,7,9,11,13,15,17,19,21,23,25,27,29,31,33,35,37,39,41,43,45,47,49,51,53,55,57,59,61,63,65,67,69,71,73,75,77,79,81,83,85,87,89,91,93,95,97,99,101,103,105,107,109,111,113,115,117,119,121,123,125,127,129,131,133,135,137,139,141,143,145,147,149,151,153,155,157,159,161,163,165,167,169,171,173,175,177,179,181,183,185,187,189,191,193,195,197,199,201,203,205,207,209,211,213,215,217,219,221,223,225,227,229,231,233,235,237,239,241,243,245,247,249,251,253,254,252,250,248,246,244,242,240,238,236,234,232,230,228,226,224,222,220,218,216,214,212,210,208,206,204,202,200,198,196,194,192,190,188,186,184,182,180,178,176,174,172,170,168,166,164,162,160,158,156,154,152,150,148,146,144,142,140,138,136,134,132,130,128,126,124,122,120,118,116,114,112,110,108,106,104,102,100,98,96,94,92,90,88,86,84,82,80,78,76,74,72,70,68,66,64,62,60,58,56,54,52,50,48,46,44,42,40,38,36,34,32,30,28,26,24,22,20,18,16,14,12,10,8,6,4,2,0],ratio_red=[0,1,3,5,7,9,11,13,15,17,19,21,23,25,27,29,31,33,35,37,39,41,43,45,47,49,51,53,55,57,59,61,63,65,67,69,71,73,75,77,79,81,83,85,87,89,91,93,95,97,99,101,103,105,107,109,111,113,115,117,119,121,123,125,127,129,131,133,135,137,139,141,143,145,147,149,151,153,155,157,159,161,163,165,167,169,171,173,175,177,179,181,183,185,187,189,191,193,195,197,199,201,203,205,207,209,211,213,215,217,219,221,223,225,227,229,231,233,235,237,239,241,243,245,247,249,251,253,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],red_vessels_blue=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,55,57,59,61,64,66,68,70,72,75,77,79,81,84,86,88,90,92,95,97,99,101,103,106,108,110,112,114,117,119,121,123,126,128,136,144,152,159,167,175,183,191,199,207,215,223,231,239,247],red_vessels_green=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,3,5,6,8,10,11,13,15,16,18,20,21,23,25,26,28,30,32,33,35,37,38,40,42,43,45,47,48,50,52,53,55,57,59,60,62,64,65,67,69,70,72,74,75,77,79,80,82,84,86,87,89,91,93,95,97,99,101,103,105,107,109,111,113,115,117,119,121,124,126,128,130,132,134,136,138,140,142,144,146,148,150,152,154,156,158,164,170,176,182,188,194,200,206,212,218,224,230,236,242,248],red_vessels_red=[0,1,2,3,5,6,7,9,10,11,12,14,15,16,18,19,20,21,23,24,25,27,28,29,30,32,33,34,36,37,38,39,41,42,43,45,46,47,49,50,51,52,54,55,56,58,59,60,61,63,64,65,67,68,69,70,72,73,74,76,77,78,79,81,82,83,85,86,87,88,90,91,92,94,95,96,98,99,100,101,103,104,105,107,108,109,110,112,113,114,116,117,118,119,121,122,123,125,126,127,128,130,131,132,134,135,136,137,139,140,141,143,144,145,147,148,149,150,152,153,154,156,157,158,159,161,162,163,165,166,167,168,170,171,172,174,175,176,177,179,180,181,183,184,185,186,188,189,190,192,193,194,196,197,198,199,200,201,202,203,204,206,207,208,209,210,211,212,213,214,215,216,217,219,220,221,222,223,224,225,226,227,228,229,231,232,233,234,235,236,237,238,239,240,241,243,244,245,246,247,248,249,250,251,252,253,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],spectrum_blue=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,250,245,240,235,230,225,220,215,210,205,200,195,190,185,180,175,170,165,160,155,150,145,140,135,130,125,120,115,110,105,100,95,90,85,80,75,70,65,60,55,50,45,40,35,30,25,20,15,10,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],spectrum_green=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110,115,120,125,130,135,140,145,150,155,160,165,170,175,180,185,190,195,200,205,210,215,220,225,230,235,240,245,251,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,250,245,240,235,230,225,220,215,210,205,200,195,190,185,180,175,170,165,160,155,150,145,140,135,130,125,120,115,110,105,100,95,90,85,80,75,70,65,60,55,50,45,40,35,30,25,20,15,10,5,0],spectrum_red=[255,250,245,240,235,230,225,220,215,210,205,200,195,190,185,180,175,170,165,160,155,150,145,140,135,130,125,120,115,110,105,100,95,90,85,80,75,70,65,60,55,50,45,40,35,30,25,20,15,10,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110,115,120,125,130,135,140,145,150,155,160,165,170,175,180,185,190,195,200,205,210,215,220,225,230,235,240,245,250,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],stern_blue=[0,1,3,5,7,9,11,13,15,17,19,21,23,25,27,29,31,33,35,37,39,41,43,45,47,49,51,53,55,57,59,61,63,65,67,69,71,73,75,77,79,81,83,85,87,89,91,93,95,97,99,101,103,105,107,109,111,113,115,117,119,121,123,125,127,129,131,133,135,137,139,141,143,145,147,149,151,153,155,157,159,161,163,165,167,169,171,173,175,177,179,181,183,185,187,189,191,193,195,197,199,201,203,205,207,209,211,213,215,217,219,221,223,225,227,229,231,233,235,237,239,241,243,245,247,249,251,253,255,251,247,243,238,234,230,226,221,217,213,209,204,200,196,192,187,183,179,175,170,166,162,158,153,149,145,141,136,132,128,124,119,115,111,107,102,98,94,90,85,81,77,73,68,64,60,56,51,47,43,39,34,30,26,22,17,13,9,5,0,3,7,11,15,19,22,26,30,34,38,41,45,49,53,57,60,64,68,72,76,79,83,87,91,95,98,102,106,110,114,117,121,125,129,133,137,140,144,148,152,156,159,163,167,171,175,178,182,186,190,194,197,201,205,209,213,216,220,224,228,232,235,239,243,247,251,255],stern_green=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255],stern_red=[0,18,36,54,72,90,108,127,145,163,181,199,217,235,254,249,244,239,234,229,223,218,213,208,203,197,192,187,182,177,172,166,161,156,151,146,140,135,130,125,120,115,109,104,99,94,89,83,78,73,68,63,58,52,47,42,37,32,26,21,16,11,6,0,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255],ucla_blue=[0,0,0,0,0,0,0,0,0,0,0,0,102,102,102,102,136,136,136,136,136,136,136,136,136,136,136,136,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,170,170,170,170,187,187,187,187,204,204,204,204,204,204,204,204,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,221,187,187,187,187,187,187,187,187,170,170,170,170,153,153,153,153,153,153,153,153,136,136,136,136,119,119,119,119,119,119,119,119,85,85,85,85,71,71,71,71,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],ucla_green=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,51,51,51,51,51,51,51,51,85,85,85,85,119,119,119,119,119,119,119,119,136,136,136,136,153,153,153,153,153,153,153,153,153,153,153,153,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,185,185,185,185,185,185,185,185,204,204,204,204,221,221,221,221,221,221,221,221,238,238,238,238,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,238,238,238,238,238,238,238,238,221,221,221,221,204,204,204,204,204,204,204,204,187,187,187,187,170,170,170,170,170,170,170,170,153,153,153,153,119,119,119,119,85,85,85,85,85,85,85,85,51,51,51,51,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],ucla_red=[0,0,0,0,0,0,0,0,0,0,0,0,85,85,85,85,119,119,119,119,119,119,119,119,136,136,136,136,136,136,136,136,136,136,136,136,102,102,102,102,68,68,68,68,68,68,68,68,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,102,102,102,102,187,187,187,187,204,204,204,204,204,204,204,204,238,238,238,238,238,238,238,238,238,238,238,238,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,238,238,238,238,221,221,221,221,221,221,221,221,204,204,204,204,255,255,255,255],"undefined"==typeof CBoBo&&(CBoBo={}),CBoBo.DataManager=function(options){var self=this,opt=(this.arrStudy=[],$.extend(!0,{render:null},options)),dl=(this.requestHandle,this.Request=function(options){var wadourl,hospid,token,imageType,hasDesensitize,departCode,isKeyImage,isInternal,clientType,error,success,progress,deseriesfakeprogress,serverRead,history,study;void 0!==options&&(5<=this.arrStudy.length?($.Msg("加载检查数上限，最高只能加载5个检查。"),console.log(CBoBo.Plugin.GetTime()+" :加载检查数上限，最高只能加载5个检查。")):null!=this.GetStudy(options.studyuid)?($.Msg("加载该检查<"+options.studyuid+">失败,当前检查已存在。"),console.log(CBoBo.Plugin.GetTime()+" :加载该检查<"+options.studyuid+">失败,检查已存在。")):({studyuid:options,wadourl,hospid,token,imageType,hasDesensitize,departCode,isKeyImage,isInternal,clientType,error,success,progress,deseriesfakeprogress,serverRead,history}=options,(study=new DVStudy).setURLSearchParams({studyuid:options,wadourl:wadourl,hospid:hospid,token:token,imageType:imageType,hasDesensitize:hasDesensitize,departCode:departCode,isKeyImage:isKeyImage,isInternal:isInternal,clientType:clientType}),this.requestHandle=new DicomRequest({wadourl:wadourl,hospid:hospid,studyuid:options,study:study,token:token,imageType:imageType,hasDesensitize:hasDesensitize,departCode:departCode,isKeyImage:isKeyImage,isInternal:isInternal,clientType:clientType,error:error,success:success,progress:progress,deseriesfakeprogress:deseriesfakeprogress,serverRead:serverRead,manager:opt.manager,history:history}),this.requestHandle.RequestVrtWsURl(),this.requestHandle.StartStudyInfo(study),this.arrStudy.push(study)))},this.RequestAIAnnotation=function(option){layer.confirm("平台只开放胸部CT、DR影像的AI服务，更多部位将陆续开放。<br>符合请“确认”</br>不符合请“返回”,解析结果需要等待大概30秒",{btn:["确定","取消"],title:"AI诊断"},function(){layer.msg("正在为您解析AI结果。",{icon:1});var tempURL=self.arrStudy[0].wadourl.replace("Wado","").replace("wado",""),tempHospitalId=self.arrStudy[0].hospid,tempStudyuid=self.arrStudy[0].stuuid;$.ajax({url:tempURL+"Ai/NewStudy",type:"get",data:{studyUid:tempStudyuid,hospId:tempHospitalId},async:!1,complete:function(response){200==response.status&&response.responseJSON&&"success"===response.responseJSON.status?option.success():(option.error&&option.error(),layer.msg("请求AI失败",{icon:5,time:3e3,shade:[.3,"#000"]}))}})},function(){})},this.RequestAIResult=function(option){var tempURL=self.arrStudy[0].wadourl.replace("Wado","").replace("wado",""),tempHospitalId=self.arrStudy[0].hospid,tempStudyuid=self.arrStudy[0].stuuid;$.ajax({url:tempURL+"Ai/GetResult",type:"get",data:{studyUid:tempStudyuid,hospId:tempHospitalId},async:!1,complete:function(response){200==response.status&&response.responseJSON?"success"===(response=response.responseJSON).status?response.result.imgDetail.length?(self.arrStudy[0].SetAnnotations(response.result.imgDetail),option.success()):layer.msg("扫描完成，未发现可疑结节",{icon:5,time:3e3,shade:[.3,"#000"]}):(layer.msg("请求AI数据失败",{icon:5,time:3e3,shade:[.3,"#000"]}),option.error&&option.error()):(option.error&&option.error(),layer.msg("请求AI数据失败",{icon:5,time:3e3,shade:[.3,"#000"]}))}})},this.RequestHistoryStudy=function(options){var opt=$.extend({hospid:"",studyuid:"",hisurl:"",process:null,progress:null,error:null,complete:null,deseriesfakeprogress:null},options);$.ajax({url:opt.hisurl,type:"get",data:{hospId:opt.hospid,mainstudyUid:opt.studyuid},complete:function(response){var bSuccess=!1;200==response.status&&response.responseJSON&&(response.responseJSON.success?(bSuccess=!0,$.each(response.responseJSON.studies,function(i,item){self.Request({wadourl:item.url,hospuid:item.hospId,studyuid:item.uid,departCode:item.departCode,progress:opt.progress,success:opt.success,error:opt.error,deseriesfakeprogress:opt.deseriesfakeprogress})})):$.Msg(response.responseJSON.msg)),null!=opt.complete&&opt.complete(bSuccess)}})},this.GetStudy=function(index){var study;if(void 0===(study=index<this.arrStudy.length&&-1<index?this.arrStudy[index]:study))for(var i=0;i<this.arrStudy.length;i++){var tmp=this.arrStudy[i];if("JPG"==tmp.totaltype)for(var arrImgs=tmp.GetJpg(),j=0;j<arrImgs.length;j++)arrImgs[j].id==index&&(study=tmp);else for(var arrDicom=tmp.GetAllDicom(),j=0;j<arrDicom.length;j++)arrDicom[j].id==index&&(study=tmp)}if(void 0===study)for(i=0;i<this.arrStudy.length;i++){var sty=this.arrStudy[i];sty.studyuid==index&&(study=sty)}return study},this.GetSeries=function(id){for(var i=0;i<this.arrStudy.length;i++){var series=this.arrStudy[i].GetSeries(id);if(null!=series)return series}},this.DeleteStudy=function(uid){for(var i=0;i<this.arrStudy.length;i++){var sty=this.arrStudy[i];sty.studyuid==uid&&(delete sty,this.arrStudy.splice(i,1))}},0),options=(this.SaveDicomBinary=function({id,buffer,width,height,bseries,progress,frames,isRGB,isIMGAnalysis2,imageType}){if(void 0!==id){null==progress&&(progress=100),dl++;for(var i=0;i<this.arrStudy.length;i++){var dicomData,study=this.arrStudy[i],dicom=study.GetDicomById(id,study.name);if(dicom){dicom.frames=frames,dicom.col=width,dicom.row=height;try{dicomData=new(isRGB||dicom.bita<=8&&!isIMGAnalysis2?Uint8Array:dicom.pixrep?Int16Array:Uint16Array)(buffer)}catch(error){console.log(error)}dicom.setPixsBuffer(dicomData),dicom.setData({isIMGAnalysis2:isIMGAnalysis2,imageType:imageType}),isIMGAnalysis2&&!isRGB&&dicom.getWwWc(),bseries?(dicom.bProgress=!0,opt.render(dicom,study,study.CompletePercent(id))):(opt.render(dicom,study,progress),buffer||((ev={}).seruid=dicom.seruid,ev.id=dicom.id,opt.render(ev,study,progress)));var dicom=study.IsPageSwitch(),ev=study.GetStudyType();dicom&&ev&&dl===study.GetAllSeries().length&&self.requestHandle.DLJsonBySeriesUid()}}}},window.config&&window.config.threadDecodePath);let workerList=["./dicomviewer/js/Thread.Decode.js","./static/dicomviewer/js/Thread.Decode.js","./js/Thread.Decode.js"],errorArr=[];options&&workerList.unshift(options),function(){workerUrl=workerList.shift()+"?v=20220616&db="+JSON.stringify(CBoBo.store.db);let response;fetch(workerUrl).then(res=>{var{statusText,ok}=response=res;if("OK"==statusText||ok)return res.text();throw{msg:"Worker文件路径错误",res:res}}).then(data=>{if(!data.includes(".postMessage("))throw{msg:"Worker文件类型错误",response:response,data:data};data=new Worker(workerUrl);(window.mergeThread=data).onmessage=function(e){var{id:e,buffer,width,height,bseries,progress,frames,isRGB,isIMGAnalysis2,imageType}=e["data"];self.SaveDicomBinary({id:e,buffer:buffer,width:width,height:height,bseries:bseries,progress:progress,frames:frames,isRGB:isRGB,isIMGAnalysis2:isIMGAnalysis2,imageType:imageType})}}).catch(error=>{errorArr.push(error),workerList.length?arguments.callee():(console.info(errorArr),console.error("请按规范接入dicomviewer!!!,worker路径不规范!!!,请联系维护人员,可以临时配置index.html=》window.config"),console.info(" dicomviewer规范详见内部git：","http://192.168.18.134:8081/dicomviewer/dicomviewer-pc-jquery"))})}()},"undefined"==typeof CBoBo&&(CBoBo={}),CBoBo.View={},CBoBo.View.Frame=function(rootDom){var self=this,bShowThumb=!0;this.index=0,this.idManager={},this.rootDom=rootDom,this.GetId=function(key){switch(key){case"main":return this.idManager.main;case"banner":return this.idManager.banner;case"contain":return this.idManager.contain;case"thumb":return this.idManager.thumb;case"canvasbox":return this.idManager.canvasbox;case"logo":return this.idManager.logo;case"toolbar":return this.idManager.toolbar;case"thumbbox":return this.idManager.thumbbox}},this.Init=function(){this.idManager.main="main"+CBoBo.Plugin.GetRandom(),this.idManager.banner=CBoBo.Plugin.GetRandom(),this.idManager.contain="contain"+CBoBo.Plugin.GetRandom(),this.idManager.thumb="thumb"+CBoBo.Plugin.GetRandom(),this.idManager.thumbbox="thumbbox"+CBoBo.Plugin.GetRandom(),this.idManager.canvasbox="canvasbox"+CBoBo.Plugin.GetRandom(),this.idManager.logo=CBoBo.Plugin.GetRandom(),this.idManager.toolbar=CBoBo.Plugin.GetRandom(),this.idManager.hidebar=CBoBo.Plugin.GetRandom(),m_printUrl=CBoBo.Plugin.GetUrlParam("WadoURL")||$("#WadoURL").val()||$("#hdurl").val()},this.Create=function(){var str="<div id='"+this.idManager.main+"'><div id='"+this.idManager.banner+"'><div id='"+this.idManager.logo+"' title='全屏'></div><div id='"+this.idManager.toolbar,str=(str+="'></div></div><div id="+this.idManager.contain+">")+("<div id ="+this.idManager.thumb+"></div><div id='"+this.idManager.canvasbox+"'></div>")+"</div></div>";this.rootDom?$(str).appendTo(this.rootDom):$(str).appendTo($("body"))},this.AddEvent=function(){},this.UpdateStyle0=function(){var winWidth=$(window).width(),winHeight=$(window).height(),main=(0!=CBoBo.View.TOOLBAR_HEIGHT&&(CBoBo.View.TOOLBAR_HEIGHT=.026*winWidth>>0,CBoBo.View.TOOLBAR_HEIGHT<29)&&(CBoBo.View.TOOLBAR_HEIGHT=29),$("#"+this.idManager.main)),mainWidth=winWidth-1,main=(main.width(mainWidth),main.height(winHeight-1),main.css({"border-top":"1px solid #282828","border-left":"1px solid #282828","border-right":"1px solid #282828",overflow:"hidden"}),$("#"+this.idManager.banner)),main=(main.width(mainWidth),main.height(CBoBo.View.TOOLBAR_HEIGHT-2),main.css({background:"#535353","border-top":"1px solid #6a6a6a","border-bottom":"1px solid #282828"}),$("#"+this.idManager.contain)),winHeight=winHeight-CBoBo.View.TOOLBAR_HEIGHT,main=(main.width(mainWidth),main.height(winHeight),main.css({position:"relative"}),$("#"+this.idManager.thumb)),thumbMinWidth=mainWidth>>4;main.width(thumbMinWidth=thumbMinWidth<101?101:thumbMinWidth),main.height(winHeight-2),main.css({float:"left",background:"#464646","border-right":"1px solid #282828"});$("#"+this.idManager.thumbbox).css({width:"100%"});main=$("#"+this.idManager.logo),main.width(thumbMinWidth),main.height(CBoBo.View.TOOLBAR_HEIGHT-2),main.css({display:"inline-block","text-align":"center"}),main=$("#"+this.idManager.toolbar),main.width(mainWidth-thumbMinWidth),main.height(CBoBo.View.TOOLBAR_HEIGHT-2),main.css({display:"inline-block",overflow:"hidden"}),mainWidth=$("#"+this.idManager.canvasbox);mainWidth.width(winWidth-thumbMinWidth-23),mainWidth.height(winHeight-22),mainWidth.css({float:"left",background:"#333",padding:"10px"})},this.UpdateStyleLB=function(bBottom){var tleft,cleft,ttop,ctop,canvasboxWidth,canvasboxHeight,thumbHeight,winWidth=$(window).width(),winHeight=$(window).height(),main=(0!=CBoBo.View.TOOLBAR_HEIGHT&&(CBoBo.View.TOOLBAR_HEIGHT=.026*winWidth>>0,CBoBo.View.TOOLBAR_HEIGHT<44)&&(CBoBo.View.TOOLBAR_HEIGHT=44),$("#"+this.idManager.main)),mainWidth=winWidth-1,main=(main.width(mainWidth),main.height(winHeight-1),main.css({"border-top":"1px solid #282828","border-left":"1px solid #282828","border-right":"1px solid #282828",overflow:"hidden"}),$("#"+this.idManager.banner)),main=(main.width(mainWidth),main.height(CBoBo.View.TOOLBAR_HEIGHT-2),main.css({background:"#535353","border-top":"1px solid #6a6a6a","border-bottom":"1px solid #282828"}),$("#"+this.idManager.contain)),winHeight=winHeight-CBoBo.View.TOOLBAR_HEIGHT,main=(main.width(mainWidth),main.height(winHeight),main.css({position:"relative"}),$("#"+this.idManager.thumb)),thumbMinWidth=mainWidth>>4,logo=(thumbMinWidth<101&&(thumbMinWidth=101),$("#"+this.idManager.logo)),logo=(logo.width(thumbMinWidth),logo.height(CBoBo.View.TOOLBAR_HEIGHT-2),logo.css({display:"inline-block","text-align":"center"}),$("#"+this.idManager.toolbar)),logo=(logo.width(mainWidth-thumbMinWidth),logo.height(CBoBo.View.TOOLBAR_HEIGHT-2),logo.css({display:"inline-block",overflow:"hidden"}),$("#"+this.idManager.canvasbox));bBottom?(ctop=cleft=tleft=0,canvasboxWidth=winWidth-20,canvasboxHeight=winHeight-20-(thumbMinWidth=(thumbMinWidth=winHeight>>4)<60?60:thumbMinWidth),ttop=winHeight-thumbMinWidth,thumbHeight=thumbMinWidth,thumbMinWidth=mainWidth):(ctop=ttop=tleft=0,canvasboxWidth=winWidth-(cleft=thumbMinWidth)-20,canvasboxHeight=winHeight-20,thumbHeight=winHeight),main.width(thumbMinWidth),main.height(thumbHeight),main.css({position:"absolute",left:tleft+"px",top:ttop+"px",background:"#464646","border-right":"1px solid #282828","white-space":"nowrap","padding-bottom":"1px"}),logo.width(canvasboxWidth),logo.height(canvasboxHeight),logo.css({position:"absolute",left:cleft+"px",top:ctop+"px",background:"#333",padding:"10px"})},this.UpdateStyle=function(){var winWidth=$(window).width(),winWidth=!($(window).height()<winWidth);this.UpdateStyleLB(winWidth)},this.HideToolBar=function(){CBoBo.View.TOOLBAR_HEIGHT=0,$("#"+this.idManager.banner).hide(),self.UpdateStyle()},this.ShowThumb=function(bShow){var thumb;bShow!=bShowThumb&&(thumb=$("#"+this.idManager.thumb),bShow?(bShowThumb=!0,thumb.css({transition:"left 500ms ease-in-out",left:0})):(bShowThumb=!1,thumb.css({transition:"left 500ms ease-in-out",left:"-150px"})))},self.Init(),self.Create(),self.UpdateStyle()},CBoBo.View.Logo=function(parentElem){var self=this,m_bFullScreen=(this.logo,this.logoFont,this.parentElem,!1);this.Create=function(){this.logo=CBoBo.Plugin.GetRandom(),this.logoFont=CBoBo.Plugin.GetRandom();var str="<span id='"+this.logo+"'></span><span id='"+this.logoFont+"'></span>";$(str).appendTo($(this.parentElem))},this.SetStyle=function(){var font=$("#"+this.logoFont),fontWidth=.9*$(this.parentElem).width()>>0,size=(font.width(fontWidth),font.height(CBoBo.View.TOOLBAR_HEIGHT-2),.2427637721755369*fontWidth>>0);font.css({"font-family":"STXingkai",color:"#aaa",overflow:"hidden","line-height":CBoBo.View.TOOLBAR_HEIGHT-2+"px","text-align":"center","font-size":size+"px",cursor:"pointer","text-shadow":"2px 2px 3px #000","font-weight":"900",display:"inline-block"}),size=(fontWidth>>1)-5,$("#"+this.logo).css({color:"#33FFFF",overflow:"hidden","line-height":CBoBo.View.TOOLBAR_HEIGHT-2+"px","text-align":"center","font-size":size+"px",cursor:"pointer"})},this.SetFont=function(name){return $("#"+this.logoFont).html(name),this},this.SetLogo=function(name){return $("#"+this.logo).html(name),this},this.AddEvent=function(){$(this.parentElem).bind("click",function(e){m_bFullScreen=!m_bFullScreen,CBoBo.Plugin.FullScreen(m_bFullScreen)})},self.parentElem=parentElem,self.Create(),self.AddEvent(),self.SetStyle()},CBoBo.View.PCToolBar=function(options){function ClearToolBox(){var ctrl=$("#"+m_arrId.toolbox);ctrl&&ctrl.empty()}function SeriesMenu(){ClearMainToolBox(),MainMenu(),MainButtonStatus("2D"),PushLine(),PushItem("&#xe631;","释放工具"),PushItem("&#xe67f;","重新加载"),PushMenuItem("&#xe62a;","图像布局"),PushMenuItem("&#xe66d;","序列布局"),PushItem("&#xe644;","恢复"),PushItem("&#xe607;","序列播放"),PushItem("&#xe610;","定位线",CBoBo.isShowScout?{}:{display:"none"}),CBoBo.IsTablet,PushItem("&#xe671;","DICOM信息"),PushItem("&#xe6b6;","显/隐四角信息"),PushLine(),PushItem("&#xe670;","放缩"),PushItem("&#xe630;","移动"),PushMenuItem("&#xe623;","旋转"),PushLine(),PushItem("&#xe603;","负像"),PushMenuItem("&#xe602;","伪彩"),PushLine(),PushItem("&#xe61b;","调窗"),PushTranAngleItem("&#xe61b;","自定义调窗"),PushItem("&#xe902;","锐化"),PushItem("&#xe901;","平滑"),PushLine(),PushItem("&#xe61f;","直线"),PushItem("&#xe619;","矩形"),PushItem("&#xe61e;","椭圆"),PushItem("&#xe618;","角度"),PushItem("&#xe637;","CT"),PushItem("&#xe629;","文本"),PushItem("&#xe62f;","箭头"),PushItem("&#xe9d8;","左标记"),PushItem("&#xE60E;","右标记"),PushItem("&#xe617;","心胸比"),PushItem("&#xe622;","撤销"),PushLine(),PushItem("&#xe653;","删除图像"),PushLine(),PushItem("&#xe900;","本地缓存"),PushLine(),PushItem("&#xe64c;","按键说明")}var m_recordPreTool,m_2DRecordTool,toolbox,self=this,opt=$.extend(!0,{parent:null,axis:"x",bottonbox:!0,msgtransform:null},options),m_arrId={},m_arrButtonSeled={},m_arrButtonNoEnable={},m_recordCurTool={type:-1,msgtansform:null},m_bCreatedGrayTool=!1,ClearMainToolBox=(this.bShowCornerInfo=!0,this.toolType,this.modalityType,function(){}),MainMenu=function(){PushButton("2D","2D"),PushButton("MPR","MPR"),PushButton("3D","3D",CBoBo.isShow3D?{}:{display:"none"}),CBoBo.isShowAi&&PushButton("AI","AI")},MsgProxy=function(event){switch(event.type){case"click":case"change":event.btntitle=event.target.title,m_recordCurTool.msgtansform&&m_recordCurTool.msgtansform(event)}},GetAllButton=function(){var arrToolItem=[];return PushItem($("."+m_arrId.item)),PushItem($("."+m_arrId.menuitem)),PushItem($("."+m_arrId.button)),arrToolItem;function PushItem(arrItem){$.each(arrItem,function(i,item){arrToolItem.push(item)})}},PushItem=function(iconCode,title,exStyle){m_arrId.item||(m_arrId.item=CBoBo.Plugin.GetRandom());title="<span class='item-box'><span class='icon_tool tool-item "+m_arrId.item+"' title='"+title+"'>"+iconCode+"</span></span>",iconCode=$(title).appendTo($("#"+m_arrId.toolbox));iconCode.bind("click",function(event){MsgProxy(event)}),"[object Object]"==Object.prototype.toString.apply(exStyle)&&iconCode.css(exStyle)},PushInput=function(iconCode,title,exStyle){m_arrId.item||(m_arrId.item=CBoBo.Plugin.GetRandom());iconCode="<span class='icon_tool tool-item "+m_arrId.item+"' title='"+title+"'>"+iconCode+"<input  type='range' min='1' max='10' step='1' value='1' style='width:100px' /></span><p style='font-size:10px' id='Thickness'>1mm<p>",iconCode=$(iconCode).appendTo($("#"+m_arrId.toolbox));iconCode.change(function(event){$("#Thickness").html(event.target.value+"mm"),event.target.title=title,MsgProxy(event)}),"[object Object]"==Object.prototype.toString.apply(exStyle)&&iconCode.css(exStyle)},PushMenuItem=function(iconCode,title,exStyle){m_arrId.menuitem||(m_arrId.menuitem=CBoBo.Plugin.GetRandom());iconCode="<span class='item-box'><div class='tool-item "+m_arrId.menuitem+"' title='"+title+"'><span class='icon_tool' title='"+title+"'>"+iconCode+"</span><span style='font-size:14px' title='"+title+"'>▾</span></div></span>",title=$(iconCode).appendTo($("#"+m_arrId.toolbox));title.bind("click",function(event){MsgProxy(event)}),"[object Object]"===Object.prototype.toString.apply(exStyle)&&title.css(exStyle)},PushTranAngleItem=function(iconCode,title,exStyle){m_arrId.menuitem||(m_arrId.menuitem=CBoBo.Plugin.GetRandom());title="<div class='tool-item tool-item-div "+m_arrId.menuitem+"' title='"+title+" '><span title='"+title+"'>▾</span></div>",title=$(title).appendTo($("#"+m_arrId.toolbox));title.bind("click",function(event){MsgProxy(event)}),"[object Object]"===Object.prototype.toString.apply(exStyle)&&title.css(exStyle),$("."+m_arrId.menuitem+" span").css({"pointer-events":"none",overflow:"hidden","white-space":"nowrap"})},PushLine=function(exStyle){m_arrId.line||(m_arrId.line=CBoBo.Plugin.GetRandom());var str="<div class='"+m_arrId.line+"'></div>",str=$(str).appendTo($("#"+m_arrId.toolbox));"[object Object]"==Object.prototype.toString.apply(exStyle)&&str.css(exStyle)},PushButton=function(iconCode,title,exStyle){var ctrl=$("div[title='"+title+"']");null==ctrl.html()&&(m_arrId.button||(m_arrId.button=CBoBo.Plugin.GetRandom()),title="<div class='"+m_arrId.button+"' title='"+title+"'>"+iconCode+"</div>",ctrl=$(title).appendTo($("#"+m_arrId.bottonbox)),"[object Object]"===Object.prototype.toString.call(exStyle)&&ctrl.css(exStyle),ctrl.bind("click mouseenter mouseout",function(event){!function(event){if(!m_arrButtonSeled[event.target.title])switch(event.type){case"mouseenter":ctrl.css({color:"#33FFFF","text-shadow":"0 0 15px #33FFFF"});break;case"mouseout":ctrl.css({color:"#efefef","text-shadow":""});break;case"click":MainButtonStatus(event.target.title),opt.msgtransform&&opt.msgtransform(event)}}(event)}))},MainButtonStatus=function(title){$("."+m_arrId.button).each(function(){var jqItem=$(this);this.title==title?(m_arrButtonSeled[this.title]=title,jqItem.css({color:"#33FFFF","text-shadow":"0px 0px 20px #FFF","pointer-events":"none"})):(m_arrButtonSeled[this.title]=null,jqItem.css({animation:"",color:"#efefef","text-shadow":"","pointer-events":"auto"}))})};this.UpdateStyle=function(){var isFlex,height,toolsBox,toolsCount,margin,parent=$(opt.parent),item=$("."+m_arrId.item),menuitem=$("."+m_arrId.menuitem),line=$("."+m_arrId.line);"x"==opt.axis?(isFlex=20<(toolsCount=(toolsBox=$(".item-box")).length),height=.66*parent.height()>>0,toolsCount=(toolsCount=.9*parent.width()/toolsCount*.5>>0)<20?20:25<toolsCount?25:toolsCount,toolsBox.css({flex:isFlex?1:"none"}),item.css({padding:isFlex?"4px 2px":"4px 6px","font-size":toolsCount+"px",border:"1px solid #535353",cursor:"pointer","border-radius":"6px"}),menuitem.css({padding:"2px","font-size":toolsCount+"px",border:"1px solid #535353",cursor:"pointer","border-radius":"6px"}),line.css({"border-left":"1px solid #383838",width:"1px",height:height+"px",margin:"0 "+margin+"px","pointer-events":"none",float:"left"}),toolsCount=.75*toolsCount>>0,$("."+m_arrId.button).css({margin:"0 4px 0 0",height:height+"px",cursor:"pointer","font-size":toolsCount+"px","text-align":"center","font-family":"Microsoft YaHei","line-height":height+"px","border-radius":"4px",border:"1px solid #535353"})):(margin=(toolsCount=.6*(toolsBox=.6*parent.width()>>0)>>0)/3>>0,item.css({display:"block",padding:"2px",width:toolsBox+"px",overflow:"hidden","font-size":toolsCount+"px",border:"1px solid #444",cursor:"pointer",margin:margin+"px auto","border-radius":"6px"}),menuitem.css({display:"block",padding:"2px",width:toolsBox+"px",overflow:"hidden",margin:margin+"px auto","font-size":toolsCount+"px",border:"1px solid #444",cursor:"pointer","border-radius":"6px"}),line.css({"border-top":"1px solid #000",width:toolsBox+"px",height:"1px",margin:margin+"px auto","pointer-events":"none"})),$(".tool-item-div").css({"margin-left":"-10px",fontSize:"14px"})},this.RequestToolBar=function(type,msgtransform,isForce){if(type!=m_recordCurTool.type||msgtransform!=m_recordCurTool.msgtansform||void 0!==isForce){switch(ClearToolBox(),type){case CBoBo.TOOLMENU_JPG:ClearMainToolBox(),PushButton("2D","2D"),MainButtonStatus("2D"),PushItem("&#xe631;","释放工具"),PushItem("&#xe67f;","重新加载"),PushMenuItem("&#xe66d;","布局"),PushItem("&#xe644;","恢复"),PushItem("&#xe670;","放缩"),PushItem("&#xe630;","移动"),PushItem("&#xe603;","负像"),PushMenuItem("&#xe602;","伪彩"),PushItem("&#xe61b;","亮度/对比"),PushItem("&#xe60f;","删除图像");break;case CBoBo.TOOLMENU_SERIES:SeriesMenu();break;case CBoBo.TOOLMENU_DESERIES:ClearMainToolBox(),PushButton("2D","2D"),MainButtonStatus("2D"),PushItem("&#xe631;","释放工具"),PushItem("&#xe67f;","重新加载"),PushMenuItem("&#xe66d;","布局"),PushItem("&#xe644;","恢复"),PushItem("&#xe606;","胶片打印"),PushItem("&#xe671;","DICOM信息"),PushItem("&#xe67a;","显/隐四角信息"),PushLine(),PushItem("&#xe670;","放缩"),PushItem("&#xe630;","移动"),PushMenuItem("&#xe623;","旋转"),PushLine(),PushItem("&#xe603;","负像"),PushMenuItem("&#xe602;","伪彩"),PushLine(),PushItem("&#xe61b;","调窗"),PushLine(),PushItem("&#xe61f;","直线"),PushItem("&#xe619;","矩形"),PushItem("&#xe61e;","椭圆"),PushItem("&#xe618;","角度"),PushItem("&#xe637;","CT"),PushItem("&#xe629;","文本"),PushItem("&#xe62f;","箭头"),PushItem("L","左标记"),PushItem("R","右标记"),PushItem("&#xe615;","心胸比"),PushItem("&#xe622;","撤销"),PushLine(),PushItem("&#xe653;","删除图像");break;case CBoBo.TOOLMENU_PRINT_JPG:PushItem("&#xe603;","负像"),PushItem("&#xe644;","恢复"),PushItem("&#xe653;","删除图像");break;case CBoBo.TOOLMENU_PRINT_RADIATE:PushItem("&#xe61f;","直线"),PushItem("&#xe619;","矩形"),PushItem("&#xe61e;","椭圆"),PushItem("&#xe618;","角度"),PushItem("&#xe637;","CT"),PushItem("&#xe629;","文本"),PushItem("&#xe62f;","箭头"),PushItem("&#xe622;","撤销"),PushLine(),PushMenuItem("&#xe623;","旋转"),PushLine(),PushItem("&#xe603;","负像"),PushItem("&#xe644;","恢复"),PushItem("&#xe653;","删除图像"),PushLine(),PushItem("&#xe67a;","显/隐四角信息");break;case CBoBo.TOOLMENU_MPR:ClearToolBox(),ClearMainToolBox(),MainMenu(),PushLine(),PushItem("&#xe61b;","切面调窗"),PushItem("&#xe68b;","十字切面"),PushItem("&#xe6ae;","CPR直线"),PushItem("&#xe6f2;","CPR曲线"),PushLine(),PushItem("&#xe6ad;","切图"),PushItem("&#xe611;","倒序"),PushLine(),PushItem("&#xec68;","最大密度投影"),PushItem("&#xec69;","最小密度投影"),PushItem("&#xec6c;","平均密度投影"),PushInput("&#xe6077;","层厚"),MainButtonStatus("MPR");break;case CBoBo.TOOLMENU_AI:ClearToolBox();break;case CBoBo.TOOLMENU_VRT:ClearToolBox(),ClearMainToolBox(),MainMenu(),PushLine(),PushItem("&#xe920;","手术刀内"),PushItem("&#xe9c8;","手术刀外"),PushLine(),PushItem("&#xe628;","重置三维视图"),MainButtonStatus("3D")}self.UpdateStyle(),m_recordPreTool=$.extend({},m_recordCurTool),m_recordCurTool.type=type,m_recordCurTool.msgtansform=msgtransform}},this.Request2DToolBar=function(){self.RequestToolBar(m_2DRecordTool.type,m_2DRecordTool.msgtansform,!0),self.ChangeBtnStatus("本地缓存",CBoBo.store.db.enableImagesDB)},this.RequestGrayToolBar=function(type,msgtransform){if(m_bCreatedGrayTool||(SeriesMenu(),self.UpdateStyle(),m_bCreatedGrayTool=!0),type!=m_recordCurTool.type||msgtransform!=m_recordCurTool.msgtansform){switch(type){case CBoBo.TOOLMENU_JPG:self.EnableButton("MPR",!1),self.EnableButton("释放工具",!0),self.EnableButton("重新加载",!0),self.EnableButton("图像布局",!0),self.EnableButton("序列布局",!0),self.EnableButton("恢复",!0),self.EnableButton("序列播放",!1),self.EnableButton("定位线",!1),self.EnableButton("胶片打印",!0),self.EnableButton("DICOM信息",!1),self.EnableButton("显/隐四角信息",!0),self.EnableButton("放缩",!0),self.EnableButton("移动",!0),self.EnableButton("旋转",!1),self.EnableButton("负像",!0),self.EnableButton("伪彩",!0),self.EnableButton("调窗",!0),self.EnableButton("直线",!1),self.EnableButton("矩形",!1),self.EnableButton("椭圆",!1),self.EnableButton("角度",!1),self.EnableButton("CT",!1),self.EnableButton("文本",!1),self.EnableButton("箭头",!1),self.EnableButton("左标记",!1),self.EnableButton("右标记",!1),self.EnableButton("心胸比",!1),self.EnableButton("撤销",!1),self.EnableButton("删除图像",!0);break;case CBoBo.TOOLMENU_SERIES:self.EnableButton("MPR",!0),self.EnableButton("3D",!0),self.EnableButton("AI",!0),self.EnableButton("释放工具",!0),self.EnableButton("重新加载",!0),self.EnableButton("图像布局",!0),self.EnableButton("序列布局",!0),self.EnableButton("恢复",!0),self.EnableButton("序列播放",!0),self.EnableButton("定位线",!0),self.EnableButton("胶片打印",!0),self.EnableButton("DICOM信息",!0),self.EnableButton("显/隐四角信息",!0),self.EnableButton("放缩",!0),self.EnableButton("移动",!0),self.EnableButton("旋转",!0),self.EnableButton("负像",!0),self.EnableButton("伪彩",!0),self.EnableButton("调窗",!0),self.EnableButton("直线",!0),self.EnableButton("矩形",!0),self.EnableButton("椭圆",!0),self.EnableButton("角度",!0),self.EnableButton("CT",!0),self.EnableButton("文本",!0),self.EnableButton("箭头",!0),self.EnableButton("左标记",!0),self.EnableButton("右标记",!0),self.EnableButton("撤销",!0),self.EnableButton("删除图像",!0);break;case CBoBo.TOOLMENU_DESERIES:self.EnableButton("MPR",!1),self.EnableButton("3D",!1),self.EnableButton("释放工具",!0),self.EnableButton("重新加载",!0),self.EnableButton("图像布局",!0),self.EnableButton("序列布局",!0),self.EnableButton("恢复",!0),self.EnableButton("序列播放",!1),self.EnableButton("定位线",!1),self.EnableButton("胶片打印",!0),self.EnableButton("DICOM信息",!0),self.EnableButton("显/隐四角信息",!0),self.EnableButton("放缩",!0),self.EnableButton("移动",!0),self.EnableButton("旋转",!0),self.EnableButton("负像",!0),self.EnableButton("伪彩",!0),self.EnableButton("调窗",!0),self.EnableButton("直线",!0),self.EnableButton("矩形",!0),self.EnableButton("椭圆",!0),self.EnableButton("角度",!0),self.EnableButton("CT",!0),self.EnableButton("文本",!0),self.EnableButton("箭头",!0),self.EnableButton("左标记",!0),self.EnableButton("右标记",!0),self.EnableButton("撤销",!0),self.EnableButton("删除图像",!0);break;case CBoBo.TOOLMENU_PRINT_JPG:case CBoBo.TOOLMENU_PRINT_RADIATE:self.EnableButton("释放工具",!0),self.EnableButton("重新加载",!0),self.EnableButton("布局",!0),self.EnableButton("恢复",!0),self.EnableButton("序列播放",!0),self.EnableButton("定位线",!0),self.EnableButton("胶片打印",!0),self.EnableButton("DICOM信息",!0),self.EnableButton("显/隐四角信息",!0),self.EnableButton("放缩",!0),self.EnableButton("移动",!0),self.EnableButton("旋转",!0),self.EnableButton("负像",!0),self.EnableButton("伪彩",!0),self.EnableButton("调窗",!0),self.EnableButton("直线",!0),self.EnableButton("矩形",!0),self.EnableButton("椭圆",!0),self.EnableButton("角度",!0),self.EnableButton("CT",!0),self.EnableButton("文本",!0),self.EnableButton("箭头",!0),self.EnableButton("左标记",!0),self.EnableButton("右标记",!0),self.EnableButton("心胸比",!0),self.EnableButton("撤销",!0),self.EnableButton("删除图像",!0);break;case CBoBo.TOOLMENU_MPR:ClearToolBox()}self.isFirst||((m_2DRecordTool=$.extend({},m_recordCurTool)).type=type,m_2DRecordTool.msgtansform=msgtransform,self.isFirst=!0),m_recordPreTool=$.extend({},m_recordCurTool),m_recordCurTool.type=type,m_recordCurTool.msgtansform=msgtransform}},this.ChangeBtnStatus=function(title,bForce){if(function(title){for(var arrToolItem=GetAllButton(),i=0;i<arrToolItem.length;i++){var item=arrToolItem[i];switch(item.title){case"切面调窗":case"十字切面":case"重新加载":case"恢复":case"胶片打印":case"负像":case"撤销":case"删除图像":continue}if(item.title==title)return!0}return!1}(title)){bForce=void 0!==bForce?!bForce:function(title){for(var key in m_arrButtonSeled)if(m_arrButtonSeled[key]==title)return!0;return!1}(title);if(function(title){var arrToolItem=[];PushItem($("."+m_arrId.item)),PushItem($("."+m_arrId.menuitem));for(var i=0;i<arrToolItem.length;i++)if(arrToolItem[i].title===title)return!0;return!1;function PushItem(arrItem){$.each(arrItem,function(i,item){switch(item.title){case"释放工具":case"切图":case"CPR曲线":case"CPR直线":case"调窗":case"锐化":case"平滑":case"放缩":case"移动":case"直线":case"矩形":case"最大密度投影":case"最小密度投影":case"平均密度投影":case"椭圆":case"角度":case"CT":case"文本":case"箭头":case"左标记":case"右标记":case"心胸比":case"亮度/对比":arrToolItem.push(item)}})}}(title))return arrToolItem=[],PushItem($("."+m_arrId.item)),PushItem($("."+m_arrId.menuitem)),$.each(arrToolItem,function(){m_arrButtonSeled[this.title]=null,$(this).css({background:"","box-shadow":""})}),self.ButtonStatus(title,!(bForce="释放工具"===title?!1:bForce)),!bForce;self.ButtonStatus(title,!bForce)}function PushItem(arrItem){$.each(arrItem,function(i,item){switch(item.title){case"释放工具":case"调窗":case"锐化":case"平滑":case"最大密度投影":case"最小密度投影":case"CPR曲线":case"CPR直线":case"切图":case"平均密度投影":case"放缩":case"移动":case"直线":case"矩形":case"椭圆":case"角度":case"CT":case"文本":case"箭头":case"左标记":case"右标记":case"心胸比":case"亮度/对比":arrToolItem.push(item)}})}var arrToolItem},this.ButtonStatus=function(title,bSeled){var item=Find($("."+m_arrId.item),title);function Find(array,title){var ret;return $.each(array,function(i,item){item.title==title&&(ret=item)}),ret}(item=item||Find($("."+m_arrId.menuitem),title))&&(bSeled?(m_arrButtonSeled[title]=title,$(item).css({background:"#777","box-shadow":"0 0 20px #aaa"})):($(item).css({background:"","box-shadow":""}),m_arrButtonSeled[title]=null))},this.EnableButton=function(title,bEnable){if(title){for(var item,jqItem,arrItem=GetAllButton(),i=0;i<arrItem.length;i++)if(arrItem[i].title==title){item=arrItem[i];break}item&&(jqItem=$(item),bEnable?(m_arrButtonNoEnable[item.title]=null,jqItem.css({color:"#efefef","pointer-events":""})):(m_arrButtonNoEnable[item.title]=item.title,jqItem.css({color:"gray","pointer-events":"none"})))}},this.BackToolBar=function(){if(m_recordPreTool){for(var key in this.RequestToolBar(m_recordPreTool.type,m_recordPreTool.msgtansform),m_arrButtonSeled)(title=m_arrButtonSeled[key])&&self.ButtonStatus(title,!0);for(var key in m_arrButtonNoEnable){var title;(title=m_arrButtonNoEnable[key])&&self.EnableButton(title,!1)}}},this.GetButtonDOM=function(title){var ret;$("."+m_arrId.item).each(function(){this.title==title&&(ret=this)});return ret},this.IsEnable=function(title){for(var key in m_arrButtonNoEnable)if(m_arrButtonNoEnable[key]==title)return!1;return!0},m_arrId.bottonbox="bottonbox"+CBoBo.Plugin.GetRandom(),m_arrId.toolbox="toolbox"+CBoBo.Plugin.GetRandom(),options="<div><div id='"+m_arrId.bottonbox+"'></div><div id='"+m_arrId.toolbox+"'></div></div>",$(options).appendTo($(opt.parent)).css({width:"100%",height:"100%",overflow:"hidden",display:"flex"}),options=$("#"+m_arrId.bottonbox),toolbox=$("#"+m_arrId.toolbox),"x"==opt.axis?opt.bottonbox?(options.css({height:"100%",display:"flex","align-items":"center",color:"#efefef"}),toolbox.css({height:"100%",display:"flex",flex:1,"align-items":"center",color:"#efefef","overflow-x":"auto"})):(options.hide(),toolbox.css({width:"100%",height:"100%",overflow:"hidden",float:"left",display:"flex","align-items":"center",color:"#efefef"})):opt.bottonbox?(options.css({width:"100%",height:"7%",overflow:"hidden",display:"flex","align-items":"center",color:"#efefef"}),toolbox.css({width:"100%",height:"93%",overflow:"hidden",display:"flex","align-items":"center",color:"#efefef"})):(options.hide(),toolbox.css({width:"100%",height:"100%",overflow:"hidden",color:"#efefef","text-align":"center"}))},CBoBo.View.LayoutCtrl=function(options){var m_Type,self=this,opt=(this.ctrlId,this.tableId,this.specialId,this.trClass,this.tdClass,this.itemId=[],this.arrTD,this.bShow,$.extend(!0,{msgtransform:null,radio:!1,specialbutton:!1},options));this.Create=function(){this.ctrlId=CBoBo.Plugin.GetRandom(),this.tableId=CBoBo.Plugin.GetRandom(),this.specialId=CBoBo.Plugin.GetRandom(),this.radioId=CBoBo.Plugin.GetRandom(),this.tdClass=CBoBo.Plugin.GetRandom();for(var tdstr="<div class='"+this.tdClass+"'></div>",tbodystr="",i=0;i<6;i++)for(var j=0;j<6;j++)tbodystr+=tdstr;var str="<div id='"+this.ctrlId+"'><div id='"+this.radioId+"'><label><input name='cbobo' type='radio' value='1' checked/>图像 </label> <label><input name='cbobo' type='radio' value='2' />序列 </label></div><div id='"+this.tableId+"'>"+tbodystr+"</div><div id='"+this.specialId+"'></div></div>";$(str).appendTo($("body")),$("#"+this.ctrlId).css({position:"absolute"})},this.Show=function(bShow){var ctrl=$("#"+this.ctrlId);bShow?(this.bShow=!0,ctrl.hide(),ctrl.show(200)):(this.bShow=!1,ctrl.hide(400))},this.UpdateStyle=function(){var width,margin_left,padding,winWidth=$(window).width(),winHeight=$(window).height(),ctrl=$("#"+this.ctrlId),winWidth=Math.max(winWidth,winHeight)/12>>0,winHeight=winWidth=winWidth<117?117:winWidth,radioHeight=(opt.radio?(radioHeight=.15*winWidth,$("#"+this.radioId).height(radioHeight).width(winWidth).show().css({"text-align":"center","font-size":"10px"}),$("#"+this.radioId),winHeight+=radioHeight):$("#"+this.radioId).hide(),ctrl.css({width:winWidth+"px",height:winHeight+"px",background:"#dcdcdc",border:"1px solid #fff","border-radius":"4px",padding:"3px","z-index":9999999}),this.arrTD=$("."+this.tdClass),winWidth/7.78>>0);this.arrTD.css({border:"1px solid #585858",width:radioHeight+"px",height:radioHeight+"px",overflow:"hidden",float:"left",margin:(.1*radioHeight>>0)+"px"}),opt.specialbutton?(winWidth=(ctrl=6*(4+radioHeight)-10)-.09*ctrl>>0,winHeight=(radioHeight=winHeight-ctrl)/7.5>>0,$("#"+this.specialId).css({width:winWidth+"px",height:(radioHeight-=winHeight)+"px","border-top":"1px solid #b3b3b3","text-align":"center","margin-top":winHeight+"px"}),margin_left=radioHeight-(width=winWidth/7>>0)>>1,padding=width/6>>0,$.each(this.itemId,function(i,id){id=$("#"+id);id.css({display:"inline-block",color:"#585858","text-align":"center","line-height":width+"px","font-size":width+"px","margin-top":.7*margin_left+"px",padding:padding+"px"}),0!=i&&id.css({"margin-left":margin_left+"px"})})):$("#"+this.specialId).hide()},this.SetPosition=function(left,top){$("#"+this.ctrlId).css({left:left+"px",top:top+"px"})},this.SpecialMenu=function(){this.PushItem(this.specialId,'"',"2*1"),this.PushItem(this.specialId,",","1*2"),this.PushItem(this.specialId,"H","3*N"),this.PushItem(this.specialId,"G","N*3")},this.PushItem=function(menuId,icon,title,callback){var id=CBoBo.Plugin.GetRandom();this.itemId.push(id),$("<span class='rotate icon_tool' id='"+id+"' title='"+title+"'>"+icon+"</span>").appendTo($("#"+menuId)),null!=callback&&$("#"+id).bind("click",callback)},this.GetRadioValue=function(){return $("#"+this.radioId+" input:checked").val()},this.AddEvent=function(){$("#"+this.tableId).bind("mousemove click",function(event){switch(event.type){case"mousemove":$.each(self.arrTD,function(i,td){event.clientX>td.getBoundingClientRect().left&&event.clientY>td.getBoundingClientRect().top?td.style.background="#c6c6c6":td.style.background="#efefef"});break;case"click":var row=0,col=0;$.each(self.arrTD,function(i,td){td=$(td);i<6&&"rgb(198, 198, 198)"==td.css("background-color")&&col++,0==i&&"rgb(198, 198, 198)"==td.css("background-color")&&row++,5<i&&i%6==0&&"rgb(198, 198, 198)"==td.css("background-color")&&row++}),sessionStorage.setItem("layout",row+","+col),console.log(row+","+col),null==opt.msgtransform||0==row&&0==col||opt.msgtransform({type:"click",target:{title:"布局控件"},row:row,col:col,ctrltype:self.Type()})}}),$("#"+this.ctrlId).bind("mouseleave",function(event){self.Show(),event.btntitle=self.Type(),event.btnforce=!1,opt.msgtransform&&opt.msgtransform(event)})},this.Type=function(type){if(void 0===type)return m_Type;m_Type=type},self.Create(),self.SpecialMenu(),self.UpdateStyle(),self.AddEvent()},CBoBo.View.RotateCtrl=function(data){var m_MsgTransform,self=this;this.ctrlId,this.itemClass,this.bShow,this.Create=function(){this.ctrlId=CBoBo.Plugin.GetRandom(),this.itemClass=CBoBo.Plugin.GetRandom();var str="<div id='"+this.ctrlId+"' class='icon_tool'><span class='"+this.itemClass+" rotate' title='逆时针'>&#xe61d;</span><span class='"+this.itemClass+" rotate' title='顺时针'>&#xe61c;</span><span class='"+this.itemClass+" rotate' title='左右镜像'>&#xe63a;</span><span class='"+this.itemClass+" rotate' title='上下镜像'>&#xe639;</span></div>";$(str).appendTo($("body")),$("#"+this.ctrlId).css({position:"absolute"})},this.UpdateStyle=function(){var winWidth=$(window).width(),winHeight=$(window).height(),ctrl=$("#"+this.ctrlId),winWidth=Math.max(winWidth,winHeight)/15>>0,winHeight=(winWidth=winWidth<70?70:winWidth)/4>>0;ctrl.css({width:winWidth+"px",height:(winHeight=winHeight<17?17:winHeight)+"px",background:"#dcdcdc",border:"1px solid #fff","border-radius":"4px","text-align":"center","z-index":999999999});ctrl=.171875*winWidth>>0;$("."+this.itemClass).css({display:"inline-block",padding:(.1*ctrl>>0)+"px",overflow:"hidden","vertical-align":"top","font-size":ctrl+"px",color:"#585858",border:"1px solid #b3b3b3","margin-top":(.03125*winHeight>>0)+"px"})},this.AddEvent=function(a){$("."+this.itemClass).bind("click",function(event){null!=m_MsgTransform&&m_MsgTransform(event)}),$("#"+this.ctrlId).bind("mouseleave",function(event){self.Show();var ev={usermsg:"ssssdafdsa132",btntitle:"旋转",btnforce:!1};m_MsgTransform&&m_MsgTransform(ev)})},this.SetPosition=function(left,top){$("#"+this.ctrlId).css({left:left+"px",top:top+"px"})},this.Show=function(bShow){var ctrl=$("#"+this.ctrlId);bShow?(this.bShow=!0,ctrl.hide(),ctrl.show(200)):(this.bShow=!1,ctrl.hide(100))},m_MsgTransform=data.msgtransform,self.Create(),self.UpdateStyle(),self.AddEvent()},CBoBo.View.PseudoColorCtrl=function(data){var m_MsgTransform,self=this;this.ctrlId,this.tdClass,this.imgClass,this.bShow,this.Home=function(){var url=window.config&&window.config.pseudoColorPath||"./static/dicomviewer/css/pseudocolor/";this.PushItem(0,url+"0.jpg","灰色"),this.PushItem(1,url+"1.jpg","彩虹"),this.PushItem(2,url+"2.jpg","黑体"),this.PushItem(3,url+"3.jpg","骨骼"),this.PushItem(4,url+"4.jpg","心脏"),this.PushItem(5,url+"5.jpg","流动"),this.PushItem(6,url+"6.jpg","Ge色"),this.PushItem(7,url+"7.jpg","灰色彩虹"),this.PushItem(8,url+"8.jpg","热绿"),this.PushItem(9,url+"9.jpg","铬铁"),this.PushItem(10,url+"10.jpg","热金属"),this.PushItem(11,url+"11.jpg","饱和度1"),this.PushItem(12,url+"12.jpg","饱和度2"),this.PushItem(13,url+"13.jpg","红外"),this.PushItem(14,url+"14.jpg","墨黑"),this.PushItem(15,url+"15.jpg","骨骼-肌肉"),this.PushItem(16,url+"16.jpg","NIH"),this.PushItem(17,url+"17.jpg","彩虹1"),this.PushItem(18,url+"18.jpg","彩虹2"),this.PushItem(19,url+"19.jpg","彩虹3"),this.PushItem(20,url+"20.jpg","比值"),this.PushItem(21,url+"21.jpg","红色血管"),this.PushItem(22,url+"22.jpg","光谱"),this.PushItem(23,url+"23.jpg","斯特恩"),this.PushItem(24,url+"24.jpg","UCLA")},this.PushItem=function(index,imgUrl,title){var elImg=$("."+this.imgClass).eq(index);elImg[0].onerror=function(){this.src=this.src.replace("static/",""),this.onerror=void 0},elImg.attr("src",imgUrl),$("."+this.tdClass).eq(index).attr("title",title)},this.Create=function(){this.ctrlId=CBoBo.Plugin.GetRandom(),this.tdClass=CBoBo.Plugin.GetRandom(),this.imgClass=CBoBo.Plugin.GetRandom();for(var tdstr="<div class='"+this.tdClass+" pc-pseudocolor'><img class='"+this.imgClass+"' /></div>",tbodystr="",i=0;i<5;i++)for(var j=0;j<5;j++)tbodystr+=tdstr;var str="<div id='"+this.ctrlId+"'>"+tbodystr+"</div>";$(str).appendTo($("body")),$("#"+this.ctrlId).css({position:"absolute"})},this.UpdateStyle=function(){var winWidth=$(window).width(),winHeight=$(window).height(),ctrl=$("#"+this.ctrlId),winWidth=Math.max(winWidth,winHeight)/10>>0,winHeight=winWidth=winWidth<151?151:winWidth,ctrl=(ctrl.css({width:winWidth+"px",height:winHeight+"px",background:"#dcdcdc",border:"1px solid #fff","border-radius":"4px","z-index":999999999}),.188*winWidth>>0),winHeight=.8*ctrl>>0;$("."+this.tdClass).width(ctrl).height(ctrl).css({border:"1px solid #b3b3b3",overflow:"hidden",position:"relative",float:"left"}),$("."+this.imgClass).width(winHeight).height(winHeight).css({position:"absolute",margin:"auto",left:0,top:0,bottom:0,right:0,"pointer-events":"none"})},this.AddEvent=function(a){$("."+this.tdClass).bind("click",function(event){null!=m_MsgTransform&&m_MsgTransform(event)}),$("#"+this.ctrlId).bind("mouseleave",function(event){self.Show();var ev={usermsg:"sssssa2ss123sa",btntitle:"伪彩",btnforce:!1};m_MsgTransform&&m_MsgTransform(ev)})},this.SetPosition=function(left,top){$("#"+this.ctrlId).css({left:left+"px",top:top+"px"})},this.Show=function(bShow){var ctrl=$("#"+this.ctrlId);bShow?(this.bShow=!0,ctrl.hide(),ctrl.show(200)):(this.bShow=!1,ctrl.hide(400))},m_MsgTransform=data.msgtransform,self.Create(),self.Home(),self.UpdateStyle(),self.AddEvent()},CBoBo.View.LableCtrl=function(){var self=this;this.ctrlId,this.bShow=!1,this.Create=function(){this.ctrlId=CBoBo.Plugin.GetRandom();var str="<div id='"+this.ctrlId+"'><textarea autofocus></textarea></div>";$(str).appendTo($("body")),$("#"+this.ctrlId).css({position:"absolute","min-width":"180px","min-height":"36px","z-index":99999999}),$("#"+this.ctrlId+" textarea").css({width:"100%",height:"100%","background-color":"rgba(0,0,0,0.2)",color:"#FFF",padding:"0",margin:"0"}),$("#"+this.ctrlId).bind("click",function(e){e.stopPropagation()})},this.SetPosition=function(left,top){left-=2,top-=4,$("#"+this.ctrlId).css({left:left+"px",top:top+"px"})},this.Show=function(bShow){this.bShow=bShow;var ctrl=$("#"+this.ctrlId);bShow?ctrl.show():ctrl.hide()},this.GetValue=function(){return $("#"+this.ctrlId+" textarea").val()},this.SetValue=function(str){$("#"+this.ctrlId+" textarea").val(str)},self.Create()},CBoBo.View.wwCtrl=function(data){var m_MsgTransform,modalityType,self=this;this.ctrlId,this.itemClass,this.bShow,modalityType=data.modalityType,this.Create=function(){var str;this.ctrlId=CBoBo.Plugin.GetRandom(),this.itemClass=CBoBo.Plugin.GetRandom(),str="CT"==modalityType?"<div id='"+this.ctrlId+"' class='icon_tool icon_ww_tool'><a class='"+this.itemClass+" ' title='CustomWWWC'>自定义窗宽窗位</a><a class='"+this.itemClass+" ' title='Abodmen'>CT Abodmen</a><a class='"+this.itemClass+" ' title='Lung'>CT Lung</a><a class='"+this.itemClass+" ' title='Brain'>CT Brain</a><a class='"+this.itemClass+" ' title='Bone'>CT Bone</a><a class='"+this.itemClass+" ' title='Chest'>CT Chest</a><a class='"+this.itemClass+" ' title='Head/Neck'>CT Head/Neck</a></div>":"<div id='"+this.ctrlId+"' class='icon_tool icon_ww_tool '><a class='"+this.itemClass+" ' title='CustomWWWC'>自定义窗宽窗位</a></div>",$(str).appendTo($("body")),$("#"+this.ctrlId).css({position:"absolute"})},this.UpdateStyle=function(){var winWidth=$(window).width(),winHeight=$(window).height(),ctrl=$("#"+this.ctrlId),winWidth=Math.max(winWidth,winHeight)/15>>0,winHeight=(winWidth=winWidth<70?70:winWidth)/4>>0;winHeight<17&&(winHeight=17),ctrl.css({width:winWidth+"px",background:"#121212","border-bottom":"1px solid #222","border-left":"1px solid #222","border-right":"1px solid #222","border-radius":"4px","text-align":"center","z-index":999999999}),$("."+this.itemClass).css({display:"block",padding:(.1*(.171875*winWidth>>0)>>0)+"px",overflow:"hidden","vertical-align":"top","font-size":"16px",color:"#fff","margin-top":(.03125*winHeight>>0)+"px",cursor:"pointer"})},this.AddEvent=function(a){$("."+this.itemClass).bind("click",function(event){null!=m_MsgTransform&&m_MsgTransform(event)}),$("#"+this.ctrlId).bind("mouseleave",function(event){self.Show();var ev={usermsg:"ssssdafdsa132312",btntitle:"自定义调窗 ",btnforce:!1};m_MsgTransform&&m_MsgTransform(ev)})},this.SetPosition=function(left,top){$("#"+this.ctrlId).css({left:left+"px",top:top+"px"})},this.Show=function(bShow){var ctrl=$("#"+this.ctrlId);bShow?(this.bShow=!0,ctrl.hide(),ctrl.show(200)):(this.bShow=!1,ctrl.hide(100))},m_MsgTransform=data.msgtransform,self.Create(),self.UpdateStyle(),self.AddEvent()},CBoBo.View.Thumb=function(data){var self=this;this.studyuid,this.bSerises,this.horv,this.arrId={},this.bItemShow=!1,this.bFirst=!1,this.parentElem,this.seriesLen=0,this.msgTransform,this.bthumbDirect=!0,this.thumbListWidth,self.AnalysisParam(data),self.Init(),self.Create(),self.AddEvent(),self.ShowItem(!0),self.OpenStyle()},CBoBo.View.Thumb.prototype.Init=function(){this.arrId.thumbitem="thumbitem"+CBoBo.Plugin.GetRandom(),this.arrId.head=CBoBo.Plugin.GetRandom(),this.arrId.info=CBoBo.Plugin.GetRandom(),this.arrId.mode=CBoBo.Plugin.GetRandom(),this.arrId.time=CBoBo.Plugin.GetRandom(),this.arrId.arrow=CBoBo.Plugin.GetRandom(),this.arrId.listbox="listbox"+CBoBo.Plugin.GetRandom(),this.arrId.listcontain="listcontain"+CBoBo.Plugin.GetRandom(),this.arrId.itemid=[],this.arrId.seriesitem="seriesitem"+CBoBo.Plugin.GetRandom(),this.arrId.seriesinfo=CBoBo.Plugin.GetRandom(),this.arrId.seriesinfoseries=CBoBo.Plugin.GetRandom(),this.arrId.seriesimgbox=CBoBo.Plugin.GetRandom(),this.arrId.seriesimg="s"+CBoBo.Plugin.GetRandom(),this.arrId.progressbar=CBoBo.Plugin.GetRandom(),this.arrId.progressparent=CBoBo.Plugin.GetRandom(),this.arrId.progress=CBoBo.Plugin.GetRandom(),this.arrId.progresspercent=CBoBo.Plugin.GetRandom()},CBoBo.View.Thumb.prototype.Create=function(){this.CreateBox(),this.CreateHeadBox(),this.CreateListBox()},CBoBo.View.Thumb.prototype.CreateBox=function(){var str="<div id='"+this.arrId.thumbitem+"'></div>";$(str).appendTo($(this.parentElem))},CBoBo.View.Thumb.prototype.CreateHeadBox=function(){var str="<div id='"+this.arrId.head+"'><span class='"+this.arrId.info+"'></span><span class='"+this.arrId.info+"'></span><span class='"+this.arrId.info+" "+this.arrId.time+"'></span><span class='"+this.arrId.arrow+" icon_tool'></span></div>";$(str).appendTo($("#"+this.arrId.thumbitem))},CBoBo.View.Thumb.prototype.CreateListBox=function(){var str="<div id='"+this.arrId.listbox+"'><div id='"+this.arrId.listcontain+"'></div></div>";$(str).appendTo($("#"+this.arrId.thumbitem))},CBoBo.View.Thumb.prototype.SetHeadInfo=function(info,mode,date){var span=$("#"+this.arrId.thumbitem+" ."+this.arrId.info);span.eq(0).html(info).attr("title",info),span.eq(1).html(mode).attr("title",mode),span.eq(2).html(date).attr("title",date)},CBoBo.View.Thumb.prototype.SetItemInfo=function(mark,nums,intro){if(void 0===mark)throw"SetItemInfo:mark is undefined.";mark=(mark="string"!=typeof mark?mark.toString():mark).replace(/\./g,""),mark=$("#"+mark+" ."+this.arrId.seriesinfo);mark.eq(0).html(nums).attr("title",nums),mark.eq(1).html(intro).attr("title",intro)},CBoBo.View.Thumb.prototype.SetItemIcon=function(mark,url,target,series){if(void 0===mark)throw"SetItemIcon:mark is undefined.";mark=(mark="string"!=typeof mark?mark.toString():mark).replace(/\./g,"");$("#"+mark+" img").attr("src",url).attr("title",target).click(event=>{event.series=series,this.msgTransform(event)})},CBoBo.View.Thumb.prototype.SetProgress=function(progressMark,value){var progressWidth,progressMark=(progressMark="string"!=typeof progressMark?progressMark.toString():progressMark).replace(/\./g,"");99<(value=value<0?0:value)?$("#"+progressMark+" ."+this.arrId.progressbar).hide():($("#"+progressMark+" ."+this.arrId.progressbar).show(),progressWidth=$("."+this.arrId.progressparent).width()*value/100>>0,$("#"+progressMark+" ."+this.arrId.progress).width(progressWidth),$("#"+progressMark+" ."+this.arrId.progresspercent).html(value+"%"))},CBoBo.View.Thumb.prototype.SetHeadArrow=function(bTop){var arrow=$("#"+this.arrId.head+" ."+this.arrId.arrow);bTop?(arrow.css({color:"#1d1d1d"}),arrow.html("&#xe646;")):(arrow.css({color:"#c5c5c5"}),arrow.html("&#xe64a;"))},CBoBo.View.Thumb.prototype.PushSerisesItem=function(progressMark){if(void 0===progressMark)throw"PushSerisesItem:progressMark is undefined.";progressMark=(progressMark="string"!=typeof progressMark?progressMark.toString():progressMark).replace(/\./g,""),this.seriesLen++,progressMark="<div class='"+this.arrId.seriesitem+"' id='"+progressMark+"'><span class='"+this.arrId.seriesinfo+"'></span><span class='"+this.arrId.seriesinfo+" "+this.arrId.seriesinfoseries+"'></span><div class='"+this.arrId.seriesimgbox+"' style='position:relative'><img class ='"+this.arrId.seriesimg+"'/> <div class='"+this.arrId.progressbar+"'><div class='"+this.arrId.progressparent+"'><div class='"+this.arrId.progress+"'></div></div><span class='"+this.arrId.progresspercent+"'></span></div></div></div>";$(progressMark).appendTo($("#"+this.arrId.listcontain))},CBoBo.View.Thumb.prototype.UpdateSeriesData=function(){var self=this,elem=" ."+this.arrId.seriesimg,imgId=(CBoBo.Plugin.GetBrowserInfo().isMobile?touch.on(elem,"doubletap",function(event){null!=self.msgTransform&&self.msgTransform(event)}):$(elem).bind("dblclick",function(event){null!=self.msgTransform&&self.msgTransform(event)}),"special2016920dragimg");interact("."+this.arrId.seriesimg).draggable({onstart:function(event){$("#"+imgId).remove();var dragImg=$(event.target).clone(),imgWidth=($("body").append(dragImg),dragImg.width()),imgHeight=dragImg.height();dragImg.attr("id",imgId).css({"z-index":"99999999999",position:"absolute",left:event.pageX-imgWidth/2+"px",top:event.pageY-imgHeight/2+"px"})},onmove:function(event){var target=$("#"+imgId)[0],x=(parseFloat(target.getAttribute("data-x"))||0)+event.dx,event=(parseFloat(target.getAttribute("data-y"))||0)+event.dy;target.style.webkitTransform=target.style.transform="translate("+x+"px, "+event+"px)",target.setAttribute("data-x",x),target.setAttribute("data-y",event)},onend:function(event){$("#"+imgId).remove()}})},CBoBo.View.Thumb.prototype.UpdateStyleL=function(){var parent=$(this.parentElem),parentWidth=parent.width(),parent=(parent.height(),$("#"+this.arrId.thumbitem)),ctrlMargin=this.bFirst?0:.0476*parentWidth>>0,parent=(parent.width(parentWidth).css({overflow:"hidden","padding-top":ctrlMargin+"px","border-bottom":"1px solid #6a6a6a",background:"#282828"}),$("#"+this.arrId.head)),ctrlMargin=(parent.width(parentWidth),.57*parentWidth>>0),parent=(parent.height(ctrlMargin).css({cursor:"pointer"}),$("."+this.arrId.info)),ctrlMargin=ctrlMargin/3>>0,font=(parent.height(ctrlMargin),parent.width(parentWidth),.11*parentWidth>>0);parent.css({"line-heihgt":ctrlMargin+"px",display:"block","text-overflow":"ellipsis","white-space":"nowrap","text-align":"center","font-size":font+"px"}),$("."+this.arrId.time).width(.8*parentWidth>>0).css({display:"inline-block"}),$("."+this.arrId.arrow).width(.2*parentWidth>>0).height(ctrlMargin).css({display:"inline-block","font-size":font+"px","line-height":ctrlMargin+"px","text-align":"center","pointer-events":"none"});var parent=1.1*parentWidth>>0,ctrlMargin=.08*parentWidth>>0,marginLeft=.06*parentWidth>>0,marginLeft=($("."+this.arrId.seriesitem).height(parent).width(parentWidth-marginLeft).css({"border-bottom":"1px solid #373737","padding-top":ctrlMargin+"px","padding-left":marginLeft+"px","padding-bottom":"2px"}),4<this.seriesLen?4:this.seriesLen),marginLeft=(marginLeft=marginLeft<1?1:marginLeft)*(parent+ctrlMargin+3),parent=($("#"+this.arrId.listbox).width(parentWidth-=4).css({border:"2px solid #cccccc",background:"#535353",height:marginLeft+"px",overflow:"hide",position:"relative"}),$("#"+this.arrId.listcontain).css({position:"absolute",width:"100%",height:"100%"}),$("#"+this.arrId.listcontain).mCustomScrollbar({axis:"y",scrollbarPosition:"inside",scrollInertia:400,mouseWheelPixels:800,theme:"thumbScroll",documentTouchScroll:!0,moveDragger:!1,advanced:{updateOnContentResize:!0}}),$("."+this.arrId.seriesinfo));parent.css({display:"block",color:"#c5c5c5","text-overflow":"ellipsis","white-space":"nowrap","text-align":"left","font-size":font+"px",cursor:"default"});ctrlMargin=.723*parentWidth>>0;$("."+this.arrId.seriesimg).width(ctrlMargin).height(ctrlMargin).css({cursor:"pointer"});marginLeft=.8*parentWidth>>0,parent=.04*parentWidth>>0,$("."+this.arrId.seriesimgbox).width(marginLeft).height(ctrlMargin).css({"text-align":"center",background:"#3a3a3a",margin:parent+"px 0px"}),parentWidth=$("."+this.arrId.progressbar),parent=.1866*ctrlMargin>>0,parentWidth.width(marginLeft).height(parent).css({position:"absolute",left:0,bottom:"2px",color:"#33ffff","text-align":"left"}),ctrlMargin=simple.queryToObject().showProgress||$("#showProgress").val();"1"!==ctrlMargin&&parentWidth.css({opacity:0});ctrlMargin=.66*parent>>0,parentWidth=.6*marginLeft>>0;$("."+this.arrId.progressparent).height(ctrlMargin).width(parentWidth).css({"border-bottom":"1px solid #757575","border-right":"1px solid #757575","border-radius":"4px",background:"#363535",display:"inline-block","margin-bottom":"3px"});parent=.66*ctrlMargin>>0,marginLeft=ctrlMargin-parent>>1;$("."+this.arrId.progress).height(parent).css({margin:marginLeft+"px 1px",background:"#33ffff"}),$("."+this.arrId.progresspercent).css({"font-size":font+"px","vertical-align":"top"})},CBoBo.View.Thumb.prototype.UpdateStyleB=function(){var parent=$(this.parentElem),parent=(parent.width(),parent.height()),ctrl=(parent-=2,$("#"+this.arrId.thumbitem)),ctrlMargin=this.bFirst?0:.0476*parent>>0;ctrl.height(parent).css({overflow:"hidden","padding-left":ctrlMargin+"px","border-right":"1px solid #6a6a6a",background:"#282828",display:"inline-block"});var ctrl=1.2*parent>>0,ctrlMargin=($("#"+this.arrId.head).width(ctrl-4).height(parent-4).css({cursor:"pointer",display:"inline-block",border:"2px solid rgba(0,0,0,0)","white-space":"pre"}),$("."+this.arrId.info)),head_spanHeight=parent/3>>0,ctrl=(ctrlMargin.width(ctrl),ctrlMargin.height(head_spanHeight),.11*parent>>0);ctrlMargin.css({"line-height":head_spanHeight+"px",display:"block","text-overflow":"ellipsis","text-align":"center","font-size":(ctrl=ctrl<10?10:ctrl)+"px"});var ctrlMargin=1.1*parent>>0,head_spanHeight=.08*parent>>0,seriesNums=($("."+this.arrId.seriesitem).height(.9*parent).width(ctrlMargin).css({"border-right":"1px solid #373737","padding-left":head_spanHeight+"px","padding-right":head_spanHeight+"px",display:"inline-block","text-align":"center","vertical-align":"top"}),4<this.seriesLen?4:this.seriesLen),seriesNums=(seriesNums=seriesNums<1?1:seriesNums)*(ctrlMargin+2*head_spanHeight+1),head_spanHeight=$("#"+this.arrId.listbox),head_spanHeight=(parent-=4,this.thumbListWidth=seriesNums,head_spanHeight.width(seriesNums).height(parent).css({border:"2px solid #cccccc",background:"#535353",overflow:"hidden",position:"relative",display:"inline-block"}),$("#"+this.arrId.listcontain).css({position:"absolute",height:"100%",width:seriesNums+"px"}),$("#"+this.arrId.listcontain).mCustomScrollbar({axis:"x",scrollInertia:800,theme:"thumbScroll",documentTouchScroll:!0,advanced:{updateOnContentResize:!0}}),$("."+this.arrId.seriesinfo)),seriesNums=Math.round(.3076923076923076*parent);head_spanHeight.height(seriesNums).css({color:"#c5c5c5","text-overflow":"ellipsis","white-space":"nowrap","text-align":"center","font-size":ctrl+"px",cursor:"default",display:"block"}),$("."+this.arrId.seriesinfoseries).css({display:"none"});head_spanHeight=.6296296296296297*parent|0,seriesNums=.8*ctrlMargin|0;$("."+this.arrId.seriesimgbox).height(head_spanHeight).width(seriesNums).css({"text-align":"center",background:"#3a3a3a",margin:"0 auto"});$("."+this.arrId.seriesimg).width(seriesNums-8).height(head_spanHeight).css({cursor:"pointer"});ctrlMargin=$("."+this.arrId.progressbar),seriesNums=.3333333333333333*parent>>0,ctrlMargin.height(seriesNums=seriesNums<18?18:seriesNums).css({width:"100%",position:"absolute",left:"0px",bottom:"1px",color:"#33ffff","text-align":"left"}),head_spanHeight=simple.queryToObject().showProgress;"1"!==head_spanHeight&&ctrlMargin.css({opacity:0});parent=.3*seriesNums>>0,head_spanHeight=1.333333333333333*seriesNums>>0;$("."+this.arrId.progressparent).height(parent).width(head_spanHeight).css({"border-bottom":"1px solid #757575","border-right":"1px solid #757575","border-radius":"4px",background:"#363535",display:"inline-block"}),$("."+this.arrId.progress).height(parent).css({margin:"1px",background:"#33ffff"}),$("."+this.arrId.progresspercent).css({"font-size":ctrl+"px",width:"20px"})},CBoBo.View.Thumb.prototype.ClearStyle=function(){$("#"+this.arrId.thumbitem).removeAttr("style"),$("#"+this.arrId.head).removeAttr("style"),$("."+this.arrId.info).removeAttr("style"),$("."+this.arrId.time).removeAttr("style"),$("."+this.arrId.arrow).removeAttr("style"),$("."+this.arrId.seriesitem).removeAttr("style"),$("#"+this.arrId.listbox).removeAttr("style"),$("#"+this.arrId.listcontain).removeAttr("style"),$("#"+this.arrId.listcontain).mCustomScrollbar("destroy"),$("."+this.arrId.seriesinfo).removeAttr("style"),$("."+this.arrId.seriesimg).removeAttr("style")},CBoBo.View.Thumb.prototype.UpdateStyle=function(){var winWidth=$(window).width(),winHeight=$(window).height();this.ClearStyle(),winHeight<winWidth?(this.UpdateStyleL(),this.bthumbDirect=!0):(this.UpdateStyleB(),this.bthumbDirect=!1),this.OpenStyle(),this.ShowItem(!0)},CBoBo.View.Thumb.prototype.ShowItem=function(bCloseAnimation){var list=$("#"+this.arrId.listbox);this.bItemShow?bCloseAnimation?list.show():this.bthumbDirect?list.slideDown(500):(list.show().css({transition:"width 500ms"}),list.width(this.thumbListWidth)):bCloseAnimation?list.hide():this.bthumbDirect?list.slideUp(500):(list.css({transition:"width 500ms"}),setTimeout(function(){list.hide()},400),list.width(0))},CBoBo.View.Thumb.prototype.OpenStyle=function(){var head=$("#"+this.arrId.head),head_span=$("."+this.arrId.info);this.bItemShow?(this.SetHeadArrow(!0),head_span.css({color:"#1d1d1d",transition:"all 0.5s ease-in"}),head.css({background:"#cccccc"})):(this.SetHeadArrow(!1),head_span.css({color:"#c5c5c5"}),head.css({background:"#373737"}))},CBoBo.View.Thumb.prototype.First=function(){this.bFirst=!0,$("#"+this.arrId.thumbitem).css({"padding-top":"0px"}),this.bItemShow=!0,this.ShowItem(!0),this.OpenStyle()},CBoBo.View.Thumb.prototype.AnalysisParam=function(data){this.parentElem=data.parentelem,this.msgTransform=data.msgtransform},CBoBo.View.Thumb.prototype.AddEvent=function(){var self=this;function head(event){null!=self.msgTransform&&(event.tag="head",event.studyuid=self.studyuid,self.msgTransform(event))}function span(event){null!=self.msgTransform&&(event.tag="head",event.studyuid=self.studyuid,event.parentid=self.arrId.head,self.msgTransform(event)),event.stopPropagation()}CBoBo.Plugin.GetBrowserInfo().isMobile?($("#"+self.arrId.head).bind("touchstart",head),$("."+this.arrId.info).bind("touchstart",span)):($("#"+self.arrId.head).bind("mousedown",head),$("."+this.arrId.info).bind("mousedown",span))},CBoBo.View.Thumb.prototype.Show=function(bShow){bShow?$("#"+this.arrId.thumbitem).show():$("#"+this.arrId.thumbitem).hide()},CBoBo.View.Thumb.prototype.Destroy=function(){$("#"+this.arrId.thumbitem).remove()},CBoBo.View.ThumbManager=function(options){var opt=$.extend(!0,{parent:null,msgtransform:null},options),m_arrThumb={};this.ThumbMsg=function(event){switch(event.type){case"touchstart":headclick();break;case"mousedown":"head"==event.tag&&1===event.which&&headclick()}function headclick(){var id=event.parentid||event.target.id;$.each(m_arrThumb,function(i,thumb){null!=thumb&&(thumb.arrId.head==id?thumb.bItemShow=!thumb.bItemShow:thumb.bItemShow=!1,thumb.ShowItem(),thumb.OpenStyle())})}null!==opt.msgtransform&&opt.msgtransform(event)},this.OpenLastThumb=function(){var len=Object.keys(m_arrThumb).length-1,index=0;$.each(m_arrThumb,function(i,thumb){null!=thumb&&(thumb.bItemShow=index==len,thumb.ShowItem(),thumb.OpenStyle(),index++)})},this.AddThumb=function(studyuid){var thumb=new CBoBo.View.Thumb({parentelem:opt.parent,msgtransform:this.ThumbMsg});return thumb.studyuid=studyuid,m_arrThumb[studyuid]=thumb},this.GetThumb=function(studyuid){return m_arrThumb[studyuid]},this.ForEach=function(callback){if(callback instanceof Function)for(var key in m_arrThumb)callback(m_arrThumb[key],key)},this.DeleteThumb=function(studyuid){var thumb=m_arrThumb[studyuid];void 0!==thumb&&(thumb.Destroy(),m_arrThumb[studyuid]=null)}},CBoBo.View.DVCanvas=function(options){var self=this;this.canvas,this.opt=$.extend({msgtransform:null,parent:null,bdrag:!1},options),this.boxId,this.canvasId,this.bFocus=!1,this.bAnimatStop=!0,this.arrCornerInfo={},this.cornerclass,self.Create(),self.GetCanvas()},CBoBo.View.DVCanvas.prototype.Destroy=function(){this.imgProcessWorker&&this.imgProcessWorker.terminate(),$("#"+this.boxId).remove()},CBoBo.View.DVCanvas.prototype.Clear=function(){var canvas=this.GetCanvas();null!=canvas&&canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height)},CBoBo.View.DVCanvas.prototype.Msg=function(event){(event.self=this).opt.msgtransform&&this.opt.msgtransform(event)},CBoBo.View.DVCanvas.prototype.GetId=function(type){switch(type){case"box":return this.boxId;case"canvas":return this.canvasId}},CBoBo.View.DVCanvas.prototype.Float=function(str){str&&$("#"+this.boxId).css("float",str)},CBoBo.View.DVCanvas.prototype.GetCanvas=function(){return void 0===this.canvas&&(this.canvas=document.getElementById(this.canvasId)),this.canvas},CBoBo.View.DVCanvas.prototype.Create=function(){var innerStr;null!=this.opt.parent&&(this.canvasId="c"+CBoBo.Plugin.GetRandom(),this.boxId="p"+CBoBo.Plugin.GetRandom(),this.cornerclass=CBoBo.Plugin.GetRandom(),innerStr="<div id='"+this.boxId+"'><canvas id='"+this.canvasId+"'></canvas>",innerStr+="</div>",$(innerStr).appendTo($(this.opt.parent)),$("#"+this.boxId).css({float:"left",margin:"1px",border:"2px solid #595959"}),$("#"+this.canvasId).css({cursor:"default"}),this.AddEvent())},CBoBo.View.DVCanvas.prototype.SetRange=function(width,height){var cvsID="#"+this.boxId;0==width||0==height?$(cvsID).hide():($(cvsID).show(),width>>=0,height>>=0,$("#"+this.boxId).width(width).height(height).css({position:"relative"}),(cvsID=this.GetCanvas()).width=width,cvsID.height=height)},CBoBo.View.DVCanvas.prototype.AddEvent=function(canvasid){var self=this,browser=CBoBo.Plugin.GetBrowserInfo(),canvas="#"+this.canvasId;browser.isMobile?($(canvas).bind("touchstart touchmove touchend",function(event){event.preventDefault(),self.Msg(event)}),touch.on(canvas,"pinchstart pinch pinchend doubletap",function(event){"doubletap"==event.type&&(event.preventDefault(),event.stopPropagation()),self.Msg(event)})):($(canvas).bind("dblclick click mousedown mousemove mouseup mouseout mousewheel",function(event){self.Msg(event)}),$(canvas).bind("touchstart touchmove touchend",function(event){self.Msg(event)}),touch.on(canvas,"pinchstart pinch pinchend",function(event){self.Msg(event)})),interact("#"+this.boxId).dropzone({ondragenter:function(event){event=event.target;$("#"+event.id+" canvas").css({"background-color":"rgba(255,255,255,0.1)"})},ondragleave:function(event){event=event.target;$("#"+event.id+" canvas").css({"background-color":""})},ondrop:function(event){var draggableElement=event.relatedTarget,event=event.target;$("#"+event.id+" canvas").css({"background-color":""}),self.opt.msgtransform&&self.opt.msgtransform({type:"drag",imgId:draggableElement.title,canvas:self})}})},CBoBo.View.DVCanvas.prototype.StartLoadingAnimation=function(){var canvas,self;this.bAnimatStop&&(canvas=this.GetCanvas(),this.bAnimatStop=!1,self=this,function Animate(t,n,r,canvas){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(a)return a(o,!0);u=new Error("Cannot find module '"+o+"'");throw u.code="MODULE_NOT_FOUND",u}a=n[o]={exports:{}};t[o][0].call(a.exports,function(e){var n=t[o][1][e];return s(n||e)},a,a.exports,Animate,t,n,r)}return n[o].exports}s(r);return s}({1:[function(require,module,exports){"use strict";var _createClass=function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor};function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}Object.defineProperty(exports,"__esModule",{value:!0});var require=require("./objects/ParticleContainer"),_ParticleContainer2=(require=require)&&require.__esModule?require:{default:require};require=function(){function Scene($canvas,width,height){if(!(this instanceof Scene))throw new TypeError("Cannot call a class as a function");this.$canvas=$canvas,this.context=this.$canvas.getContext("2d"),this.width=0,this.height=0,this.params={},this.tick=0,this.lastTime=0,this.particleContainer=new _ParticleContainer2.default(10,width,height),this.resize(width,height)}return _createClass(Scene,[{key:"resize",value:function(width,height){this.width=width,this.height=height,this.particleContainer.resize(width,height),this.$canvas.width=width*window.devicePixelRatio,this.$canvas.height=height*window.devicePixelRatio}},{key:"render",value:function(){var now=Date.now(),elapsed=(now-this.lastTime)/1e3;this.tick+=elapsed,this.context.clearRect(0,0,this.width,this.height),this.particleContainer.update(this.context,this.tick),this.lastTime=now}}]),Scene}();exports.default=require},{"./objects/ParticleContainer":6}],2:[function(require,module,exports){"use strict";var _Scene2=_interopRequireDefault(require("./Scene")),_raf2=_interopRequireDefault(require("raf"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var scene=new _Scene2.default(canvas,canvas.width,canvas.height);window.addEventListener("resize",function(){self.bAnimatStop||scene.resize(canvas.width,canvas.height)}),function animate(){if(self.bAnimatStop)return;(0,_raf2.default)(animate);scene.render()}()},{"./Scene":1,raf:9}],3:[function(require,module,exports){"use strict";var _createClass=function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor};function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}Object.defineProperty(exports,"__esModule",{value:!0});var require=require("./Vector2"),_Vector2=(require=require)&&require.__esModule?require:{default:require};require=function(){function Particle(){var x=arguments.length<=0||void 0===arguments[0]?0:arguments[0],y=arguments.length<=1||void 0===arguments[1]?0:arguments[1],radius=arguments.length<=2||void 0===arguments[2]?5:arguments[2],color=arguments.length<=3||void 0===arguments[3]?"#000":arguments[3],gravity=arguments.length<=4||void 0===arguments[4]?0:arguments[4],instance=this,Constructor=Particle;if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function");instance=arguments.length<=5||void 0===arguments[5]?1:arguments[5];this.position=new _Vector2.default(x,y),this.velocity=new _Vector2.default,this.acceleration=new _Vector2.default,this.friction=instance,this.gravity=gravity,this.scale=window.devicePixelRatio,this.radius=radius,this.color=color}return _createClass(Particle,[{key:"accelerate",value:function(ax,ay){this.acceleration.x=ax,this.acceleration.y=ay}},{key:"update",value:function(){this.velocity.add(this.acceleration),this.velocity.multiply(this.friction),this.velocity.y+=this.gravity,this.position.add(this.velocity)}},{key:"draw",value:function(context){context.scale(window.devicePixelRatio,window.devicePixelRatio),context.fillStyle=this.color,context.beginPath(),context.arc(this.position.x,this.position.y,this.radius*this.scale,0,2*Math.PI,!1),context.fill()}}]),Particle}();exports.default=require},{"./Vector2":4}],4:[function(require,module,exports){"use strict";var _createClass=function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor};function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}Object.defineProperty(exports,"__esModule",{value:!0});var Vector2=function(){function Vector2(){var x=arguments.length<=0||void 0===arguments[0]?0:arguments[0],instance=this,Constructor=Vector2;if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function");instance=arguments.length<=1||void 0===arguments[1]?0:arguments[1];this.x=x,this.y=instance}return _createClass(Vector2,[{key:"invert",value:function(){this.x=-this.x,this.y=-this.y}},{key:"add",value:function(vector){this.x+=vector.x,this.y+=vector.y}},{key:"subtract",value:function(vector){this.x-=vector.x,this.y-=vector.y}},{key:"multiply",value:function(value){this.x*=value,this.y*=value}},{key:"divide",value:function(value){this.x/=value,this.y/=value}},{key:"equals",value:function(vector){return this.x===vector.x&&this.y===vector.y}},{key:"dot",value:function(vector){return this.x*vector.x+this.y*vector.y}},{key:"length",value:function(){return Math.sqrt(this._x*this._x+this._y*this._y)}},{key:"distance",value:function(vector){return Math.sqrt(this.distSq(vector))}},{key:"normalize",value:function(){return this.divide(this.length())}},{key:"angle",value:function(){return Math.atan2(this.y,this.x)}},{key:"clone",value:function(){return new Vector(this.x,this.y)}}]),Vector2}();exports.default=Vector2},{}],5:[function(require,module,exports){"use strict";function normalize(value,min,max){return(value-min)/(max-min)}function lerp(norm,min,max){return(max-min)*norm+min}Object.defineProperty(exports,"__esModule",{value:!0}),exports.normalize=normalize,exports.lerp=lerp,exports.map=function(value,sourceMin,sourceMax,destMin,destMax){return lerp(normalize(value,sourceMin,sourceMax),destMin,destMax)},exports.clamp=function(value,min,max){return Math.min(Math.max(value,Math.min(min,max)),Math.max(min,max))},exports.distance=function(x0,y0,x1,y1){x1-=x0,x0=y1-y0;return Math.sqrt(x1*x1+x0*x0)},exports.inRange=function(value,min,max){return value>=Math.min(min,max)&&value<=Math.max(min,max)},exports.degreesToRads=function(degrees){return degrees/180*Math.PI},exports.radsToDegrees=function(radians){return 180*radians/Math.PI},exports.randomRange=function(min,max){return min+Math.random()*(max-min)}},{}],6:[function(require,module,exports){"use strict";var _createClass=function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor};function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}Object.defineProperty(exports,"__esModule",{value:!0});var _Particle=require("../lib/Particle"),_Particle2=(_Particle=_Particle)&&_Particle.__esModule?_Particle:{default:_Particle},_math=require("../lib/math");_Particle=function(){function ParticleContainer(nbParticle,width,height){if(!(this instanceof ParticleContainer))throw new TypeError("Cannot call a class as a function");this.width=width,this.height=height,this.nbParticle=nbParticle,this.pool=[],this.angles=[],this.radius=Math.min(width,height)>>4,this.slice=0,this.sliceTo=2*Math.PI/this.nbParticle,this.speed=0,this.dir=1,this.populate()}return _createClass(ParticleContainer,[{key:"populate",value:function(){for(var p=void 0,i=0;i<this.nbParticle;i++){var angle=this.slice*i,x=.5*this.width+Math.cos(angle)*this.radius,y=.5*this.height+Math.sin(angle)*this.radius,tmpRadius=this.radius>>4;tmpRadius<1&&(tmpRadius=1),(p=new _Particle2.default(x,y,tmpRadius)).color="#848282",this.pool.push(p),this.angles.push(angle)}}},{key:"resize",value:function(width,height){this.width=width,this.height=height}},{key:"update",value:function(context,tick){var _this=this;this.slice>=this.sliceTo-.001&&1===this.dir&&.5<tick&&(this.dir=-1),this.slice<=.01&&-.01<=this.slice&&-1===this.dir&&(this.dir=1),this.slice=(0,_math.lerp)(this.dir*Math.abs(Math.sin(.8*tick)),0,this.sliceTo),this.pool.forEach(function(particle,i){_this.angles[i]=_this.slice*i,particle.position.x=.5*_this.width+Math.cos(_this.angles[i])*_this.radius,particle.position.y=.5*_this.height+Math.sin(_this.angles[i])*_this.radius,particle.update(),particle.draw(context)})}}]),ParticleContainer}();exports.default=_Particle},{"../lib/Particle":3,"../lib/math":5}],7:[function(require,module,exports){!function(process){!function(){var getNanoSeconds,hrtime,loadTime;"undefined"!=typeof performance&&null!==performance&&performance.now?module.exports=function(){return performance.now()}:loadTime=null!=process&&process.hrtime?(module.exports=function(){return(getNanoSeconds()-loadTime)/1e6},hrtime=process.hrtime,(getNanoSeconds=function(){var hr=hrtime();return 1e9*hr[0]+hr[1]})()):Date.now?(module.exports=function(){return Date.now()-loadTime},Date.now()):(module.exports=function(){return(new Date).getTime()-loadTime},(new Date).getTime())}.call(this)}.call(this,require("_process"))},{_process:8}],8:[function(require,module,exports){var currentQueue,module=module.exports={},queue=[],draining=!1,queueIndex=-1;function cleanUpNextTick(){draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue()}function drainQueue(){if(!draining){for(var timeout=setTimeout(cleanUpNextTick),len=(draining=!0,queue.length);len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,clearTimeout(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}module.nextTick=function(fun){var args=new Array(arguments.length-1);if(1<arguments.length)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||setTimeout(drainQueue,0)},Item.prototype.run=function(){this.fun.apply(null,this.array)},module.title="browser",module.browser=!0,module.env={},module.argv=[],module.version="",module.versions={},module.on=noop,module.addListener=noop,module.once=noop,module.off=noop,module.removeListener=noop,module.removeAllListeners=noop,module.emit=noop,module.binding=function(name){throw new Error("process.binding is not supported")},module.cwd=function(){return"/"},module.chdir=function(dir){throw new Error("process.chdir is not supported")},module.umask=function(){return 0}},{}],9:[function(require,module,exports){for(var last,id,queue,now=require("performance-now"),global="undefined"==typeof window?{}:window,vendors=["moz","webkit"],suffix="AnimationFrame",raf=global["request"+suffix],caf=global["cancel"+suffix]||global["cancelRequest"+suffix],i=0;i<vendors.length&&!raf;i++)raf=global[vendors[i]+"Request"+suffix],caf=global[vendors[i]+"Cancel"+suffix]||global[vendors[i]+"CancelRequest"+suffix];raf&&caf||(id=last=0,queue=[],raf=function(callback){var _now,next;return 0===queue.length&&(_now=now(),next=Math.max(0,1e3/60-(_now-last)),last=next+_now,setTimeout(function(){for(var cp=queue.slice(0),i=queue.length=0;i<cp.length;i++)if(!cp[i].cancelled)try{cp[i].callback(last)}catch(e){setTimeout(function(){throw e},0)}},Math.round(next))),queue.push({handle:++id,callback:callback,cancelled:!1}),id},caf=function(handle){for(var i=0;i<queue.length;i++)queue[i].handle===handle&&(queue[i].cancelled=!0)}),module.exports=function(fn){return raf.call(global,fn)},module.exports.cancel=function(){caf.apply(global,arguments)}},{"performance-now":7}],10:!1},{},2))},CBoBo.View.DVCanvas.prototype.StopLoadingAnimation=function(){this.bAnimatStop=!0},CBoBo.View.DVCanvas.prototype.PushCornerInfo=function(position,text){this.arrCornerInfo[position]instanceof Array||(this.arrCornerInfo[position]=[]),this.arrCornerInfo[position].push(text)},CBoBo.View.DVCanvas.prototype.ClearCornerInfo=function(){this.arrCornerInfo={},$("."+this.cornerclass).remove()},CBoBo.View.DVCanvas.prototype.ShowCornerInfo=function(){var lts=this.arrCornerInfo.lt,rts=this.arrCornerInfo.rt,rbs=this.arrCornerInfo.rb,lbs=this.arrCornerInfo.lb;this.DrawBox(lts,"lt",3,3),this.DrawBox(rts,"rt",3,3),this.DrawBox(rbs,"rb",3,3),this.DrawBox(lbs,"lb",3,3)},CBoBo.View.DVCanvas.prototype.DrawBox=function(text,position,x,y){if(void 0!==text){var texts=[];text instanceof Array?texts=text:texts.push(text);var posstrh,posstrv,textalign="left";switch(position){case"lt":posstrh="left",posstrv="top";break;case"rt":posstrv="top",textalign=posstrh="right";break;case"rb":posstrv="bottom",textalign=posstrh="right";break;case"lb":posstrh="left",posstrv="bottom"}for(var box="<div class='"+this.cornerclass+"' style='position:absolute;"+posstrh+":"+x+"px;"+posstrv+":"+y+"px;color:#FFF;text-align:"+textalign+";font-size:10px;text-shadow:1px 1px 1px #000;cursor:default;pointer-events:none;'>",i=0;i<texts.length;i++){var txt=texts[i];box+=str="<p>"+txt+"</p>"}box+="</div>",$(box).appendTo("#"+this.boxId)}},CBoBo.View.DVCanvas.prototype.DrawCornerInfo=function(status){var image,study;this.ClearCornerInfo(),this.canvas.width<150||this.canvas.height<150||status instanceof Object&&(image=status.image,study=window.globalStudyInfo,image.patientid&&this.PushCornerInfo("lt","ID:"+image.patientid),image.name&&this.PushCornerInfo("lt","姓名:"+image.name),image.mod&&this.PushCornerInfo("lt","设备:"+image.mod),image.sex&&this.PushCornerInfo("lt","性别:"+image.sex),image.age&&this.PushCornerInfo("lt","年龄:"+image.age),image.kv&&this.PushCornerInfo("lb","电压:"+image.kv),image.ma&&this.PushCornerInfo("lb","电流:"+image.ma),image.sliceth&&this.PushCornerInfo("lb","层厚:"+image.sliceth),image.studt&&this.PushCornerInfo("rt","日期:"+image.studt),image.acqtm&&this.PushCornerInfo("rt","时间:"+image.acqtm),this.PushCornerInfo("rt","影像号:"+image.stuid+"-"+image.serid+"-"+image.imgnum),this.PushCornerInfo("rb","倍数:"+status.scale),this.PushCornerInfo("rb","窗位:"+status.wc),this.PushCornerInfo("rb","窗宽:"+status.ww),image.inst&&this.PushCornerInfo("rb",study.hospname||image.inst),this.ShowCornerInfo())},CBoBo.View.CMngFirstLayer=function(options){var defaults={parent:null,scrollsize:CBoBo.Scrollsize,msgtransform:null,single:!0},self=(this.opt=$.extend(!0,defaults,options),this.arrTag={},this.arrCanvas=[],this.checkbox,this.nLayoutRow=0,this.nLayoutCol=0,this.bMax=!1,this.bFocus=!1,this.scroll,this.imageNums,this.seriesIndex,this.annStatusMng=null,this.bBorderSpColor=!1,this.focusIndex=1,this);self.CreateBox(),self.opt.single?self.UpdateStyle():(defaults="#"+self.arrTag.box,self.checkbox=new CBoBo.View.CheckBox({parent:defaults,title:"序列对比",msgtransform:function(bNF){null!==self.annStatusMng&&(self.annStatusMng.compare=bNF)}}),self.checkbox.Show(!1))},CBoBo.View.CMngFirstLayer.prototype.Clear=function(){this.UpdateLayout(0,1,1),null!=this.annStatusMng&&($.each(this.arrCanvas,function(i,canvas){canvas.Clear()}),this.annStatusMng=null)},CBoBo.View.CMngFirstLayer.prototype.AnnStatusMng=function(annStatusMng){if(void 0===annStatusMng)return this.annStatusMng;annStatusMng=!!(this.annStatusMng=annStatusMng)&&annStatusMng.compare;this.checkbox&&this.checkbox.On_Off(annStatusMng)},CBoBo.View.CMngFirstLayer.prototype.CreateBox=function(){var str;if(null!=this.opt.parent)return this.arrTag.box="box"+CBoBo.Plugin.GetRandom(),this.arrTag.canvasbox="box"+CBoBo.Plugin.GetRandom(),this.arrTag.container="box"+CBoBo.Plugin.GetRandom(),this.arrTag.scroll="box"+CBoBo.Plugin.GetRandom(),str="<div id='"+this.arrTag.box+"'><div id='"+this.arrTag.canvasbox+"'><div id='"+this.arrTag.container+"'></div></div><div id='"+this.arrTag.scroll+"'></div></div>",null!=(str=$(str).appendTo(this.opt.parent))&&(this.opt.single?str.css({position:"relative",background:"#000"}):str.css({position:"relative",background:"#000",float:"left",border:"2px solid #595959",margin:"1px"})),$("#"+this.arrTag.canvasbox).css({position:"relative",float:"left"}),$("#"+this.arrTag.container).css({position:"absolute",left:0,top:0,right:0,bottom:0,margin:"auto"}),$("#"+this.arrTag.scroll).css({float:"right",position:"relative","margin-bottom":"1px","margin-right":"1px","margin-top":"1px"}),str},CBoBo.View.CMngFirstLayer.prototype.UpdateStyle=function(){var parentWidth,parent=$(this.opt.parent);null!=parent&&(parentWidth=parent.width(),parent=parent.height(),$("#"+this.arrTag.box).width(parentWidth).height(parent))},CBoBo.View.CMngFirstLayer.prototype.TriggerResize=function(event){var pos;this.opt.single&&(this.UpdateStyle(),pos=1,this.scroll&&(pos=this.scroll.draggerPos),this.UpdateLayout(this.imageNums,this.nLayoutRow,this.nLayoutCol,pos),this.opt.msgtransform)&&event&&this.opt.msgtransform(event)},CBoBo.View.CMngFirstLayer.prototype.AddEvent=function(){},CBoBo.View.CMngFirstLayer.prototype.SetBoxRange=function(width,height){var box=$("#"+this.arrTag.box);0==width||0==height?box.hide():(box.show(),height>>=0,box.width(width>>=0).height(height))},CBoBo.View.CMngFirstLayer.prototype.ShowScroll=function(bShow){var self,scroll=$("#"+this.arrTag.scroll),container=$("#"+this.arrTag.container),box=$("#"+this.arrTag.box),canvasbox=$("#"+this.arrTag.canvasbox),boxWidth=box.width(),box=box.height();bShow?(scroll.width(this.opt.scrollsize-1).height(box-2).show(),boxWidth-=this.opt.scrollsize,void 0===(self=this).scroll&&(this.scroll=new CBoBo.View.Scroll({parent:"#"+this.arrTag.scroll,msgtransform:function(event){null!=(event.firstmng=self).opt.msgtransform&&self.opt.msgtransform(event)},size:self.opt.scrollsize}))):(scroll.hide(),this.scroll=void 0),boxWidth=Math.floor(boxWidth),box=Math.floor(box),container.width(boxWidth).height(box),canvasbox.width(boxWidth).height(box)},CBoBo.View.CMngFirstLayer.prototype.GetId=function(string){if(null!=string)return this.arrTag[string]},CBoBo.View.CMngFirstLayer.prototype.Focus=function(id){if("[object String]"==Object.prototype.toString.apply(id))for(var i=0;i<this.arrCanvas.length;i++){var canvas=this.arrCanvas[i],jqcanvas=$("#"+canvas.boxId);canvas.GetId("canvas")==id?(canvas.bFocus=!0,this.focusIndex=i,jqcanvas.css({"border-color":"#33ffff"})):(canvas.bFocus=!1,jqcanvas.css({"border-color":"#595959"}))}else if("[object Number]"==Object.prototype.toString.apply(id)&&-1<id&&id<this.arrCanvas.length)for(var focusStyle=this.opt.single?"2px solid #33ffff":"2px dashed #FFFF00",i=0;i<this.arrCanvas.length;i++){canvas=this.arrCanvas[i],jqcanvas=$("#"+canvas.boxId);i==id?(canvas.bFocus=!0,this.focusIndex=i,jqcanvas.css({border:focusStyle})):(canvas.bFocus=!1,jqcanvas.css({border:"2px solid #595959"}))}},CBoBo.View.CMngFirstLayer.prototype.MsgProxy=function(event){!this.opt.single||"mousedown"!=event.type&&"touchstart"!=event.type||this.bBorderSpColor||this.Focus(event.target.id),null!=(event.mng=this).opt.msgtransform&&this.opt.msgtransform(event)},CBoBo.View.CMngFirstLayer.prototype.AddCanvas=function(){var self=this,canvas=new CBoBo.View.DVCanvas({parent:"#"+this.arrTag.container,msgtransform:function(event){self.MsgProxy(event)},bdrag:this.opt.single});this.arrCanvas.push(canvas)},CBoBo.View.CMngFirstLayer.prototype.DeleteCanvas=function(startPos){if(!(null==startPos||startPos>this.arrCanvas.length))for(var i=this.arrCanvas.length-1;startPos<=i;i--){var canvas=this.arrCanvas[i];$("#"+canvas.boxId).remove(),this.arrCanvas.pop()}},CBoBo.View.CMngFirstLayer.prototype.SetLayout=function(row,col){var parent=$("#"+this.arrTag.container),win_w=parent.width(),parent=parent.height(),nCanvasW=Math.floor((win_w-6*col)/col),nCanvasH=Math.floor((parent-6*row)/row),nCount=row*col,win_w=this.arrCanvas.length;if(win_w<nCount)for(var i=win_w;i<nCount;i++)this.AddCanvas();else nCount<win_w&&this.DeleteCanvas(nCount);$.each(this.arrCanvas,function(i,canvas){canvas.Float("left")});for(i=0;i<this.arrCanvas.length;i++){var can=this.arrCanvas[i];i<nCount?can.SetRange(nCanvasW,nCanvasH):can.SetRange(0,0)}this.nLayoutRow=row,this.nLayoutCol=col},CBoBo.View.CMngFirstLayer.prototype.GetFocusCanvas=function(){for(var i=0;i<this.arrCanvas.length;i++){var canvas=this.arrCanvas[i];if(canvas.bFocus)return canvas}},CBoBo.View.CMngFirstLayer.prototype.GetCanvasIndex=function(canvasId){if(null==canvasId){for(var i=0;i<this.arrCanvas.length;i++)if(this.arrCanvas[i].bFocus)return i}else for(i=0;i<this.arrCanvas.length;i++)if(this.arrCanvas[i].GetId("canvas")==canvasId)return i},CBoBo.View.CMngFirstLayer.prototype.GetAllCanvas=function(){return this.arrCanvas},CBoBo.View.CMngFirstLayer.prototype.GetLayoutCanvas=function(){var layoutNums=(layoutNums=this.nLayoutRow*this.nLayoutCol)>this.arrCanvas.length?this.arrCanvas.length:layoutNums;return this.arrCanvas.slice(0,layoutNums)},CBoBo.View.CMngFirstLayer.prototype.GetCanvasById=function(id){for(var i=0;i<this.arrCanvas.length;i++){var canvas=this.arrCanvas[i];if(canvas.GetId("canvas")==id)return canvas}},CBoBo.View.CMngFirstLayer.prototype.GetCanvas=function(index){index=index<this.arrCanvas.length&&-1<index?this.arrCanvas.slice(0,index):this.arrCanvas;return index},CBoBo.View.CMngFirstLayer.prototype.UpdateLayout=function(nums,row,col,scrollPos){null!=nums&&(null!=row&&null!=col||(row=0<this.nLayoutRow?this.nLayoutRow:1,col=0<this.nLayoutCol?this.nLayoutCol:1),row*col<(this.imageNums=nums)?(this.ShowScroll(!0),nums=Math.ceil(nums/(row*col)),this.scroll.SetRange(nums,scrollPos)):this.ShowScroll(!1),this.SetLayout(row,col))},CBoBo.View.CMngFirstLayer.prototype.UpdateLayoutSp3=function(nums,direct,scrollPos){void 0!==nums&&(3<(this.imageNums=nums)?(this.ShowScroll(!0),nums=Math.ceil(nums/3),this.scroll.SetRange(nums,scrollPos)):this.ShowScroll(!1),this.LayoutSp3(direct))},CBoBo.View.CMngFirstLayer.prototype.LayoutSp3=function(direct){var parent=$("#"+this.arrTag.container),win_w=(parent.width(),parent.width()-1),parent=parent.height()-1,spW=win_w-6,spH=parent-6,nCanvasW=win_w-12>>1,nCanvasH=parent-12>>1,win_w=this.arrCanvas.length;if(win_w<3)for(var i=win_w;i<3;i++)this.AddCanvas();else 3<win_w&&this.DeleteCanvas(3);var floatStr="right"===direct?"right":"left";switch($.each(this.arrCanvas,function(i,canvas){canvas.Float(floatStr)}),direct){case"left":this.arrCanvas[0].SetRange(nCanvasW,spH),this.arrCanvas[1].SetRange(nCanvasW,nCanvasH),this.arrCanvas[2].SetRange(nCanvasW,nCanvasH);break;case"top":this.arrCanvas[0].SetRange(spW,nCanvasH),this.arrCanvas[1].SetRange(nCanvasW,nCanvasH),this.arrCanvas[2].SetRange(nCanvasW,nCanvasH);break;case"right":this.arrCanvas[0].SetRange(nCanvasW,spH),this.arrCanvas[1].SetRange(nCanvasW,nCanvasH),this.arrCanvas[2].SetRange(nCanvasW,nCanvasH);break;case"bottom":this.arrCanvas[0].SetRange(nCanvasW,nCanvasH),this.arrCanvas[1].SetRange(nCanvasW,nCanvasH),this.arrCanvas[2].SetRange(spW,nCanvasH)}},CBoBo.View.CMngFirstLayer.prototype.SetDefaultFocus=function(index){isNaN(index)||(index=index>this.arrCanvas.length-1?this.arrCanvas.length-1:index,this.Focus(this.arrCanvas[index=index<0?0:index].canvasId))},CBoBo.View.CMngFirstLayer.prototype.GetLayout=function(){return{row:this.nLayoutRow,col:this.nLayoutCol}},CBoBo.View.CMngFirstLayer.prototype.SeriesIndex=function(index){return null==index?this.seriesIndex:(this.seriesIndex=index,this)},CBoBo.View.CMngFirstLayer.prototype.GetBoundary=function(){var ret={},ctrl=$("#"+this.arrTag.box),pos=ctrl.offset();return ret.left=pos.left,ret.top=pos.top,ret.width=ctrl.width(),ret.height=ctrl.height(),ret},CBoBo.View.CMngFirstLayer.prototype.SetSpBoundaryColor=function(index,color){this.bBorderSpColor=!0;index=this.arrCanvas[index];null!=index&&$("#"+index.boxId).css({"border-color":color})},CBoBo.View.CMngFirstLayer.prototype.EnableScroll=function(bEnable){this.scroll||this.ShowScroll(!0),this.scroll.Enable(bEnable)},CBoBo.View.CMngFirstLayer.prototype.SetCanavsBoxBoundary=function(level,vertical){var container,boxWidth,box,contarnerWidth,contarnerHeight;isNaN(level)||isNaN(vertical)||(container=$("#"+this.arrTag.container),boxWidth=(box=$("#"+this.arrTag.box)).width(),box=box.height(),this.scroll&&(boxWidth-=this.opt.scrollsize),(level=level/vertical)<boxWidth/box?contarnerWidth=(contarnerHeight=box)*level:contarnerHeight=(contarnerWidth=boxWidth)/level,container.width(contarnerWidth).height(contarnerHeight))},CBoBo.View.CMngFirstLayer.prototype.SetCanvasMsgPro=function(msgPro){$.each(this.arrCanvas,function(){this.SetMsgPro(msgPro)})},CBoBo.View.CMngFirstLayer.prototype.Destroy=function(){$("#"+this.arrTag.box).remove()},CBoBo.View.CMngFirstLayer.prototype.GetEventImageIndex=function(dvCanvas){var scrollValue=this.scroll?this.scroll.draggerPos:1,row=this.nLayoutRow,col=this.nLayoutCol;(row<1||col<1)&&(col=row=1);for(var scrollValue=(scrollValue-1)*(row*col),index=0,i=0;i<this.arrCanvas.length;i++)if(this.arrCanvas[i]===dvCanvas){index=i;break}return scrollValue+=index},CBoBo.View.CMngSecondLayer=function(options){var self=this,defaults={parent:null,scrollsize:CBoBo.Scrollsize},opt=$.extend(!0,defaults,options);this.arrTag={},this.arrFirstLayer=[],this.nLayoutRow=0,this.nLayoutCol=0,this.scroll,this.bMax=!1,this.imageNums,this.focusIndex=1,this.CreateBox=function(){var str;if(null!=opt.parent)return this.arrTag.box="box"+CBoBo.Plugin.GetRandom(),this.arrTag.container="container"+CBoBo.Plugin.GetRandom(),this.arrTag.scroll="scroll"+CBoBo.Plugin.GetRandom(),str=!0!==opt.aiRead?"<div id='"+this.arrTag.box+"'><div id='"+this.arrTag.container+"'></div><div id='"+this.arrTag.scroll+"'></div></div>":"<div id='"+this.arrTag.box+"'><div id='"+this.arrTag.container+"'></div></div>",null!=(str=$(str).appendTo(opt.parent))&&str.css({position:"relative",background:"#000"}),$("#"+this.arrTag.container).css({display:"inline-block"}),$("#"+this.arrTag.scroll).css({display:"inline-block",position:"relative","margin-bottom":"1px","margin-top":"1px","margin-right":"1px"}),str},this.UpdateStyle=function(){var parentWidth,parent=$(opt.parent);null!=parent&&(parentWidth=parent.width(),parent=parent.height(),$("#"+this.arrTag.box).width(parentWidth).height(parent))},this.TriggerResize=function(event){self.UpdateStyle();var pos=self.scroll?self.scroll.draggerPos:1;self.UpdateLayout(self.imageNums,self.nLayoutRow,self.nLayoutCol,pos),self.arrFirstLayer.forEach(function(mng){pos=mng.scroll?mng.scroll.draggerPos:1,mng.UpdateLayout(mng.imageNums,mng.nLayoutRow,mng.nLayoutCol,pos)}),opt.msgtransform&&event&&opt.msgtransform(event)},this.AddEvent=function(){},this.ShowScroll=function(bShow){var scroll=$("#"+this.arrTag.scroll),container=$("#"+this.arrTag.container),box=$("#"+this.arrTag.box);bShow?(scroll.width(opt.scrollsize-1).height(box.height()-2).show(),container.width(box.width()-opt.scrollsize),null==this.scroll&&(this.scroll=new CBoBo.View.Scroll({parent:"#"+this.arrTag.scroll,msgtransform:function(event){event.secondmng=self,opt.msgtransform(event)},size:opt.scrollsize}))):(scroll.hide(),this.scroll=void 0,container.width(box.width())),container.height(box.height())},this.Focus=function(id){var bExist=!1;$.each(this.arrFirstLayer,function(i,mng){$.each(mng.arrCanvas,function(j,canvas){var jqcanvas=$("#"+canvas.boxId);canvas.GetId("canvas")==id?(canvas.bFocus=!0,mng.focusIndex=j,jqcanvas.css({border:"2px dashed #FFFF00"}),bExist=!0):(canvas.bFocus=!1,jqcanvas.css({border:"2px solid #595959"}))});var box=$("#"+mng.GetId("box"));bExist?(box.css({"border-color":"#33ffff"}),self.focusIndex=i,mng.bFocus=!0,bExist=!1):(box.css({"border-color":"#595959"}),mng.bFocus=!1)})},this.MsgProxy=function(event){"mousedown"!=event.type&&"touchstart"!=event.type||this.Focus(event.target.id),opt.msgtransform&&opt.msgtransform(event)},this.AddFirstMng=function(){var self=this;this.arrFirstLayer.push(new CBoBo.View.CMngFirstLayer({parent:"#"+this.arrTag.container,scrollsize:opt.scrollsize,msgtransform:function(event){self.MsgProxy(event)},single:!1}))},this.SetLayout=function(row,col){var parent=$("#"+this.arrTag.container),nCanvasW=(parent.width()-6*col)/col,nCanvasH=(parent.height()-6*row)/row,nCount=row*col,parent=this.arrFirstLayer.length;if(parent<nCount)for(var i=parent;i<nCount;i++)this.AddFirstMng();for(i=0;i<this.arrFirstLayer.length;i++){var mng=this.arrFirstLayer[i];i<nCount?mng.SetBoxRange(nCanvasW,nCanvasH):mng.SetBoxRange(0,0)}this.nLayoutRow=row,this.nLayoutCol=col,sessionStorage.setItem("layout",row+","+col)},this.GetLayout=function(){return{row:this.nLayoutRow,col:this.nLayoutCol}},this.GetActiveMng=function(){var ret=[];return $.each(this.arrFirstLayer,function(i,mng){(mng.bFocus||mng.checkbox.bState)&&ret.push(mng)}),ret},this.GetFocusMng=function(){for(var i=0;i<this.arrFirstLayer.length;i++)for(var firstmng=this.arrFirstLayer[i],j=0;j<firstmng.arrCanvas.length;j++)if(firstmng.arrCanvas[j].bFocus)return firstmng},this.GetFocusCanvas=function(){for(var i=0;i<this.arrFirstLayer.length;i++)for(var firstmng=this.arrFirstLayer[i],j=0;j<firstmng.arrCanvas.length;j++){var canvas=firstmng.arrCanvas[j];if(canvas.bFocus)return canvas}},this.GetMng=function(index){if(null==index)return this.arrFirstLayer;if("[object Object]"==Object.prototype.toString.apply(index)){for(var i=0;i<this.arrFirstLayer.length;i++)if((firstmng=this.arrFirstLayer[i]).scroll==index)return firstmng}else{if("[object Number]"==Object.prototype.toString.apply(index))return index=index>this.arrFirstLayer.length-1?this.arrFirstLayer.length-1:index,this.arrFirstLayer[index=index<0?0:index];if("[object String]"==Object.prototype.toString.apply(index))for(var firstmng,i=0;i<this.arrFirstLayer.length;i++)if((firstmng=this.arrFirstLayer[i]).GetId("box")==index)return firstmng}},this.GetMngByCanvas=function(canvas){for(var id=canvas.GetId("canvas"),i=0;i<this.arrFirstLayer.length;i++){var firstmng=this.arrFirstLayer[i];if(firstmng.GetCanvasById(id))return firstmng}},this.GetAllCanvas=function(){var ret=[];return $.each(this.arrFirstLayer,function(i,itm){ret=ret.concat(itm.arrCanvas)}),ret},this.GetCanvasById=function(id){for(var i=0;i<this.arrFirstLayer.length;i++)for(var arrCanvas=this.arrFirstLayer[i].GetAllCanvas(),j=0;j<arrCanvas.length;j++){var canvas=arrCanvas[j];if(canvas.GetId("canvas")==id)return canvas}},this.GetSeriesCanvasById=function(id){for(var ret={},i=0;i<this.arrFirstLayer.length;i++)for(var arrCanvas=this.arrFirstLayer[i].GetAllCanvas(),j=0;j<arrCanvas.length;j++)if(arrCanvas[j].GetId("canvas")==id)return ret.arrcanvas=arrCanvas,ret.mng=this.arrFirstLayer[i],ret},this.UpdateLayout=function(nums,row,col,scrollPos){null!=nums&&(null!=row&&null!=col||(row=0<this.nLayoutRow?this.nLayoutRow:1,col=0<this.nLayoutCol?this.nLayoutCol:1),row*col<(this.imageNums=nums)?(this.ShowScroll(!0),nums=Math.ceil(nums/(row*col)),this.scroll.SetRange(nums,scrollPos)):this.ShowScroll(!1),CBoBo.IsTablet&&this.ShowScroll(!1),this.SetLayout(row,col))},this.SetDefaultFocus=function(index,idx){isNaN(index)||(index=index>this.arrFirstLayer.length-1?this.arrFirstLayer.length-1:index,(index=this.arrFirstLayer[index=index<0?0:index].GetAllCanvas()).length<1)||this.Focus(index[idx].GetId("canvas"))},this.GetLayoutCanvas=function(index){if(void 0===index)return this.GetFocusMng().GetLayoutCanvas()},this.GetLayoutMng=function(index){var layoutNums=(layoutNums=this.nLayoutRow*this.nLayoutCol)>this.arrFirstLayer.length?this.arrFirstLayer.length:layoutNums;return this.arrFirstLayer.slice(0,layoutNums)},this.GetMngIndex=function(mngId){if(void 0===mngId){for(var i=0;i<this.arrFirstLayer.length;i++)for(var firstmng=this.arrFirstLayer[i],j=0;j<firstmng.arrCanvas.length;j++)if(firstmng.arrCanvas[j].bFocus)return i}else for(i=0;i<this.arrFirstLayer.length;i++)if((firstmng=this.arrFirstLayer[i]).GetId("box")==mngId)return i},this.EachMng=function(callback){callback instanceof Function&&$.each(this.arrFirstLayer,function(i,value){callback(value,i)})},this.Destroy=function(){$("#"+this.arrTag.box).remove()},self.CreateBox(),self.UpdateStyle(),self.ShowScroll(!0)},CBoBo.View.CheckBox=function(options){var self=this,opt=$.extend(!0,{parent:null,title:"",msgtransform:null},options),pos_right=(this.ctrlId,this.bState=!1,this.bShow=!1,this.dragId,20),pos_top=40;this.Create=function(){this.ctrlId=CBoBo.Plugin.GetRandom(),this.dragId=CBoBo.Plugin.GetRandom();var innerStr="<div class='seriCompareBar' id='"+this.ctrlId+"' title='"+opt.title+"'><div class='seriCompareSlide'><input type='checkbox' value='none' name='checkbox' id='"+this.dragId+"' /><label for='"+this.dragId+"'></label></div></div>";CBoBo.IsTablet&&(innerStr="<div class='seriCompareBar' id='"+this.ctrlId+"' title='"+opt.title+"'><div class='seriCompareSlideSP'><input type='checkbox' value='none' name='checkbox' id='"+this.dragId+"' /><label for='"+this.dragId+"'></label></div></div>"),$(innerStr).appendTo($(opt.parent)),$("#"+this.ctrlId).css({position:"absolute"}),$("#"+this.ctrlId).css({position:"absolute"})},this.SetPositon=function(right,top){pos_right=right,pos_top=top,self.UpdateStyle()},this.Show=function(bShow){bShow?(this.bShow=!0,$("#"+this.ctrlId).show()):(this.bShow=!1,self.On_Off(!1),$("#"+this.ctrlId).hide())},this.On_Off=function(bNF){bNF?(self.bState=!0,$("#"+this.dragId).prop("checked",!0).next().css({left:"33px"})):(self.bState=!1,$("#"+this.dragId).prop("checked",!1).next().css({left:"2px"}))},this.AddEvent=function(){$("#"+this.dragId).bind("click",function(event){var checkbox=$(this);self.bState=checkbox.is(":checked"),self.bState?checkbox.next().css({left:"33px"}):checkbox.next().css({left:"2px"}),null!==opt.msgtransform&&opt.msgtransform(self.bState)}),$(window).bind("resize",function(event){self.UpdateStyle()})},this.UpdateStyle=function(){$("#"+this.ctrlId).css({right:pos_right+"px",top:pos_top+"px"})},self.Create(),self.UpdateStyle(),self.AddEvent()},CBoBo.View.DVPrint=function(options){var m_mng,m_layoutCtrl,m_toolBar,m_waitWindow,self=this,opt=$.extend(!0,{msgtransform:null,mode:1},options),m_arrId={},m_arrPrintImgs=[],m_arrCanvasCount=[],m_pageIndex=1,m_recordCurPageLayout=new PageGrid,m_arrConfigId={},m_printerInfo=[],m_printUrl=CBoBo.Plugin.GetUrlParam("WadoURL")||$("#WadoURL").val()||$("#hdurl").val();this.bShow,this.bShowPrintSetBox=!1,this.bShowPrintAddBox=!1,this.isAddPrint=!0,this.closePrintBox=function(flag,element){"bShowPrintSetBox"===flag?this.bShowPrintSetBox=!1:this.bShowPrintAddBox=!1,$("#"+element).hide()},this.showPrintBox=function(flag,element){"bShowPrintSetBox"===flag?this.bShowPrintSetBox=!0:this.bShowPrintAddBox=!0,$("#"+element).show()},this.readLocalPrint=function(){if(localPrint=localStorage.getItem("localPrint")){var localPrint,localPrintArray=(localPrint=JSON.parse(localPrint)).print;if(0<localPrintArray.length){for(var _html="",i=0;i<localPrintArray.length;i++)localPrintArray[i].id===localPrint.defaultId?_html+="<tr class='current' id='"+localPrintArray[i].id+"'>":_html+="<tr id='"+localPrintArray[i].id+"'>",_html+="<td width='35%'>"+localPrintArray[i].printName+"</td><td width='25%'>"+localPrintArray[i].printTitle+"</td><td width='25%'>"+localPrintArray[i].printAddress+"</td><td width='15%'>"+localPrintArray[i].printPort+"</td></tr>";$("#"+m_arrId.tableContent).html(_html),$("#"+m_arrId.tableContent+" tr").on("click",function(event){$("#"+m_arrId.tableContent+" tr").removeClass("current"),$(this).addClass("current")})}else $("#"+m_arrId.tableContent).html("")}},this.PrintSearchByPrintId=function(printId){var printObj=null;if(localPrint=localStorage.getItem("localPrint")){var localPrint,localPrintArray=JSON.parse(localPrint).print;if(localPrintArray&&0<localPrintArray.length)for(var i=0;i<localPrintArray.length;i++)printId==localPrintArray[i].id&&(printObj=localPrintArray[i])}return printObj},this.LoadPrintToSelelct=function(parentId,pointerFlag){if("pointer"==pointerFlag&&(pointerFlag=localStorage.getItem("localPrint"))){var localPrintArray=(pointerFlag=JSON.parse(pointerFlag)).print,pointerFlag=pointerFlag.defaultId;if(localPrintArray&&0<localPrintArray.length){for(var _options="",i=0;i<localPrintArray.length;i++)_options+="<option value='"+localPrintArray[i].id+"'>"+localPrintArray[i].printName+"</option>";$(parentId).html(_options),$(parentId).val(pointerFlag).removeAttr("disabled")}else $(parentId).html("").attr("disabled","disabled")}},this.ModifyLocalPrint=function(printId){var localPrint=localStorage.getItem("localPrint"),localPrintArray=JSON.parse(localPrint).print;if(localPrintArray&&0<localPrintArray.length)for(var i=0;i<localPrintArray.length;i++)localPrintArray[i].id==printId&&($("#iptInputPrintName").val(localPrintArray[i].printName),$("#iptInputPrintTitle").val(localPrintArray[i].printTitle),$("#iptInputPrintAddress").val(localPrintArray[i].printAddress),$("#iptInputPrintPort").val(localPrintArray[i].printPort));self.showPrintBox("bShowPrintAddBox",m_arrId.settingAddBox)};function PageGrid(type,row,col){this.type=type||"",this.row=row||1,this.col=col||2}var LoadPrintThumbnail=function(){var printInfo=GetPrintInfo(),url=m_printUrl+"/CreatDicomFilm";m_mng.arrCanvas[0].StartLoadingAnimation(),$.ajax({type:"post",dataType:"json",url:url,data:JSON.stringify(printInfo),complete:function(xhr){var leftBox,image;200==xhr.status&&xhr.responseJSON.success?(leftBox=$("#"+m_arrId.leftBox),(image=new Image).src=m_printUrl+"/GetViewFilm?uuid="+xhr.responseJSON.data.UID+"&width="+leftBox.width()+"&height="+leftBox.height()+"&r="+Math.random(),image.onload=function(){m_mng.arrCanvas[0].StopLoadingAnimation();var tempCanvas=$("#"+m_arrId.ctrl+" canvas")[0];tempCanvas.getContext("2d").clearRect(0,0,tempCanvas.width,tempCanvas.height),$(tempCanvas).attr("imgID",xhr.responseJSON.data.UID),tempCanvas.getContext("2d").drawImage(image,0,0,image.width,image.height)}):$.Msg("打印胶片加载失败。",CBoBo.MSG_ERROR)}})},GetPrintInfo=function(){var baseImages=this.CBoBo.AnnStatusManager.Get(),c=0,r=0,layout=sessionStorage.getItem("layout"),r=null==layout?(c=3,2):(c=layout.split(",")[1],layout.split(",")[0]),printInfo=new CBoBo.View.DVPrintInfo;printInfo.ImageDisplayFormat="STANDARD\\"+c+","+r;for(var i=0;i<baseImages.length;i++){var printImageInfo=new CBoBo.View.DVPrintImageInfo,topLeftLabelsDescribe=(printImageInfo.WindowLevel=baseImages[i].viewport.wc,printImageInfo.WindowWidth=baseImages[i].viewport.ww,printImageInfo.ID=baseImages[i].viewport.image.id,printImageInfo.TopLabel=baseImages[i].viewport.image.ort,printImageInfo.DownLabel=baseImages[i].viewport.image.orb,printImageInfo.LeftLabel=baseImages[i].viewport.image.orl,printImageInfo.RightLabel=baseImages[i].viewport.image.orr,new CBoBo.View.DVPrintImageDescribe),topLeftLabelsDescribe=(topLeftLabelsDescribe.Describe.push("ID:"+baseImages[i].viewport.image.accnum),topLeftLabelsDescribe.Describe.push("姓名:"+baseImages[i].viewport.image.name),topLeftLabelsDescribe.Describe.push("设备:"+baseImages[i].viewport.image.mod),topLeftLabelsDescribe.Describe.push("性别:"+baseImages[i].viewport.image.sex),printImageInfo.TopLeftLabels=topLeftLabelsDescribe,new CBoBo.View.DVPrintImageDescribe),topLeftLabelsDescribe=(topLeftLabelsDescribe.Describe.push("日期:"+baseImages[i].viewport.image.studt),topLeftLabelsDescribe.Describe.push("时间:"+baseImages[i].viewport.image.acqtm),topLeftLabelsDescribe.Describe.push("影像号:"+baseImages[i].viewport.image.serid+"-"+baseImages[i].viewport.image.stuid+"-"+baseImages[i].viewport.image.imgnum),printImageInfo.TopRightLabels=topLeftLabelsDescribe,new CBoBo.View.DVPrintImageDescribe),topLeftLabelsDescribe=(topLeftLabelsDescribe.Describe.push("倍数:"+baseImages[i].viewport.scale),topLeftLabelsDescribe.Describe.push("窗位:"+baseImages[i].viewport.wc),topLeftLabelsDescribe.Describe.push("窗宽:"+baseImages[i].viewport.ww),topLeftLabelsDescribe.Describe.push("医院名:"+baseImages[i].viewport.image.manu),printImageInfo.DownRightLabels=topLeftLabelsDescribe,new CBoBo.View.DVPrintImageDescribe);topLeftLabelsDescribe.Describe.push("电压:"+baseImages[i].viewport.image.kv),topLeftLabelsDescribe.Describe.push("层厚:"+baseImages[i].viewport.image.sliceth),printImageInfo.DownLeftLabels=topLeftLabelsDescribe,printInfo.DicomInfos.push(printImageInfo)}return printInfo.Orientation=$(m_arrConfigId.direct).val(),printInfo.FilmSizeID=$(m_arrConfigId.size).val(),printInfo},options=function(){m_arrId.ctrl=CBoBo.Plugin.GetRandom(),m_arrId.title=CBoBo.Plugin.GetRandom(),m_arrId.title=CBoBo.Plugin.GetRandom(),m_arrId.titleBtn=CBoBo.Plugin.GetRandom(),m_arrId.container=CBoBo.Plugin.GetRandom(),m_arrId.leftBox=CBoBo.Plugin.GetRandom(),m_arrId.canvasBox=CBoBo.Plugin.GetRandom(),m_arrId.controlBar=CBoBo.Plugin.GetRandom(),m_arrId.control=CBoBo.Plugin.GetRandom(),m_arrId.controlItem=CBoBo.Plugin.GetRandom(),m_arrId.pageInfo=CBoBo.Plugin.GetRandom(),m_arrId.toolBox=CBoBo.Plugin.GetRandom(),m_arrId.winLayout=CBoBo.Plugin.GetRandom(),m_arrId.tool=CBoBo.Plugin.GetRandom(),m_arrId.config=CBoBo.Plugin.GetRandom(),m_arrId.toolId=CBoBo.Plugin.GetRandom(),m_arrId.winLayoutId=CBoBo.Plugin.GetRandom(),m_arrId.configId=CBoBo.Plugin.GetRandom(),m_arrId.settingBox=CBoBo.Plugin.GetRandom(),m_arrId.settingAddBox=CBoBo.Plugin.GetRandom(),m_arrId.tableContent=CBoBo.Plugin.GetRandom();var innerStr="<object id='csharpActiveX' classid='clsid:CC6F4407-B2B2-47FB-AE00-7E88A7E615EC' width='0' height='0'></object><div id='"+m_arrId.ctrl+"' class='icon_tool'><div id='"+m_arrId.title+"'><span class='"+m_arrId.titleBtn+"'>胶片打印</span></div><div id='"+m_arrId.container+"'><div id='"+m_arrId.leftBox+"'><div id='"+m_arrId.canvasBox+"'></div><div id='"+m_arrId.controlBar+"'><div id='"+m_arrId.control+"'></div></div></div><div id='"+m_arrId.toolBox+"'><div id='"+m_arrId.config+"'><span >打 印 配 置</span><div id='"+m_arrId.configId+"'></div></div></div></div>''<div id='"+m_arrId.settingBox+"' class='zzhsettingBox'><div class='title-container'>DICOM 打印机配置</div><div class='setting-content'><div class='operation-container'><button class='setting-btn' id='printNetTest'>网络测试</button><button class='setting-btn' id='printerAdd'>添加</button><button class='setting-btn' id='printerChange'>修改</button><button class='setting-btn' id='printerDel'>删除</button></div><div class='table-content'><table cellpadding='0' cellspacing='0'><thead><tr><th width='35%'>名称</th><th width='25%'>AET</th><th width='25%'>地址</th><th width='15%'>端口</th></tr></thead></table><div class='contentScroll'><table cellpadding='0' cellspacing='0' id='"+m_arrId.tableContent+"'></table></div></div><div class='operation-container setting-footer'><button class='setting-btn' id='printSetDefault'>设为默认</button><button class='setting-btn' id='printSetBoxClose'>关闭</button></div></div></div><div id='"+m_arrId.settingAddBox+"' class='addPrintterContainer'><div class='title-container' id='"+m_arrId.settingAddBox+"Title'>添加打印机</div><div class='inputItem'><div class='inputName'>打印机名：</div><div class='inputContainer'><input type='text' id='iptInputPrintName'/></div></div><div class='inputItem'><div class='inputName'>AETitle：</div><div class='inputContainer'><input type='text' id='iptInputPrintTitle'/></div></div><div class='inputItem'><div class='inputName'>IP地址：</div><div class='inputContainer'><input type='text' id='iptInputPrintAddress'/></div></div><div class='inputItem'><div class='inputName'>端口：</div><div class='inputContainer'><input type='text 'maxlength='5'id='iptInputPrintPort'/></div></div><div class='operation-container setting-footer'><button class='setting-btn' id='printAddSubmit'>确定</button><button class='setting-btn' id='printCancelBox'>取消</button></div></div></div>";$(innerStr).appendTo($("body"))},UpdateStyle=function(){{var screenWidth,screenWidth,screenWidth=(screenWidth=.8*(screenWidth=$(window).width())>>0)<800?800:screenWidth,ctrl,ctrl,ctrl;(ctrl=$("#"+m_arrId.ctrl)).width(screenWidth).height(820).css({border:"1px solid #676767",position:"absolute","z-index":"9999",background:"#444444",display:"none","user-select":"none",color:"#CCCCC4"}),(ctrl=$("#"+m_arrId.title)).css({height:"30px",width:"100%",background:"#555555",cursor:"move"}),(ctrl=$("."+m_arrId.titleBtn)).css({width:"100%",height:"100%","text-align":"center",display:"inline-block","font-size":"16px","line-height":"30px"});var ctrl,ctrl=((ctrl=$("#"+m_arrId.title+" a")).css({display:"inline-block",position:"absolute",top:"3px",right:"5px",cursor:"pointer","font-size":"20px",color:"#000"}),$("#"+m_arrId.container).css({position:"relative"}),$("#"+m_arrId.leftBox)),screenWidth,ctrl;leftBoxWidth=screenWidth-202,ctrl.width(leftBoxWidth).height(790).css({float:"left"}),(screenWidth=$("#"+m_arrId.canvasBox)).width(leftBoxWidth).height(745).css({"border-bottom":"1px solid #676767"}),(ctrl=$("#"+m_arrId.controlBar)).height(44).css({width:"100%"})}$("#"+m_arrId.control).height(44).width(220).css({float:"right","text-align":"center","font-size":"25px","line-height":"40px",color:"#000"}),$("."+m_arrId.controlItem).css({cursor:"pointer",margin:"0 10px"}),$("#"+m_arrId.pageInfo).css({color:"#CCCCC4","font-size":"18px","vertical-align":"middle",cursor:"default"}),$("#"+m_arrId.toolBox).css({height:"590px",width:"200px",float:"right","border-left":"1px solid #676767","border-top":"1px solid #000"}),$("#"+m_arrId.toolBox+" span").css({width:"100%","text-align":"center",display:"inline-block","font-size":"14px",background:"#555555",cursor:"default",color:"rgba(255,255,255,0.8)"}),$("#"+m_arrId.winLayout).height(100),$("#"+m_arrId.tool).css({height:"490px",width:"25%",display:"inline-block","border-right":"1px solid #676767",overflow:"hidden"}),$("#"+m_arrId.config).css({height:"490px",width:"100%",display:"inline-block",overflow:"hidden"}),$("#"+m_arrId.winLayoutId).height(84).css({overflow:"hidden"});$("#"+m_arrId.toolId).height(474).css({overflow:"hidden",width:"50px"}),$("#"+m_arrId.configId).height(474).css({overflow:"hidden"})},FillPrinter=function(){var parent=m_arrConfigId.printer;DeleteSelCtrl(parent);var hospName=GetPrintCfgInfo().hospital;hospName&&(hospName=function(hospName){for(var i=0;i<m_printerInfo.length;i++){var item=m_printerInfo[i];if(item.name==hospName)return item.printer}}(hospName))&&$.each(hospName,function(){InsertForSelCtrl(parent,this.name,this.uid)})},UpdateWinPosition=function(){var body=$("body"),ctrl=$("#"+m_arrId.ctrl),winWidth=body.width(),body=body.height(),ctrlWidth=ctrl.width(),ctrlHeight=ctrl.height();ctrl.css({left:(winWidth-ctrlWidth>>1)+"px",top:(body-ctrlHeight>>1)+"px"})},UpdateCtrlStatus=function(){var item=$("."+m_arrId.controlItem),first=item.eq(0),pre=item.eq(1),next=item.eq(2),item=item.eq(3),pageNums=m_arrCanvasCount.length;pageNums<2?(first.css({"pointer-events":"none",color:"gray"}),pre.css({"pointer-events":"none",color:"gray"}),next.css({"pointer-events":"none",color:"gray"}),item.css({"pointer-events":"none",color:"gray"})):m_pageIndex<2?(first.css({"pointer-events":"none",color:"gray"}),pre.css({"pointer-events":"none",color:"gray"}),next.css({"pointer-events":"auto",color:"#000"}),item.css({"pointer-events":"auto",color:"#000"})):pageNums-1<m_pageIndex?(first.css({"pointer-events":"auto",color:"#000"}),pre.css({"pointer-events":"auto",color:"#000"}),next.css({"pointer-events":"none",color:"gray"}),item.css({"pointer-events":"none",color:"gray"})):(first.css({"pointer-events":"auto",color:"#000"}),pre.css({"pointer-events":"auto",color:"#000"}),next.css({"pointer-events":"auto",color:"#000"}),item.css({"pointer-events":"auto",color:"#000"}))},RecordCurPageLayout=function(data){var bRet;if(data)return bRet=!1,data.type==m_recordCurPageLayout.type&&data.row==m_recordCurPageLayout.row&&data.col==m_recordCurPageLayout.col&&(bRet=!0),m_recordCurPageLayout.type=data.type,m_recordCurPageLayout.row=data.row,m_recordCurPageLayout.col=data.col,bRet},ToolBarMsg=function(event){switch(event.usermsg||event.target.title){case"恢复":!function(){var canvas=m_mng.GetFocusCanvas();!function(imgStatus,canvas){var annStatus=canvas.AnnStatus();null!=annStatus&&null!=imgStatus&&(imgStatus.Restore(),imgStatus.FitCanvas(canvas).DrawImg(canvas),(annStatus=annStatus.ann).DeleteAllAnn(),annStatus.DrawAllAnn(canvas,imgStatus))}(canvas.AnnStatus().status,canvas)}();break;case"旋转":null==manager.rotateCtrl&&(manager.rotateCtrl=new CBoBo.View.RotateCtrl({msgtransform:ToolBarMsg})),manager.rotateCtrl.bShow?manager.rotateCtrl.Show(!1):(manager.rotateCtrl.SetPosition(event.clientX,event.clientY),manager.rotateCtrl.Show(!0));break;case"负像":!function(){var canvas=m_mng.GetFocusCanvas(),imgStatus=canvas.AnnStatus().status;null!=imgStatus&&(imgStatus.SetNegative(!imgStatus.GetNegative()),imgStatus.DrawImg(canvas))}();break;case"直线":m_toolBar.toolType=CBoBo.TOOL_M_LINE;break;case"矩形":m_toolBar.toolType=CBoBo.TOOL_M_RECT;break;case"椭圆":m_toolBar.toolType=CBoBo.TOOL_M_ELLIPSE;break;case"角度":m_toolBar.toolType=CBoBo.TOOL_M_ANGLE;break;case"CT":m_toolBar.toolType=CBoBo.TOOL_M_POINT;break;case"文本":m_toolBar.toolType=CBoBo.TOOL_LABEL,null==manager.lableCtrl&&(manager.lableCtrl=new CBoBo.View.LableCtrl,manager.lableCtrl.Show(!1));break;case"箭头":m_toolBar.toolType=CBoBo.TOOL_ARROW;break;case"左标记":m_toolBar.toolType=CBoBo.TOOL_LEFT;break;case"右标记":m_toolBar.toolType=CBoBo.TOOL_RIGHT;break;case"撤销":var imgStatus,canvas=m_mng.GetFocusCanvas();null!=canvas&&(imgStatus=canvas.AnnStatus().status,ann=canvas.AnnStatus().ann,null!=imgStatus)&&(imgStatus.DrawImg(canvas),ann.PopAnn(canvas,imgStatus),ann.DrawAllAnn(canvas,imgStatus));break;case"逆时针":case"顺时针":case"左右镜像":case"上下镜像":!function(type){var annStatus,canvas=m_mng.GetFocusCanvas();canvas&&(annStatus=canvas.AnnStatus())&&!function(imgStatus,canvas){if(null!=imgStatus){switch(type){case"逆时针":imgStatus.SetRotate(270);break;case"顺时针":imgStatus.SetRotate(90);break;case"左右镜像":imgStatus.FlipImage();break;case"上下镜像":imgStatus.InvertImage()}null!=canvas&&(imgStatus.DrawImg(canvas),canvas.AnnStatus().ann.DrawAllAnn(canvas,imgStatus))}}(annStatus.status,canvas)}(event.target.title);break;case"删除图像":var ann=m_mng.GetFocusCanvas(),annStatus=ann.AnnStatus();if(null!=ann&&null!=annStatus){for(var i=0;i<m_arrPrintImgs.length;i++)if(annStatus==m_arrPrintImgs[i]){m_arrPrintImgs.splice(i,1);break}FlushCanvasCountArray(),FlushPageInfo(),FlushScrollInfo(),FlushCurPageImage(!0),UpdateCtrlStatus()}break;case"显/隐四角信息":m_toolBar.bShowCornerInfo=!m_toolBar.bShowCornerInfo,event.btntitle="显/隐四角信息",event.btnforce=m_toolBar.bShowCornerInfo,$.each(m_arrPrintImgs,function(i,annStatus){annStatus.status.SetDrawTextFlag(m_toolBar.bShowCornerInfo)}),FlushCurPageImage()}!1===m_toolBar.ChangeBtnStatus(event.btntitle,event.btnforce)&&(m_toolBar.toolType=CBoBo.TOOL_NULL,m_toolBar.ChangeBtnStatus("释放工具"))},MsgProxy=function(event){switch(event.type){case"scroll":RequestDrawCurPage(event.value);break;case"change":switch(event.target.title){case"医院":FillPrinter();case"打印机":case"胶片尺寸":case"方向":LoadPrintThumbnail()}break;case"mousewheel":var scroll=m_mng.scroll;null!=scroll&&scroll.TriggerClick(event.deltaY);break;default:event.tooltype=m_toolBar.toolType,opt.msgtransform&&opt.msgtransform(event)}if(event.target)switch("printSetting"===event.target.name&&!function(event){var ctrl=$(m_arrConfigId.printSetting);switch(event.type){case"mouseenter":ctrl.css({"background-color":"#CCCCC4",color:"#555555"});break;case"mouseout":ctrl.css({"background-color":"#555555",color:"#CCCCC4"});break;case"click":self.bShowPrintSetBox||(self.bShowPrintSetBox=!0,$("#"+m_arrId.settingBox).show(!0))}}(event),event.target.title){case"1*1":case"1*1+2":case"2+1*1":case"2*1+1":case"1+1*2":case"1*2":case"2*1":case"2*2":case"2*3":case"布局控件":case"m*n":!function(event){var ctrl=$("#"+event.target.id);switch(event.type){case"mouseenter":ctrl.css({color:"#CCCCC4"});break;case"mouseout":ctrl.css({color:"#888"});break;case"click":var layout=new PageGrid("",-1,-1);switch(event.target.title){case"1*1":layout.row=1,layout.col=1;case"1*2":-1!=layout.row&&-1!=layout.col||(layout.row=1,layout.col=2);case"2*1":-1!=layout.row&&-1!=layout.col||(layout.row=2,layout.col=1);case"2*2":-1!=layout.row&&-1!=layout.col||(layout.row=2,layout.col=2);case"2*3":-1!=layout.row&&-1!=layout.col||(layout.row=2,layout.col=3);case"布局控件":-1!=layout.row&&-1!=layout.col||(layout.row=event.row,layout.col=event.col),m_mng.SetLayout(layout.row,layout.col);break;case"1*1+2":layout.type="bottom";case"2+1*1":""==layout.type&&(layout.type="top");case"2*1+1":""==layout.type&&(layout.type="left");case"1+1*2":""==layout.type&&(layout.type="right"),m_mng.LayoutSp3(layout.type),layout.row=1,layout.col=3;break;case"m*n":return(m_layoutCtrl=m_layoutCtrl||new CBoBo.View.LayoutCtrl({msgtransform:MsgProxy})).bShow?m_layoutCtrl.Show(!1):(m_layoutCtrl.SetPosition(event.clientX+3,event.clientY+3),m_layoutCtrl.Show(!0))}var data=m_arrCanvasCount[m_pageIndex-1];data.row=layout.row,data.col=layout.col,data.type=layout.type,FlushCanvasCountArray(),FlushScrollInfo(),FlushPageInfo(),FlushCurPageImage(!0),UpdateCtrlStatus(),RecordCurPageLayout(layout)}}(event);break;case"第一页":case"上一页":case"下一页":case"最后一页":!function(event){$(event.target);if("click"===event.type){var index=m_pageIndex;switch(event.target.title){case"第一页":m_pageIndex=1;break;case"上一页":m_pageIndex=--m_pageIndex<1?1:m_pageIndex;break;case"下一页":m_pageIndex=++m_pageIndex>m_arrCanvasCount.length?m_arrCanvasCount.length:m_pageIndex;break;case"最后一页":m_pageIndex=m_arrCanvasCount.length}index!=m_pageIndex&&(m_mng.scroll&&m_mng.scroll.TriggerDragger(m_pageIndex),UpdateCtrlStatus())}}(event);break;case"开始打印":!function(event){var $CsharpActiveX=document.getElementById("csharpActiveX"),ctrl=$(m_arrConfigId.startPrint),$printer=$(m_arrConfigId.printer).val(),$printColor=$(m_arrConfigId.color).val(),$printOrientation=$(m_arrConfigId.direct).val(),$printRuler=$(m_arrConfigId.size).val(),localPrintStorage=localStorage.getItem("localPrint");switch(event.type){case"mouseenter":ctrl.css({"background-color":"#CCCCC4",color:"#555555"});break;case"mouseout":ctrl.css({"background-color":"#555555",color:"#CCCCC4"});break;case"click":if(localPrintStorage){var filmuid=$("#"+m_arrId.ctrl+" canvas").attr("imgID"),$userId=$("#hduseruid").val(),url=m_printUrl+"/ConfirmPrint?filmuid="+filmuid,$currentPrint=(localPrintStorage=JSON.parse(localPrintStorage),self.PrintSearchByPrintId($printer));if($printColor="multicolour"==$printColor?"彩色":"黑白",!(window.ActiveXObject||"ActiveXObject"in window))return layer.msg("请使用IE浏览器！");if(null==$CsharpActiveX.object)return layer.msg("csharpActiveX插件未安装！");$.ajax({type:"post",url:url,dataType:"json",complete:function(xhr){200==xhr.status?(xhr.responseJSON.success?$CsharpActiveX.Print($userId,filmuid,$currentPrint.printTitle,$currentPrint.printAddress,$currentPrint.printPort,$printColor,$printRuler,$printOrientation):$.Msg("胶片打印失败。",CBoBo.MSG_ERROR),self.Show(!1)):$.Msg("胶片打印异常。",CBoBo.MSG_ERROR)}})}else layer.msg("请先设置打印机!")}}(event);break;case"取消打印":!function(event){var ctrl=$(m_arrConfigId.cancelPrint);switch(event.type){case"mouseenter":ctrl.css({"background-color":"#CCCCC4",color:"#555555"});break;case"mouseout":ctrl.css({"background-color":"#555555",color:"#CCCCC4"});break;case"click":self.Show(!1);var filmuid=$("#"+m_arrId.ctrl+" canvas").attr("imgID"),filmuid=m_printUrl+"/CancelPrint?filmuid="+filmuid;$.ajax({type:"get",url:filmuid,dataType:"json",processData:!1,contentType:!1,complete:function(xhr){200==xhr.status?(event.preventDefault(),self.Show(!1),null!=opt.msgtransform&&opt.msgtransform({type:"btnfocus",btntitle:"协同诊断",btnforce:!1}),m_waitWindow&&m_waitWindow.bUpload||ClearMemory()):$.Msg("打印取消失败。",CBoBo.MSG_ERROR)}})}}(event)}};var AddEvent=function(){var ptMDown,ptPos,bLdown=!1,ctrl=$("#"+m_arrId.ctrl);$("#"+m_arrId.title).bind("mousedown",function(event){bLdown=!0,ptMDown=new Point(event.pageX,event.pageY);event=ctrl.offset();ptPos=new Point(event.left,event.top)}),$("#"+m_arrId.title+" a").bind("click",function(event){}),$(document).bind("mousemove mouseup",function(event){switch(event.type){case"mousemove":var disX,disY;bLdown&&(disX=event.pageX-ptMDown.x,disY=event.pageY-ptMDown.y,disX=disX+ptPos.x,disY=disY+ptPos.y,ctrl.css({left:disX+"px",top:disY+"px"}));break;case"mouseup":bLdown=!1}}),$("."+m_arrId.controlItem).bind("click mouseenter mouseout",function(event){MsgProxy(event)}),$("#printNetTest,#printerAdd,#printerChange,#printerDel,#printSetDefault,#printSetBoxClose,#printAddSubmit,#printCancelBox").bind("click",function(event){var $currentPrint,localPrintStorage=JSON.parse(localStorage.getItem("localPrint")),$CsharpActiveX=document.getElementById("csharpActiveX"),activityId=$("#"+m_arrId.tableContent+" .current").attr("id");switch(event.target.id){case"printNetTest":null==$CsharpActiveX.object?layer.msg("csharpActiveX插件未安装！"):($currentPrint=self.PrintSearchByPrintId(activityId),console.log($CsharpActiveX.TestAE),$CsharpActiveX.TestAE($currentPrint.printTitle,$currentPrint.printAddress,$currentPrint.printPort));break;case"printerAdd":$("#iptInputPrintName").val(""),$("#iptInputPrintTitle").val(""),$("#iptInputPrintAddress").val(""),$("#iptInputPrintPort").val(""),$("#"+m_arrId.settingAddBox+"Title").text("添加打印机"),self.isAddPrint=!0,self.showPrintBox("bShowPrintAddBox",m_arrId.settingAddBox);break;case"printerChange":activityId&&""!=activityId?(self.isAddPrint=!1,$("#"+m_arrId.settingAddBox+"Title").text("修改打印机"),self.ModifyLocalPrint(activityId)):layer.msg("暂无可操作的打印机！");break;case"printerDel":var localPrintArray=localPrintStorage.print,newPrintArray=[];if(0<localPrintArray.length){for(var d=0;d<localPrintArray.length;d++)localPrintArray[d].id!=activityId&&newPrintArray.push(localPrintArray[d]);localPrintStorage.print=newPrintArray,localPrintStorage.defaultId==activityId&&(localPrintStorage.defaultId=0<newPrintArray.length?newPrintArray[0].id:""),localStorage.setItem("localPrint",JSON.stringify(localPrintStorage)),self.readLocalPrint(),self.LoadPrintToSelelct(m_arrConfigId.printer,"pointer")}else layer.msg("暂无可操作的打印机！");break;case"printSetDefault":activityId&&""!=activityId?(localPrintStorage.defaultId=activityId,localStorage.setItem("localPrint",JSON.stringify(localPrintStorage)),self.LoadPrintToSelelct(m_arrConfigId.printer,"pointer"),self.closePrintBox("bShowPrintSetBox",m_arrId.settingBox)):layer.msg("暂无可操作的打印机！");break;case"printSetBoxClose":self.closePrintBox("bShowPrintSetBox",m_arrId.settingBox);break;case"printAddSubmit":!function(activityId){var localPrintStorage=localStorage.getItem("localPrint"),localPrint={},iptInputPrintName=$("#iptInputPrintName").val(),iptInputPrintTitle=$("#iptInputPrintTitle").val(),iptInputPrintAddress=$("#iptInputPrintAddress").val().trim(),iptInputPrintPort=$("#iptInputPrintPort").val();if(iptInputPrintName&&""!=iptInputPrintName)if(iptInputPrintTitle&&""!=iptInputPrintTitle)if(iptInputPrintAddress&&""!=iptInputPrintAddress)if(/^((2[0-4]\d|25[0-5]|[01]?\d\d?)\.){3}(2[0-4]\d|25[0-5]|[01]?\d\d?)$/.test(iptInputPrintAddress))if(iptInputPrintPort&&""!=iptInputPrintPort){if(isNaN(iptInputPrintPort)&&layer.msg("请输入正确的端口号"),self.isAddPrint&&(localPrint.id="print"+Date.parse(new Date)),localPrint.printName=iptInputPrintName,localPrint.printTitle=iptInputPrintTitle,localPrint.printAddress=iptInputPrintAddress,localPrint.printPort=iptInputPrintPort,localPrintStorage)if(localPrintStorage=JSON.parse(localPrintStorage),self.isAddPrint)localPrintStorage.print.push(localPrint),localPrintStorage.defaultId&&""!=localPrintStorage.defaultId||(localPrintStorage.defaultId=localPrint.id);else{for(var localPrintArrs=localPrintStorage.print,i=0;i<localPrintArrs.length;i++)localPrintArrs[i].id==activityId&&(localPrintArrs[i].printName=iptInputPrintName,localPrintArrs[i].printTitle=iptInputPrintTitle,localPrintArrs[i].printAddress=iptInputPrintAddress,localPrintArrs[i].printPort=iptInputPrintPort);localPrintStorage.print=localPrintArrs}else{var localPrintArray=[],localPrintStorage={};localPrintArray.push(localPrint),localPrintStorage.defaultId=localPrint.id,localPrintStorage.print=localPrintArray}localStorage.setItem("localPrint",JSON.stringify(localPrintStorage)),self.closePrintBox("bShowPrintAddBox",m_arrId.settingAddBox),self.readLocalPrint(),self.LoadPrintToSelelct(m_arrConfigId.printer,"pointer")}else layer.msg("请输入打印机的端口号");else layer.msg("请输入正确的IP地址");else layer.msg("请输入打印机的IP地址");else layer.msg("请输入打印机的AETitle");else layer.msg("请输入打印机的名称")}(activityId);break;case"printCancelBox":self.closePrintBox("bShowPrintAddBox",m_arrId.settingAddBox)}}),$(m_arrConfigId.direct+","+m_arrConfigId.size+","+m_arrConfigId.color+","+m_arrConfigId.printer).bind("change",function(event){MsgProxy(event)}),$(m_arrConfigId.startPrint+","+m_arrConfigId.cancelPrint+","+m_arrConfigId.printSetting).bind("click mouseenter mouseout",function(event){MsgProxy(event)})},FlushPageInfo=function(){$("#"+m_arrId.pageInfo).html(m_pageIndex+"/"+m_arrCanvasCount.length)},GetCurShowImage=function(pageIndex){null==pageIndex&&(pageIndex=m_pageIndex);for(var startIndex=0,i=0;i<pageIndex-1;i++){var data=m_arrCanvasCount[i];startIndex+=data.row*data.col}var layout=m_arrCanvasCount[pageIndex-1],layout=layout.row*layout.col+startIndex;return layout>m_arrPrintImgs.length&&(layout=m_arrPrintImgs.length),m_arrPrintImgs.slice(startIndex,layout)},FlushCurPageImage=function(bForce){var arrSel=GetCurShowImage(),arrCanvas=m_mng.GetAllCanvas();opt.msgtransform&&opt.msgtransform({type:"draw",arrcanvas:arrCanvas,arrannstatus:arrSel,bforce:bForce})},FlushScrollInfo=function(){var index;m_mng&&(index=1<m_arrCanvasCount.length?(m_mng.EnableScroll(!0),m_pageIndex>m_arrCanvasCount.length?m_arrCanvasCount.length:m_pageIndex):(m_mng.EnableScroll(!1),1),m_mng.scroll.SetRange(m_arrCanvasCount.length,index))},FlushCanvasCountArray=function(){var imgNums=m_arrPrintImgs.length;if(imgNums){for(var tmparr=m_arrCanvasCount,i=(m_arrCanvasCount=[],0),j=0;j<imgNums;){var data=(data=tmparr[i])||new PageGrid;m_arrCanvasCount.push(data),j+=data.row*data.col,i++}m_pageIndex>m_arrCanvasCount.length&&(m_pageIndex=m_arrCanvasCount.length)}},GetPrintCfgInfo=function(){var key,cfgData={};for(key in m_arrConfigId){var ctrlID=m_arrConfigId[key],ctrlID=("mode"==key?$(ctrlID+" input:checked"):$(ctrlID).find("option:selected")).val();cfgData[key]=ctrlID}return cfgData},RequestDrawCurPage=function(index,bFChangs){index&&!isNaN(index)&&(m_pageIndex=index);var data=m_arrCanvasCount[m_pageIndex-1];if(data&&(bFChangs||!RecordCurPageLayout(data)))switch(data.type){case"left":case"top":case"right":case"bottom":m_mng.LayoutSp3(data.type);break;default:m_mng.SetLayout(data.row,data.col)}FlushCurPageImage(!0),FlushPageInfo(),UpdateCtrlStatus()},ClearMemory=function(){m_arrPrintImgs=[],m_arrCanvasCount=[],m_pageIndex=1,m_recordCurPageLayout=new PageGrid,m_arrCanvasCount.push(m_recordCurPageLayout),m_mng.SetLayout(1,1),FlushScrollInfo(),FlushPageInfo(),UpdateCtrlStatus()},PushItem=function(options){var options=$.extend(!0,{parent:null,iconstr:"",title:"",angle:0,size:30,margin:{left:0,top:0,right:0,bottom:0},padding:{left:0,top:0,right:0,bottom:0}},options),itemID=CBoBo.Plugin.GetRandom(),innerStr="<div id='"+itemID+"' title='"+options.title+"'>"+options.iconstr+"</div>",innerStr=$(innerStr).appendTo($(options.parent));return $("#"+itemID).bind("click mouseenter mouseout",function(event){MsgProxy(event)}),innerStr.css({transform:"rotate("+options.angle+"deg)","font-size":options.size+"px",float:"left","padding-left":options.padding.left+"px","padding-top":options.padding.top+"px","padding-right":options.padding.right+"px","padding-bottom":options.padding.bottom+"px","margin-left":options.margin.left+"px","margin-top":options.margin.top+"px","margin-right":options.margin.right+"px","margin-bottom":options.margin.bottom+"px",cursor:"pointer",color:"#888"}),itemID},PushSelectCtrl=function(parentID,title){var itemID,ctrlID;if(null!=title&&null!=parentID)return itemID=CBoBo.Plugin.GetRandom(),ctrlID=CBoBo.Plugin.GetRandom(),$("<div id='"+ctrlID+"'><span>"+title+"</span><select id='"+itemID+"' title='"+title+"'></select></div>").appendTo($(parentID)).css({float:"left",width:"100%","text-align":"center",height:"45px","margin-top":"6px"}),$("#"+ctrlID+" span").css({width:"90%","font-size":"14px",height:"20px",cursor:"default"}),$("#"+itemID).css({width:"90%",cursor:"pointer",height:"25px"}),itemID},InsertForSelCtrl=function(parentID,string,value){null!=string&&$("<option value='"+value+"'>"+string+"</option>").appendTo($(parentID))},DeleteSelCtrl=function(id){$(id).empty()},PushBtnCtrl=function(parentID,title,flag){var itemID;if(null!=title&&null!=parentID)return itemID=CBoBo.Plugin.GetRandom(),title=$("<div><button id='"+itemID+"' title='"+title+"'name='"+flag+"'>"+title+"</button></div>").appendTo($(parentID)),"printSetting"===flag?title.css({float:"left",width:"100%",height:"30px","text-align":"center","margin-top":"100px"}):title.css({float:"left",width:"100%",height:"30px","text-align":"center","margin-top":"6px"}),$("#"+itemID).css({width:"90%",height:"30px",background:"#555555",color:"#CCCCC4",border:"none","font-size":"14px","font-weight":"bold","border-radius":"5px",cursor:"pointer"}),itemID};this.Show=function(bShow){var printBox=$("#"+m_arrId.ctrl);bShow?(LoadPrintThumbnail(),printBox.fadeIn(300),this.bShow=!0):(printBox.fadeOut(500),this.bShow=!1)},this.RequestPrint=function(arrAnnStatus){if(arrAnnStatus&&!(arrAnnStatus.length<1)){for(var i=0;i<arrAnnStatus.length;i++){var annStatus=arrAnnStatus[i];annStatus.type==CBoBo.PTYPE_SERIES&&(annStatus.type=CBoBo.PTYPE_DESERIES),annStatus.type==CBoBo.PTYPE_JPG?$.Msg("不支持超声打印!"):(annStatus.bPrint=!0,annStatus.status.bDrawText=!0,m_arrPrintImgs.push(annStatus))}FlushCanvasCountArray(),FlushPageInfo(),FlushScrollInfo(),FlushCurPageImage(!0),UpdateCtrlStatus()}},options(),UpdateStyle(),UpdateWinPosition(),UpdateCtrlStatus(),new CBoBo.View.CMngFirstLayer,(m_toolBar=new CBoBo.View.PCToolBar({parent:"#"+m_arrId.toolId,axis:"y",bottonbox:!1})).RequestToolBar(CBoBo.TOOLMENU_PRINT_RADIATE,ToolBarMsg),m_toolBar.ChangeBtnStatus("显/隐四角信息",!0),m_mng=new CBoBo.View.CMngFirstLayer({parent:"#"+m_arrId.canvasBox,single:!0,msgtransform:MsgProxy}),m_arrCanvasCount.push(new PageGrid),FlushScrollInfo(),m_mng.SetLayout(1,1),m_mng.SetDefaultFocus(0);options={parent:"#"+m_arrId.winLayoutId,iconstr:"&#xe667;",title:"1*1",angle:0,size:30,margin:{left:5,top:4,right:5,bottom:5},padding:{left:0,top:0,right:0,bottom:0}};PushItem(options),options="#"+m_arrId.configId,UpdateStyle="#"+PushSelectCtrl(options,"胶片尺寸"),m_arrConfigId.size=UpdateStyle,InsertForSelCtrl(UpdateStyle,"8INX10IN","8INX10IN"),InsertForSelCtrl(UpdateStyle,"10INX12IN","10INX12IN"),InsertForSelCtrl(UpdateStyle,"10INX14IN","10INX14IN"),InsertForSelCtrl(UpdateStyle,"11INX14IN","11INX14IN"),InsertForSelCtrl(UpdateStyle,"14INX14IN","14INX14IN"),InsertForSelCtrl(UpdateStyle,"14INX17IN","14INX17IN"),UpdateStyle="#"+PushSelectCtrl(options,"方向"),m_arrConfigId.direct=UpdateStyle,InsertForSelCtrl(UpdateStyle,"纵向","PORTRAIT"),InsertForSelCtrl(UpdateStyle,"横向","LANDSCAPE"),UpdateStyle="#"+PushSelectCtrl(options,"颜色"),m_arrConfigId.color=UpdateStyle,InsertForSelCtrl(UpdateStyle,"彩色","multicolour"),InsertForSelCtrl(UpdateStyle,"灰阶","grayscale"),UpdateStyle="#"+PushSelectCtrl(options,"打印机"),m_arrConfigId.printer=UpdateStyle,self.LoadPrintToSelelct(UpdateStyle,"pointer"),UpdateStyle="#"+PushBtnCtrl(options,"开始打印"),m_arrConfigId.startPrint=UpdateStyle,UpdateStyle="#"+PushBtnCtrl(options,"取消打印"),m_arrConfigId.cancelPrint=UpdateStyle,AddEvent()},CBoBo.View.DVPrintInfo=function(){this.DicomInfos=new Array,this.ImageDisplayFormat,this.Size,this.Direct},CBoBo.View.DVPrintImageInfo=function(){this.ID,this.WindowLevel,this.WindowWidth,this.Multiple,this.TopLeftLabels,this.TopRightLabels,this.DownLeftLabels,this.DownRightLabels,this.TopLabel,this.DownLabel,this.LeftLabel,this.RightLabel},CBoBo.View.DVPrintImageDescribe=function(){this.Describe=new Array},CBoBo.View.MenuBall=function(){this.breatheID,this.touchStartPosX,this.touchStartPosY,this.CircleLeft,this.CircleTop,this.CircleWidth,this.CircleHeight,this.breatheRadius,this.breatheCentreX,this.breatheCentreY,this.documentWidth,this.documentHeight,this.startTimeStamp,this.HomeMenu,this.CentreClick,this.CreateBall=function(){this.breatheID="#breatheBall";$('<div id="menuCircle" class=\'icon_tool\'><div id ="menuRing"></div><div id="breatheBall"></div></div>').appendTo($("body")),this.Int(),this.AddEnvent()},this.SetMainMenu=function(callback){this.HomeMenu=callback,this.HomeMenu()},this.Animation=function(index){switch(index){case 1:$("#menuRing").addClass("itemRingRotate"),setTimeout("$('#menuRing').removeClass('itemRingRotate');",700);break;case 2:$("#menuRing").addClass("itemRingRotate1"),setTimeout("$('#menuRing').removeClass('itemRingRotate1');",700);break;case 3:$("#menuRing").addClass("itemRingFade"),setTimeout("$('#menuRing').removeClass('itemRingFade');",700)}},this.CloseRingMenu=function(){$("#menuCircle").hasClass("open")&&$("#menuCircle").removeClass("open")},this.OpenRingMenu=function(event){$("#menuCircle").hasClass("open")||$("#menuCircle").addClass("open")},this.Clear=function(){$(".menuItem").unbind(),$("#menuRing").empty(),this.CentreClick=null},this.SetCentreIcon=function(iconFont){var centreIcon=$(this.breatheID);centreIcon.empty(),$("<span class=breatheBallCentre>"+iconFont+"</span>").appendTo(centreIcon)},this.Push=function(iconFont,itemName,callback,angle){null==itemName&&(itemName="");var firstP,lastP,objthis,itemID="cMenuItem"+CBoBo.Plugin.GetRandom(),innerStr=(innerStr=(innerStr="<div class='menuItem' id=\"")+itemID+("\" title='"+itemName+"'><p style='pointer-events:none;'>"+iconFont+"</p><p class=\"itemTitle\" style='pointer-events:none;'>"))+itemName+"</p></div>";$(innerStr).appendTo($("#menuRing")),null!=callback&&(firstP=(iconFont="#"+itemID)+" p:first-child",lastP=iconFont+" p:last-child",objthis=this,$(iconFont).bind("touchstart",function(event){objthis.startTimeStamp=event.timeStamp,$(lastP).css("color","#67CBFA")}),$(iconFont).bind("touchend",function(event){var className;event.timeStamp-objthis.startTimeStamp<200&&(className=$(firstP).text(),objthis.SetCentreIcon(className),callback(event)),$(lastP).css("color","#FFF")})),angle&&$(firstP).css({transform:"rotate("+angle+"deg)"})},this.PushImage=function(url,title,callback){var firstP,lastP,objthis,itemID=CBoBo.Plugin.GetRandom();$("<div class='menuItem' id='"+itemID+"' title='"+title+"'><img class='pseudocolor' src='"+url+"'/><div class='itemTitle' style='pointer-events:none;'>"+title+"</div></div>").appendTo($("#menuRing")),null!=callback&&(firstP=(url="#"+itemID)+" p:first-child",lastP=url+" p:last-child",objthis=this,$(url).bind("touchstart",function(event){objthis.startTimeStamp=event.timeStamp,$(lastP).css("color","#67CBFA")}),$(url).bind("touchend",function(event){var className;event.timeStamp-objthis.startTimeStamp<200&&(className=$(firstP).text(),objthis.SetCentreIcon(className),callback(event)),$(lastP).css("color","#FFF")}))},this.FlushMenu=function(){for(var items=document.querySelectorAll(".menuItem"),i=0,l=items.length;i<l;i++)items[i].style.left=(50-35*Math.cos(-.5*Math.PI-1/l*2*i*Math.PI)).toFixed(4)+"%",items[i].style.top=(50+35*Math.sin(-.5*Math.PI-1/l*2*i*Math.PI)).toFixed(4)+"%"},this.Int=function(){this.breatheRadius=$(this.breatheID).width()/2,this.documentWidth=$(window).width()-1,this.documentHeight=$(window).height()-1,this.CircleWidth=$("#menuCircle").width(),this.CircleHeight=$("#menuCircle").height()},this.AddEnvent=function(){var objthis=this;$(this.breatheID).bind("touchstart",function(event){objthis.BreatheTouchStart(event)}),$(this.breatheID).bind("touchmove",function(event){objthis.BreatheTouchMove(event)}),$(this.breatheID).bind("touchend",function(event){objthis.BreatheTouchEnd(event)}),$(document).bind("touchstart",function(event){objthis.DocumentTouchStart(event)}),$(document).bind("touchend",function(event){objthis.DocumentTouchEnd(event)}),$("#menuCircle").bind("touchmove touchstart touchend",function(event){objthis.CircleEvent(event)})},this.WindowResize=function(event){var newWinWidth=$(window).width(),newWinHeight=$(window).height(),_L=(this.CircleLeft=$("#menuCircle").offset().left,this.CircleTop=$("#menuCircle").offset().top,this.CircleLeft*newWinWidth/this.documentWidth),_T=this.CircleTop*newWinHeight/this.documentHeight,maxWidth=newWinWidth-this.CircleWidth/2-this.breatheRadius-2,minWidth=-this.CircleWidth/2+this.breatheRadius+2,maxHeight=newWinHeight-this.CircleHeight/2-this.breatheRadius-2,minHeight=-this.CircleHeight/2+this.breatheRadius+2;maxWidth<_L?_L=maxWidth:_L<minWidth&&(_L=minWidth),maxHeight<_T?_T=maxHeight:_T<minHeight&&(_T=minHeight),$("#menuCircle").css({left:_L+"px",top:_T+"px"}),this.documentWidth=newWinWidth,this.documentHeight=newWinHeight},this.BreatheTouchStart=function(event){this.startTimeStamp=event.timeStamp;event=event.originalEvent.targetTouches[0];this.touchStartPosX=event.screenX,this.touchStartPosY=event.screenY,this.CircleLeft=$("#menuCircle").offset().left,this.CircleTop=$("#menuCircle").offset().top},this.BreatheTouchMove=function(event){event.preventDefault();var event=event.originalEvent.targetTouches[0],event=(this.breatheCentreX=event.screenX,this.breatheCentreY=event.screenY,this.breatheCentreX-this.touchStartPosX+this.CircleLeft),_T=this.breatheCentreY-this.touchStartPosY+this.CircleTop,maxWidth=this.documentWidth-this.CircleWidth-2,maxHeight=this.documentHeight-this.CircleHeight-2;maxWidth<event?event=maxWidth:event<1&&(event=1),maxHeight<_T?_T=maxHeight:_T<1&&(_T=1),$("#menuCircle").css({left:event+"px",top:_T+"px"})},this.SetCentreClick=function(callback){this.CentreClick=callback},this.BreatheTouchEnd=function(event){event.timeStamp-this.startTimeStamp<200&&(null==this.CentreClick||null==this.CentreClick?0<document.querySelectorAll(".menuItem").length&&$("#menuCircle").toggleClass("open"):(this.CentreClick(),this.CentreClick=null))},this.DocumentTouchStart=function(event){this.startTimeStamp=event.timeStamp},this.DocumentTouchEnd=function(event){event.timeStamp-this.startTimeStamp<200&&(this.CloseRingMenu(),this.Clear(),this.HomeMenu())},this.CircleEvent=function(event){event.stopPropagation(),event.preventDefault()}},CBoBo.View.MobileMenuBall=function(data){var m_Type,m_LayoutType,self=this,m_MsgTransform=(this.menuBall,data.msgtransform),m_bMpr=!1,SetMenuBallHome=(this.toolType,this.bShowCornerInfo=!0,this.menuBall=new CBoBo.View.MenuBall,this.menuBall.CreateBall(),this.SeriesHomeMenu=function(){self.menuBall.Push("&#xe67f;","重新加载",self.MsgTransform),self.menuBall.Push("&#xe61b;","调窗",self.MsgTransform),self.menuBall.Push("&#xe603;","负像",self.MsgTransform),self.menuBall.Push("&#xe644;","恢复",self.MsgTransform),self.menuBall.Push("&#xe653;","删除图像",self.MsgTransform),self.menuBall.Push("&#xe604;","测量",self.MsgTransform),self.menuBall.Push("&#xe60d;","旋转",self.MsgTransform),self.menuBall.Push("&#xe62a;","图像布局",self.MsgTransform),self.menuBall.Push("&#xe63d;","序列布局",self.MsgTransform),self.menuBall.Push("&#xe602;","伪彩",self.MsgTransform),self.menuBall.Push("&#xe643;","MPR",self.MsgTransform),self.menuBall.FlushMenu()},this.DeSeriesHomeMenu=function(){self.menuBall.Push("&#xe67f;","重新加载",self.MsgTransform),self.menuBall.Push("&#xe61b;","调窗",self.MsgTransform),self.menuBall.Push("&#xe603;","负像",self.MsgTransform),self.menuBall.Push("&#xe644;","恢复",self.MsgTransform),self.menuBall.Push("&#xe653;","删除图像",self.MsgTransform),self.menuBall.Push("&#xe604;","测量",self.MsgTransform),self.menuBall.Push("&#xe60d;","旋转",self.MsgTransform),self.menuBall.Push("&#xe62a;","图像布局",self.MsgTransform),self.menuBall.Push("&#xe63d;","序列布局",self.MsgTransform),self.menuBall.Push("&#xe602;","伪彩",self.MsgTransform),self.menuBall.FlushMenu()},this.JpgHomeMenu=function(){self.menuBall.Push("&#xe67f;","重新加载",self.MsgTransform),self.menuBall.Push("&#xe61b;","亮/对比",self.MsgTransform),self.menuBall.Push("&#xe603;","负像",self.MsgTransform),self.menuBall.Push("&#xe644;","恢复",self.MsgTransform),self.menuBall.Push("&#xe653;","删除图像",self.MsgTransform),self.menuBall.Push("&#xe62a;","图像布局",self.MsgTransform),self.menuBall.Push("&#xe602;","伪彩",self.MsgTransform),self.menuBall.FlushMenu()},this.MprHomeMenu=function(){self.menuBall.Push("&#xe658;","2D",self.MsgTransform),self.menuBall.Push("&#xe61b;","切面调窗",self.MsgTransform),self.menuBall.Push("&#xe6aa;","十字切面",self.MsgTransform),self.menuBall.FlushMenu()},this.MsgTransform=function(event){switch(event.target.title){case"测量":self.MeasureMenu();break;case"旋转":self.RotateMenu();break;case"图像布局":case"序列布局":m_LayoutType=event.target.title,self.LayoutMenu();break;case"伪彩":self.PseudoColor();break;case"调窗":case"亮/对比":case"恢复":case"移动":case"负像":case"删除图像":case"直线":case"矩形":case"CT":case"椭圆":case"文本":case"箭头":case"左标记":case"右标记":case"重新加载":case"切面调窗":case"十字切面":self.menuBall.CloseRingMenu(),void 0!==m_MsgTransform&&m_MsgTransform(event);break;case"1x1":event={target:{title:"布局控件"},row:1,col:1,ctrltype:m_LayoutType},null!=m_MsgTransform&&m_MsgTransform(event);break;case"1x2":event={target:{title:"布局控件"},row:1,col:2,ctrltype:m_LayoutType},null!=m_MsgTransform&&m_MsgTransform(event);break;case"2x1":event={target:{title:"布局控件"},row:2,col:1,ctrltype:m_LayoutType},null!=m_MsgTransform&&m_MsgTransform(event);break;case"2x2":event={target:{title:"布局控件"},row:2,col:2,ctrltype:m_LayoutType},null!=m_MsgTransform&&m_MsgTransform(event);break;case"2x3":event={target:{title:"布局控件"},row:2,col:3,ctrltype:m_LayoutType},null!=m_MsgTransform&&m_MsgTransform(event);break;case"3x2":event={target:{title:"布局控件"},row:3,col:2,ctrltype:m_LayoutType},null!=m_MsgTransform&&m_MsgTransform(event);break;case"3x3":event={target:{title:"布局控件"},row:3,col:3,ctrltype:m_LayoutType},null!=m_MsgTransform&&m_MsgTransform(event);break;case"MPR":m_bMpr=!0,self.Clear(),SetMenuBallHome(),m_MsgTransform&&m_MsgTransform(event);break;case"2D":m_bMpr=!1,self.Clear(),SetMenuBallHome();default:null!=m_MsgTransform&&m_MsgTransform(event)}},this.RequestToolBall=function(toolType,msg){toolType===m_Type&&m_MsgTransform===msg||(m_Type=toolType,m_MsgTransform=msg,SetMenuBallHome())},this.PseudoColor=function(){self.Clear(3);var url="./dicomviewer/css/pseudocolor/";self.menuBall.PushImage(url+"0.jpg","灰色",self.MsgTransform),self.menuBall.PushImage(url+"1.jpg","彩虹",self.MsgTransform),self.menuBall.PushImage(url+"2.jpg","黑体",self.MsgTransform),self.menuBall.PushImage(url+"3.jpg","骨骼",self.MsgTransform),self.menuBall.PushImage(url+"4.jpg","心脏",self.MsgTransform),self.menuBall.PushImage(url+"5.jpg","流动",self.MsgTransform),self.menuBall.PushImage(url+"6.jpg","Ge色",self.MsgTransform),self.menuBall.PushImage(url+"8.jpg","热绿",self.MsgTransform),self.menuBall.PushImage(url+"9.jpg","铬铁",self.MsgTransform),self.menuBall.PushImage(url+"10.jpg","热金属",self.MsgTransform),self.menuBall.FlushMenu(),self.menuBall.SetCentreClick(self.BackHome)},this.RotateMenu=function(){self.Clear(3),self.menuBall.Push("&#xe61d;","逆时针",self.MsgTransform),self.menuBall.Push("&#xe61c;","顺时针",self.MsgTransform),self.menuBall.Push("&#xe63a;","左右镜像",self.MsgTransform),self.menuBall.Push("&#xe639;","上下镜像",self.MsgTransform),self.menuBall.FlushMenu(),self.menuBall.SetCentreClick(self.BackHome)},this.MeasureMenu=function(){self.Clear(3),self.menuBall.Push("&#xe61f;","直线",self.MsgTransform),self.menuBall.Push("&#xe619;","矩形",self.MsgTransform),self.menuBall.Push("&#xe637;","CT",self.MsgTransform),self.menuBall.Push("&#xe61e;","椭圆",self.MsgTransform),self.menuBall.Push("&#xe629;","文本",self.MsgTransform),self.menuBall.Push("&#xe62f;","箭头",self.MsgTransform),self.menuBall.Push("L","左标记",self.MsgTransform),self.menuBall.Push("R","右标记",self.MsgTransform),self.menuBall.Push("&#xe622;","撤销",self.MsgTransform),self.menuBall.FlushMenu(),self.menuBall.SetCentreClick(self.BackHome)},this.LayoutMenu=function(){self.Clear(3),self.menuBall.Push("&#xe667;","1x1",self.MsgTransform),self.menuBall.Push("&#xe66f;","1x2",self.MsgTransform,90),self.menuBall.Push("&#xe66f;","2x1",self.MsgTransform),self.menuBall.Push("&#xe66e;","2x2",self.MsgTransform),self.menuBall.Push("&#xe66a;","3x2",self.MsgTransform,90),self.menuBall.Push("&#xe66a;","2x3",self.MsgTransform),self.menuBall.Push("&#xe66d;","3x3",self.MsgTransform),self.menuBall.FlushMenu(),self.menuBall.SetCentreClick(self.BackHome)},this.Clear=function(index){void 0!==index&&self.menuBall.Animation(index),self.menuBall.Clear()},this.BackHome=function(){self.Clear(3),m_bMpr?self.MprHomeMenu():m_Type==CBoBo.PTYPE_JPG?self.JpgHomeMenu():m_Type==CBoBo.PTYPE_SERIES?self.SeriesHomeMenu():self.DeSeriesHomeMenu(),self.menuBall.OpenRingMenu()},function(){m_bMpr?self.menuBall.SetMainMenu(self.MprHomeMenu):m_Type==CBoBo.PTYPE_JPG?self.menuBall.SetMainMenu(self.JpgHomeMenu):m_Type==CBoBo.PTYPE_SERIES?self.menuBall.SetMainMenu(self.SeriesHomeMenu):self.menuBall.SetMainMenu(self.DeSeriesHomeMenu)})},CBoBo.View.SeriesPlayer=function(options){this.bShow;var bPlay,m_timer,rangeMap=1,playPos=1,opt=$.extend(!0,{msgtransform:null},options),arrId={},m_mng=null,MsgAgent=function(event){var bSubSwitch=!0,bCall=!0;if(bSubSwitch=rangeMap<2?!1:bSubSwitch){var playFunc=$("."+arrId.playItem).eq(2);switch(event.target.title){case"第一张":playPos=1;break;case"上一张":playPos=--playPos<1?1:playPos;break;case"播放":null!=opt.msgtransform&&(event.usermsg="seriesplay",event.value=playPos,opt.msgtransform(event)),SetPlayTimer(),playFunc.html("&#xe713;"),playFunc.attr("title","暂停"),bPlay=!(bCall=!1);break;case"暂停":KillPlayTimer(),setTimeout(function(){null!=opt.msgtransform&&(event.usermsg="seriesplay",event.value=playPos,opt.msgtransform(event)),playFunc.html("&#xe724;"),playFunc.attr("title","播放")},100),bCall=bPlay=!1;break;case"下一张":playPos=++playPos>rangeMap?rangeMap:playPos;break;case"最后一张":playPos=rangeMap;break;case"播放速度":bPlay&&(KillPlayTimer(),SetPlayTimer()),bCall=!1}}UpdatePlayBtnState(),null!=opt.msgtransform&&bCall&&("userdocument"==event.userdocument?opt.msgtransform({usermsg:"seriesplay",value:playPos,userdocument:"userdocument"}):opt.msgtransform({usermsg:"seriesplay",value:playPos}))},SetPlayTimer=function(){var speed=$("#"+arrId.playSpeed).val();null!=speed&&($("body").css("pointer-events","none"),m_timer=setInterval(function(){++playPos>rangeMap&&(playPos=1);null!=opt.msgtransform&&opt.msgtransform({usermsg:"seriesplay",value:playPos})},1e3/speed))},KillPlayTimer=function(){clearInterval(m_timer),m_timer=null,$("body").css("pointer-events","auto")},UpdatePlayBtnState=function(){var item=$("."+arrId.playItem),playFirst=item.eq(0),playPre=item.eq(1),playFunc=item.eq(2),playNext=item.eq(3),item=item.eq(4);rangeMap<2?(playFirst.css({"pointer-events":"none",color:"gray"}),playPre.css({"pointer-events":"none",color:"gray"}),playFunc.css({"pointer-events":"none",color:"gray"}),playNext.css({"pointer-events":"none",color:"gray"}),item.css({"pointer-events":"none",color:"gray"})):bPlay?(playFirst.css({"pointer-events":"none",color:"gray"}),playPre.css({"pointer-events":"none",color:"gray"}),playFunc.css({"pointer-events":"auto",color:"#33FFFF"}),playNext.css({"pointer-events":"none",color:"gray"}),item.css({"pointer-events":"none",color:"gray"})):playPos<2?(playFirst.css({"pointer-events":"none",color:"gray"}),playPre.css({"pointer-events":"none",color:"gray"}),playFunc.css({"pointer-events":"auto",color:"#33FFFF"}),playNext.css({"pointer-events":"auto",color:"#33FFFF"}),item.css({"pointer-events":"auto",color:"#33FFFF"})):rangeMap-1<playPos?(playFirst.css({"pointer-events":"auto",color:"#33FFFF"}),playPre.css({"pointer-events":"auto",color:"#33FFFF"}),playFunc.css({"pointer-events":"auto",color:"#33FFFF"}),playNext.css({"pointer-events":"none",color:"gray"}),item.css({"pointer-events":"none",color:"gray"})):(playFirst.css({"pointer-events":"auto",color:"#33FFFF"}),playPre.css({"pointer-events":"auto",color:"#33FFFF"}),playFunc.css({"pointer-events":"auto",color:"#33FFFF"}),playNext.css({"pointer-events":"auto",color:"#33FFFF"}),item.css({"pointer-events":"auto",color:"#33FFFF"})),$("#"+arrId.playSpeed).css({"pointer-events":"auto"})};this.SetPosition=function(x,y){$("#"+arrId.ctrl).css({left:x+"px",top:y+"px"})},this.Show=function(bShow){var ctrl=$("#"+arrId.ctrl);bShow?(this.bShow=!0,ctrl.hide(),ctrl.show(200)):(this.bShow=!1,ctrl.hide(400))},this.SetRange=function(nums,pos){isNaN(nums)||(rangeMap=nums,null==(playPos=pos)&&(playPos=1),bPlay=!1,(nums=$("."+arrId.playItem).eq(2)).html("&#xe724;"),nums.attr("title","播放"),UpdatePlayBtnState())},this.TriggerClick=function(index){$("."+arrId.playItem).eq(index).triggerHandler("click")},this.SaveSeriesTag=function(mng){m_mng=mng},this.GetSeriesTag=function(){return m_mng},arrId.ctrl=CBoBo.Plugin.GetRandom(),arrId.playItem=CBoBo.Plugin.GetRandom(),arrId.playfps=CBoBo.Plugin.GetRandom(),arrId.playSpeed=CBoBo.Plugin.GetRandom(),options="<div id='"+arrId.ctrl+"' class='icon-player'><ul>",options=(options=(options=(options=(options=(options=(options+="<li><span class='player "+arrId.playItem+"' title='第一张'>&#xe76a;</span></li>")+"<li><span class='player "+arrId.playItem+"' title='上一张'>&#xe68d;</span></li>")+"<li><span class='player "+arrId.playItem+"' title='播放'>&#xe724;</span></li>")+"<li><span class='player "+arrId.playItem+"' title='下一张'>&#xe68c;</span></li>")+"<li><span class='player "+arrId.playItem+"' title='最后一张'>&#xe769;</span></li>")+"<li><span  id='"+arrId.playfps+"'>FPS</span></li>")+"<li><input id='"+arrId.playSpeed+"' type='number' min='1' max='50' value='10' title='播放速度'/></li></ul></div>",$(options).appendTo($("body")).width(293).height(40).css({position:"absolute",background:"rgba(0,0,0,1)","z-index":11111,border:"1px solid #33FFFF","border-radius":"6px 6px","user-select":"none","line-height":"40px"}),$("#"+arrId.ctrl+" ul").css({"list-style":"none",position:"absolute",margin:"auto",left:0,top:0,bottom:0,right:0,padding:"0"}),$("#"+arrId.ctrl+" ul li").css({display:"inline-block"}),$("#"+arrId.playfps).css({"font-size":"16px","font-family":"Microsoft YaHei","margin-left":"10px","vertical-align":"middle",cursor:"default",color:"#FFF"}),$("#"+arrId.playSpeed).height(18).width(35).css({"margin-left":"5px","vertical-align":"middle"}),$("."+arrId.playItem).bind("click",function(event){MsgAgent(event),event.stopPropagation()}),$("#"+arrId.playSpeed).bind("change",function(event){MsgAgent(event)}),$(document).bind("click",function(event){event.userdocument="userdocument",MsgAgent(event)})},CBoBo.View.ContextMenu=function(options){var m_reserveData,m_ctrlId,opt=$.extend(!0,{offsetX:2,offsetY:2,speed:300,flash:!1,items:[],action:null},options),self=this;this.ctrl,this.bShow=!1,this.Create=function(){m_ctrlId="cbobo"+CBoBo.Plugin.GetRandom();var listr="",str=($.each(opt.items,function(i,itm){itm&&(listr+="<li title='"+itm.text+"' class='ctxmenu'><span>"+itm.text+"</span></li>")}),"<div id='"+m_ctrlId+"'><ul>"+listr+"</ul></div>");this.ctrl=$(str).appendTo("body"),this.ctrl.css({position:"absolute","border-radius":"5px","z-index":999999,"-webkit-user-select":"none","background-color":"rgba(56, 56, 56, 0.8)",border:"1px solid rgba(80, 80, 80, 1)","font-family":"tahoma, arial, sans-serif",color:"#FFF",display:"none","box-shadow":"-2px 2px 5px #000"}),$("#"+m_ctrlId+" ul").css({"list-style":"none",padding:"0",margin:"0"}),$("#"+m_ctrlId+" ul li").css({padding:"2px",margin:"0",display:"block"}),$("#"+m_ctrlId+" ul li span").css({"pointer-events":"none"})},this.SetPosition=function(left,top){return this.ctrl.css({left:left+"px",top:top+"px"}),this},this.Show=function(bShow){return(this.bShow=bShow)?(this.ctrl.hide(),opt.flash?this.ctrl.show(opt.speed):this.ctrl.show()):opt.flash?this.ctrl.hide(opt.speed):this.ctrl.hide(),this},this.UpdateStyle=function(){var winWidth=$(window).width(),winHeight=$(window).height(),winWidth=Math.max(winWidth,winHeight)/17>>0,winHeight=.1234*(winWidth=winWidth<63?63:winWidth)>>0,winHeight=(this.ctrl.css({width:winWidth+"px","font-size":winHeight+"px"}),.2*winWidth>>0);$("#"+m_ctrlId+" ul li").css({"padding-left":winHeight+"px"})},this.AddEvent=function(){CBoBo.Plugin.GetBrowserInfo().isMobile?($(document).bind("touchstart",function(event){self.Show(!1)}),$("#"+m_ctrlId+" li").bind("touchstart",function(event){event.reservedata=m_reserveData,event.btntitle=event.target.title,null!=opt.action&&opt.action(event),event.stopPropagation()})):($(document).bind("mousedown",function(event){1==event.which&&self.Show(!1)}),$("#"+m_ctrlId+" li").bind("mousedown",function(event){event.reservedata=m_reserveData,event.btntitle=event.target.title,null!=opt.action&&opt.action(event)}))},this.SetReserve=function(data){m_reserveData=data},this.GetReserve=function(){return m_reserveData},this.Destroy=function(){$("#"+m_ctrlId).remove()},self.Create(),self.UpdateStyle(),self.AddEvent()},CBoBo.View.Scroll=function(options){var self=this;this.opt=$.extend(!0,{parent:null,axis:"y",showbutton:!0,size:20,range:100,offset:0,railalign:"center",msgtransform:null},options),this.arrClass={},this.draggerPos=1,this.rangeMap=1,this.stack=[],null!=self.opt.parent&&(self.Create(),self.UpdateStyle(),self.AddEvent())},CBoBo.View.Scroll.prototype.GetId=function(key){switch(key){case"ctrl":return this.arrClass.ctrl=CBoBo.Plugin.GetRandom();case"buttonl_t":return this.arrClass.buttonl_t;case"buttonr_b":return this.arrClass.buttonr_b;case"container":return this.arrClass.container;case"dragger_bar":return this.arrClass.dragger_bar;case"dragger":return this.arrClass.dragger;case"dragger_rail":return this.arrClass.dragger_rail}},CBoBo.View.Scroll.prototype.Create=function(){this.arrClass.ctrl=CBoBo.Plugin.GetRandom(),this.arrClass.buttonl_t=CBoBo.Plugin.GetRandom(),this.arrClass.buttonr_b=CBoBo.Plugin.GetRandom(),this.arrClass.container=CBoBo.Plugin.GetRandom(),this.arrClass.dragger_bar=CBoBo.Plugin.GetRandom(),this.arrClass.dragger=CBoBo.Plugin.GetRandom(),this.arrClass.dragger_rail=CBoBo.Plugin.GetRandom(),"x"==this.opt.axis?(leftstr="&#xe6d5;",rightstr="&#xe6d6;"):"y"==this.opt.axis&&(leftstr="&#xe6d7;",rightstr="&#xe6d4;");var leftstr="<div id='"+this.arrClass.ctrl+"' class='icon-player'><span id='"+this.arrClass.buttonl_t+"'>"+leftstr+"</span><div id='"+this.arrClass.container+"'><div id='"+this.arrClass.dragger_bar+"'></div><div id='"+this.arrClass.dragger+"'><div id='"+this.arrClass.dragger_rail+"'></div></div></div><span id='"+this.arrClass.buttonr_b+"'>"+rightstr+"</span></div>",rightstr=$(leftstr).appendTo(this.opt.parent);return rightstr.css({position:"absolute","background-color":"#333333",color:"rgba(255,255,255,0.3)"}),rightstr},CBoBo.View.Scroll.prototype.SetRange=function(value,pos){isNaN(value)||value<1||(this.rangeMap=value,this.draggerPos=pos=null==pos?1:pos,this.UpdateStyle(),this.UpdateBtnStatus())},CBoBo.View.Scroll.prototype.UpdateStyle=function(){var parent=$(this.opt.parent);if(null!=parent){var ctrl=$("#"+this.arrClass.ctrl),buttonl_t=$("#"+this.arrClass.buttonl_t),buttonr_b=$("#"+this.arrClass.buttonr_b),container=$("#"+this.arrClass.container),dragger_bar=$("#"+this.arrClass.dragger_bar),dragger=$("#"+this.arrClass.dragger),dragger_rail=$("#"+this.arrClass.dragger_rail);if("x"==this.opt.axis){var ctrlWidth=parent.width()*this.opt.range/100>>0,ctrlWidth=(ctrl.width(ctrlWidth).height(this.opt.size),parent.width()-ctrlWidth>>1);ctrl.css({left:ctrlWidth+"px",bottom:this.opt.offset+"px"})}else if("y"==this.opt.axis){var ctrlWidth=parent.height()*this.opt.range/100>>0,parent=(ctrl.width(this.opt.size).height(ctrlWidth),parent.height()-ctrlWidth>>1),containerHeight=(ctrl.css({top:parent+"px",right:this.opt.offset+"px"}),CBoBo.IsTablet?(dragger_barHeight=containerHeight-10,buttonl_t.width(this.opt.size).height(this.opt.size).css({cursor:"pointer","font-size":"18px",position:"relative",Top:"0px"}),buttonr_b.width(this.opt.size).height(this.opt.size).css({cursor:"pointer","font-size":"18px",position:"relative",bottom:"8px"})):(buttonl_t.width(this.opt.size).height(this.opt.size).css({cursor:"pointer","font-size":this.opt.size+"px"}),buttonr_b.width(this.opt.size).height(this.opt.size).css({cursor:"pointer","font-size":this.opt.size+"px",position:"absolute",bottom:"0px"})),ctrlWidth-(this.opt.size<<1)-4),dragger_barHeight=(container.width(this.opt.size).height(containerHeight).css({position:"relative"}),containerHeight-2),ctrl=(CBoBo.IsTablet&&(dragger_barHeight=containerHeight-10),dragger_bar.width(this.opt.size).height(dragger_barHeight).css({"border-top":"1px solid #000","border-bottom":"1px solid #000"}),dragger_barHeight/this.rangeMap>>0),parent=(dragger_barHeight-(ctrl=ctrl<10?10:ctrl))*((this.draggerPos-1)/(this.rangeMap-1))+1,rail_width=(dragger.width(this.opt.size).height(ctrl).css({position:"absolute",top:parent+"px"}),this.opt.size-5);switch(dragger_rail.width(rail_width).height(ctrl).css({"background-color":"rgba(255,255,255,0.2)","border-radius":"1px"}),this.opt.railalign){case"left":case"top":case"right":case"bottom":break;case"center":var rail_left=(this.opt.size-rail_width)/2;dragger_rail.css({position:"absolute",left:rail_left+"px"})}}}},CBoBo.View.Scroll.prototype.AddEvent=function(){var self=this,m_recordPos=($(window).bind("resize",function(event){self.UpdateStyle()}),CBoBo.Plugin.GetBrowserInfo().isMobile?($("#"+this.arrClass.dragger).bind("touchstart",dragger_msg),$(document).bind("touchmove touchend",dragger_msg),$("#"+this.arrClass.buttonl_t).bind("touchstart",function(event){button_click("lt")}),$("#"+this.arrClass.buttonr_b).bind("touchstart",function(event){button_click("rb")}),$("#"+this.arrClass.container).bind("touchstart",function(event){container_click(event),dragger_start(event)})):($("#"+this.arrClass.dragger).bind("touchstart",dragger_msg),$(document).bind("touchmove touchend",dragger_msg),$("#"+this.arrClass.container).bind("touchstart",function(event){container_click(event),dragger_start(event)}),$("#"+this.arrClass.dragger).bind("mousedown",dragger_msg),$(document).bind("mousemove mouseup",dragger_msg),$("#"+this.arrClass.dragger_rail).bind("mouseenter mouseout",function(event){"mouseenter"==event.type?$(this).css({cursor:"pointer","background-color":"rgba(255,255,255,0.3)"}):"mouseout"==event.type&&$(this).css({cursor:"default","background-color":"rgba(255,255,255,0.2)"})}),$("#"+this.arrClass.buttonl_t).bind("mousedown",function(event){"mousedown"==event.type&&button_click("lt")}),$("#"+this.arrClass.buttonr_b).bind("mousedown",function(event){"mousedown"==event.type&&button_click("rb")}),$("#"+this.arrClass.container).bind("mousedown",function(event){container_click(event),dragger_start(event)})),1);function dragger_msg(event){switch(event.type){case"touchstart":case"mousedown":dragger_start(event);break;case"touchmove":case"mousemove":!function(event){{var dragger_lt,id;self.stack[0]&&(id=self.GetId("dragger_rail"),$("#"+id).triggerHandler("mouseenter"),self.evenType=event.type,"touchmove"==event.type?(id=event.originalEvent.targetTouches[0],"y"==self.opt.axis?dragger_lt=id.pageY-self.stack[1]+self.stack[2]:"x"==self.opt.axis&&(dragger_lt=id.pageX-self.stack[1]+self.stack[2])):"mousemove"==event.type&&("y"==self.opt.axis?dragger_lt=event.pageY-self.stack[1]+self.stack[2]:"x"==self.opt.axis&&(dragger_lt=event.pageX-self.stack[1]+self.stack[2])),dragger_lt=(dragger_lt=dragger_lt>self.stack[3]?self.stack[3]:dragger_lt)<1?1:dragger_lt,"y"==self.opt.axis?self.stack[4].css("top",dragger_lt+"px"):"x"==self.opt.axis&&self.stack[4].css("left",dragger_lt+"px"),self.draggerPos=Math.round(dragger_lt/(self.stack[3]/(self.rangeMap-1)))+1,m_recordPos!=self.draggerPos)&&(self.UpdateBtnStatus(),m_recordPos=self.draggerPos,self.opt.msgtransform({type:"scroll",value:self.draggerPos,scroll:self}))}}(event);break;case"touchend":case"mouseup":!function(){if(!(self.stack<1)){for(var i=0;i<5;i++)self.stack.pop();var id=self.GetId("dragger_rail");$("#"+id).triggerHandler("mouseout")}}()}}function dragger_start(event){var max_lt,pt={},touch=("touchstart"==event.type?(touch=event.originalEvent.targetTouches[0],pt.x=touch.pageX,pt.y=touch.pageY):"mousedown"==event.type&&(pt.x=event.pageX,pt.y=event.pageY),$("#"+self.arrClass.dragger)),draggerpos=touch.position(),dragger_bar=$("#"+self.arrClass.dragger_bar);self.stack.push(!0),"y"==self.opt.axis?(self.stack.push(pt.y),self.stack.push(draggerpos.top),max_lt=dragger_bar.height()-touch.height(),self.stack.push(max_lt)):"x"==self.opt.axis&&(self.stack.push(pt.x),self.stack.push(draggerpos.left),max_lt=dragger_bar.width()-touch.width(),self.stack.push(max_lt)),self.stack.push(touch),event.stopPropagation()}function button_click(direct){var record=self.draggerPos;"lt"==direct?(self.draggerPos--,self.draggerPos=self.draggerPos<1?1:self.draggerPos):"rb"==direct&&(self.draggerPos++,self.draggerPos=self.draggerPos>self.rangeMap?self.rangeMap:self.draggerPos),record!=self.draggerPos&&(self.FlushDraggerPos(),self.UpdateBtnStatus(),self.opt.msgtransform({type:"scroll",value:self.draggerPos,scroll:self}))}function container_click(event){var max_lt,pt={},touch=("touchstart"==event.type?(touch=event.originalEvent.targetTouches[0],pt.x=touch.pageX,pt.y=touch.pageY):"mousedown"==event.type&&(pt.x=event.pageX,pt.y=event.pageY),$("#"+self.arrClass.dragger)),event=$("#"+self.arrClass.dragger_bar),lt=1;"y"==self.opt.axis?(max_lt=event.height()-touch.height(),lt=pt.y-$("#"+self.arrClass.container).offset().top-touch.height()/2+1,touch.css("top",(lt=max_lt<(lt=lt<1?1:lt)?max_lt:lt)+"px")):"x"==self.opt.axis&&(max_lt=event.width()-touch.width(),lt=pt.x-$("#"+self.arrClass.container).offset().left-touch.width()/2+1,touch.css("left",(lt=max_lt<(lt=lt<1?1:lt)?max_lt:lt)+"px")),self.draggerPos=Math.ceil(lt/max_lt*self.rangeMap),self.UpdateBtnStatus(),self.opt.msgtransform({type:"scroll",value:self.draggerPos,scroll:self})}},CBoBo.View.Scroll.prototype.FlushDraggerPos=function(pos){null!=pos&&(this.draggerPos=pos);var top,pos=$("#"+this.arrClass.dragger),dragger_bar=$("#"+this.arrClass.dragger_bar);"y"==this.opt.axis?(top=(dragger_bar.height()-pos.height())*((this.draggerPos-1)/(this.rangeMap-1))+1,pos.css("top",top+"px")):"x"==this.opt.axis&&(top=(dragger_bar.width()-pos.width())*((this.draggerPos-1)/(this.rangeMap-1))+1,pos.css("left",top+"px"))},CBoBo.View.Scroll.prototype.TriggerClick=function(delta){id=0<delta?this.GetId("buttonl_t"):this.GetId("buttonr_b"),$("#"+id).triggerHandler("mousedown")},CBoBo.View.Scroll.prototype.TriggerDragger=function(pos){this.FlushDraggerPos(pos),this.UpdateBtnStatus(),this.opt.msgtransform&&this.opt.msgtransform({type:"scroll",value:pos,scroll:this})},CBoBo.View.Scroll.prototype.Enable=function(bEnable){var ctrl=$("#"+this.arrClass.ctrl),dragger=$("#"+this.arrClass.dragger);bEnable?(ctrl.css({"pointer-events":"auto"}),dragger.show()):(ctrl.css({"pointer-events":"none"}),dragger.hide())},CBoBo.View.Scroll.prototype.UpdateBtnStatus=function(){var tbtn=$("#"+this.arrClass.buttonl_t),bbtn=$("#"+this.arrClass.buttonr_b);1==this.draggerPos?(tbtn.css({color:"rgba(255,255,255,0.1)","pointer-events":"none"}),bbtn.css({color:"rgba(255,255,255,0.3)","pointer-events":""})):this.draggerPos==this.rangeMap?(tbtn.css({color:"rgba(255,255,255,0.3)","pointer-events":""}),bbtn.css({color:"rgba(255,255,255,0.1)","pointer-events":"none"})):(tbtn.css({color:"rgba(255,255,255,0.3)","pointer-events":""}),bbtn.css({color:"rgba(255,255,255,0.3)","pointer-events":""}))},CBoBo.View.Msg=function($){var m_status,msgStack=new function(){this.ctrl=CBoBo.Plugin.GetRandom();var arrMsg=[];this.Push=function(data){arrMsg.push(data),setTimeout(function(ctrl){var oid=ctrl.GetId();$.each(arrMsg,function(i,info){null!=info&&(info=info.GetId(),oid==info)&&(ctrl.Destroy(),arrMsg.splice(i,1))})},4e3,data);for(var maxHeight=0,bodyHeight=$("body").height(),recordIndex=-1,i=arrMsg.length-1;-1<i;i--)if(bodyHeight<(maxHeight+=(item=arrMsg[i]).Height())){recordIndex=i;break}for(var bottom=10,i=recordIndex+1;i<arrMsg.length;i++)(item=arrMsg[i]).SetBottom(bottom),bottom+=item.Height()+5;for(var item,i=0;i<recordIndex+1;i++)(item=arrMsg[i]).Destroy();arrMsg.splice(0,recordIndex+1)},this.Length=function(){return arrMsg.length}};function MsgInfo(msg,typeCode){var ctrl=CBoBo.Plugin.GetRandom();(function(){var icon;switch(typeCode){case CBoBo.MSG_SUCCESS:icon="&#xe63c;";break;case CBoBo.MSG_ERROR:icon="&#xe686;";break;default:CBoBo.MSG_ALERT;icon="&#xe628;"}$("<div id='"+ctrl+"'><span class='icon_tool'>"+icon+"</span><span>"+msg+"</span></div>").appendTo($("body"))})(),function(){var backgroud,iconColor,jqctrl=$("#"+ctrl);switch(typeCode){case CBoBo.MSG_SUCCESS:backgroud="#058912",iconColor="#08ED1F";break;case CBoBo.MSG_ERROR:backgroud="#F0120A",iconColor="#F0524D";break;default:CBoBo.MSG_ALERT;backgroud="#FAF003",iconColor="#525503"}jqctrl.css({position:"absolute",right:"10px",background:backgroud,height:"50px","box-shadow":"0 0 10px "+iconColor,padding:"5px","border-radius":"5px","pointer-events":"none","z-index":"9999999999999999",overflow:"hidden"});jqctrl=$("#"+ctrl+" span");jqctrl.css({color:"#000",height:"50px","font-weight":"bold",display:"flex","align-items":"center",float:"left"}),jqctrl.eq(0).css({"font-size":"35px","padding-right":"5px",color:iconColor})}();this.Width=function(){return $("#"+ctrl).width()+10},this.Height=function(){return $("#"+ctrl).height()+10},this.SetBottom=function(value){$("#"+ctrl).css({bottom:value+"px"})},this.Destroy=function(){var jqctrl=$("#"+ctrl);null!=jqctrl&&(jqctrl.fadeOut(500),setTimeout(function(){jqctrl.remove()},500))},this.GetId=function(){return ctrl}}function StatusInfo(string){function TimerPro(event){var ctrl=$("#"+ctrlId);ctrl.fadeOut(speed),setTimeout(function(){ctrl.remove(),m_status=void 0},speed)}var timer,speed=3e3,ctrlId=CBoBo.Plugin.GetRandom();$("<div id='"+ctrlId+"'><span>"+string+"</span></div>").appendTo($("body")).css({position:"absolute",bottom:"2px",color:"#33FFFF","pointer-events":"none",padding:"0 2px","z-index":"99999"}),timer=setTimeout(TimerPro,speed);this.Print=function(string){$("#"+ctrlId+" span").html(string),null!=timer&&clearTimeout(timer),timer=setTimeout(TimerPro,speed)}}$.extend({Msg:function(string,typeCode){msgStack.Push(new MsgInfo(string,typeCode))},Status:function(string){null==m_status?m_status=new StatusInfo(string):m_status.Print(string)}})}(jQuery),CBoBo.View.AI=function(options){this.bShow,this.isAIReuest=!1,this.isAIFinished=!1;var opt=$.extend(!0,{parent:null},options),ctrlId=CBoBo.Plugin.GetRandom();this.UpdateStyle=function(){var ctrl=$("#"+ctrlId),parent=$(opt.refrence),width=parent.width(),parent=parent.height();ctrl.width(width).height(parent)},this.Show=function(bShow){var ctrl=$("#"+ctrlId);bShow?(this.bShow=!0,ctrl.hide(),ctrl.fadeIn(400)):(this.bShow=!1,ctrl.fadeOut(400))},$("<div id='"+ctrlId+"'></div>").appendTo($(opt.refrence)).css({position:"absolute","z-index":1003,"-webkit-user-select":"none","background-color":"#535353","font-family":"tahoma, arial, sans-serif",color:"#FFF",display:"none"}),this.UpdateStyle(),options.parent="#"+ctrlId,options.aiRead=!0,this.secondCtrl=new CBoBo.View.CMngSecondLayer(options)},CBoBo.View.VRT=function(options){this.bShow;var m_series=null,defaults={mode:CBoBo.PTYPE_SERIES,parent:"body",msgtransform:null},opt=(this.bMsg,$.extend(!0,defaults,options)),ctrlId=CBoBo.Plugin.GetRandom();this.UpdateStyle=function(){var ctrl=$("#"+ctrlId),parent=$(opt.parent),width=parent.width(),parent=parent.height();ctrl.width(width).height(parent).css({left:"10px",top:"10px"})};this.Show=function(bShow){var ctrl=$("#"+ctrlId);bShow?(this.bShow=!0,ctrl.hide(),ctrl.fadeIn(400)):(this.bShow=!1,ctrl.fadeOut(400))},this.Series=function(series){if(null==series)return m_series;m_series=series,this.bMsg=!0},this.SetLayout=function(nums){this.mng.UpdateLayout(0,2,2),this.mng.SetSpBoundaryColor(0,"#FF0"),this.mng.SetSpBoundaryColor(1,"#F00"),this.mng.SetSpBoundaryColor(2,"#0F0"),this.mng.SetSpBoundaryColor(3,"#00F")},null!=(defaults=$("<div id='"+ctrlId+"'></div>").appendTo($(opt.parent)))&&defaults.css({position:"absolute","z-index":10001,"-webkit-user-select":"none","background-color":"#535353","font-family":"tahoma, arial, sans-serif",color:"#FFF",display:"none"}),this.UpdateStyle(),this.mng=new CBoBo.View.CMngFirstLayer({parent:"#"+ctrlId,single:!0,msgtransform:opt.msgtransform})},CBoBo.View.MPR=function(options){this.bShow;var layoutNums,m_series=null,defaults={mode:CBoBo.PTYPE_SERIES,parent:"body",msgtransform:null},opt=(this.bMsg,$.extend(!0,defaults,options)),ctrlId=CBoBo.Plugin.GetRandom();this.UpdateStyle=function(){var ctrl=$("#"+ctrlId),parent=$(opt.parent),width=parent.width(),parent=parent.height();ctrl.width(width).height(parent).css({left:"10px",top:"10px"})};this.Show=function(bShow){var ctrl=$("#"+ctrlId);bShow?(this.bShow=!0,ctrl.hide(),ctrl.fadeIn(400)):(this.bShow=!1,ctrl.fadeOut(400))},this.Series=function(series){if(null==series)return m_series;m_series=series,this.bMsg=!0},this.SetLayout=function(nums){layoutNums!==nums&&(3===nums?(this.mng.UpdateLayoutSp3(0,"left"),this.mng.SetSpBoundaryColor(0,"#F00"),this.mng.SetSpBoundaryColor(1,"#0F0"),this.mng.SetSpBoundaryColor(2,"#00F")):4===nums&&(this.mng.UpdateLayout(0,2,2),this.mng.SetSpBoundaryColor(0,"#F00"),this.mng.SetSpBoundaryColor(1,"#0F0"),this.mng.SetSpBoundaryColor(2,"#00F"),this.mng.SetSpBoundaryColor(3,"#FF0")),layoutNums=nums)},null!=(defaults=$("<div id='"+ctrlId+"'></div>").appendTo($(opt.parent)))&&defaults.css({position:"absolute","z-index":10001,"-webkit-user-select":"none","background-color":"#535353","font-family":"tahoma, arial, sans-serif",color:"#FFF",display:"none"}),this.UpdateStyle(),this.mng=new CBoBo.View.CMngFirstLayer({parent:"#"+ctrlId,single:!0,msgtransform:opt.msgtransform})},CBoBo.View.DicomScan=function(options){function PushLine(parent,key,value,decollator){decollator=key+(decollator=null==decollator?"&nbsp;&nbsp;&nbsp;&nbsp;":decollator),m_arrId.key||(m_arrId.key=CBoBo.Plugin.GetRandom()),m_arrId.value||(m_arrId.value=CBoBo.Plugin.GetRandom()),decollator="<div><span class='1604335943322'>"+decollator+"</span><span class='"+m_arrId.value+"'>"+value+"</span></div>",$(decollator).appendTo($(parent)).css({height:"25px","margin-left":"20px"}),(key=$("."+m_arrId.key)).css({color:"#FFF","font-size":"16px"}),(value=$("."+m_arrId.value)).css({color:"#DDD","font-size":"14px"})}var ptMDown,ptPos,bLdown,ctrl,self=this,opt=$.extend(!0,{msgtransform:null},options),m_arrId={};this.bShow;this.Show=function(bShow){var printBox=$("#"+m_arrId.ctrl);bShow?(printBox.fadeIn(300),this.bShow=!0):(printBox.fadeOut(800),this.bShow=!1)},this.SetDicomInfo=function(dicom){var container="#"+m_arrId.container;$(container).html(""),dicom&&(PushLine(container,"0008,0018",dicom.sopuid),PushLine(container,"0008,0020",dicom.studt),PushLine(container,"0008,0022",dicom.acqdt),PushLine(container,"0008,0030",dicom.stutm),PushLine(container,"0008,0032",dicom.acqtm),PushLine(container,"0008,0050",dicom.accnum),PushLine(container,"0008,0060",dicom.mod),PushLine(container,"0008,0070",dicom.manu),PushLine(container,"0008,0080",dicom.inst),PushLine(container,"0008,1030",dicom.studes),PushLine(container,"0008,103E",dicom.serdes),PushLine(container,"0010,0010",dicom.name),PushLine(container,"0010,0020",dicom.patid),PushLine(container,"0010,0030",dicom.birth),PushLine(container,"0010,0040",dicom.sex),PushLine(container,"0010,1010 ",dicom.age),PushLine(container,"0018,0050",dicom.sliceth),PushLine(container,"0018,0060",dicom.kv),PushLine(container,"0018,1151",dicom.ma),PushLine(container,"0020,0010",dicom.stuid),PushLine(container,"0020,000D",dicom.stuuid),PushLine(container,"0020,000E",dicom.seruid),PushLine(container,"0020,0011",dicom.serid),PushLine(container,"0020,0013",dicom.imgnum),PushLine(container,"0028,0002",dicom.sappix),PushLine(container,"0028,0004",dicom.phme),PushLine(container,"0028,0010",dicom.row),PushLine(container,"0028,0011",dicom.col),PushLine(container,"0028,0030",dicom.pixx+"/"+dicom.pixy),PushLine(container,"0028,0100",dicom.bita),PushLine(container,"0028,0101",dicom.bits),PushLine(container,"0028,0102",dicom.hbit),PushLine(container,"0028,0103",dicom.pixrep),PushLine(container,"0028,1050",dicom.wc),PushLine(container,"0028,1051",dicom.ww),PushLine(container,"0028,1052",dicom.rescin),PushLine(container,"0028,1053",dicom.rescsl),PushLine(container,"图像方位左",dicom.orl),PushLine(container,"图像方位上",dicom.ort),PushLine(container,"图像方位右",dicom.orr),PushLine(container,"图像方位下",dicom.orb)),$("#"+m_arrId.container).mCustomScrollbar({axis:"y",scrollbarPosition:"inside",scrollInertia:800,theme:"minimal"})},m_arrId.ctrl=CBoBo.Plugin.GetRandom(),m_arrId.title=CBoBo.Plugin.GetRandom(),m_arrId.container=CBoBo.Plugin.GetRandom(),options="<div id='"+m_arrId.ctrl+"' class='icon_tool'><div id='"+m_arrId.title+"'><span>Dicom信息</span><a>&#xe661;</a></div><div id='"+m_arrId.container+"'></div></div>",$(options).appendTo($("body")),function(){var ctrlWidth=(ctrlWidth=.5*$(window).width()>>0)<600?600:ctrlWidth,ctrlHeight=(ctrlHeight=.9*$(window).height()>>0)<300?300:ctrlHeight;$("#"+m_arrId.ctrl).width(ctrlWidth).height(ctrlHeight).css({border:"1px solid #676767",position:"absolute","z-index":11111,background:"#444444",display:"none","user-select":"none",color:"#CCCCC4"}),$("#"+m_arrId.title).css({height:"30px",width:"100%",background:"#555555",cursor:"default","border-bottom":"1px solid #000","text-align":"center"}),$("#"+m_arrId.title+" span").css({width:"15%",height:"100%","text-align":"center",display:"inline-block","font-size":"16px","line-height":"30px"}),$("#"+m_arrId.title+" a").css({display:"inline-block",position:"absolute",top:"3px",right:"5px",cursor:"pointer","font-size":"20px",color:"#000"});$("#"+m_arrId.container).width(ctrlWidth-6).height(ctrlHeight-6-30).css({"user-select":"auto",padding:"3px","font-family":"Microsoft YaHei",overflow:"auto"})}(),bLdown=!1,ctrl=$("#"+m_arrId.ctrl),$("#"+m_arrId.title).bind("mousedown",function(event){bLdown=!0,ptMDown=new Point(event.pageX,event.pageY);event=ctrl.offset();ptPos=new Point(event.left,event.top)}),$("#"+m_arrId.title+" a").bind("click",function(event){event.preventDefault(),self.Show(!1),opt.msgtransform&&(event.btntitle="DICOM信息",event.btnforce=!1,opt.msgtransform(event)),setTimeout(function(){ctrl.remove()},800)}),$(document).bind("mousemove mouseup",function(event){switch(event.type){case"mousemove":var disX,disY;bLdown&&(disX=event.pageX-ptMDown.x,disY=event.pageY-ptMDown.y,disX=disX+ptPos.x,disY=disY+ptPos.y,ctrl.css({left:disX+"px",top:disY+"px"}));break;case"mouseup":bLdown=!1}}),function(){var body=$("body"),ctrl=$("#"+m_arrId.ctrl),winWidth=body.width(),body=body.height(),ctrlWidth=ctrl.width(),ctrlHeight=ctrl.height();ctrl.css({left:(winWidth-ctrlWidth>>1)+"px",top:(body-ctrlHeight>>1)+"px"})}()},CBoBo.View.AutoScroll=function(options){},CBoBo.View.Config=function(){function Style(){var pWidth=(parent=$("body")).width(),parent=parent.height(),left=($("#"+m_arrId.ctrl).width(pWidth=pWidth<1150?1150:pWidth).height(parent-CBoBo.View.TOOLBAR_HEIGHT).css({top:CBoBo.View.TOOLBAR_HEIGHT}),$("#"+m_arrId.left)),lWidth=.08*pWidth;left.width(lWidth=lWidth<97?97:lWidth).height(parent-CBoBo.View.TOOLBAR_HEIGHT).css({display:"inline-block"}),$("#"+m_arrId.right).width(pWidth-lWidth-2).height(parent-CBoBo.View.TOOLBAR_HEIGHT).css({background:"#333333",display:"inline-block",position:"relative"}),left=.12*lWidth,$("."+m_arrId.headbtn).width(lWidth).height(60).css({"border-bottom":"1px solid #383838","line-height":"60px",cursor:"pointer","font-size":left+"px",color:"#efefef"}),$("."+m_arrId.headbtnicon).css({"font-size":1.5*left+"px","vertical-align":"middle",color:"#ccc"}),$("."+m_arrId.headbtn+" span").css({"pointer-events":"none",padding:"4px"})}var m_childStyle,str,headbtn,m_arrId={},focusIndex=(this.bShow=!1,0),BasePage=(this.TriggerResize=function(){Style(),m_childStyle&&m_childStyle()},function(){function Style(){$("#"+arrId.ctrl).css({width:"50%",height:"100%",position:"absolute",top:0,left:"60px",overflow:"hidden","font-family":"Microsoft Yahei"}),$("#"+arrId.selmodality).css({height:"100%",width:"20%",display:"inline-block","padding-top":"10px"}),$("#"+arrId.main).css({height:"100%",width:"70%",display:"inline-block","margin-left":"10%","padding-top":"10px"}),$("#"+arrId.radio).css({height:"20%",width:"100%"}),$("#"+arrId.checkbox).css({height:"20%",width:"100%"}),$("#"+arrId.layout).css({width:"100%"})}function UpdateLayout(modality,platform){var layoutString=CBoBo.Config.GetSeriesLayout(modality,platform),layoutString=($("input:radio[name='serieslayout']").each(function(){var icon=$(this).prev();this.value===layoutString?(this.checked=!0,icon.css("color","#F0F")):(this.checked=!1,icon.css("color","#FFF"))}),CBoBo.Config.GetImageLayout(modality,platform));$("input:radio[name='imagelayout']").each(function(){var icon=$(this).prev();this.value===layoutString?(this.checked=!0,icon.css("color","#F0F")):(this.checked=!1,icon.css("color","#FFF"))})}function SetPageConfig(modality){var imageShowValue=CBoBo.Config.GetImageShowMode(modality),thumbPositionValue=($("input:radio[name='imageshow']").each(function(){this.value===imageShowValue?this.checked=!0:this.checked=!1}),CBoBo.Config.GetThumbPosition(modality)),mouseOpareteString=($("input:radio[name='thumbposition']").each(function(){this.value===thumbPositionValue?this.checked=!0:this.checked=!1}),CBoBo.Config.GetMouseLeft(modality));$(arrId.mouseLeft).val(mouseOpareteString),mouseOpareteString=CBoBo.Config.GetMouseRight(modality),$(arrId.mouseRight).val(mouseOpareteString),mouseOpareteString=CBoBo.Config.GetMouseMiddle(modality),$(arrId.mouseMiddle).val(mouseOpareteString),mouseOpareteString=CBoBo.Config.GetMouseMiddleRoll(modality),$(arrId.mouseMiddleRoll).val(mouseOpareteString),$(arrId.platform).val("pc"),UpdateLayout(modality,"pc")}function SetOparete(type,value){switch(type){case"imageshow":CBoBo.Config.SetImageShowMode(g_modality,value);break;case"thumbposition":CBoBo.Config.SetThumbPosition(g_modality,value)}}var g_modality="CT",arrId={};arrId.ctrl=CBoBo.Plugin.GetRandom(),arrId.selmodality=CBoBo.Plugin.GetRandom(),arrId.main=CBoBo.Plugin.GetRandom(),arrId.radio=CBoBo.Plugin.GetRandom(),arrId.checkbox=CBoBo.Plugin.GetRandom(),arrId.layout=CBoBo.Plugin.GetRandom(),$("<div id='"+arrId.ctrl+"'><div id='"+arrId.selmodality+"'></div><div id='"+arrId.main+"'><div id='"+arrId.radio+"'></div><div id='"+arrId.checkbox+"'></div><div id='"+arrId.layout+"'></div></div></div>").appendTo($("#"+m_arrId.right)),Style(),arrId.modality=id="#"+PushSelectCtrl("#"+arrId.selmodality,"设备类型",{},function(modality){SetPageConfig(g_modality=modality)}),InsertForSelCtrl(id,"CT","CT"),InsertForSelCtrl(id,"PT","PT"),InsertForSelCtrl(id,"MR","MR"),InsertForSelCtrl(id,"XR","XR"),InsertForSelCtrl(id,"OTHER","OTHER"),InsertHeadTitle(id="#"+arrId.radio,"图像默认显示",{width:"100%",height:"30px"}),InsertRadioCtrl(id,"imageshow","正常（默认）","normal",{"margin-left":"20px"},function(event){SetOparete("imageshow",event.target.value)}),InsertRadioCtrl(id,"imageshow","反色","inverse",{"margin-left":"10px"},function(event){SetOparete("imageshow",event.target.value)}),InsertHeadTitle(id,"缩略图位置",{width:"100%","margin-top":"30px",height:"30px"});InsertRadioCtrl(id,name="thumbposition","自动（默认）","auto",{"margin-left":"20px"},function(event){SetOparete("thumbposition",event.target.value)}),InsertRadioCtrl(id,name,"左边显示","left",{"margin-left":"10px"},function(event){SetOparete("thumbposition",event.target.value)}),InsertRadioCtrl(id,name,"下方显示","bottom",{"margin-left":"10px"},function(event){SetOparete("thumbposition",event.target.value)}),pid="#"+arrId.checkbox,InsertHeadTitle(pid,"默认鼠标配置",{width:"100%",height:"30px"}),arrId.mouseLeft=id="#"+PushSelectCtrl(pid,"左键",{width:"40%",height:"30px","margin-left":"20px"},function(oparete){CBoBo.Config.SetMouseLeft(g_modality,oparete)}),mouseSel(id),arrId.mouseRight=id="#"+PushSelectCtrl(pid,"右键",{width:"40%",height:"30px"},function(oparete){CBoBo.Config.SetMouseRight(g_modality,oparete)}),mouseSel(id),arrId.mouseMiddle=id="#"+PushSelectCtrl(pid,"中键",{width:"40%",height:"30px","margin-left":"20px"},function(oparete){CBoBo.Config.SetMouseMiddle(g_modality,oparete)}),mouseSel(id),arrId.mouseMiddleRoll=id="#"+PushSelectCtrl(pid,"滚轮",{width:"40%",height:"30px"},function(oparete){CBoBo.Config.SetMouseMiddleRoll(g_modality,oparete)}),InsertForSelCtrl(id,"翻页","page"),InsertForSelCtrl(id,"缩放","zoom"),pid="#"+arrId.layout,InsertHeadTitle(pid,"默认布局配置",{width:"100%",height:"30px"}),arrId.platform=id="#"+PushSelectCtrl(pid,"使用设备",{"margin-left":"20px"},function(platform){UpdateLayout(g_modality,platform)}),InsertForSelCtrl(id,"PC","pc"),InsertForSelCtrl(id,"IPAD","ipad"),InsertForSelCtrl(id,"IPHONE","iphone"),InsertForSelCtrl(id,"OTHER","other"),InsertHeadTitle(pid,"序列布局",{width:"100%",height:"30px","margin-left":"40px","margin-top":"20px"});var id,name={parent:pid,iconstr:"&#xe667;",title:"1*1",name:"serieslayout",value:"1*1",exstyle:{"margin-left":"40px","margin-top":"10px"},iconstyle:{"font-size":"27px"},change:function(value){CBoBo.Config.SetSeriesLayout(g_modality,$(arrId.platform).val(),value)}},name=(InsertWinItem(name),name.value=name.title="2*1",name.iconstr="&#xe66f;",InsertWinItem(name),name.value=name.title="1*2",name.iconstyle.transform="rotate(90deg)",InsertWinItem(name),name.value=name.title="2*2",name.iconstr="&#xe66b;",name.iconstyle.transform="",InsertWinItem(name),name.value=name.title="2*3",name.iconstr="&#xe668;",InsertWinItem(name),name.value=name.title="3*2",name.iconstr="&#xe668;",name.iconstyle.transform="rotate(90deg)",InsertWinItem(name),name.value=name.title="3*3",name.iconstr="&#xe665;",name.iconstyle.transform="",InsertWinItem(name),InsertHeadTitle(pid,"图像布局",{width:"100%",height:"30px","margin-left":"40px","margin-top":"20px"}),{parent:pid,iconstr:"&#xe667;",title:"1*1",name:"imagelayout",value:"1*1",exstyle:{"margin-left":"40px","margin-top":"10px"},iconstyle:{"font-size":"27px"},change:function(value){CBoBo.Config.SetImageLayout(g_modality,$(arrId.platform).val(),value)}});return InsertWinItem(name),name.value=name.title="2*1",name.iconstr="&#xe66f;",InsertWinItem(name),name.value=name.title="1*2",name.iconstyle.transform="rotate(90deg)",InsertWinItem(name),name.value=name.title="2*2",name.iconstr="&#xe66b;",name.iconstyle.transform="",InsertWinItem(name),name.value=name.title="2*3",name.iconstr="&#xe668;",InsertWinItem(name),name.value=name.title="3*2",name.iconstr="&#xe668;",name.iconstyle.transform="rotate(90deg)",InsertWinItem(name),name.value=name.title="3*3",name.iconstr="&#xe665;",name.iconstyle.transform="",InsertWinItem(name),id=g_modality,$(arrId.modality).val(id),SetPageConfig(id),Style;function mouseSel(id){InsertForSelCtrl(id,"平移","translation"),InsertForSelCtrl(id,"窗宽窗位","wwwc"),InsertForSelCtrl(id,"翻页","page"),InsertForSelCtrl(id,"缩放","zoom"),InsertForSelCtrl(id,"释放","release")}}),CornerInfo=function(){function Style(){var lt=$("#"+arrId.lt),rt=$("#"+arrId.rt),rb=$("#"+arrId.rb),lb=$("#"+arrId.lb),center=$("#"+arrId.center),left=$("#"+arrId.left),right=$("#"+arrId.right),centerHead=$("#"+arrId.centerHead),centerHeadSpan=$("#"+arrId.centerHead+" span"),centerContainer=$("#"+arrId.centerContainer),itemHead=$("."+arrId.itemhead),itemHeadSpan=$("."+arrId.itemhead+" span"),itemHeadName=$("."+arrId.itemHeadName),itemHeadOparete=$("."+arrId.itemHeadOparete),left_modalty=$("#"+arrId.left_modalty),left_fontStyle=$("#"+arrId.left_fontStyle),parent=right.parent(),parentWidth=parent.width(),boxWidth=parentWidth/6|0,boxHeight=parent.height(),boxWidth=(left.width(boxWidth).height(boxHeight).css({display:"inline-block"}),right.width(parentWidth-boxWidth-1).height(boxHeight).css({display:"inline-block",position:"relative"}),(((parent=lt.parent()).width()-20)/3|0)-2),boxHeight=((parent.height()-10)/2|0)-2,left=(lt.width(boxWidth).height(boxHeight).css({border:"1px solid #666",position:"absolute","background-color":"#000",left:0,top:0}),center.width(boxWidth).height(2*boxHeight+10).css({position:"absolute",left:10+boxWidth,top:0}),rt.width(boxWidth).height(boxHeight).css({border:"1px solid #666",position:"absolute","background-color":"#000",left:2*(10+boxWidth),top:0}),rb.width(boxWidth).height(boxHeight).css({border:"1px solid #666",position:"absolute","background-color":"#000",left:2*(10+boxWidth),top:10+boxHeight}),lb.width(boxWidth).height(boxHeight).css({border:"1px solid #666",position:"absolute","background-color":"#000",left:0,top:10+boxHeight}),FocusStyle(),centerHead.css({"font-family":"Microsoft YaHei",width:"100%",height:"25px",background:"#222",cursor:"default","font-size":"17px"}),centerHeadSpan.css({color:"#efefef",display:"inline-block",height:"100%"}),centerHeadSpan.eq(0).css({width:"30%"}),centerHeadSpan.eq(1).css({width:"50%"}),centerHeadSpan.eq(2).css({width:"20%","text-align":"center"}),centerContainer.height(centerContainer.parent().height()-20).css({width:"100%"}),CenterItemStyle(),itemHead.css({"font-family":"Microsoft YaHei",width:"100%",height:"25px",background:"#222",cursor:"default","font-size":"17px",color:"#efefef"}),itemHeadSpan.css({display:"inline-block",height:"100%"}),itemHeadName.css({width:"80%"}),itemHeadOparete.css({width:"20%","text-align":"center"}),left_modalty.height(74).css({width:"90%","margin-left":"10%"}),left_fontStyle.parent().height());left_fontStyle.height(left-86).css({width:"90%","margin-left":"10%","border-top":"1px solid #222","margin-top":"10px"})}function FocusStyle(){var lt=$("#"+arrId.lt),rt=$("#"+arrId.rt),rb=$("#"+arrId.rb),lb=$("#"+arrId.lb);switch(lt.css({"border-color":"#666"}),rt.css({"border-color":"#666"}),rb.css({"border-color":"#666"}),lb.css({"border-color":"#666"}),focusIndex){case 0:lt.css({"border-color":"#0ff"});break;case 1:rt.css({"border-color":"#0ff"});break;case 2:rb.css({"border-color":"#0ff"});break;case 3:lb.css({"border-color":"#0ff"})}}function GetPosition(){switch(focusIndex){case 0:return"lt";case 1:return"rt";case 2:return"rb";case 3:return"lb"}}function CenterItemStyle(){$("."+arrId.centerContainerItem).height(20).css({"font-family":"Microsoft YaHei",cursor:"default",margin:"4px 0"}),$("."+arrId.centerContainerItem+" span").css({display:"inline-block",height:"100%","line-height":"20px"}),$("."+arrId.centerContainerItemTag).css({color:"#aaa",width:"30%","text-overflow":"ellipsis","white-space":"nowrap"}),$("."+arrId.centerContainerItemName).css({color:"#FFF",width:"50%","text-overflow":"ellipsis","white-space":"nowrap"}),$("."+arrId.centerContainerItemTool).css({color:"#0f0",width:"20%","text-align":"center",cursor:"pointer"})}function PushSelItem(id,tag){void 0===arrId.item&&(arrId.item=CBoBo.Plugin.GetRandom()),void 0===arrId.itemName&&(arrId.itemName=CBoBo.Plugin.GetRandom()),void 0===arrId.itemDelete&&(arrId.itemDelete=CBoBo.Plugin.GetRandom());var itemid=CBoBo.Plugin.GetRandom(),item=CBoBo.Dicom.GetTagData(tag);void 0!==item&&(item=item.name,tag={id:id,tag:tag},item="<div class='"+arrId.item+" config-conerinfoitem'><span class='"+arrId.itemName+"' title='"+item+"'>"+item+"</span><span class='"+arrId.itemDelete+" icon_tool' title='删除该项' id='"+itemid+"'>&#xe653;</span></div>",$(item).appendTo($("#"+id)).bind("dblclick",tag,function(event){DeleteSelItem(event.data.id,event.data.tag.toString())}),$("#"+itemid).bind("click dblclick",tag,function(event){"dblclick"===event.type?(event.stopPropagation(),event.preventDefault()):DeleteSelItem(event.data.id,event.data.tag.toString())}))}function ItemTableEmpty(){var id=arrId.ltContainer;$("#"+id).empty(),id=arrId.rtContainer,$("#"+id).empty(),id=arrId.rbContainer,$("#"+id).empty(),id=arrId.lbContainer,$("#"+id).empty()}function InitItemTable(){var id=arrId.ltContainer,array=CBoBo.Config.GetCornerInfoItem(g_modality,"lt"),id=(PushItemByArray(id,array),arrId.rtContainer),array=CBoBo.Config.GetCornerInfoItem(g_modality,"rt"),id=(PushItemByArray(id,array),arrId.rbContainer),id=(array=CBoBo.Config.GetCornerInfoItem(g_modality,"rb"),PushItemByArray(id,array),arrId.lbContainer),id=(array=CBoBo.Config.GetCornerInfoItem(g_modality,"lb"),PushItemByArray(id,array),CBoBo.Config.GetCornerInfoFontColor()),array=CBoBo.Config.GetCornerInfoFontFamily();ItemStyle(id,array)}var centerHead,centerContainer,itemHead,left_modalty,left_fontStyle,g_modality="CT",arrId={},AddItemFromCenterList=function(tag){var Item;switch(focusIndex){case 0:Item=arrId.ltContainer;break;case 1:Item=arrId.rtContainer;break;case 2:Item=arrId.rbContainer;break;case 3:Item=arrId.lbContainer}var status=CBoBo.Config.PushCornerInfoItem(g_modality,GetPosition(),tag);status?$.Msg(status):(PushSelItem(Item,tag),status=CBoBo.Config.GetCornerInfoFontColor(),tag=CBoBo.Config.GetCornerInfoFontFamily(),ItemStyle(status,tag))},ItemStyle=function(color,fontFamily){void 0===color&&(color="#efefef"),void 0===fontFamily&&(fontFamily="Microsoft YaHei"),$("."+arrId.item).height(20).css({"font-family":fontFamily,cursor:"default",margin:"4px 0"});$("."+arrId.item+" span").css({display:"inline-block",height:"100%","line-height":"20px"});$("."+arrId.itemName).css({color:color,width:"80%","text-overflow":"ellipsis","white-space":"nowrap"}),$("."+arrId.itemDelete).css({color:"#F00",width:"20%","text-align":"center",cursor:"pointer"})},DeleteSelItem=function(id,tag){var name,item=CBoBo.Dicom.GetTagData(tag);void 0!==item&&CBoBo.Config.DeleteCornerInfoItem(g_modality,GetPosition(),tag)&&(name=item.name,$("#"+id+" ."+arrId.item).each(function(){var jqDom=$(this);jqDom.children("."+arrId.itemName).html()===name&&jqDom.remove()}))},PushItemByArray=function(id,array){if(!(array instanceof Array))throw"PushItemByArray:array is not correct.";$.each(array,function(){PushSelItem(id,this)})};return arrId.ctrl=CBoBo.Plugin.GetRandom(),arrId.left=CBoBo.Plugin.GetRandom(),arrId.right=CBoBo.Plugin.GetRandom(),arrId.lt=CBoBo.Plugin.GetRandom(),arrId.rt=CBoBo.Plugin.GetRandom(),arrId.rb=CBoBo.Plugin.GetRandom(),arrId.lb=CBoBo.Plugin.GetRandom(),arrId.center=CBoBo.Plugin.GetRandom(),arrId.centerHead=CBoBo.Plugin.GetRandom(),arrId.centerContainer=CBoBo.Plugin.GetRandom(),arrId.itemhead=CBoBo.Plugin.GetRandom(),arrId.itemHeadName=CBoBo.Plugin.GetRandom(),arrId.itemHeadOparete=CBoBo.Plugin.GetRandom(),arrId.lbContainer=CBoBo.Plugin.GetRandom(),arrId.ltContainer=CBoBo.Plugin.GetRandom(),arrId.rtContainer=CBoBo.Plugin.GetRandom(),arrId.rbContainer=CBoBo.Plugin.GetRandom(),arrId.left_modalty=CBoBo.Plugin.GetRandom(),arrId.left_fontStyle=CBoBo.Plugin.GetRandom(),centerHead="<div id='"+arrId.centerHead+"'><span>Tag</span><span>Name</span><span>操作</span></div>",centerContainer="<div id='"+arrId.centerContainer+"'></div>",itemHead="<div class='"+arrId.itemhead+"'><span class='"+arrId.itemHeadName+"'>Name</span><span class='"+arrId.itemHeadOparete+"'>操作</span></div>",left_modalty="<div id='"+arrId.left_modalty+"'></div>",left_fontStyle="<div id='"+arrId.left_fontStyle+"'></div>",left_modalty="<div id='"+arrId.left+"'>"+left_modalty+left_fontStyle+"</div><div id='"+arrId.right+"'><div id='"+arrId.lt+"'>"+itemHead+"<div id='"+arrId.ltContainer+"'></div></div><div id='"+arrId.center+"'>"+centerHead+centerContainer+"</div><div id='"+arrId.rt+"'>"+itemHead+"<div id='"+arrId.rtContainer+"'></div></div><div id='"+arrId.rb+"'>"+itemHead+"<div id='"+arrId.rbContainer+"'></div></div><div id='"+arrId.lb+"'>"+itemHead+"<div id='"+arrId.lbContainer+"'></div></div></div>",$(left_modalty).appendTo($("#"+m_arrId.right)),Style(),left_fontStyle=$("#"+arrId.lt),centerHead=$("#"+arrId.rt),centerContainer=$("#"+arrId.rb),itemHead=$("#"+arrId.lb),left_fontStyle.bind("mousedown",function(event){focusIndex=0,FocusStyle()}),centerHead.bind("mousedown",function(event){focusIndex=1,FocusStyle()}),centerContainer.bind("mousedown",function(event){focusIndex=2,FocusStyle()}),itemHead.bind("mousedown",function(event){focusIndex=3,FocusStyle()}),left_modalty="#"+arrId.left_modalty,InsertHeadTitle(left_modalty,"设备配置",{width:"100%",height:"30px"}),left_modalty="#"+PushSelectCtrl(left_modalty,"影像",{"margin-left":"10px"},function(mode){var parent=$(arrId.modality).parent();g_modality="2D"===mode?(parent.css({visibility:""}),$(arrId.modality).val()):(parent.css({visibility:"hidden"}),mode),ItemTableEmpty(),InitItemTable()}),InsertForSelCtrl(left_modalty,"2D","2D"),InsertForSelCtrl(left_modalty,"Film","FILM"),left_modalty="#"+arrId.left_modalty,arrId.modality=left_modalty="#"+PushSelectCtrl(left_modalty,"设备",{"margin-left":"10px"},function(modality){g_modality=modality,ItemTableEmpty(),InitItemTable()}),InsertForSelCtrl(left_modalty,"CT","CT"),InsertForSelCtrl(left_modalty,"PT","PT"),InsertForSelCtrl(left_modalty,"MR","MR"),InsertForSelCtrl(left_modalty,"XR","XR"),InsertForSelCtrl(left_modalty,"OTHER","OTHER"),left_modalty="#"+arrId.left_fontStyle,InsertHeadTitle(left_modalty,"字体设置",{width:"100%",height:"30px"}),left_modalty="#"+PushSelectCtrl(left_modalty,"样式",{"margin-left":"10px"},function(fontFamily){CBoBo.Config.SetCornerInfoFontFamily(fontFamily);var color=CBoBo.Config.GetCornerInfoFontColor();ItemStyle(color,fontFamily)}),InsertForSelCtrl(left_modalty,"Arial","Arial"),InsertForSelCtrl(left_modalty,"微软雅黑","Microsoft YaHei"),InsertForSelCtrl(left_modalty,"宋体","SimSun"),InsertForSelCtrl(left_modalty,"新宋体","NSimSun"),InsertForSelCtrl(left_modalty,"仿宋_GB2312","FangSong_GB2312"),InsertForSelCtrl(left_modalty,"楷体_GB2312","KaiTi_GB2312"),InsertForSelCtrl(left_modalty,"黑体","SimHei"),InsertForSelCtrl(left_modalty,"Arial Black","Arial Black"),InsertForSelCtrl(left_modalty,"Times New Roman","Times New Roman"),InsertForSelCtrl(left_modalty,"Courier New","Courier New"),InsertForSelCtrl(left_modalty,"Tahoma","Tahoma"),InsertForSelCtrl(left_modalty,"Verdana","Verdana"),left_fontStyle=CBoBo.Config.GetCornerInfoFontFamily(),$(left_modalty).val(left_fontStyle),left_modalty="#"+arrId.left_fontStyle,left_fontStyle=CBoBo.Config.GetCornerInfoFontColor(),InsertColorSel(left_modalty,left_fontStyle,function(color){CBoBo.Config.SetCornerInfoFontColor(color);var family=CBoBo.Config.GetCornerInfoFontFamily();ItemStyle(color,family)},{margin:"10px 0 0 10px"}),void 0!==CBoBo.Dicom&&($.each(CBoBo.Dicom.GetTagData(),function(){var tag,name,id;tag=this.tag,name=this.name,void 0===arrId.centerContainerItem&&(arrId.centerContainerItem=CBoBo.Plugin.GetRandom()),void 0===arrId.centerContainerItemTag&&(arrId.centerContainerItemTag=CBoBo.Plugin.GetRandom()),void 0===arrId.centerContainerItemName&&(arrId.centerContainerItemName=CBoBo.Plugin.GetRandom()),void 0===arrId.centerContainerItemTool&&(arrId.centerContainerItemTool=CBoBo.Plugin.GetRandom()),id=CBoBo.Plugin.GetRandom(),name="<div class='"+arrId.centerContainerItem+" config-conerinfoitem'><span class='"+arrId.centerContainerItemTag+"' title='"+tag+"'>"+tag+"</span><span class='"+arrId.centerContainerItemName+"' title='"+name+"'>"+name+"</span><span class='"+arrId.centerContainerItemTool+" icon_tool' title='增加到指定列表' id='"+id+"'>&#xe6ca;</span></div>",$(name).appendTo($("#"+arrId.centerContainer)).bind("dblclick",tag,function(event){AddItemFromCenterList(event.data)}),$("#"+id).bind("click dblclick",tag,function(event){"dblclick"===event.type?(event.stopPropagation(),event.preventDefault()):AddItemFromCenterList(event.data)})}),CenterItemStyle(),$("#"+arrId.centerContainer).mCustomScrollbar({axis:"y",scrollbarPosition:"inside",scrollInertia:800,theme:"minimal"})),InitItemTable(),Style},ToolBar=function(){CBoBo.Plugin.GetRandom(),CBoBo.Plugin.GetRandom(),CBoBo.Plugin.GetRandom(),CBoBo.Plugin.GetRandom(),CBoBo.Plugin.GetRandom(),CBoBo.Plugin.GetRandom(),$("<h1>工具栏配置</h1>").appendTo($("#"+m_arrId.right))},Other=function(){function InitPreWwWcItem(){var arrParam,bodyid=arrId.bodyid,arrItem=($(bodyid).empty(),CBoBo.Config.GetPreWwWc(g_modality));$.each(arrItem,function(){(arrParam=[]).push({title:this.title,width:"20%"}),arrParam.push({title:this.ww,width:"20%"}),arrParam.push({title:this.wc,width:"20%"}),arrParam.push({title:this.shortcutName,width:"20%"}),InsertTableItem(bodyid,arrParam,this.id,ItemCallback)}),TableItemStyle()}var shortcut,str,parentHeight,preWw,g_modality="CT",arrId={},GetItemTitle=function(index){switch(index){case 0:return"title";case 1:return"ww";case 2:return"wc";case 3:return"shortcut"}},ItemCallback=function(type,uniqueMask,domOrIndex,value,codeName,bCtrl,bAlt){switch(type){case"delete":CBoBo.Config.DeletePreWwWc(g_modality,uniqueMask),domOrIndex.remove();break;case"modify":CBoBo.Config.ModalityPreWwWc(g_modality,uniqueMask,GetItemTitle(domOrIndex),value,codeName,bCtrl,bAlt)}};arrId.ctrl=CBoBo.Plugin.GetRandom(),arrId.preWw=CBoBo.Plugin.GetRandom(),arrId.shortcut=CBoBo.Plugin.GetRandom(),str="<div id='"+arrId.ctrl+"'><div id='"+arrId.preWw+"'></div><div id='"+arrId.shortcut+"'></div></div>",$(str).appendTo($("#"+m_arrId.right)),str=$("#"+arrId.ctrl),preWw=$("#"+arrId.preWw),shortcut=$("#"+arrId.shortcut),parentHeight=str.parent().width(),str.width(parentHeight-60).css({height:"100%",position:"absolute",top:0,left:"60px",overflow:"hidden","font-family":"Microsoft Yahei"}),preWw.css({width:"30%",height:"100%",display:"inline-block"}),shortcut.css({width:"69%",height:"100%",display:"inline-block"}),str="#"+arrId.preWw,InsertHeadTitle(str,"预设窗宽窗位",{width:"100%",height:"30px"}),str="#"+PushSelectCtrl(str,"设备类型",{"margin-left":"20px"},function(modality){g_modality=modality,InitPreWwWcItem()}),InsertForSelCtrl(str,"CT","CT"),InsertForSelCtrl(str,"PT","PT"),InsertForSelCtrl(str,"MR","MR"),InsertForSelCtrl(str,"XR","XR"),InsertForSelCtrl(str,"OTHER","OTHER"),str="#"+arrId.preWw,parentHeight=$(str).width()-22,str="#"+PushTable(str,{float:"left",width:parentHeight+"px",height:"400px",margin:"10px 0 0 20px",border:"1px solid #666",position:"relative"}),(preWw=[]).push({title:"名称",width:"20%"}),preWw.push({title:"窗宽",width:"20%"}),preWw.push({title:"窗位",width:"20%"}),preWw.push({title:"快捷键",width:"20%"}),preWw.push({title:"操作",width:"20%"}),PushTableHead(str,preWw,{height:"20px",background:"#333",width:"100%",color:"#efefef",cursor:"default"}),arrId.bodyid="#"+PushTableBody(str,{height:"355px",width:"100%",background:"#222",overflow:"hidden"}),PushTableFooter(str,{bottom:"0",width:"100%",height:"25px",position:"absolute","text-align":"center",color:"green",cursor:"pointer"},function(event){var arrParam,itemId=CBoBo.Config.PushPreWwWc(g_modality,"","","","",!1,!1);itemId instanceof String?$.Msg(itemId):((arrParam=[]).push({title:"",width:"20%"}),arrParam.push({title:"",width:"20%"}),arrParam.push({title:"",width:"20%"}),arrParam.push({title:"",width:"20%"}),InsertTableItem(arrId.bodyid,arrParam,itemId,ItemCallback))}),str="#"+arrId.shortcut,InsertHeadTitle(str,"快捷键配置",{width:"100%",height:"30px","margin-left":"40px"}),parentHeight=$(str).width()-62,preBoxHeight=$(str).height()-60,str="#"+PushTable(str,{float:"left",width:parentHeight+"px",height:preBoxHeight+"px",margin:"10px 0 0 60px",border:"1px solid #666",position:"relative"}),(preWw=[]).push({title:"动作",width:"80%"}),preWw.push({title:"快捷键",width:"20%"}),PushTableHead(str,preWw,{height:"20px",background:"#333",width:"100%",color:"#efefef",cursor:"default"},!0),parentHeight="#"+PushTableBody(str,{height:preBoxHeight-20+"px",width:"100%",background:"#222",overflow:"hidden"}),(preWw=[]).push({title:"的撒哥反对大师傅",width:"80%"}),preWw.push({title:"R",width:"20%"}),TableItemStyle(),$(parentHeight).mCustomScrollbar({axis:"y",scrollbarPosition:"inside",scrollInertia:800,theme:"minimal"}),InitPreWwWcItem()},ClearRightBox=function(){$("#"+m_arrId.right).empty()},PushSelectCtrl=function(parentID,title,exStyle,callback){var itemID,ctrlID;if(null!=title&&null!=parentID)return itemID=CBoBo.Plugin.GetRandom(),ctrlID=CBoBo.Plugin.GetRandom(),(title=$("<div id='"+ctrlID+"'><span>"+title+"</span><select id='"+itemID+"' title='"+title+"'></select></div>").appendTo($(parentID))).css({float:"left",color:"#efefef"}),$("#"+ctrlID+" span").css({cursor:"default","margin-right":"8px"}),$("#"+itemID).css({cursor:"pointer","min-width":"100px"}),void 0!==exStyle&&"object"==typeof exStyle&&title.css(exStyle),callback instanceof Function&&$("#"+itemID).bind("change",function(event){callback($(this).val())}),itemID},InsertForSelCtrl=function(parent,string,value){null!=string&&$("<option value='"+value+"'>"+string+"</option>").appendTo($(parent))},PushTable=function(parent,exStyle){var id=CBoBo.Plugin.GetRandom(),parent=$("<div id ='"+id+"'></div>").appendTo($(parent));return void 0!==exStyle&&"object"==typeof exStyle&&parent.css(exStyle),id},PushTableHead=function(parent,arrParam,exStyle,patch){var subStr,temp="",str=($.each(arrParam,function(i){subStr=patch||arrParam.length-1!==i?"<span style='width:"+this.width+";height:100%;display:inline-block;'>"+this.title+"</span>":"<span style='width:"+this.width+";height:100%;display:inline-block;text-align:center;'>"+this.title+"</span>",temp+=subStr}),"<div>"+temp+"</div>"),str=$(str).appendTo($(parent));void 0!==exStyle&&"object"==typeof exStyle&&str.css(exStyle)},PushTableBody=function(parent,exStyle){var id=CBoBo.Plugin.GetRandom(),parent=$("<div id ='"+id+"'></div>").appendTo($(parent));return void 0!==exStyle&&"object"==typeof exStyle&&parent.css(exStyle),id},InsertTableItem=function(parent,arrParam,uniqueMask,callback,patch){void 0===m_arrId.InsertTableItem&&(m_arrId.InsertTableItem=CBoBo.Plugin.GetRandom());var subStr,delid,char,ctrlKey,altKey,id=CBoBo.Plugin.GetRandom(),classStyle=CBoBo.Plugin.GetRandom(),temp="",str=(patch?$.each(arrParam,function(i){subStr=arrParam.length-1===i?"<input id='"+id+"' type='text' style=' width:"+this.width+";height:100%;float:left;padding:0;border:0;background:#444;color:#efefef; user-select:none;' readOnly='true' value='"+this.title+"'/>":"<input type='text' style='width:"+this.width+";height:100%;float:left;padding:0;border:0;background:#444;color:#efefef; user-select:none;' readOnly='true' value='"+this.title+"'/>",temp+=subStr}):(delid=CBoBo.Plugin.GetRandom(),$.each(arrParam,function(i){subStr=arrParam.length-1===i?"<input id='"+id+"' type='text' style='width:"+this.width+";height:100%;float:left;padding:0;border:0;background:#444;color:#efefef; user-select:none;' readOnly='true' value='"+this.title+"'/>":"<input class='"+classStyle+"' type='text' style='width:"+this.width+";height:100%;float:left;padding:0;border:0;background:#444;color:#efefef;' value='"+this.title+"'/>",temp+=subStr}),temp+="<span type='text' style='width:20%;height:100%;float:left;text-align:center; cursor:pointer;display:inline-block;color:red;' id='"+delid+"' class='icon_tool' title='删除该项'>&#xe653;</span>"),"<div class='"+m_arrId.InsertTableItem+"'>"+temp+"</div>"),ctrl=$(str).appendTo($(parent));$("#"+id).bind("focus blur keydown",uniqueMask,function(event){var input=$(this);switch(event.type){case"focus":input.css({color:"#222",background:"#aaa","text-align":"center"});break;case"blur":input.css({color:"#efefef",background:"#444","text-align":"left"});break;case"keydown":var code=event.keyCode;(8<=code&&code<=36||41<=code&&code<=47||136<=code&&code<=254||91<=code&&code<=95)&&192!==code||(char=String.fromCharCode(event.keyCode).toUpperCase(),ctrlKey=event.ctrlKey,altKey=event.altKey,event.stopPropagation(),event.preventDefault(),code="",event.ctrlKey&&(code+="Ctrl+"),event.altKey&&(code+="Alt+"),"Ctrl+C"===(code+=char)||"Ctrl+A"===code||"Ctrl+V"===code||"Ctrl+X"===code||"Ctrl+F"===code?$.Msg("该组合键被系统占用."):(input.val(code),callback instanceof Function&&callback("modify",uniqueMask,arrParam.length-1,event.target.value,char,ctrlKey,altKey)))}}),patch||($("#"+delid).bind("click",uniqueMask,function(event){callback instanceof Function&&callback("delete",uniqueMask,ctrl)}),$("."+classStyle).bind("change",uniqueMask,function(event){var dom,retIndex;callback instanceof Function&&callback("modify",uniqueMask,(dom=event.target,$("."+classStyle).each(function(index,value){dom===this&&(retIndex=index)}),retIndex),event.target.value)}))},TableItemStyle=function(){$("."+m_arrId.InsertTableItem).css({height:"20px",margin:"5px 0"})},PushTableFooter=function(parent,exStyle,callback){parent=$("<div>Add</div>").appendTo($(parent));void 0!==exStyle&&"object"==typeof exStyle&&parent.css(exStyle),callback instanceof Function&&parent.bind("mouseenter mouseleave click ",function(event){var button=$(this);switch(event.type){case"mouseenter":button.css({background:"#666"});break;case"mouseleave":button.css({background:"#333"});break;case"click":callback(event)}})},InsertColorSel=function(parent,default_color,callback,exStyle){var id=CBoBo.Plugin.GetRandom(),default_color=$("<div>颜色 <input id='"+id+"' type='color' name='favcolor'value='"+default_color+"' /></div>").appendTo($(parent));return default_color.height(60).css({float:"left",color:"#efefef",cursor:"default","min-width":"100px"}),void 0!==exStyle&&"object"==typeof exStyle&&default_color.css(exStyle),callback instanceof Function&&$("#"+id).bind("change",function(event){callback($(this).val())}),id},InsertRadioCtrl=function(parent,name,title,value,exStyle,callback){var id=CBoBo.Plugin.GetRandom(),name=$("<label title='"+title+"' value='"+value+"'><input id='"+id+"' name='"+name+"' type='radio'  value='"+value+"'/>"+title+"</label>").appendTo($(parent));name.css({float:"left",color:"#efefef",cursor:"pointer"}),void 0!==exStyle&&"object"==typeof exStyle&&name.css(exStyle),callback instanceof Function&&$("#"+id).bind("click",callback)},InsertHeadTitle=function(parent,title,exStyle){title=$("<label>"+title+"</label>").appendTo($(parent));title.css({float:"left",color:"#efefef"}),void 0!==exStyle&&"object"==typeof exStyle&&title.css(exStyle)},InsertWinItem=function(options){var opt=$.extend(!0,{parent:null,iconstr:"",title:"",name:"",value:"",exstyle:{},iconstyle:{},change:null},options),options=CBoBo.Plugin.GetRandom(),str="<div title='"+opt.title+"'><div style='pointer-events:none;' id='"+options+"' class='icon_tool'>"+opt.iconstr+"</div><input name='"+opt.name+"'style='pointer-events:none;' type='radio'  value='"+opt.value+"' style='cursor:pointer'></div>",str=$(str).appendTo($(opt.parent));return str.css({float:"left",color:"#fff",cursor:"pointer","text-align":"center"}),str.css(opt.exstyle),$("#"+options).css(opt.iconstyle),str.bind("click",function(event){var value=event.target.title;$("input:radio[name='"+opt.name+"']").each(function(){var item=$(this),icon=item.prev();item.val()===value?(icon.css("color","#F0F"),this.checked=!0):(icon.css("color","#fff"),this.checked=!1)}),opt.change instanceof Function&&opt.change(value)}),options};this.Show=function(bShow){this.bShow=bShow;var ctrl=$("#"+m_arrId.ctrl),body=$("body");bShow?(ctrl.hide(),ctrl.fadeIn(500),body.css("pointer-events","none"),ctrl.css("pointer-events","auto")):(ctrl.fadeOut(500),body.css("pointer-events",""),ctrl.css("pointer-events",""))},m_arrId.ctrl=CBoBo.Plugin.GetRandom(),m_arrId.left=CBoBo.Plugin.GetRandom(),m_arrId.right=CBoBo.Plugin.GetRandom(),m_arrId.headbtn=CBoBo.Plugin.GetRandom(),m_arrId.headbtnicon=CBoBo.Plugin.GetRandom(),str="<div id='"+m_arrId.ctrl+"' class='icon_tool'><div id='"+m_arrId.left+"'><div class='"+m_arrId.headbtn+"' title='基本配置'><span class='"+m_arrId.headbtnicon+"'>&#xe6ba;</span><span>基本配置</span></div><div class='"+m_arrId.headbtn+"' title='四角信息配置'><span class='"+m_arrId.headbtnicon+"'>&#xe6bb;</span><span>四角信息配置</span></div><div class='"+m_arrId.headbtn+"' title='其他配置'><span class='"+m_arrId.headbtnicon+"'>&#xe6b8;</span><span>其他配置</span></div></div><div id='"+m_arrId.right+"'></div></div>",$(str).appendTo($("body")).css({position:"absolute",left:0,top:CBoBo.View.TOOLBAR_HEIGHT,"z-index":"9999",background:"#535353","border-top":"1px solid #383838",overflow:"hide"}),Style(),(headbtn=$("."+m_arrId.headbtn)).bind("click",function(e){headbtn.css({"background-color":"","pointer-events":""}),$(this).css({"background-color":"#333333","pointer-events":"none"});e=e.target.title;switch(ClearRightBox(),e){case"基本配置":m_childStyle=BasePage();break;case"四角信息配置":m_childStyle=CornerInfo();break;case"工具栏配置":m_childStyle=ToolBar();break;case"其他配置":m_childStyle=Other()}}),$("."+m_arrId.headbtn).eq(0).trigger("click")},CBoBo.View.AssistDiagnose=function(options){var m_socket,m_createRoom,m_destory,m_restore,ctrl,winWidth,ctrlWidth,ctrlHeight,self=this,opt=(this.recrodStatus={},$.extend(!0,{msgtransform:null,server:""},options)),m_arrId={},m_bFirstBind=!(this.bShow=!1),ListentEvent=(this.Login=function(){m_socket=io.connect("ws://"+opt.server),ListentEvent(),self.UpdateRoomList(!0),self.UpdateRoomList(!1)},this.UpdateRoomList=function(bMy){void 0!==m_socket&&(bMy?m_socket.emit("getmyroom",{uid:"ranqiwu"}):m_socket.emit("getotherroom",{uid:"ranqiwu"}))},this.Show=function(bShow){this.bShow=bShow;bShow=$("#"+m_arrId.ctrl);this.bShow?(bShow.hide(),bShow.fadeIn(400)):bShow.fadeOut(400)},this.SendCommand=function(msg){m_socket.emit("command",msg)},function(){var socket=m_socket;socket.on("connect",function(){null!==opt.msgtransform&&opt.msgtransform({type:"socket.io",data:{type:"success"}})}),socket.on("connect_failed",function(data){null!==opt.msgtransform&&opt.msgtransform({type:"socket.io",data:{type:"failed"}})}),socket.on("error",function(data){null!==opt.msgtransform&&opt.msgtransform({type:"socket.io",data:{type:"error"}})}),socket.on("reconnecting",function(times){null!==opt.msgtransform&&opt.msgtransform({type:"socket.io",data:{type:"reconnecting",times:times}})}),socket.on("reconnect",function(times){null!==opt.msgtransform&&opt.msgtransform({type:"socket.io",data:{type:"reconnected",times:times}})}),socket.on("disconnect",function(data){null!==opt.msgtransform&&opt.msgtransform({type:"socket.io",data:{type:"disconnect"}})}),socket.on("command",function(event){null!==opt.msgtransform&&opt.msgtransform({type:"command",data:event})}),socket.on("myroom",function(event){$.each(event,function(){PushRoom({title:this.title,personcount:this.personcount,id:this.roomid},!0)})}),socket.on("otherroom",function(event){$.each(event,function(){PushRoom({title:this.title,personcount:this.personcount,id:this.roomid})})})}),UpdateStyle=function(ctrlWidth,ctrlHeight){$("."+m_arrId.clear).css({display:"none",float:"none"});{var ctrl=$("#"+m_arrId.ctrl),ctrl,ctrl;ctrl.width(ctrlWidth).height(ctrlHeight).css({border:"1px solid #676767",position:"absolute","z-index":"9999",background:"#444444","user-select":"none",color:"#CCCCC4"}),(ctrl=$("#"+m_arrId.title)).css({height:"30px",width:"100%",background:"#555555",cursor:"default","border-bottom":"1px solid #000","text-align":"center","box-shadow":"0 1px 2px #000"}),(ctrl=$("#"+m_arrId.title+" span")).css({width:"40%",height:"100%","text-align":"center",display:"inline-block","font-size":"16px","line-height":"30px"})}$("#"+m_arrId.title+" a").css({display:"inline-block",position:"absolute",top:"3px",right:"5px",cursor:"pointer","font-size":"20px",color:"#000"}),$("#"+m_arrId.container).css({position:"relative"});$("#"+m_arrId.search).css({height:"30px",width:"100%",background:"#131313"}),$("#"+m_arrId.search+" input").css({width:ctrlWidth-55+"px",height:"100%","padding-left":"3px",float:"left"}),$("#"+m_arrId.searchbtn).css({width:"48px","font-size":"5%",cursor:"pointer",display:"block","text-align":"center",height:"30px",float:"right","line-height":"30px"});ctrl=ctrlHeight-62;$("#"+m_arrId.room).height(ctrl).width(288).css({float:"left"}),$("#"+m_arrId.roommanager).height(30).css({width:"100%",background:"gray",color:"#222"}),$("."+m_arrId.roommanactrl).height(30).css({width:"90","line-height":"30px",cursor:"pointer"});$("."+m_arrId.roommanactrl+" label").css({"font-size":"130%","padding-right":"4px"});ctrlHeight=$("."+m_arrId.roomtitle);ctrlHeight.css({width:"100%",background:"#555555",display:"block","margin-bottom":"3px","box-shadow":"0 1px 3px #333",cursor:"pointer","padding-left":"5px"});var myroomHeight=.3*ctrl>>0,myroomul=($("#"+m_arrId.myroom).css({width:"100%","margin-bottom":"6px","max-height":myroomHeight+"px"}),$("#"+m_arrId.myroom+" ul")),myroomHeightul=myroomHeight-ctrlHeight.height();myroomul.css({"overflow-y":"auto",height:myroomHeightul+"px"});myroomul=ctrl-myroomHeight,$("#"+m_arrId.otherroom).css({width:"100%","max-height":myroomul+"px"}),myroomHeightul=$("#"+m_arrId.otherroom+" ul"),myroomHeight=myroomul-ctrlHeight.height();myroomHeightul.css({"overflow-y":"auto",height:myroomHeight+"px"});myroomul=ctrlWidth-288;$("#"+m_arrId.roomin).height(ctrl).width(myroomul).css({float:"right",background:"#da8456"})},CreateRoomPro=function(e){m_destory=e.destory,m_restore=e.gray;var md5pass=e.password;m_createRoom=e.title,""!==md5pass&&(md5pass=hex_md5(md5pass)),m_socket.emit("createroom",{uid:"ranqiwu",title:e.title,isprivate:e.isprivate,password:md5pass}),m_bFirstBind&&(m_socket.on("createroomstatus",function(e){e.success?(void 0!==m_destory&&m_destory(),PushRoom({title:m_createRoom},!0),$.Msg(e.msg,CBoBo.MSG_SUCCESS)):(void 0!==m_restore&&m_restore(),$.Msg(e.msg,CBoBo.MSG_ERROR))}),m_bFirstBind=!1)},PushRoom=function(data,bMy){var info,str;"object"==typeof data&&(str="<li><span>"+(info=$.extend(!0,{title:"",personcount:0,author:"",createtime:"",type:"",id:""},data)).title+"</span><span style='color:#FFF'> "+info.personcount+"</span></li>",bMy=bMy?m_arrId.myroom+" ul":m_arrId.otherroom+" ul",$(str).appendTo("#"+bMy).css({cursor:"default",margin:"2px 0"}).bind("dblclick",function(e){ShowRoomMember(!0);var datainfo=$(this).data("info");"object"==typeof data&&void 0!==m_socket&&m_socket.emit("entersession",{uid:"ranqiwu",roomid:datainfo.id})}).data("info",info))},ShowRoomMember=function(bShow){$("#"+m_arrId.ctrl);var ctrlWidth,ctrlHeight=(ctrlHeight=.5*$(window).height()>>0)<300?300:ctrlHeight;ctrlWidth=bShow?(ctrlWidth=.3*$(window).width()>>0)<285?285:ctrlWidth:288,UpdateStyle(ctrlWidth,ctrlHeight)},CreateRoomView=function(msgTransform){var m_cfmbtn,m_ctrl,id,titleid,passwordid,cpasswordid,spanitem,confirm,checkbox,passwordbox,self=this,m_bShowPassword=!1;function Destroy(){m_ctrl.remove()}function GrayCfmBtn(bGray){var ctrl=$("#"+m_cfmbtn);bGray?(ctrl.html("正在创建..."),ctrl.css({"pointer-events":"none"})):(ctrl.html("确定"),ctrl.css({"pointer-events":""}))}id="assist"+CBoBo.Plugin.GetRandom(),titleid="input"+CBoBo.Plugin.GetRandom(),passwordid="input"+CBoBo.Plugin.GetRandom(),cpasswordid="input"+CBoBo.Plugin.GetRandom(),spanitem="input"+CBoBo.Plugin.GetRandom(),confirm="input"+CBoBo.Plugin.GetRandom(),self.cfmbtn=confirm,self="input"+CBoBo.Plugin.GetRandom(),checkbox="checkbox"+CBoBo.Plugin.GetRandom(),passwordbox="passwordbox"+CBoBo.Plugin.GetRandom(),(m_ctrl=$("<div ><form id='"+id+"'><div class='"+spanitem+"'><span >房间名：</span><input id='"+titleid+"' type='text' placeholder='请输入房间名称' required='required' autofocus max='15' tabindex='0'></input></div><div id='"+checkbox+"' ><div style='text-align:right; width:90px'>房间加密</div></div><div id='"+passwordbox+"' style='display:none;'><div class='"+spanitem+"'><span>密码：</span><input id='"+passwordid+"' type='password' placeholder='请输入房间密码' required='required' tabindex='1'></input></div><div class='"+spanitem+"'><span>确认密码：</span><input id='"+cpasswordid+"' type='password' placeholder='请确认房间密码' required='required' tabindex='2'></input></div></div><div class='"+spanitem+"'><button id='"+confirm+"' tabindex='3' type='submit'>确定</button><button id='"+self+"' tabindex='4'>取消</button></div></form></div>").appendTo($("#"+m_arrId.container))).css({position:"absolute",left:0,top:0,width:"100%",height:"100%",background:"#444444","box-shadow":"1px 1px 2px #000"}),$("#"+id).css({margin:"0 auto",width:"288px",height:"100%","padding-top":"20px"}),$("."+spanitem).css({"margin-bottom":"10px","text-align":"center"}),$("."+spanitem+" span").css({"text-align":"right",width:"90px",display:"inline-block","vertical-align":"middle"}),$("."+spanitem+" input").css({padding:"0",border:"1px solid #333",background:"#ddd",height:"25px"}),$("."+spanitem+" button").css({width:"90px",background:"#333",border:"0",height:"30px",color:"#ccccc4",cursor:"pointer"}).bind("mouseenter mouseleave",function(e){"mouseenter"==e.type?$(this).css({background:"#ccccc4",color:"#333"}):"mouseleave"==e.type&&$(this).css({background:"#333",color:"#ccccc4"})}),$("#"+confirm).css({"margin-right":"10px"}),$("#"+self).bind("click",function(e){e.preventDefault(),Destroy()}),$("#"+confirm).bind("click",function(e){if(e.preventDefault(),void 0!==msgTransform||null!==msgTransform){e=$("#"+titleid).val();if(""===e)$.Msg("房间名不能为空!");else{var psw="";if(m_bShowPassword){var psw=$("#"+passwordid).val(),cpsw=$("#"+cpasswordid).val();if(""===psw)return void $.Msg("密码不能为空!");if(psw!==cpsw)return void $.Msg("两次输入的密码不相同!")}GrayCfmBtn(!0),msgTransform({title:e,isprivate:m_bShowPassword,password:psw,destory:Destroy,gray:GrayCfmBtn})}}}),$("#"+checkbox).height(40).css({position:"relative"}),new CBoBo.View.CheckBox({parent:"#"+checkbox,title:"房间加密",msgtransform:function(bShow){m_bShowPassword=bShow;var box=$("#"+passwordbox);bShow?box.slideDown(400):box.slideUp(400)}}).SetPositon(110,-18)};m_arrId.ctrl="assist"+CBoBo.Plugin.GetRandom(),m_arrId.title=CBoBo.Plugin.GetRandom(),m_arrId.container=CBoBo.Plugin.GetRandom(),m_arrId.search=CBoBo.Plugin.GetRandom(),m_arrId.searchbtn=CBoBo.Plugin.GetRandom(),m_arrId.room=CBoBo.Plugin.GetRandom(),m_arrId.roommanager=CBoBo.Plugin.GetRandom(),m_arrId.roomin=CBoBo.Plugin.GetRandom(),m_arrId.clear=CBoBo.Plugin.GetRandom(),m_arrId.roommanactrl=CBoBo.Plugin.GetRandom(),m_arrId.myroom=CBoBo.Plugin.GetRandom(),m_arrId.otherroom=CBoBo.Plugin.GetRandom(),m_arrId.roomtitle=CBoBo.Plugin.GetRandom(),m_arrId.addstudy=CBoBo.Plugin.GetRandom(),options="<div id='"+m_arrId.ctrl+"' class='icon_tool'><div id='"+m_arrId.title+"'><span>协同诊断</span><a>&#xe661;</a></div><div id='"+m_arrId.container+"'><div id='"+m_arrId.search+"'><input type='text' placeholder='搜索：房间名/号、在线用户'></input><a id='"+m_arrId.searchbtn+"'>取消</a><div class'"+m_arrId.clear+"'></div></div><div id='"+m_arrId.room+"'><div id='"+m_arrId.roommanager+"'><div class='"+m_arrId.roommanactrl+"'><label>&#xe69d;</label><span>创建房间</span></div></div><div id='"+m_arrId.myroom+"'><span class='"+m_arrId.roomtitle+"'>我的房间</span><ul></ul></div><div id='"+m_arrId.otherroom+"'><span class='"+m_arrId.roomtitle+"'>公共房间</span><ul></ul></div></div><div id='"+m_arrId.roomin+"'><a id='"+m_arrId.addstudy+"'>更新检查</a></div><div class'"+m_arrId.clear+"'></div></div></div>",$(options).appendTo($("body")),ShowRoomMember(!1),$("#"+m_arrId.title).bind("mousedown",function(event){var ctrl=$("#"+m_arrId.ctrl),ptMDown=new Point(event.pageX,event.pageY),event=ctrl.offset(),ptPos=new Point(event.left,event.top);$(document).bind("mousemove mouseup",function doc(event){switch(event.type){case"mousemove":var disX=event.pageX-ptMDown.x,disY=event.pageY-ptMDown.y,disX=disX+ptPos.x,disY=disY+ptPos.y;ctrl.css({left:disX+"px",top:disY+"px"});break;case"mouseup":$(document).unbind("mousemove mouseup",doc)}})}),$("#"+m_arrId.title+" a").bind("click",function(event){event.preventDefault(),self.Show(!1),null!=opt.msgtransform&&opt.msgtransform({type:"btnfocus",btntitle:"协同诊断",btnforce:!1})}),$("."+m_arrId.roomtitle).bind("click",function(e){var next=$(this).next();"none"==next.css("display")?(next.hide(),next.slideDown(300)):next.slideUp(300)}),$("."+m_arrId.roommanactrl).bind("click",function(e){"创建房间"===$(this).children("span").html()&&CreateRoomView(CreateRoomPro)}),$("#"+m_arrId.addstudy).bind("click",function(e){"function"==typeof opt.msgtransform&&opt.msgtransform({type:"addstudy"})}),options=$("body"),ctrl=$("#"+m_arrId.ctrl),winWidth=options.width(),options=options.height(),ctrlWidth=ctrl.width(),ctrlHeight=ctrl.height(),ctrl.css({left:(winWidth-ctrlWidth>>1)+"px",top:(options-ctrlHeight>>1)+"px"}),PushRoom({title:"厕所",personcount:2016,id:"aa123"},!0)},CBoBo.View.CanvasMax=function(options){this.bShow;var opt=$.extend(!0,{parent:null},options),ctrlId=CBoBo.Plugin.GetRandom();this.UpdateStyle=function(){var ctrl=$("#"+ctrlId),parent=$(opt.parent),width=parent.width(),parent=parent.height();ctrl.width(width).height(parent).css({left:"10px",top:"10px"})},this.Show=function(bShow){var ctrl=$("#"+ctrlId);bShow?(this.bShow=!0,ctrl.hide(),ctrl.fadeIn(400)):(this.bShow=!1,ctrl.fadeOut(400))},$("<div id='"+ctrlId+"'></div>").appendTo($(opt.parent)).css({position:"absolute","z-index":1e3,"-webkit-user-select":"none","background-color":"#535353","font-family":"tahoma, arial, sans-serif",color:"#FFF",display:"none"}),this.UpdateStyle(),options.parent="#"+ctrlId,this.secondCtrl=new CBoBo.View.CMngSecondLayer(options)},CBoBo.View.IconInfo=function(options){$.extend(!0,{msgtransform:null},options);var m_arrId={},options=(this.bShow,this.Show=function(bShow){var printBox=$("#"+m_arrId.ctrl);bShow?(printBox.fadeIn(300),this.bShow=!0):(printBox.fadeOut(800),this.bShow=!1)},this.SetInfo=function(){var container="#"+m_arrId.container,str=($(container).html(""),m_arrId.td||(m_arrId.td=CBoBo.Plugin.GetRandom()),m_arrId.th||(m_arrId.th=CBoBo.Plugin.GetRandom()),"<table><tr><td class='"+m_arrId.th+"'>按键</td><td class='"+m_arrId.th+"'>功能描述</td><td class='"+m_arrId.th+"'>按键</td><td class='"+m_arrId.th+"'>功能描述</td></tr></table>");str=(str=(str=(str=(str=(str=(str=(str=(str=(str=(str=(str=(str=(str=(str=(str=(str+="<table><tr><td class='"+m_arrId.td+"'>影像源</td><td class='"+m_arrId.td+"'>双击全屏</td><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe61b</span></td><td class='"+m_arrId.td+"'>调窗/自定义</td></tr></table>")+"<table><tr><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe631</span></td><td class='"+m_arrId.td+"'>释放工具</td><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe67f</span></td><td class='"+m_arrId.td+"'>重新加载</td></tr></table>")+"<table><tr><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe62a</span></td><td class='"+m_arrId.td+"'>图像布局</td><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe66d</span></td><td class='"+m_arrId.td+"'>序列布局</td></tr></table>")+"<table><tr><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe644</span></td><td class='"+m_arrId.td+"'>恢复</td><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe607</span></td><td class='"+m_arrId.td+"'>序列播放</td></tr></table>")+"<table><tr><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe610</span></td><td class='"+m_arrId.td+"'>定位线</td><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe629</span></td><td class='"+m_arrId.td+"'>文本</td></tr></table>")+"<table><tr><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe671</span></td><td class='"+m_arrId.td+"'>DICOM信息</td><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe6b6</span></td><td class='"+m_arrId.td+"'>四角信息</td></tr></table>")+"<table><tr><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe670</span></td><td class='"+m_arrId.td+"'>放缩</td><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe630</span></td><td class='"+m_arrId.td+"'>移动</td></tr></table>")+"<table><tr><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe623</span></td><td class='"+m_arrId.td+"'>旋转</td><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe603</span></td><td class='"+m_arrId.td+"'>负像</td></tr></table>")+"<table><tr><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe602</span></td><td class='"+m_arrId.td+"'>伪彩</td><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe61f</span></td><td class='"+m_arrId.td+"'>直线</td></tr></table>")+"<table><tr><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe902</span></td><td class='"+m_arrId.td+"'>锐化</td><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe901</span></td><td class='"+m_arrId.td+"'>平滑</td></tr></table>")+"<table><tr><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe617</span></td><td class='"+m_arrId.td+"'>心胸比</td><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe619</span></td><td class='"+m_arrId.td+"'>矩形</td></tr></table>")+"<table><tr><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe622</span></td><td class='"+m_arrId.td+"'>撤销</td><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe61e</span></td><td class='"+m_arrId.td+"'>椭圆</td></tr></table>")+"<table><tr><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe653</span></td><td class='"+m_arrId.td+"'>删除图像</td><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe618</span></td><td class='"+m_arrId.td+"'>角度</td></tr></table>")+"<table><tr><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe64c</span></td><td class='"+m_arrId.td+"'>按键说明</td><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe637</span></td><td class='"+m_arrId.td+"'>CT值</td></tr></table>")+"<table><tr><td class='"+m_arrId.td+"'>MPR</td><td class='"+m_arrId.td+"'>MPR</td><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe62f</span></td><td class='"+m_arrId.td+"'>箭头</td></tr></table>")+"<table><tr><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xE60E</span></td><td class='"+m_arrId.td+"'>右标记</td><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe9d8</span></td><td class='"+m_arrId.td+"'>左标记</td></tr></table>")+"<table><tr><td class='"+m_arrId.td+"'><span class='icon_tool'>&#xe900</span></td><td class='"+m_arrId.td+"'>开/关图像缓存</td><td class='"+m_arrId.td+"'>shift+delete</td><td class='"+m_arrId.td+"'>清除图像缓存</td></tr></table>",$(str).appendTo($(container)),$("."+m_arrId.th).width(140).css({color:"#33ffff","font-size":"17px"}),$("."+m_arrId.td).width(140).css({color:"#FFF","font-size":"17px"})},m_arrId.ctrl=CBoBo.Plugin.GetRandom(),m_arrId.container=CBoBo.Plugin.GetRandom(),options="<div id='"+m_arrId.ctrl+"' class='icon_tool'><div id='"+m_arrId.container+"'></div></div>",$(options).appendTo($("body")),$(window).width()),options=($(window).height(),600<(options=.5*options>>0)?600:options),ctrlHeight=$("#"+CBoBo.Manager.canvasManager.arrTag.box).height(),top=$("#"+CBoBo.Manager.frame.GetId("banner")).height();$("#"+m_arrId.ctrl).width(options).height(ctrlHeight).css({border:"1px solid #676767",position:"absolute","z-index":11111,background:"#444444","border-radius":"20px",display:"none","user-select":"none",color:"#CCCCC4",opacity:"90%",right:"0px",top:top+"px"}),$("#"+m_arrId.container).width(options-30).height(ctrlHeight-30-30).css({"user-select":"auto",padding:"15px","font-family":"Microsoft YaHei",overflow:"auto"})};